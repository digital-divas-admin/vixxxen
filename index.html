<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vixxxen - AI Image Generator</title>

  <!-- Favicons -->
  <link rel="icon" type="image/x-icon" sizes="16x16" href="/public/favicon/favicon-16px.ico">
  <link rel="icon" type="image/x-icon" sizes="32x32" href="/public/favicon/favicon-32px.ico">
  <link rel="icon" type="image/x-icon" sizes="48x48" href="/public/favicon/favicon-48px.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/public/favicon/favicon-180px.ico">

  <!-- Resource hints for faster loading -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.socket.io">
  <!-- Supabase API and storage -->
  <link rel="preconnect" href="https://kdgjbyfqytjtywxlekpz.supabase.co" crossorigin>
  <link rel="dns-prefetch" href="https://kdgjbyfqytjtywxlekpz.supabase.co">

  <!-- Critical loading splash (inline to show immediately) -->
  <style id="splash-styles">
    .loading-splash {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #0f0f0f;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      transition: opacity 0.3s ease-out;
    }
    .loading-splash.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .loading-splash-logo {
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 20px;
    }
    .loading-splash-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255, 46, 187, 0.2);
      border-top-color: #ff2ebb;
      border-radius: 50%;
      animation: splash-spin 1s linear infinite;
    }
    .loading-splash-text {
      color: #888;
      margin-top: 16px;
      font-size: 0.9rem;
    }
    @keyframes splash-spin {
      to { transform: rotate(360deg); }
    }
  </style>

  <!-- External CSS - Organized styles -->
  <link rel="stylesheet" href="css/main.css?v=20260115">
  <link rel="stylesheet" href="css/landing-page.css?v=20260115">
  <link rel="stylesheet" href="css/onboarding-wizard.css?v=20260115">

  <style>
    /* ===========================================
       PAGE & FEATURE SPECIFIC STYLES
       Base styles are now in external css/main.css
       =========================================== */

    /* Marketplace Page */
    .marketplace-page {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #0f0f0f;
      overflow-y: auto;
      padding: 40px;
    }

    .marketplace-header {
      margin-bottom: 40px;
    }

    .marketplace-title {
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }

    .marketplace-subtitle {
      font-size: 1.1rem;
      color: #888;
    }

    .marketplace-tabs {
      display: flex;
      gap: 16px;
      margin-bottom: 32px;
      border-bottom: 2px solid #2a2a2a;
      padding-bottom: 0;
    }

    .marketplace-tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      color: #888;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .marketplace-tab:hover {
      color: #fff;
      border-bottom-color: #3a3a3a;
    }

    .marketplace-tab.active {
      color: #fff;
      border-bottom-color: #ff2ebb;
    }

    .marketplace-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 24px;
      margin-bottom: 40px;
    }

    .character-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s;
    }

    .character-card:hover {
      transform: translateY(-4px);
      border-color: var(--accent-primary);
      box-shadow: 0 8px 24px rgba(255, 46, 187, 0.2);
    }

    .character-image {
      width: 100%;
      height: 280px;
      object-fit: cover;
      background: var(--bg-hover);
    }

    .character-info {
      padding: 20px;
    }

    .character-name {
      font-size: 1.2rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 8px;
    }

    .character-category {
      font-size: 0.85rem;
      color: #888;
      margin-bottom: 12px;
    }

    .character-stats {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
      font-size: 0.85rem;
      color: #666;
    }

    .character-rating {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .character-purchases {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .character-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-top: 16px;
      border-top: 1px solid #2a2a2a;
    }

    .character-price {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .character-price-label {
      font-size: 0.75rem;
      color: #666;
      margin-top: 2px;
    }

    .character-buy-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .character-buy-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(255, 46, 187, 0.4);
    }

    /* Custom Commission Card */
    .custom-commission-card {
      border: 2px dashed rgba(157, 78, 221, 0.4);
      background: linear-gradient(135deg, rgba(157, 78, 221, 0.05) 0%, rgba(255, 46, 187, 0.05) 100%);
    }

    .custom-commission-card:hover {
      border-style: solid;
      border-color: rgba(157, 78, 221, 0.8);
      background: linear-gradient(135deg, rgba(157, 78, 221, 0.1) 0%, rgba(255, 46, 187, 0.1) 100%);
    }

    .custom-commission-image {
      width: 100%;
      height: 280px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, rgba(157, 78, 221, 0.2) 0%, rgba(255, 46, 187, 0.2) 100%);
    }

    .custom-commission-icon {
      font-size: 5rem;
      margin-bottom: 12px;
    }

    .custom-commission-label {
      font-size: 1rem;
      font-weight: 600;
      color: #9d4edd;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .character-buy-btn.owned {
      background: #2a2a2a;
      color: #00ff88;
      cursor: default;
    }

    .character-buy-btn.owned:hover {
      transform: none;
      box-shadow: none;
    }

    /* Character Detail Modal */
    .character-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 30000;
      align-items: center;
      justify-content: center;
      padding: 40px;
    }

    .character-modal.active {
      display: flex;
    }

    .character-modal-content {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 16px;
      max-width: 1000px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    .character-modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      background: #2a2a2a;
      border: none;
      border-radius: 50%;
      color: #fff;
      font-size: 1.5rem;
      cursor: pointer;
      z-index: 10;
      transition: all 0.2s;
    }

    .character-modal-close:hover {
      background: #ff2ebb;
      transform: rotate(90deg);
    }

    .character-modal-header {
      display: flex;
      gap: 32px;
      padding: 40px;
      border-bottom: 1px solid #2a2a2a;
    }

    .character-modal-image {
      width: 300px;
      height: 400px;
      object-fit: cover;
      border-radius: 12px;
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .character-modal-image:hover {
      opacity: 0.9;
    }

    .character-modal-info {
      flex: 1;
    }

    .character-modal-name {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .character-modal-category {
      color: #888;
      font-size: 1rem;
      margin-bottom: 20px;
    }

    .character-modal-description {
      color: #ccc;
      line-height: 1.6;
      margin-bottom: 24px;
    }

    .character-modal-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 24px;
    }

    .character-tag {
      padding: 6px 12px;
      background: #2a2a2a;
      border-radius: 6px;
      font-size: 0.85rem;
      color: #00b2ff;
    }

    .character-modal-purchase {
      padding: 24px;
      background: #0f0f0f;
      border-radius: 12px;
      margin-top: 24px;
    }

    .character-modal-price {
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 16px;
    }

    .character-modal-buy-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      border: none;
      border-radius: 12px;
      color: #fff;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }

    .character-modal-buy-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(255, 46, 187, 0.4);
    }

    .character-modal-gallery {
      padding: 40px;
    }

    .character-modal-gallery-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 24px;
    }

    .character-gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
    }

    .character-gallery-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 8px;
      background: #2a2a2a;
      cursor: pointer;
      transition: all 0.2s;
    }

    .character-gallery-image:hover {
      transform: scale(1.05);
    }

    /* Lightbox Modal */
    .lightbox-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .lightbox-modal.active {
      display: flex;
      opacity: 1;
    }

    .lightbox-image {
      max-width: 90vw;
      max-height: 90vh;
      object-fit: contain;
      border-radius: 8px;
      user-select: none;
    }

    .lightbox-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 48px;
      height: 48px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 24px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s;
      backdrop-filter: blur(10px);
      z-index: 40001;
    }

    .lightbox-close:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: rotate(90deg);
    }

    .lightbox-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 64px;
      height: 64px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 48px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s;
      backdrop-filter: blur(10px);
      z-index: 40001;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      padding: 0;
    }

    .lightbox-nav:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .lightbox-nav:active {
      transform: translateY(-50%) scale(0.95);
    }

    .lightbox-prev {
      left: 20px;
    }

    .lightbox-next {
      right: 20px;
    }

    .lightbox-counter {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      padding: 12px 24px;
      border-radius: 24px;
      font-size: 0.9rem;
      backdrop-filter: blur(10px);
      z-index: 40001;
    }

    /* Make gallery items clickable */
    .character-gallery-item {
      cursor: pointer;
      overflow: hidden;
      border-radius: 8px;
    }

    .character-gallery-item img {
      transition: transform 0.2s;
    }

    .character-gallery-item:hover img {
      transform: scale(1.05);
    }

    /* Payment Modals */
    .payment-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 50000;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .payment-modal.active {
      display: flex;
      opacity: 1;
    }

    .payment-modal-content {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 48px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      position: relative;
      border: 2px solid;
    }

    .payment-modal-content.success {
      border-color: #00ff88;
      animation: successPop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .payment-modal-content.failure {
      border-color: #ff4444;
      animation: jiggle 0.5s ease-in-out;
    }

    @keyframes successPop {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); opacity: 1; }
    }

    @keyframes jiggle {
      0%, 100% { transform: translateX(0) rotate(0deg); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-10px) rotate(-2deg); }
      20%, 40%, 60%, 80% { transform: translateX(10px) rotate(2deg); }
    }

    .payment-modal-icon {
      font-size: 80px;
      margin-bottom: 24px;
      line-height: 1;
    }

    .payment-modal-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--text-primary);
    }

    .payment-modal-message {
      font-size: 1.1rem;
      color: var(--text-secondary);
      margin-bottom: 32px;
      line-height: 1.6;
    }

    .payment-modal-button {
      padding: 16px 48px;
      border-radius: 12px;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .payment-modal-button.success {
      background: linear-gradient(135deg, #00ff88, #00cc88);
      color: #0f0f0f;
    }

    .payment-modal-button.success:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 255, 136, 0.3);
    }

    .payment-modal-button.failure {
      background: linear-gradient(135deg, #ff4444, #cc3333);
      color: white;
    }

    .payment-modal-button.failure:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(255, 68, 68, 0.3);
    }

    /* Confetti */
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background: #00ff88;
      animation: confetti-fall 3s linear forwards;
    }

    @keyframes confetti-fall {
      0% {
        transform: translateY(0) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }

    /* My Characters Library */
    .library-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 20px;
    }

    .library-character-card {
      background: #1a1a1a;
      border: 2px solid #00ff88;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }

    .library-character-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 6px 12px;
      background: #00ff88;
      color: #0f0f0f;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 700;
    }

    /* Subscription Page */
    .subscription-page {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #0f0f0f;
      overflow-y: auto;
      padding: 60px 40px;
    }

    .subscription-header {
      text-align: center;
      margin-bottom: 60px;
    }

    .subscription-title {
      font-size: 3rem;
      font-weight: 800;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 16px;
    }

    .subscription-subtitle {
      font-size: 1.2rem;
      color: #888;
      max-width: 600px;
      margin: 0 auto;
    }

    .pricing-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 32px;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    .pricing-card {
      background: #1a1a1a;
      border: 2px solid #2a2a2a;
      border-radius: 16px;
      padding: 40px 32px;
      display: flex;
      flex-direction: column;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .pricing-card:hover {
      transform: translateY(-8px);
      border-color: #3a3a3a;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
    }

    .pricing-card.featured {
      border-color: #ff2ebb;
      background: linear-gradient(135deg, rgba(255, 46, 187, 0.05), rgba(0, 178, 255, 0.05));
    }

    .pricing-card.featured::before {
      content: 'MOST POPULAR';
      position: absolute;
      top: 20px;
      right: -35px;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      color: #fff;
      padding: 4px 40px;
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 1px;
      transform: rotate(45deg);
    }

    .pricing-tier {
      font-size: 0.9rem;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .pricing-card.featured .pricing-tier {
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .pricing-name {
      font-size: 2rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 16px;
    }

    .pricing-price {
      font-size: 3.5rem;
      font-weight: 800;
      color: #fff;
      margin-bottom: 8px;
    }

    .pricing-price span {
      font-size: 1.2rem;
      color: #666;
      font-weight: 500;
    }

    .pricing-period {
      color: #666;
      font-size: 0.95rem;
      margin-bottom: 32px;
    }

    .pricing-credits {
      background: rgba(0, 178, 255, 0.1);
      border: 1px solid rgba(0, 178, 255, 0.2);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 32px;
      text-align: center;
    }

    .pricing-credits-amount {
      font-size: 2rem;
      font-weight: 700;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 4px;
    }

    .pricing-credits-label {
      font-size: 0.85rem;
      color: #888;
    }

    .pricing-features {
      list-style: none;
      padding: 0;
      margin: 0 0 32px 0;
      flex: 1;
    }

    .pricing-feature {
      padding: 12px 0;
      color: #aaa;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .pricing-feature::before {
      content: '✓';
      color: #00ff88;
      font-weight: 700;
      font-size: 1.2rem;
    }

    .pricing-feature.disabled {
      color: #444;
    }

    .pricing-feature.disabled::before {
      content: '✗';
      color: #444;
    }

    .pricing-cta {
      width: 100%;
      padding: 16px;
      background: rgba(255, 46, 187, 0.1);
      border: 2px solid rgba(255, 46, 187, 0.3);
      border-radius: 12px;
      color: #fff;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .pricing-cta:hover {
      background: rgba(255, 46, 187, 0.2);
      border-color: rgba(255, 46, 187, 0.5);
      transform: translateY(-2px);
    }

    .pricing-card.featured .pricing-cta {
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      border: none;
    }

    .pricing-card.featured .pricing-cta:hover {
      box-shadow: 0 8px 24px rgba(255, 46, 187, 0.4);
    }

    .pricing-footer {
      text-align: center;
      margin-top: 60px;
      padding-top: 40px;
      border-top: 1px solid #2a2a2a;
    }

    .pricing-footer-text {
      color: #666;
      font-size: 0.95rem;
      margin-bottom: 16px;
    }

    .pricing-contact {
      color: #00b2ff;
      text-decoration: none;
      font-weight: 600;
    }

    .pricing-contact:hover {
      text-decoration: underline;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .pricing-cards {
        grid-template-columns: 1fr;
        max-width: 500px;
      }

      .subscription-page {
        padding: 40px 20px;
      }
    }

    .nav-tab {
      padding: 20px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
      color: var(--text-muted);
      transition: background 0.2s, color 0.2s;
    }

    .nav-tab:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .nav-tab.active {
      border-left-color: var(--accent-primary);
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .nav-icon {
      font-size: 1.5rem;
    }

    .nav-label {
      font-size: 0.7rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Left Panel */
    .left-panel {
      width: 380px;
      background: var(--bg-tertiary);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      transition: width 0.3s ease, background 0.3s;
    }

    .left-panel.canvas-active {
      width: 760px;
    }

    .header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .logo {
      height: 40px;
      width: auto;
    }

    .header h1 {
      font-size: 1.3rem;
      font-weight: 600;
      margin: 0;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .tagline {
      font-size: 0.75rem;
      color: #666;
      margin-top: 4px;
    }

    /* Content Mode Toggle (Safe/NSFW) */
    .content-mode-toggle {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 16px;
      padding: 8px 16px;
      background: #1a1a1a;
      border-radius: 8px;
      border: 1px solid #2a2a2a;
    }

    .content-mode-label {
      font-size: 0.85rem;
      color: #888;
      font-weight: 500;
    }

    .content-mode-switch {
      display: flex;
      background: #252525;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid #2a2a2a;
      flex-shrink: 0;
    }

    .content-mode-btn {
      padding: 8px 18px;
      min-width: 65px;
      text-align: center;
      border: none;
      background: transparent;
      color: #aaa;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .content-mode-btn.active {
      background: linear-gradient(135deg, #00b2ff, #00e676);
      color: #fff;
    }

    .content-mode-btn.nsfw-btn.active {
      background: linear-gradient(135deg, #ff2ebb, #ff6b6b);
    }

    .content-mode-btn:hover:not(.active) {
      color: #aaa;
      background: #333;
    }

    .content-mode-info {
      font-size: 0.75rem;
      color: #666;
      margin-left: auto;
    }

    .model-tabs {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .model-tab {
      flex: 1;
      min-width: 120px;
      padding: 12px 16px;
      background: #252525;
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      color: #888;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      white-space: nowrap;
    }

    .model-tab:hover {
      background: #2a2a2a;
      color: #fff;
      transform: translateY(-2px);
      border-color: #3a3a3a;
    }

    .model-tab.active {
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 4px 12px rgba(255, 46, 187, 0.3);
    }

    /* Tab Content Sections */
    .tab-section {
      display: none;
      flex: 1;
    }

    .tab-section.active {
      display: flex;
    }

    .content {
      padding: 20px;
      flex: 1;
      overflow-y: auto;
    }

    /* Video tab specific - ensure generate button stays visible */
    #videoSection .left-panel {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 156px); /* Account for footer + navbar */
      overflow: hidden;
    }

    #videoSection .left-panel .header {
      flex-shrink: 0;
    }

    #videoSection .content {
      flex: 1;
      overflow-y: auto;
      padding-bottom: 30px;
    }

    /* Placeholder for empty tabs */
    .placeholder-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #666;
      padding: 40px;
      text-align: center;
    }

    .placeholder-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    .placeholder-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: #888;
    }

    .placeholder-text {
      font-size: 0.9rem;
      line-height: 1.6;
    }

    .section {
      margin-bottom: 24px;
    }

    .section-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
    }

    /* Reference Images */
    .reference-upload {
      border: 2px dashed var(--border-color);
      border-radius: 8px;
      padding: 30px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--bg-primary);
    }

    .reference-upload:hover {
      border-color: var(--accent-primary);
      background: var(--bg-hover);
    }

    .reference-upload.drag-over,
    .inpaint-upload-placeholder.drag-over {
      border-color: var(--accent-primary);
      background: rgba(255, 46, 187, 0.15);
      box-shadow: 0 0 20px rgba(255, 46, 187, 0.3);
      transform: scale(1.02);
    }

    .reference-upload-icon {
      font-size: 2rem;
      margin-bottom: 8px;
    }

    .reference-upload-text {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .reference-upload-hint {
      font-size: 0.75rem;
      color: #555;
      margin-top: 4px;
    }

    /* Form Input Styles */
    .input-select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 0.9rem;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      transition: background 0.3s, border-color 0.3s, color 0.3s;
    }

    .input-select:focus {
      outline: none;
      border-color: var(--accent-primary);
    }

    .input-select optgroup {
      background: var(--bg-tertiary);
      color: var(--accent-primary);
      font-weight: 600;
    }

    .input-select option {
      background: #1a1a1a;
      color: #fff;
      padding: 8px;
    }

    .slider-container {
      margin-bottom: 16px;
    }

    .slider-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      color: #888;
      margin-bottom: 6px;
    }

    .slider {
      width: 100%;
      height: 6px;
      -webkit-appearance: none;
      appearance: none;
      background: #2a2a2a;
      border-radius: 3px;
      outline: none;
      cursor: pointer;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    .slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      border-radius: 50%;
      border: none;
      cursor: pointer;
    }

    .slider-hint {
      font-size: 0.7rem;
      color: #555;
      margin-top: 4px;
    }

    .char-count {
      font-size: 0.75rem;
      color: #666;
      text-align: right;
      margin-top: 6px;
    }

    .clone-info {
      font-size: 0.85rem;
      color: #888;
      line-height: 1.5;
      margin-bottom: 16px;
      padding: 12px;
      background: rgba(255, 46, 187, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(255, 46, 187, 0.2);
    }

    /* Education Tab Styles */
    .education-page {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .education-no-access {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100%;
      padding: 40px;
    }

    .no-access-content {
      text-align: center;
      max-width: 900px;
    }

    .no-access-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .no-access-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .no-access-subtitle {
      color: #888;
      font-size: 1.1rem;
      margin-bottom: 40px;
    }

    .membership-tiers {
      display: flex;
      gap: 24px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .membership-card {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 16px;
      padding: 32px;
      width: 320px;
      text-align: center;
      position: relative;
      transition: transform 0.3s, border-color 0.3s;
    }

    .membership-card:hover {
      transform: translateY(-4px);
      border-color: #444;
    }

    .membership-card.featured {
      border-color: #ff2ebb;
      background: linear-gradient(180deg, #1a1a1a 0%, #1f1020 100%);
    }

    .membership-popular {
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      color: #fff;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 4px 16px;
      border-radius: 20px;
    }

    .membership-badge {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .membership-name {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .membership-price {
      font-size: 2.5rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 24px;
    }

    .membership-price span {
      font-size: 1rem;
      color: #888;
      font-weight: 400;
    }

    .membership-features {
      list-style: none;
      padding: 0;
      margin: 0 0 24px 0;
      text-align: left;
    }

    .membership-features li {
      padding: 8px 0;
      color: #aaa;
      font-size: 0.9rem;
      border-bottom: 1px solid #2a2a2a;
    }

    .membership-features li:last-child {
      border-bottom: none;
    }

    .membership-btn {
      width: 100%;
      padding: 14px;
      border-radius: 8px;
      border: none;
      background: #2a2a2a;
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .membership-btn:hover {
      background: #3a3a3a;
    }

    .membership-btn.primary {
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
    }

    .membership-btn.primary:hover {
      opacity: 0.9;
    }

    .membership-btn .crypto-icon {
      margin-right: 6px;
      font-weight: bold;
    }

    .membership-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Education Sub-tabs */
    .education-subtabs {
      display: flex;
      gap: 0;
      background: #1a1a1a;
      border-bottom: 1px solid #2a2a2a;
      padding: 0 20px;
    }

    .education-subtab {
      padding: 16px 24px;
      color: #888;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .education-subtab:hover {
      color: #fff;
      background: rgba(255,255,255,0.03);
    }

    .education-subtab.active {
      color: #fff;
      border-bottom-color: #ff2ebb;
    }

    .education-subtab-icon {
      font-size: 1.1rem;
    }

    /* Education Sub-tab Content */
    .education-subtab-content {
      display: none;
      flex: 1;
      overflow: hidden;
    }

    .education-subtab-content.active {
      display: flex;
      flex-direction: column;
    }

    /* Resource Library Styles */
    .resource-library {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: #0a0a0a;
    }

    .resource-filters {
      padding: 20px;
      background: #111;
      border-bottom: 1px solid #2a2a2a;
    }

    .resource-filter-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .resource-filter-row:last-child {
      margin-bottom: 0;
    }

    .resource-filter-label {
      color: #666;
      font-size: 0.8rem;
      min-width: 50px;
      display: flex;
      align-items: center;
    }

    .resource-filter-btn {
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid #333;
      background: transparent;
      color: #888;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .resource-filter-btn:hover {
      border-color: #555;
      color: #fff;
    }

    .resource-filter-btn.active {
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      border-color: transparent;
      color: #fff;
    }

    /* Resource Grid */
    .resource-grid-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .resource-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    /* Resource Card */
    .resource-card {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s;
      position: relative;
    }

    .resource-card:hover {
      transform: translateY(-4px);
      border-color: #444;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }

    .resource-card.locked {
      opacity: 0.85;
    }

    .resource-card.locked:hover {
      border-color: #ff2ebb;
    }

    .resource-thumbnail {
      width: 100%;
      height: 160px;
      background: linear-gradient(135deg, #1f1f1f 0%, #2a2a2a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      position: relative;
    }

    .resource-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .resource-type-badge {
      position: absolute;
      top: 12px;
      left: 12px;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .resource-type-badge.tutorial {
      background: #4CAF50;
      color: #fff;
    }

    .resource-type-badge.guide {
      background: #2196F3;
      color: #fff;
    }

    .resource-type-badge.video {
      background: #F44336;
      color: #fff;
    }

    .resource-tier-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      color: #fff;
    }

    .resource-tier-badge.mentorship-only {
      background: linear-gradient(135deg, #ff2ebb, #e040fb);
    }

    .resource-tier-badge.supernova-only {
      background: linear-gradient(135deg, #00b2ff, #00e5ff);
    }

    .resource-duration {
      position: absolute;
      bottom: 12px;
      right: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      background: rgba(0,0,0,0.8);
      color: #fff;
    }

    .resource-card-body {
      padding: 16px;
    }

    .resource-title {
      font-size: 1rem;
      font-weight: 600;
      color: #fff;
      margin-bottom: 8px;
      line-height: 1.3;
    }

    .resource-description {
      font-size: 0.85rem;
      color: #888;
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .resource-topic-tag {
      display: inline-block;
      margin-top: 12px;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.7rem;
      background: #2a2a2a;
      color: #aaa;
      text-transform: capitalize;
    }

    /* Locked Overlay */
    .resource-locked-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .resource-card.locked:hover .resource-locked-overlay {
      opacity: 1;
    }

    .resource-lock-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .resource-lock-text {
      font-size: 0.85rem;
      color: #ff2ebb;
      font-weight: 600;
    }

    /* No Access Overlay for Resources */
    .resource-no-access-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(10,10,10,0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
      padding: 40px;
    }

    .resource-no-access-content {
      text-align: center;
      max-width: 500px;
    }

    .resource-no-access-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .resource-no-access-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 8px;
    }

    .resource-no-access-text {
      color: #888;
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .resource-upgrade-btn {
      padding: 14px 32px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.2s;
    }

    .resource-upgrade-btn:hover {
      opacity: 0.9;
      transform: scale(1.02);
    }

    .resource-upgrade-btn.secondary {
      background: transparent;
      border: 1px solid #ff2ebb;
      color: #ff2ebb;
    }

    /* Price Badge */
    .resource-price-badge {
      position: absolute;
      bottom: 12px;
      left: 12px;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 700;
      background: linear-gradient(135deg, #00c853, #00e676);
      color: #fff;
      box-shadow: 0 2px 8px rgba(0,200,83,0.3);
    }

    .resource-price-badge.sale {
      background: linear-gradient(135deg, #ff5722, #ff9800);
    }

    .resource-price-badge .original-price {
      text-decoration: line-through;
      opacity: 0.7;
      font-size: 0.8rem;
      margin-right: 6px;
    }

    .resource-price-badge .sale-price {
      font-size: 1rem;
    }

    /* Purchased Badge */
    .resource-purchased-badge {
      position: absolute;
      top: 12px;
      left: 12px;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 600;
      background: linear-gradient(135deg, #00c853, #00e676);
      color: #fff;
    }

    .resource-card.purchased {
      border: 2px solid #00c853;
    }

    /* Purchasable overlay */
    .resource-locked-overlay.purchasable {
      background: rgba(0,0,0,0.8);
    }

    .resource-buy-btn {
      padding: 12px 24px;
      border-radius: 8px;
      background: linear-gradient(135deg, #00c853, #00e676);
      color: #fff;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .resource-buy-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 20px rgba(0,200,83,0.4);
    }

    /* Purchase Modal Content */
    .resource-modal-purchase {
      text-align: center;
      padding: 40px 20px;
    }

    .resource-modal-purchase-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .resource-modal-purchase-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 12px;
    }

    .resource-modal-purchase-price {
      font-size: 2rem;
      font-weight: 700;
      color: #00e676;
      margin-bottom: 8px;
    }

    .resource-modal-purchase-price .original-price {
      text-decoration: line-through;
      color: #666;
      font-size: 1.2rem;
      margin-right: 10px;
    }

    .resource-modal-purchase-price .sale-price {
      color: #ff5722;
    }

    .sale-ends-text {
      color: #ff5722;
      font-size: 0.9rem;
      margin-bottom: 16px;
    }

    .resource-modal-purchase-text {
      color: #888;
      margin-bottom: 24px;
      line-height: 1.6;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    .resource-purchase-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
      margin-bottom: 20px;
    }

    .credit-balance-display {
      background: #1a1a1a;
      padding: 8px 16px;
      border-radius: 8px;
      color: #00e676;
      font-size: 0.9rem;
      margin-bottom: 8px;
    }

    .resource-buy-btn.primary {
      padding: 16px 48px;
      font-size: 1.1rem;
      border: none;
    }

    .resource-buy-btn.secondary {
      background: transparent;
      border: 2px solid #00c853;
      color: #00c853;
    }

    .resource-modal-or {
      color: #666;
      font-size: 0.9rem;
      margin: 16px 0;
    }

    /* Free with tier display */
    .resource-free-with {
      font-size: 0.85rem;
      color: #00e676;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .resource-or-divider {
      color: #666;
      font-size: 0.75rem;
      margin: 6px 0;
    }

    .resource-modal-free-tier {
      background: linear-gradient(135deg, rgba(0,230,118,0.1), rgba(0,178,255,0.1));
      border: 1px solid rgba(0,230,118,0.3);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 8px;
    }

    .free-tier-badge {
      display: inline-block;
      background: linear-gradient(135deg, #00c853, #00e676);
      color: #fff;
      padding: 6px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 8px;
    }

    .resource-modal-free-tier p {
      color: #aaa;
      font-size: 0.85rem;
      margin: 0;
    }

    /* Resource Modal */
    .resource-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      padding: 40px;
    }

    .resource-modal.active {
      display: flex;
    }

    .resource-modal-content {
      background: #1a1a1a;
      border-radius: 16px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .resource-modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: #2a2a2a;
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      z-index: 10;
      transition: background 0.2s;
    }

    .resource-modal-close:hover {
      background: #3a3a3a;
    }

    .resource-modal-header {
      padding: 24px;
      border-bottom: 1px solid #2a2a2a;
    }

    .resource-modal-type {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 12px;
    }

    .resource-modal-type.tutorial {
      background: #4CAF50;
      color: #fff;
    }

    .resource-modal-type.guide {
      background: #2196F3;
      color: #fff;
    }

    .resource-modal-type.video {
      background: #F44336;
      color: #fff;
    }

    /* Education Member Content Container */
    .education-member-content {
      display: none;
      flex-direction: column;
      flex: 1;
      height: 100%;
      overflow: hidden;
    }

    .resource-modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 8px;
    }

    .resource-modal-meta {
      display: flex;
      gap: 16px;
      color: #888;
      font-size: 0.85rem;
    }

    .resource-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    .resource-modal-body h2 {
      font-size: 1.3rem;
      color: #fff;
      margin: 24px 0 12px 0;
    }

    .resource-modal-body h2:first-child {
      margin-top: 0;
    }

    .resource-modal-body p {
      color: #bbb;
      line-height: 1.7;
      margin-bottom: 16px;
    }

    .resource-modal-body ul, .resource-modal-body ol {
      color: #bbb;
      margin: 0 0 16px 24px;
      line-height: 1.7;
    }

    .resource-modal-body code {
      background: #2a2a2a;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.9em;
    }

    /* Video Container in Modal */
    .resource-video-container {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
    }

    .resource-video-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    /* Upgrade Prompt in Modal */
    .resource-modal-upgrade {
      text-align: center;
      padding: 60px 40px;
    }

    .resource-modal-upgrade-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .resource-modal-upgrade-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 12px;
    }

    .resource-modal-upgrade-text {
      color: #888;
      margin-bottom: 24px;
      line-height: 1.6;
    }

    /* Empty State */
    .resource-empty {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .resource-empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    /* Start Here Section */
    .starthere-container {
      padding: 24px;
      height: 100%;
      overflow-y: auto;
    }

    .starthere-header {
      margin-bottom: 24px;
      text-align: center;
    }

    .starthere-title {
      font-size: 1.8rem;
      font-weight: 700;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }

    .starthere-subtitle {
      color: #888;
      font-size: 1rem;
    }

    .starthere-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .starthere-card {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s;
      position: relative;
    }

    .starthere-card:hover {
      transform: translateY(-4px);
      border-color: #00b2ff;
      box-shadow: 0 8px 24px rgba(0, 178, 255, 0.2);
    }

    .starthere-card-number {
      position: absolute;
      top: 16px;
      left: 16px;
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      font-weight: 700;
      color: #fff;
      z-index: 1;
    }

    .starthere-card-thumbnail {
      width: 100%;
      height: 140px;
      background: linear-gradient(135deg, #1f1f1f 0%, #2a2a2a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
    }

    .starthere-card-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .starthere-card-body {
      padding: 16px;
    }

    .starthere-card-title {
      font-size: 1rem;
      font-weight: 600;
      color: #fff;
      margin-bottom: 8px;
      line-height: 1.3;
    }

    .starthere-card-description {
      font-size: 0.85rem;
      color: #888;
      line-height: 1.4;
    }

    .starthere-card-status {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 12px;
      font-size: 0.8rem;
      color: #666;
    }

    .starthere-card-status.completed {
      color: #00e676;
    }

    .starthere-card-status-icon {
      font-size: 1rem;
    }

    .starthere-card.completed {
      border-color: #00e676;
    }

    .starthere-card.completed .starthere-card-number {
      background: #00e676;
    }

    .starthere-complete-section {
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid #2a2a2a;
      text-align: center;
    }

    .starthere-complete-btn {
      padding: 14px 32px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .starthere-complete-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(255, 46, 187, 0.3);
    }

    .starthere-complete-btn.completed {
      background: #00e676;
      cursor: default;
    }

    .starthere-complete-btn.completed:hover {
      transform: none;
      box-shadow: none;
    }

    .starthere-card-edit {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.2s, background 0.2s;
    }

    .starthere-card:hover .starthere-card-edit {
      opacity: 1;
    }

    .starthere-card-edit:hover {
      background: #ff2ebb;
    }

    .admin-starthere-btn {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 14px 24px;
      border-radius: 30px;
      border: none;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(255, 46, 187, 0.4);
      z-index: 1000;
      display: none;
      align-items: center;
      gap: 8px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .admin-starthere-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 28px rgba(255, 46, 187, 0.5);
    }

    .admin-starthere-btn.visible {
      display: flex;
    }

    /* Policies Admin Section */
    .policies-admin-container {
      padding: 24px;
      height: 100%;
      overflow-y: auto;
    }

    .policies-admin-header {
      margin-bottom: 24px;
      text-align: center;
    }

    .policies-admin-title {
      font-size: 1.8rem;
      font-weight: 700;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }

    .policies-admin-subtitle {
      color: var(--text-secondary);
      font-size: 1rem;
    }

    .policies-admin-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      max-width: 1000px;
      margin: 0 auto;
    }

    /* Analytics Dashboard Styles */
    .analytics-dashboard {
      margin-bottom: 40px;
      padding-bottom: 40px;
      border-bottom: 1px solid var(--border-color);
    }

    /* Live Users Widget */
    .live-users-widget {
      background: linear-gradient(135deg, rgba(0, 200, 83, 0.15), rgba(0, 150, 60, 0.1));
      border: 1px solid rgba(0, 200, 83, 0.3);
      border-radius: 16px;
      padding: 20px 24px;
      margin-bottom: 24px;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }

    .live-users-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .live-users-pulse {
      width: 12px;
      height: 12px;
      background: #00c853;
      border-radius: 50%;
      animation: pulse 2s infinite;
      box-shadow: 0 0 8px rgba(0, 200, 83, 0.6);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(0.9); }
    }

    .live-users-count {
      font-size: 2rem;
      font-weight: 700;
      color: #00c853;
    }

    .live-users-label {
      font-size: 1rem;
      color: var(--text-secondary);
    }

    .live-users-countries {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .live-users-country {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(255, 255, 255, 0.05);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
    }

    .live-users-country-flag {
      font-size: 1.1rem;
    }

    .live-users-country-count {
      font-weight: 600;
      color: #00c853;
    }

    .live-users-loading {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .analytics-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }

    .analytics-card {
      background: linear-gradient(135deg, rgba(157, 78, 221, 0.1), rgba(255, 46, 187, 0.05));
      border: 1px solid rgba(157, 78, 221, 0.2);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      transition: transform 0.2s, border-color 0.2s;
    }

    .analytics-card:hover {
      transform: translateY(-2px);
      border-color: rgba(157, 78, 221, 0.4);
    }

    .analytics-card-icon {
      font-size: 2rem;
      margin-bottom: 12px;
    }

    .analytics-card-value {
      font-size: 2.2rem;
      font-weight: 700;
      background: linear-gradient(135deg, #9d4edd, #ff2ebb);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 4px;
    }

    .analytics-card-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .analytics-charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
      max-width: 900px;
      margin: 0 auto;
    }

    .analytics-chart-container {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 20px;
    }

    .analytics-chart-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 16px;
      text-align: center;
    }

    .analytics-chart-container canvas {
      max-height: 250px;
    }

    /* Analytics Sub-tabs */
    .analytics-subtab {
      padding: 10px 20px;
      background: rgba(157, 78, 221, 0.1);
      border: 1px solid rgba(157, 78, 221, 0.2);
      border-radius: 8px;
      color: var(--text-secondary);
      cursor: pointer;
      font-weight: 500;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .analytics-subtab:hover {
      background: rgba(157, 78, 221, 0.2);
      border-color: rgba(157, 78, 221, 0.4);
    }

    .analytics-subtab.active {
      background: linear-gradient(135deg, #9d4edd, #ff2ebb);
      border-color: transparent;
      color: #fff;
    }

    .analytics-subtab-content {
      display: block;
    }

    .analytics-subtab-content:not(.active) {
      display: none;
    }

    /* Funnel Visualization */
    .funnel-container {
      min-height: 200px;
    }

    .funnel-loading {
      text-align: center;
      color: var(--text-secondary);
      padding: 40px;
    }

    .funnel-step {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }

    .funnel-step-bar {
      height: 36px;
      background: linear-gradient(90deg, #9d4edd, #ff2ebb);
      border-radius: 4px;
      display: flex;
      align-items: center;
      padding: 0 12px;
      transition: width 0.5s ease;
      min-width: 60px;
    }

    .funnel-step-label {
      color: #fff;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    .funnel-step-value {
      margin-left: 12px;
      font-size: 0.85rem;
      color: var(--text-secondary);
      min-width: 80px;
    }

    .funnel-step-value strong {
      color: var(--text-primary);
    }

    .funnel-summary {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
      text-align: center;
    }

    .funnel-summary-rate {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #9d4edd, #ff2ebb);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .funnel-summary-label {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    /* Top Events List */
    .top-events-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .top-event-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .top-event-item:last-child {
      border-bottom: none;
    }

    .top-event-name {
      font-size: 0.85rem;
      color: var(--text-primary);
    }

    .top-event-count {
      font-size: 0.85rem;
      font-weight: 600;
      color: #9d4edd;
      background: rgba(157, 78, 221, 0.1);
      padding: 4px 10px;
      border-radius: 12px;
    }

    /* Session Stats Styles */
    .session-stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 16px;
    }

    @media (max-width: 768px) {
      .session-stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .session-stat-item {
      text-align: center;
      padding: 12px;
      background: rgba(157, 78, 221, 0.05);
      border-radius: 8px;
      border: 1px solid rgba(157, 78, 221, 0.1);
    }

    .session-stat-value {
      font-size: 1.3rem;
      font-weight: 700;
      color: #9d4edd;
    }

    .session-stat-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .duration-bar-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .duration-bar-label {
      width: 60px;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .duration-bar-container {
      flex: 1;
      height: 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      overflow: hidden;
    }

    .duration-bar {
      height: 100%;
      background: linear-gradient(90deg, #9d4edd, #ff2ebb);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .duration-bar-count {
      width: 40px;
      text-align: right;
      font-size: 0.8rem;
      color: var(--text-primary);
      font-weight: 500;
    }

    /* First Generation Metrics Styles */
    .first-gen-metrics-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 16px;
    }

    @media (max-width: 768px) {
      .first-gen-metrics-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .first-gen-metric {
      text-align: center;
      padding: 16px 12px;
      background: rgba(157, 78, 221, 0.05);
      border-radius: 8px;
      border: 1px solid rgba(157, 78, 221, 0.1);
    }

    .first-gen-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #9d4edd;
    }

    .first-gen-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    /* Retention Table Styles */
    .retention-summary-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(157, 78, 221, 0.05);
      border-radius: 8px;
      border: 1px solid rgba(157, 78, 221, 0.1);
    }

    .retention-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .retention-value {
      font-size: 1rem;
      font-weight: 700;
      color: #9d4edd;
    }

    .retention-table-wrapper {
      overflow-x: auto;
    }

    .retention-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .retention-table th {
      text-align: left;
      padding: 12px 8px;
      border-bottom: 2px solid rgba(157, 78, 221, 0.2);
      color: var(--text-secondary);
      font-weight: 500;
    }

    .retention-table td {
      padding: 10px 8px;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    .retention-table tr:hover td {
      background: rgba(157, 78, 221, 0.05);
    }

    .retention-high {
      color: #4ade80;
      font-weight: 600;
    }

    .retention-medium {
      color: #f59e0b;
      font-weight: 600;
    }

    .retention-low {
      color: #ef4444;
      font-weight: 600;
    }

    /* GPU Usage Heatmap Styles */
    .analytics-section-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 32px 0 16px 0;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .analytics-section-title::before,
    .analytics-section-title::after {
      content: '';
      flex: 1;
      max-width: 100px;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(157, 78, 221, 0.3), transparent);
    }

    .analytics-full-width {
      max-width: 900px;
      margin: 24px auto;
    }

    .heatmap-container {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 20px;
      overflow-x: auto;
    }

    .heatmap-grid {
      display: grid;
      grid-template-columns: 50px repeat(24, 1fr);
      gap: 2px;
      min-width: 600px;
    }

    .heatmap-header {
      font-size: 0.65rem;
      color: var(--text-secondary);
      text-align: center;
      padding: 4px 0;
      font-weight: 500;
    }

    .heatmap-day-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 8px;
      font-weight: 500;
    }

    .heatmap-cell {
      aspect-ratio: 1;
      min-height: 20px;
      border-radius: 3px;
      background: rgba(157, 78, 221, 0.1);
      transition: transform 0.1s, box-shadow 0.1s;
      cursor: pointer;
      position: relative;
    }

    .heatmap-cell:hover {
      transform: scale(1.2);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      z-index: 10;
    }

    .heatmap-cell[data-level="0"] { background: rgba(157, 78, 221, 0.05); }
    .heatmap-cell[data-level="1"] { background: rgba(157, 78, 221, 0.2); }
    .heatmap-cell[data-level="2"] { background: rgba(157, 78, 221, 0.4); }
    .heatmap-cell[data-level="3"] { background: rgba(157, 78, 221, 0.6); }
    .heatmap-cell[data-level="4"] { background: rgba(255, 46, 187, 0.7); }
    .heatmap-cell[data-level="5"] { background: rgba(255, 46, 187, 0.9); }

    .heatmap-legend {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 16px;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .heatmap-legend-item {
      width: 16px;
      height: 16px;
      border-radius: 3px;
    }

    .heatmap-tooltip {
      position: fixed;
      background: rgba(0, 0, 0, 0.9);
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      pointer-events: none;
      z-index: 1000;
      display: none;
    }

    /* Admin Panel Sidebar Layout */
    .admin-panel-layout {
      display: flex;
      gap: 0;
      min-height: 600px;
      background: var(--bg-primary);
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid var(--border-color);
    }

    .admin-sidebar {
      width: 220px;
      min-width: 220px;
      background: linear-gradient(180deg, rgba(157, 78, 221, 0.05) 0%, rgba(255, 46, 187, 0.02) 100%);
      border-right: 1px solid var(--border-color);
      padding: 20px 0;
      display: flex;
      flex-direction: column;
    }

    .admin-sidebar-header {
      padding: 0 20px 20px 20px;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 12px;
    }

    .admin-sidebar-title {
      font-size: 1.1rem;
      font-weight: 700;
      background: linear-gradient(135deg, #9d4edd, #ff2ebb);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0;
    }

    .admin-sidebar-nav {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 0 12px;
    }

    .admin-nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-secondary);
      font-size: 0.9rem;
      font-weight: 500;
      border: 1px solid transparent;
    }

    .admin-nav-item:hover {
      background: rgba(157, 78, 221, 0.1);
      color: var(--text-primary);
    }

    .admin-nav-item.active {
      background: linear-gradient(135deg, rgba(157, 78, 221, 0.2), rgba(255, 46, 187, 0.1));
      color: #fff;
      border-color: rgba(157, 78, 221, 0.3);
    }

    .admin-nav-icon {
      font-size: 1.2rem;
      width: 24px;
      text-align: center;
    }

    .admin-nav-badge {
      margin-left: auto;
      background: rgba(255, 165, 0, 0.2);
      color: #ffa500;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .admin-content-area {
      flex: 1;
      padding: 24px 32px;
      overflow-y: auto;
      max-height: calc(100vh - 356px);
    }

    .admin-section {
      display: none;
      animation: fadeIn 0.3s ease-out;
    }

    .admin-section.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .admin-section-header {
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .admin-section-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0 0 8px 0;
    }

    .admin-section-subtitle {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin: 0;
    }

    /* Responsive Admin Panel */
    @media (max-width: 900px) {
      .admin-panel-layout {
        flex-direction: column;
      }

      .admin-sidebar {
        width: 100%;
        min-width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
        padding: 12px 0;
      }

      .admin-sidebar-nav {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 8px;
        padding: 0 12px;
      }

      .admin-nav-item {
        padding: 10px 14px;
        font-size: 0.8rem;
      }

      .admin-nav-icon {
        font-size: 1rem;
      }

      .admin-content-area {
        padding: 16px;
        max-height: none;
      }
    }

    /* Image Moderation Queue Styles */
    .mod-filter-btn {
      padding: 8px 16px;
      background: #252525;
      border: 1px solid #333;
      border-radius: 20px;
      color: #888;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .mod-filter-btn:hover {
      color: #fff;
      border-color: #555;
    }

    .mod-filter-btn.active {
      background: rgba(255, 165, 0, 0.15);
      border-color: #ffa500;
      color: #ffa500;
    }

    .mod-bulk-btn {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .mod-bulk-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .mod-bulk-btn.approve {
      background: rgba(74, 222, 128, 0.15);
      color: #4ade80;
      border: 1px solid rgba(74, 222, 128, 0.3);
    }

    .mod-bulk-btn.approve:not(:disabled):hover {
      background: rgba(74, 222, 128, 0.25);
    }

    .mod-bulk-btn.reject {
      background: rgba(255, 68, 68, 0.15);
      color: #ff4444;
      border: 1px solid rgba(255, 68, 68, 0.3);
    }

    .mod-bulk-btn.reject:not(:disabled):hover {
      background: rgba(255, 68, 68, 0.25);
    }

    .moderation-queue-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .moderation-loading {
      grid-column: 1 / -1;
      text-align: center;
      padding: 40px;
      color: #888;
    }

    .mod-queue-card {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.2s;
    }

    .mod-queue-card:hover {
      border-color: #444;
    }

    .mod-queue-card.selected {
      border-color: #ff2ebb;
      box-shadow: 0 0 0 2px rgba(255, 46, 187, 0.2);
    }

    .mod-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.02);
      border-bottom: 1px solid #2a2a2a;
    }

    .mod-card-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #ff2ebb;
    }

    .mod-card-user {
      flex: 1;
      font-size: 0.85rem;
      color: #888;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .mod-card-date {
      font-size: 0.75rem;
      color: #666;
    }

    .mod-card-image {
      position: relative;
      aspect-ratio: 1;
      background: #111;
      cursor: pointer;
    }

    .mod-card-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .mod-card-flags {
      position: absolute;
      top: 8px;
      left: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .mod-flag-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .mod-flag-badge.celebrity {
      background: rgba(255, 165, 0, 0.9);
      color: #000;
    }

    .mod-flag-badge.minor {
      background: rgba(255, 68, 68, 0.9);
      color: #fff;
    }

    .mod-card-appeal {
      padding: 12px;
      background: rgba(255, 46, 187, 0.05);
      border-top: 1px solid rgba(255, 46, 187, 0.2);
    }

    .mod-card-appeal-label {
      font-size: 0.75rem;
      color: #ff2ebb;
      margin-bottom: 6px;
      font-weight: 600;
    }

    .mod-card-appeal-text {
      font-size: 0.85rem;
      color: #ccc;
      line-height: 1.4;
      max-height: 60px;
      overflow-y: auto;
    }

    .mod-card-body {
      padding: 12px;
    }

    .mod-card-reasons {
      font-size: 0.8rem;
      color: #888;
      margin-bottom: 12px;
    }

    .mod-card-reasons ul {
      margin: 4px 0 0 16px;
      padding: 0;
    }

    .mod-card-reasons li {
      margin-bottom: 2px;
    }

    .mod-card-actions {
      display: flex;
      gap: 8px;
    }

    .mod-action-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .mod-action-btn.approve {
      background: #4ade80;
      color: #000;
    }

    .mod-action-btn.approve:hover {
      background: #22c55e;
    }

    .mod-action-btn.reject {
      background: #ff4444;
      color: #fff;
    }

    .mod-action-btn.reject:hover {
      background: #dc2626;
    }

    .mod-page-btn {
      padding: 8px 16px;
      background: #252525;
      border: 1px solid #333;
      border-radius: 6px;
      color: #888;
      cursor: pointer;
      transition: all 0.2s;
    }

    .mod-page-btn:hover:not(:disabled) {
      color: #fff;
      border-color: #555;
    }

    .mod-page-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .mod-page-info {
      padding: 8px 16px;
      color: #888;
      font-size: 0.9rem;
    }

    .policy-admin-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      cursor: pointer;
      transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s, background 0.3s;
    }

    .policy-admin-card:hover {
      transform: translateY(-4px);
      border-color: var(--accent-secondary);
      box-shadow: 0 8px 24px rgba(0, 178, 255, 0.2);
    }

    .policy-admin-card-icon {
      font-size: 2.5rem;
      margin-bottom: 16px;
    }

    .policy-admin-card-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .policy-admin-card-desc {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .policy-admin-card-meta {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .policy-admin-card-btn {
      margin-top: 16px;
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      background: var(--accent-gradient);
      color: #fff;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .policy-admin-card-btn:hover {
      opacity: 0.9;
    }

    /* Admin Panel Styles */
    .admin-resources-btn {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 14px 24px;
      border-radius: 30px;
      border: none;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(255, 46, 187, 0.4);
      z-index: 1000;
      display: none;
      align-items: center;
      gap: 8px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .admin-resources-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 28px rgba(255, 46, 187, 0.5);
    }

    .admin-resources-btn.visible {
      display: flex;
    }

    /* Admin Preview Toggle */
    .admin-preview-toggle {
      position: fixed;
      bottom: 24px;
      right: 200px;
      padding: 12px 18px;
      border-radius: 30px;
      border: 2px solid #ff9800;
      background: rgba(255, 152, 0, 0.1);
      color: #ff9800;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      z-index: 1000;
      display: none;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .admin-preview-toggle:hover {
      background: rgba(255, 152, 0, 0.2);
      transform: scale(1.02);
    }

    /* GPU Status Grid */
    .gpu-status-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 24px;
    }

    .gpu-status-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 16px;
    }

    .gpu-status-label {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 8px;
    }

    .gpu-status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .gpu-status-indicator .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #666;
    }

    .gpu-status-indicator .status-dot.online {
      background: #4caf50;
      box-shadow: 0 0 8px rgba(76, 175, 80, 0.5);
    }

    .gpu-status-indicator .status-dot.offline {
      background: #f44336;
      box-shadow: 0 0 8px rgba(244, 67, 54, 0.5);
    }

    .gpu-status-indicator .status-dot.checking {
      background: #ff9800;
      animation: pulse 1s ease-in-out infinite;
    }

    .gpu-status-indicator .status-text {
      font-size: 0.9rem;
      color: #fff;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .admin-preview-toggle.active {
      background: #ff9800;
      color: #000;
    }

    .admin-preview-toggle.visible {
      display: flex;
    }

    .preview-indicator {
      position: fixed;
      top: 80px;
      right: 20px;
      padding: 8px 16px;
      background: #ff9800;
      color: #000;
      font-size: 0.85rem;
      font-weight: 600;
      border-radius: 6px;
      z-index: 1001;
      display: none;
      animation: pulse 2s infinite;
    }

    .preview-indicator.visible {
      display: block;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Resource Form Modal */
    .resource-form-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      z-index: 10001;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .resource-form-modal.active {
      display: flex;
    }

    .resource-form-content {
      background: #1a1a1a;
      border-radius: 16px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    .resource-form-header {
      padding: 20px 24px;
      border-bottom: 1px solid #2a2a2a;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      background: #1a1a1a;
      z-index: 10;
    }

    .resource-form-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #fff;
    }

    .resource-form-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: #2a2a2a;
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    .resource-form-close:hover {
      background: #3a3a3a;
    }

    .resource-form-body {
      padding: 24px;
    }

    .resource-form-group {
      margin-bottom: 20px;
    }

    .resource-form-label {
      display: block;
      color: #aaa;
      font-size: 0.85rem;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .resource-form-input,
    .resource-form-select,
    .resource-form-textarea {
      width: 100%;
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #0a0a0a;
      color: #fff;
      font-size: 0.95rem;
      transition: border-color 0.2s;
    }

    .resource-form-input:focus,
    .resource-form-select:focus,
    .resource-form-textarea:focus {
      outline: none;
      border-color: #ff2ebb;
    }

    .resource-form-textarea {
      min-height: 150px;
      resize: vertical;
      font-family: monospace;
    }

    .resource-form-section {
      margin-top: 24px;
      padding: 16px;
      background: #1a1a1a;
      border-radius: 8px;
      border: 1px solid #2a2a2a;
    }

    .resource-form-section-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #00e676;
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .resource-form-label input[type="checkbox"] {
      margin-right: 8px;
      accent-color: #00e676;
    }

    .tier-checkboxes {
      display: flex;
      gap: 16px;
      margin-top: 8px;
    }

    .tier-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid #3a3a3a;
      background: #1a1a1a;
      transition: all 0.2s;
    }

    .tier-checkbox:hover {
      border-color: #4a4a4a;
      background: #252525;
    }

    .tier-checkbox:has(input:checked) {
      border-color: #00e676;
      background: rgba(0, 230, 118, 0.1);
    }

    .tier-checkbox input[type="checkbox"] {
      accent-color: #00e676;
      width: 18px;
      height: 18px;
    }

    .tier-checkbox-label {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .tier-checkbox-label.supernova {
      color: #00b2ff;
    }

    .tier-checkbox-label.mentorship {
      color: #ff2ebb;
    }

    .resource-form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .resource-form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      padding-top: 20px;
      border-top: 1px solid #2a2a2a;
      margin-top: 20px;
    }

    .resource-form-btn {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .resource-form-btn.cancel {
      background: #2a2a2a;
      color: #fff;
    }

    .resource-form-btn.cancel:hover {
      background: #3a3a3a;
    }

    .resource-form-btn.save {
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      color: #fff;
    }

    .resource-form-btn.save:hover {
      opacity: 0.9;
    }

    .resource-form-btn.delete {
      background: #dc3545;
      color: #fff;
      margin-right: auto;
    }

    .resource-form-btn.delete:hover {
      background: #c82333;
    }

    .resource-form-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Admin edit button on cards */
    .resource-card-edit {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: rgba(0,0,0,0.8);
      color: #fff;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      z-index: 5;
      transition: background 0.2s;
    }

    .resource-card-edit:hover {
      background: #ff2ebb;
    }

    .resource-card-edit.visible {
      display: flex;
    }

    /* Thumbnail Upload Styles */
    .resource-thumbnail-upload {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .resource-thumbnail-preview {
      width: 100%;
      height: 150px;
      background: #0a0a0a;
      border: 2px dashed #333;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .resource-thumbnail-preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .resource-thumbnail-placeholder {
      color: #555;
      font-size: 1rem;
    }

    .resource-thumbnail-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .resource-thumbnail-actions .resource-form-input {
      min-width: 0;
    }

    .resource-thumbnail-loading {
      color: #ff2ebb;
      font-size: 0.9rem;
    }

    /* Chat Interface */
    .education-chat {
      display: flex;
      height: 100%;
      background: #0a0a0a;
      padding-bottom: 50px; /* Account for fixed footer */
    }

    .channel-sidebar {
      width: 260px;
      min-width: 260px;
      height: 100%;
      background: #111;
      border-right: 1px solid #2a2a2a;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .channel-header {
      padding: 16px;
      border-bottom: 1px solid #2a2a2a;
    }

    .channel-tier-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: linear-gradient(135deg, rgba(255, 46, 187, 0.2), rgba(0, 178, 255, 0.2));
      border: 1px solid rgba(255, 46, 187, 0.3);
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      color: #fff;
    }

    .channel-section {
      padding: 16px;
      flex-shrink: 0;
    }

    .channel-section:first-of-type {
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }

    .channel-section-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .channel-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .channel-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 6px;
      cursor: pointer;
      color: #888;
      font-size: 0.9rem;
      transition: background 0.2s, color 0.2s;
    }

    .channel-item:hover {
      background: #1a1a1a;
      color: #fff;
    }

    .channel-item.active {
      background: linear-gradient(135deg, rgba(255, 46, 187, 0.15), rgba(0, 178, 255, 0.15));
      color: #fff;
    }

    .channel-item-icon {
      font-size: 1rem;
    }

    .channel-online {
      padding: 16px;
      margin-top: auto;
      border-top: 1px solid #2a2a2a;
    }

    .online-users-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .online-user {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: #888;
    }

    .online-user-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #2a2a2a;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
    }

    .online-user-dot {
      width: 8px;
      height: 8px;
      background: #22c55e;
      border-radius: 50%;
      margin-left: auto;
    }

    /* Chat Area */
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      background: var(--bg-primary);
      transition: background 0.3s;
    }

    .chat-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-secondary);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.3s, border-color 0.3s;
    }

    .chat-header-info {
      flex: 1;
    }

    .chat-rules-btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .chat-rules-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
      border-color: var(--border-light);
    }

    .chat-header-actions {
      display: flex;
      gap: 8px;
    }

    .chat-call-btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #fff;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .chat-call-btn:hover {
      opacity: 0.9;
      transform: scale(1.02);
    }

    .admin-members-toggle {
      display: block;
      width: 100%;
      margin-top: 12px;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid rgba(234, 179, 8, 0.3);
      background: rgba(234, 179, 8, 0.1);
      color: #eab308;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .admin-members-toggle:hover {
      background: rgba(234, 179, 8, 0.2);
    }

    /* Members Panel (Admin) */
    .members-panel {
      width: 280px;
      background: #111;
      border-left: 1px solid #2a2a2a;
      display: flex;
      flex-direction: column;
    }

    .members-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid #2a2a2a;
    }

    .members-panel-header h3 {
      margin: 0;
      font-size: 1rem;
      color: #fff;
    }

    .members-panel-close {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: none;
      background: #2a2a2a;
      color: #888;
      cursor: pointer;
      transition: all 0.2s;
    }

    .members-panel-close:hover {
      background: #ff4444;
      color: #fff;
    }

    .members-panel-stats {
      display: flex;
      gap: 8px;
      padding: 16px;
      border-bottom: 1px solid #2a2a2a;
    }

    .member-stat {
      flex: 1;
      text-align: center;
      padding: 8px;
      background: #0a0a0a;
      border-radius: 6px;
    }

    .stat-value {
      display: block;
      font-size: 1.2rem;
      font-weight: 700;
      color: #fff;
    }

    .stat-label {
      font-size: 0.7rem;
      color: #666;
      text-transform: uppercase;
    }

    .members-list {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }

    .member-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 6px;
      background: #0a0a0a;
      transition: background 0.2s;
    }

    .member-item:hover {
      background: #1a1a1a;
    }

    .member-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      flex-shrink: 0;
      position: relative;
    }

    .member-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .member-online-dot {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 10px;
      height: 10px;
      background: #22c55e;
      border: 2px solid #111;
      border-radius: 50%;
    }

    .member-info {
      flex: 1;
      min-width: 0;
    }

    .member-name {
      font-size: 0.9rem;
      font-weight: 500;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .member-tier {
      font-size: 0.75rem;
      color: #888;
    }

    .member-tier.supernova {
      color: #eab308;
    }

    .member-tier.mentorship {
      color: #ff2ebb;
    }

    .member-tier.admin {
      color: #f97316;
    }

    /* Admin Channel Management Button */
    .admin-channels-toggle {
      display: block;
      width: 100%;
      margin-top: 8px;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid rgba(0, 178, 255, 0.3);
      background: rgba(0, 178, 255, 0.1);
      color: #00b2ff;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .admin-channels-toggle:hover {
      background: rgba(0, 178, 255, 0.2);
    }

    /* Channel Management Modal */
    .channel-manage-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .channel-manage-content {
      background: #1a1a1a;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      border: 1px solid #2a2a2a;
    }

    .channel-manage-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #2a2a2a;
    }

    .channel-manage-header h3 {
      margin: 0;
      font-size: 1.2rem;
      color: #fff;
    }

    .channel-manage-close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: #2a2a2a;
      color: #888;
      cursor: pointer;
      font-size: 1.1rem;
      transition: all 0.2s;
    }

    .channel-manage-close:hover {
      background: #ff4444;
      color: #fff;
    }

    .channel-manage-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .channel-add-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid #2a2a2a;
    }

    .channel-add-form input,
    .channel-add-form select {
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #0a0a0a;
      color: #fff;
      font-size: 0.95rem;
    }

    .channel-add-form input::placeholder {
      color: #666;
    }

    .channel-add-form input:focus,
    .channel-add-form select:focus {
      outline: none;
      border-color: #00b2ff;
    }

    .channel-add-row {
      display: flex;
      gap: 12px;
    }

    .channel-add-row select {
      flex: 1;
    }

    .channel-add-btn {
      padding: 12px 20px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(135deg, #00b2ff, #0088cc);
      color: #fff;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .channel-add-btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .channel-list-manage {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .channel-list-manage-title {
      font-size: 0.85rem;
      color: #888;
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .channel-manage-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: #0a0a0a;
      border-radius: 8px;
      border: 1px solid #2a2a2a;
    }

    .channel-manage-item-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .channel-manage-item-icon {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      background: #2a2a2a;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    .channel-manage-item-details {
      display: flex;
      flex-direction: column;
    }

    .channel-manage-item-name {
      font-size: 0.95rem;
      font-weight: 500;
      color: #fff;
    }

    .channel-manage-item-tier {
      font-size: 0.8rem;
      color: #666;
    }

    .channel-manage-item-tier.supernova {
      color: #eab308;
    }

    .channel-manage-item-tier.mentorship {
      color: #ff2ebb;
    }

    .channel-delete-btn {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: none;
      background: rgba(255, 68, 68, 0.1);
      color: #ff4444;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s;
    }

    .channel-delete-btn:hover {
      background: #ff4444;
      color: #fff;
    }

    .channel-manage-empty {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }

    .chat-channel-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: #fff;
    }

    .chat-channel-desc {
      font-size: 0.85rem;
      color: #666;
      margin-top: 4px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .chat-welcome {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      color: #666;
    }

    .chat-welcome-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .chat-welcome-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #fff;
      margin-bottom: 8px;
    }

    .chat-welcome-text {
      font-size: 0.9rem;
    }

    .chat-message {
      display: flex;
      gap: 12px;
    }

    .chat-message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      flex-shrink: 0;
    }

    .chat-message-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .chat-message-content {
      flex: 1;
      min-width: 0;
    }

    .chat-message-header {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 4px;
    }

    .chat-message-name {
      font-weight: 600;
      color: #fff;
      font-size: 0.95rem;
    }

    .chat-message-time {
      font-size: 0.75rem;
      color: #555;
    }

    .message-delete-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 0.75rem;
      opacity: 0;
      transition: opacity 0.2s;
      padding: 2px 6px;
      margin-left: auto;
    }

    .message-delete-btn:hover {
      opacity: 1 !important;
      background: rgba(255, 50, 50, 0.2);
      border-radius: 4px;
    }

    .chat-message:hover .message-delete-btn {
      opacity: 0.5;
    }

    .message-report-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 0.7rem;
      padding: 2px 4px;
      margin-left: 6px;
      border-radius: 3px;
      color: #666;
      opacity: 0;
      transition: opacity 0.2s, color 0.2s;
    }

    .chat-message:hover .message-report-btn {
      opacity: 0.6;
    }

    .message-report-btn:hover {
      opacity: 1 !important;
      color: #ffa500;
    }

    /* Report button for generated content */
    .report-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      color: #888;
      transition: all 0.2s;
    }

    .report-btn:hover {
      background: rgba(255, 165, 0, 0.2);
      color: #ffa500;
    }

    /* Report Modal */
    .report-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }

    .report-modal.active {
      display: flex;
    }

    .report-modal-content {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 24px;
      width: 90%;
      max-width: 450px;
    }

    .report-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .report-modal-title {
      color: #fff;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .report-modal-close {
      background: transparent;
      border: none;
      color: #888;
      font-size: 1.5rem;
      cursor: pointer;
    }

    .report-modal-close:hover {
      color: #fff;
    }

    .report-form-group {
      margin-bottom: 16px;
    }

    .report-form-label {
      display: block;
      color: #aaa;
      font-size: 0.9rem;
      margin-bottom: 8px;
    }

    .report-form-select {
      width: 100%;
      padding: 12px;
      background: #252525;
      border: 1px solid #333;
      border-radius: 8px;
      color: #fff;
      font-size: 1rem;
    }

    .report-form-select:focus {
      outline: none;
      border-color: #ff2ebb;
    }

    .report-form-textarea {
      width: 100%;
      padding: 12px;
      background: #252525;
      border: 1px solid #333;
      border-radius: 8px;
      color: #fff;
      font-size: 0.9rem;
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
    }

    .report-form-textarea:focus {
      outline: none;
      border-color: #ff2ebb;
    }

    .report-form-checkbox {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #aaa;
      font-size: 0.9rem;
    }

    .report-form-checkbox input {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .report-form-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .report-btn-cancel {
      flex: 1;
      padding: 12px;
      background: #333;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
    }

    .report-btn-cancel:hover {
      background: #444;
    }

    .report-btn-submit {
      flex: 1;
      padding: 12px;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
    }

    .report-btn-submit:hover {
      opacity: 0.9;
    }

    .report-btn-submit:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .chat-message {
      transition: opacity 0.2s, transform 0.2s;
    }

    .chat-message-text {
      color: #ccc;
      font-size: 0.9rem;
      line-height: 1.5;
      word-break: break-word;
    }

    /* Message Reactions */
    .message-reactions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .reaction-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border: 1px solid #333;
      border-radius: 12px;
      font-size: 14px;
      cursor: pointer;
      background: #1a1a1a;
      transition: all 0.2s;
    }

    .reaction-pill:hover {
      background: #2a2a2a;
      border-color: #444;
    }

    .reaction-pill.active {
      background: rgba(255, 46, 187, 0.2);
      border-color: #ff2ebb;
    }

    .reaction-pill .reaction-count {
      font-size: 12px;
      color: #888;
    }

    .reaction-pill.active .reaction-count {
      color: #ff2ebb;
    }

    .add-reaction-btn {
      opacity: 0;
      padding: 2px 8px;
      border: 1px dashed #333;
      border-radius: 12px;
      background: transparent;
      color: #666;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .chat-message:hover .add-reaction-btn {
      opacity: 1;
    }

    .add-reaction-btn:hover {
      background: #1a1a1a;
      border-color: #444;
      color: #888;
    }

    .emoji-picker-popup {
      position: absolute;
      bottom: 100%;
      left: 0;
      display: flex;
      gap: 4px;
      padding: 8px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 100;
      margin-bottom: 8px;
    }

    .emoji-picker-popup button {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      background: transparent;
      font-size: 18px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .emoji-picker-popup button:hover {
      background: #2a2a2a;
    }

    /* @Mentions */
    .mention {
      background: rgba(255, 46, 187, 0.2);
      color: #ff2ebb;
      padding: 0 4px;
      border-radius: 4px;
      font-weight: 500;
    }

    .mention.mention-me {
      background: rgba(255, 46, 187, 0.35);
    }

    .chat-message.mentioned {
      background: rgba(255, 46, 187, 0.08);
      border-left: 3px solid #ff2ebb;
      margin-left: -3px;
    }

    .mention-autocomplete {
      position: absolute;
      bottom: 100%;
      left: 16px;
      right: 16px;
      max-height: 200px;
      overflow-y: auto;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 100;
      margin-bottom: 8px;
      display: none;
    }

    .mention-autocomplete.active {
      display: block;
    }

    .mention-autocomplete-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .mention-autocomplete-item:hover,
    .mention-autocomplete-item.selected {
      background: #2a2a2a;
    }

    .mention-autocomplete-item:first-child {
      border-radius: 8px 8px 0 0;
    }

    .mention-autocomplete-item:last-child {
      border-radius: 0 0 8px 8px;
    }

    .mention-autocomplete-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      color: #fff;
    }

    .mention-autocomplete-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .mention-autocomplete-name {
      color: #fff;
      font-size: 14px;
    }

    /* Inpaint Tab Styles */
    .inpaint-container {
      display: flex;
      height: calc(100vh - 136px);
      gap: 0;
    }

    .inpaint-canvas-area {
      flex: 0 0 400px;
      display: flex;
      flex-direction: column;
      padding: 24px;
      overflow: hidden;
    }

    .inpaint-header {
      margin-bottom: 20px;
    }

    .inpaint-header h2 {
      margin: 0;
      font-size: 1.5rem;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .inpaint-subtitle {
      margin: 8px 0 0 0;
      color: #888;
      font-size: 0.9rem;
    }

    .inpaint-canvas-wrapper {
      flex: 1;
      position: relative;
      background: #0a0a0a;
      border: 1px solid #2a2a2a;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      min-height: 400px;
    }

    .inpaint-upload-placeholder {
      text-align: center;
      cursor: pointer;
      padding: 60px;
      transition: all 0.2s;
      border: 2px dashed transparent;
      border-radius: 8px;
    }

    .inpaint-upload-placeholder:hover {
      background: rgba(255, 46, 187, 0.05);
    }

    .inpaint-upload-icon {
      font-size: 4rem;
      margin-bottom: 16px;
    }

    .inpaint-upload-text {
      color: #fff;
      font-size: 1.1rem;
      margin-bottom: 8px;
    }

    .inpaint-upload-hint {
      color: #666;
      font-size: 0.85rem;
    }

    #inpaintCanvas, #inpaintMaskCanvas {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 100%;
      max-height: 100%;
      cursor: crosshair;
    }

    #inpaintMaskCanvas {
      pointer-events: none;
      opacity: 0.6;
    }

    .inpaint-sidebar {
      flex: 0 0 320px;
      background: #111;
      border-left: 1px solid #2a2a2a;
      padding: 24px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .inpaint-control-section {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .inpaint-control-label {
      color: #888;
      font-size: 0.85rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .inpaint-brush-size-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .inpaint-brush-size-container input[type="range"] {
      flex: 1;
      -webkit-appearance: none;
      background: #2a2a2a;
      height: 6px;
      border-radius: 3px;
      outline: none;
    }

    .inpaint-brush-size-container input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      cursor: pointer;
    }

    .inpaint-brush-size-value {
      color: #fff;
      font-size: 0.85rem;
      min-width: 40px;
    }

    .inpaint-brush-preview {
      width: 110px;
      height: 110px;
      border: 1px solid #333;
      border-radius: 8px;
      background: #0a0a0a;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      overflow: hidden;
    }

    .inpaint-intensity-slider {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 8px;
    }

    .inpaint-intensity-slider input[type="range"] {
      flex: 1;
      height: 6px;
      -webkit-appearance: none;
      background: linear-gradient(to right, #444, #ff2ebb);
      border-radius: 3px;
      cursor: pointer;
    }

    .inpaint-intensity-slider input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #ff2ebb;
      cursor: pointer;
    }

    .inpaint-intensity-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: #888;
      margin-top: 4px;
    }

    .inpaint-button-row {
      display: flex;
      gap: 10px;
    }

    .inpaint-btn {
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .inpaint-btn.secondary {
      flex: 1;
      background: #1a1a1a;
      border: 1px solid #333;
      color: #ccc;
    }

    .inpaint-btn.secondary:hover {
      background: #2a2a2a;
      color: #fff;
    }

    .inpaint-btn.primary {
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      color: #fff;
    }

    .inpaint-btn.primary:hover {
      opacity: 0.9;
    }

    .inpaint-divider {
      height: 1px;
      background: #2a2a2a;
      margin: 4px 0;
    }

    .inpaint-textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #2a2a2a;
      background: #0a0a0a;
      color: #fff;
      font-size: 0.9rem;
      resize: vertical;
      font-family: inherit;
    }

    .inpaint-textarea:focus {
      outline: none;
      border-color: #ff2ebb;
    }

    .inpaint-select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #2a2a2a;
      background: #0a0a0a;
      color: #fff;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .inpaint-select:focus {
      outline: none;
      border-color: #ff2ebb;
    }

    .inpaint-mode-toggle {
      display: flex;
      gap: 8px;
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      padding: 4px;
    }

    .inpaint-mode-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 6px;
      background: transparent;
      color: #888;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .inpaint-mode-btn:hover {
      color: #fff;
    }

    .inpaint-mode-btn.active {
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      color: #fff;
    }

    .inpaint-generate-btn {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.2s;
      margin-top: auto;
    }

    .inpaint-generate-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(255, 46, 187, 0.3);
    }

    .inpaint-generate-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .inpaint-generate-icon {
      font-size: 1.2rem;
    }

    .inpaint-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 16px;
      color: #888;
      flex-direction: column;
    }

    .inpaint-loading-status {
      font-size: 0.85rem;
      color: #666;
    }

    .inpaint-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #333;
      border-top-color: #ff2ebb;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Loading spinner for infinite scroll */
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #333;
      border-top-color: #ff2ebb;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      vertical-align: middle;
      margin-right: 8px;
    }

    .load-more-sentinel {
      grid-column: 1 / -1;
      text-align: center;
      padding: 20px;
      color: #666;
      font-size: 0.9rem;
    }

    /* Inpaint Results - Right Panel (matches Image tab) */
    .inpaint-result-section {
      flex: 1;
      background: var(--bg-primary);
      overflow-y: auto;
      overflow-x: hidden;
      padding: 20px;
      transition: background 0.3s;
      min-width: 300px;
    }

    .inpaint-result-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .inpaint-result-header h3 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .inpaint-results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(var(--grid-item-size, 200px), 1fr));
      gap: 16px;
    }

    .inpaint-result-placeholder {
      grid-column: 1 / -1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 80px 20px;
      text-align: center;
      color: #555;
    }

    .inpaint-result-placeholder-icon {
      font-size: 4rem;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .inpaint-result-placeholder-text {
      font-size: 0.95rem;
      line-height: 1.5;
    }

    /* Inpaint output items inherit from .output-item styles */
    .inpaint-results-grid .output-item:hover .output-item-overlay {
      opacity: 1;
    }

    .chat-typing {
      padding: 8px 20px;
      font-size: 0.85rem;
      color: #888;
      font-style: italic;
    }

    .chat-input-area {
      display: flex;
      gap: 12px;
      padding: 16px 20px;
      background: #111;
      border-top: 1px solid #2a2a2a;
    }

    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid #2a2a2a;
      background: #0a0a0a;
      color: #fff;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.2s;
    }

    .chat-input:focus {
      border-color: #ff2ebb;
    }

    .chat-send-btn {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      color: #fff;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .chat-send-btn:hover {
      opacity: 0.9;
    }

    .chat-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Media buttons (image upload, GIF) */
    .chat-media-btn {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #2a2a2a;
      background: #1a1a1a;
      color: #888;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .chat-media-btn:hover {
      background: #2a2a2a;
      color: #fff;
      border-color: #3a3a3a;
    }

    /* Mobile Chat Back Button */
    .chat-back-btn {
      display: none;
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 1.2rem;
      cursor: pointer;
      margin-right: 12px;
    }

    .chat-back-btn:hover {
      color: var(--text-primary);
    }

    /* ========== MOBILE COMMUNITY OVERLAY ========== */
    .mobile-community-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10000;
      background: #111;
      flex-direction: column;
    }

    .mobile-community-overlay.active {
      display: flex;
    }

    .mobile-community-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: #1a1a1a;
      border-bottom: 1px solid #2a2a2a;
      flex-shrink: 0;
    }

    .mobile-community-close {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      background: #2a2a2a;
      color: #fff;
      font-size: 0.9rem;
      cursor: pointer;
      min-height: 44px;
    }

    .mobile-community-close:active {
      background: #3a3a3a;
    }

    .mobile-community-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #fff;
    }

    .mobile-community-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    /* When community chat is inside the overlay */
    .mobile-community-content .education-chat {
      flex: 1;
      display: flex;
      position: relative;
      overflow: hidden;
      height: 100%;
      padding-bottom: 0;
    }

    .mobile-community-content .channel-sidebar {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10;
      transform: translateX(0);
      transition: transform 0.3s ease;
      overflow-y: auto;
      background: #111;
      -webkit-overflow-scrolling: touch;
    }

    .mobile-community-content .chat-area {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 5;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    /* Slide animations for overlay */
    .mobile-community-content .education-chat.mobile-chat-active .channel-sidebar {
      transform: translateX(-100%);
    }

    .mobile-community-content .education-chat.mobile-chat-active .chat-area {
      transform: translateX(0);
    }

    /* Chat area layout inside overlay */
    .mobile-community-content .chat-messages {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .mobile-community-content .chat-input-area {
      flex-shrink: 0;
      padding: 12px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom, 0));
      box-sizing: border-box;
      width: 100%;
      gap: 8px;
    }

    .mobile-community-content .chat-send-btn {
      padding: 12px 16px;
      flex-shrink: 0;
    }

    .mobile-community-content .chat-media-btn {
      padding: 8px;
      min-width: 40px;
      flex-shrink: 0;
    }

    .mobile-community-content .chat-input {
      min-width: 0;
      flex: 1;
    }

    .mobile-community-content .chat-back-btn {
      display: block;
    }

    /* Hide Tidio chat widget when mobile community overlay is active */
    body.mobile-community-active #tidio-chat,
    body.mobile-community-active #tidio-chat-iframe,
    body.mobile-community-active [id^="tidio"],
    body.mobile-community-active iframe[src*="tidio"],
    body.mobile-community-active iframe[title*="chat"] {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }

    /* Hide desktop chat back button by default */
    .chat-back-btn {
      display: none;
    }

    /* ========== END MOBILE COMMUNITY OVERLAY ========== */

    /* Mobile improvements (non-community specific) */
    @media (max-width: 768px) {
      /* Members panel - full screen overlay on mobile */
      .members-panel {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        height: 100dvh;
        z-index: 1000;
        border-left: none;
        background: #111;
      }

      .members-panel-close {
        width: 44px;
        height: 44px;
      }

      /* Giphy modal - responsive grid */
      .giphy-results {
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
        padding: 0 16px 16px;
      }

      .giphy-modal-content {
        width: 95%;
        max-height: 85vh;
        max-height: 85dvh;
      }

      .giphy-modal-close {
        min-width: 44px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    }

    /* Very small screens - single column Giphy */
    @media (max-width: 480px) {
      .giphy-results {
        grid-template-columns: 1fr;
      }

      .chat-call-btn,
      .chat-rules-btn {
        padding: 8px 10px;
        font-size: 0.8rem;
      }

      .chat-header-actions {
        flex-wrap: wrap;
        justify-content: flex-end;
      }
    }

    /* Giphy Modal */
    .giphy-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .giphy-modal-content {
      background: #1a1a1a;
      border-radius: 16px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .giphy-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid #2a2a2a;
    }

    .giphy-modal-header h3 {
      margin: 0;
      color: #fff;
      font-size: 1.1rem;
    }

    .giphy-modal-close {
      background: transparent;
      border: none;
      color: #888;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 4px 8px;
    }

    .giphy-modal-close:hover {
      color: #fff;
    }

    .giphy-search-area {
      padding: 16px 20px;
    }

    .giphy-search-input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid #2a2a2a;
      background: #0a0a0a;
      color: #fff;
      font-size: 0.9rem;
      outline: none;
      box-sizing: border-box;
    }

    .giphy-search-input:focus {
      border-color: #ff2ebb;
    }

    .giphy-results {
      flex: 1;
      overflow-y: auto;
      padding: 0 20px 20px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      align-content: start;
    }

    .giphy-trending-label {
      grid-column: 1 / -1;
      color: #888;
      font-size: 0.85rem;
      padding: 8px 0;
    }

    .giphy-item {
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .giphy-item:hover {
      transform: scale(1.05);
    }

    .giphy-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .giphy-attribution {
      padding: 12px 20px;
      text-align: center;
      color: #555;
      font-size: 0.75rem;
      border-top: 1px solid #2a2a2a;
    }

    .giphy-loading {
      grid-column: 1 / -1;
      text-align: center;
      color: #888;
      padding: 20px;
    }

    /* Embedded images in messages */
    .chat-message-image {
      max-width: 300px;
      max-height: 300px;
      border-radius: 8px;
      margin-top: 8px;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .chat-message-image:hover {
      opacity: 0.9;
    }

    /* Image upload progress */
    .upload-progress {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #2a2a2a;
      border-radius: 8px;
      color: #888;
      font-size: 0.85rem;
    }

    .upload-progress-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #333;
      border-top-color: #ff2ebb;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Rules Modal */
    .rules-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .rules-modal.active {
      display: flex;
    }

    .rules-modal-content {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 16px;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }

    .rules-modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: #2a2a2a;
      color: #888;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .rules-modal-close:hover {
      background: #ff4444;
      color: #fff;
    }

    .rules-modal-header {
      text-align: center;
      padding: 32px 32px 24px;
      border-bottom: 1px solid #2a2a2a;
    }

    .rules-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }

    .rules-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0 0 8px;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .rules-subtitle {
      color: #888;
      font-size: 0.9rem;
      margin: 0;
    }

    .rules-list {
      padding: 24px;
    }

    .rule-item {
      display: flex;
      gap: 12px;
      padding: 14px;
      background: #0f0f0f;
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .rule-item.rule-highlight {
      background: linear-gradient(135deg, rgba(255, 46, 187, 0.1), rgba(0, 178, 255, 0.1));
      border-color: rgba(255, 46, 187, 0.3);
    }

    .rule-item.rule-critical {
      background: rgba(255, 68, 68, 0.1);
      border-color: rgba(255, 68, 68, 0.3);
    }

    .rule-item.rule-contact {
      background: linear-gradient(135deg, rgba(0, 178, 255, 0.1), rgba(34, 197, 94, 0.1));
      border-color: rgba(0, 178, 255, 0.3);
    }

    .rule-number {
      font-size: 1.2rem;
      flex-shrink: 0;
      width: 32px;
      text-align: center;
    }

    .rule-text {
      color: #ccc;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .rule-text strong {
      color: #fff;
    }

    .rule-text a {
      color: #00b2ff;
      text-decoration: none;
    }

    .rule-text a:hover {
      text-decoration: underline;
    }

    .rules-accept-btn {
      display: block;
      width: calc(100% - 48px);
      margin: 0 24px 24px;
      padding: 14px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .rules-accept-btn:hover {
      opacity: 0.9;
    }

    /* Site Footer */
    .site-footer {
      position: fixed;
      bottom: 0;
      left: 90px; /* Offset for sidebar */
      right: 0;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
      padding: 12px 32px;
      z-index: 100;
      transition: background 0.3s, border-color 0.3s;
    }

    .footer-brand {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .footer-logo {
      font-size: 1.2rem;
      font-weight: 700;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .footer-tagline {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .footer-links {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
    }

    .footer-links a {
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 0.9rem;
      transition: color 0.2s;
    }

    .footer-links a:hover {
      color: var(--text-primary);
    }

    .footer-copyright {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .footer-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .footer-ai-disclosure {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.75rem;
      color: #888;
      background: rgba(0, 178, 255, 0.1);
      padding: 6px 16px;
      border-radius: 20px;
      border: 1px solid rgba(0, 178, 255, 0.2);
    }

    .ai-badge {
      background: linear-gradient(135deg, #00b2ff, #00d4aa);
      color: #000;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
    }

    .footer-main {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 32px;
    }

    /* Policy Modal */
    .policy-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--overlay);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .policy-modal.active {
      display: flex;
    }

    .policy-modal-content {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      max-width: 800px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      position: relative;
      transition: background 0.3s, border-color 0.3s;
    }

    .policy-modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--bg-hover);
      color: var(--text-secondary);
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
      z-index: 10;
    }

    .policy-modal-close:hover {
      background: var(--error);
      color: #fff;
    }

    .policy-modal-body {
      padding: 32px;
      color: var(--text-secondary);
      line-height: 1.7;
      transition: color 0.3s;
    }

    .policy-modal-body h2 {
      color: var(--text-primary);
      font-size: 1.5rem;
      margin: 0 0 16px;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .policy-modal-body h3 {
      color: var(--text-primary);
      font-size: 1.1rem;
      margin: 24px 0 12px;
    }

    .policy-modal-body p {
      margin: 0 0 16px;
    }

    .policy-modal-body ul, .policy-modal-body ol {
      margin: 0 0 16px;
      padding-left: 24px;
    }

    .policy-modal-body li {
      margin-bottom: 8px;
    }

    .policy-modal-body a {
      color: var(--accent-secondary);
      text-decoration: none;
    }

    .policy-modal-body a:hover {
      text-decoration: underline;
    }

    .policy-modal-footer {
      padding: 16px 32px;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      transition: border-color 0.3s;
    }

    .policy-edit-btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .policy-edit-btn:hover {
      opacity: 0.9;
    }

    /* Age Verification Modal */
    .age-verification-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }

    .age-verification-modal.active {
      display: flex;
    }

    .age-verification-content {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
      overflow: hidden;
    }

    .age-verification-header {
      padding: 24px;
      border-bottom: 1px solid #2a2a2a;
      text-align: center;
    }

    .age-verification-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #fff;
      margin: 0;
    }

    .age-verification-body,
    .age-verification-blocked {
      padding: 24px;
      text-align: center;
    }

    .age-verification-icon {
      font-size: 4rem;
      margin-bottom: 16px;
    }

    .age-verification-text {
      color: #ccc;
      font-size: 1rem;
      line-height: 1.6;
      margin-bottom: 16px;
    }

    .age-verification-subtext {
      color: #888;
      font-size: 0.9rem;
    }

    .age-verification-list {
      text-align: left;
      color: #aaa;
      font-size: 0.9rem;
      line-height: 1.8;
      margin: 16px 0;
      padding-left: 24px;
    }

    .age-verification-checkbox {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 24px 0;
      cursor: pointer;
      color: #ccc;
      font-size: 0.95rem;
    }

    .age-verification-checkbox input {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .age-verification-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 24px;
    }

    .age-verification-btn {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .age-verification-btn.cancel {
      background: #333;
      color: #aaa;
    }

    .age-verification-btn.cancel:hover {
      background: #444;
      color: #fff;
    }

    .age-verification-btn.confirm {
      background: linear-gradient(135deg, #ff2ebb, #ff6b6b);
      color: #fff;
    }

    .age-verification-btn.confirm:hover:not(:disabled) {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .age-verification-btn.confirm:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .reference-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 12px;
    }

    .reference-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid #2a2a2a;
    }

    .reference-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .reference-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.8);
      border: none;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .reference-remove:hover {
      background: #ff4444;
    }

    /* Prompt */
    textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.9rem;
      resize: vertical;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s, background 0.3s, color 0.3s;
    }

    textarea:focus {
      border-color: var(--accent-primary);
    }

    textarea::placeholder {
      color: var(--text-muted);
    }

    /* Checkbox Labels */
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-primary);
      font-size: 0.9rem;
      transition: background 0.3s, border-color 0.3s;
    }

    .checkbox-label:hover {
      border-color: var(--accent-primary);
    }

    /* Settings */
    .settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .setting-item {
      display: flex;
      flex-direction: column;
    }

    .setting-item.full {
      grid-column: span 2;
    }

    select {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 0.9rem;
      cursor: pointer;
      outline: none;
      transition: border-color 0.2s, background 0.3s, color 0.3s;
    }

    select:focus {
      border-color: var(--accent-primary);
    }

    /* Generate Button */
    .generate-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .generate-btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 8px 24px rgba(255, 46, 187, 0.4);
    }

    .generate-btn:active:not(:disabled) {
      transform: translateY(0);
    }

    .generate-btn:disabled {
      background: #2a2a2a;
      color: #666;
      cursor: not-allowed;
    }

    .generate-btn.generating {
      background: linear-gradient(90deg, #ff2ebb 0%, #00b2ff 50%, #ff2ebb 100%);
      background-size: 200% 100%;
      animation: gradient-shift 2s ease-in-out infinite;
    }

    @keyframes gradient-shift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* Right Panel - Output */
    .right-panel {
      flex: 1;
      background: var(--bg-primary);
      overflow-y: auto;
      padding: 20px;
      transition: background 0.3s;
    }

    .output-header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .output-header {
      font-size: 1.1rem;
      font-weight: 600;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .zoom-slider-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .zoom-icon {
      font-size: 0.75rem;
      color: #666;
      user-select: none;
    }

    .zoom-slider {
      width: 100px;
      height: 4px;
      -webkit-appearance: none;
      appearance: none;
      background: #333;
      border-radius: 2px;
      outline: none;
      cursor: pointer;
    }

    .zoom-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .zoom-slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    .zoom-slider::-moz-range-thumb {
      width: 14px;
      height: 14px;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      border-radius: 50%;
      border: none;
      cursor: pointer;
    }

    .output-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(var(--grid-item-size, 250px), 1fr));
      gap: 16px;
    }

    .output-placeholder {
      grid-column: span 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 80px 20px;
      text-align: center;
      color: #555;
    }

    .output-placeholder-icon {
      font-size: 4rem;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .output-placeholder-text {
      font-size: 1rem;
      line-height: 1.5;
    }

    .output-item {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      animation: fadeIn 0.4s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    .output-item img {
      width: 100%;
      display: block;
      aspect-ratio: 1;
      object-fit: cover;
      cursor: pointer;
      transition: transform 0.2s, opacity 0.2s;
    }

    .output-item img:hover {
      transform: scale(1.02);
      opacity: 0.9;
    }

    /* Video grid - consistent 16:9 containers for clean layout */
    #videoOutputGrid .output-item {
      aspect-ratio: 16 / 9;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
    }

    #videoOutputGrid .output-item video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
    }

    /* Edit tab output cards */
    .output-card {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      animation: fadeIn 0.4s ease-out;
      display: flex;
      flex-direction: column;
    }

    .output-image {
      width: 100%;
      max-height: 400px;
      display: block;
      object-fit: contain;
      cursor: pointer;
      transition: transform 0.2s, opacity 0.2s;
      background: #0a0a0a;
    }

    .output-image:hover {
      transform: scale(1.02);
      opacity: 0.9;
    }

    .output-actions {
      display: flex;
      gap: 8px;
      padding: 12px;
      background: #0a0a0a;
      border-top: 1px solid #2a2a2a;
    }

    .output-action-btn {
      flex: 1;
      padding: 10px;
      background: rgba(255, 46, 187, 0.1);
      border: 1px solid rgba(255, 46, 187, 0.2);
      border-radius: 8px;
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .output-action-btn:hover {
      background: rgba(255, 46, 187, 0.2);
      border-color: rgba(255, 46, 187, 0.4);
      transform: translateY(-2px);
    }

    /* Loading placeholder */
    .output-placeholder-loading {
      width: 100%;
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #0a0a0a;
      position: relative;
      overflow: hidden;
    }

    /* Animated static/noise effect using brand colors */
    .output-placeholder-loading::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image:
        repeating-linear-gradient(
          0deg,
          transparent,
          transparent 2px,
          rgba(255, 46, 187, 0.03) 2px,
          rgba(255, 46, 187, 0.03) 4px
        ),
        repeating-linear-gradient(
          90deg,
          transparent,
          transparent 2px,
          rgba(0, 178, 255, 0.03) 2px,
          rgba(0, 178, 255, 0.03) 4px
        );
      animation: staticNoise 0.15s infinite;
      opacity: 0.8;
    }

    .output-placeholder-loading::after {
      content: '';
      position: absolute;
      top: -100%;
      left: -100%;
      width: 300%;
      height: 300%;
      background: radial-gradient(
        circle,
        rgba(255, 46, 187, 0.15) 0%,
        transparent 30%,
        rgba(0, 178, 255, 0.15) 60%,
        transparent 100%
      );
      animation: staticMove 3s linear infinite;
    }

    @keyframes staticNoise {
      0% { transform: translate(0, 0); }
      10% { transform: translate(-2px, 2px); }
      20% { transform: translate(2px, -1px); }
      30% { transform: translate(-1px, -2px); }
      40% { transform: translate(1px, 1px); }
      50% { transform: translate(-2px, -1px); }
      60% { transform: translate(2px, 2px); }
      70% { transform: translate(-1px, 1px); }
      80% { transform: translate(1px, -2px); }
      90% { transform: translate(-2px, -2px); }
      100% { transform: translate(0, 0); }
    }

    @keyframes staticMove {
      0% { transform: translate(0, 0) rotate(0deg); }
      100% { transform: translate(50%, 50%) rotate(360deg); }
    }

    .loading-static-overlay {
      position: absolute;
      inset: 0;
      background:
        repeating-linear-gradient(
          45deg,
          rgba(255, 46, 187, 0.05),
          rgba(255, 46, 187, 0.05) 1px,
          transparent 1px,
          transparent 3px
        ),
        repeating-linear-gradient(
          -45deg,
          rgba(0, 178, 255, 0.05),
          rgba(0, 178, 255, 0.05) 1px,
          transparent 1px,
          transparent 3px
        );
      animation: staticFlicker 0.3s infinite;
      z-index: 1;
    }

    @keyframes staticFlicker {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.6; }
    }

    .loading-text {
      color: #fff;
      font-size: 0.85rem;
      position: relative;
      z-index: 2;
      text-shadow: 0 0 10px rgba(255, 46, 187, 0.5),
                   0 0 20px rgba(0, 178, 255, 0.3);
      animation: textGlow 2s ease-in-out infinite;
    }

    @keyframes textGlow {
      0%, 100% {
        text-shadow: 0 0 10px rgba(255, 46, 187, 0.5),
                     0 0 20px rgba(0, 178, 255, 0.3);
      }
      50% {
        text-shadow: 0 0 20px rgba(255, 46, 187, 0.8),
                     0 0 30px rgba(0, 178, 255, 0.6);
      }
    }

    /* Failed placeholder */
    .output-placeholder-failed {
      position: relative;
      width: 100%;
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(255, 68, 68, 0.05);
      border: 2px dashed rgba(255, 68, 68, 0.3);
      color: #ff6666;
      padding: 20px;
      text-align: center;
    }

    .failed-dismiss-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      border: none;
      border-radius: 50%;
      background: rgba(255, 68, 68, 0.2);
      color: #ff6666;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .failed-dismiss-btn:hover {
      background: rgba(255, 68, 68, 0.5);
      color: #fff;
    }

    .failed-icon {
      font-size: 3rem;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .failed-text {
      font-size: 0.85rem;
      line-height: 1.5;
    }


    .output-item-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 12px;
      background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
      display: flex;
      justify-content: space-between;
      align-items: center;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .output-item:hover .output-item-overlay {
      opacity: 1;
    }

    .output-item-info {
      font-size: 0.75rem;
      color: #aaa;
    }

    .output-item-actions {
      display: flex;
      gap: 8px;
    }

    .icon-btn {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      font-size: 1.1rem;
      position: relative;
      overflow: hidden;
    }

    .icon-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255, 46, 187, 0.3), rgba(0, 178, 255, 0.3));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }

    .icon-btn:hover::before {
      opacity: 1;
    }

    .download-icon {
      position: relative;
      z-index: 1;
      display: inline-block;
      transition: transform 0.3s ease;
    }

    .icon-btn:hover .download-icon {
      transform: translateY(2px);
      animation: downloadBounce 0.6s ease;
    }

    @keyframes downloadBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(4px); }
    }

    /* Delete button */
    .delete-btn:hover {
      background: rgba(255, 77, 77, 0.3) !important;
    }

    .delete-btn:hover svg {
      stroke: #ff4d4d;
    }

    /* Send-to dropdown menu */
    .send-to-container {
      position: relative;
    }

    .send-to-menu {
      position: absolute;
      bottom: 100%;
      right: 0;
      margin-bottom: 8px;
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      padding: 4px;
      display: none;
      flex-direction: column;
      gap: 2px;
      min-width: 140px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      z-index: 100;
    }

    .send-to-menu.active {
      display: flex;
    }

    .send-to-option {
      padding: 8px 12px;
      background: transparent;
      border: none;
      color: #fff;
      text-align: left;
      cursor: pointer;
      border-radius: 6px;
      font-size: 0.85rem;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .send-to-option:hover {
      background: rgba(255, 46, 187, 0.15);
      color: #ff2ebb;
    }

    /* NSFW Content Blur - Active when in safe mode */
    body.content-mode-safe .output-item[data-nsfw="true"] img,
    body.content-mode-safe .output-item[data-nsfw="true"] video {
      filter: blur(25px);
      transition: filter 0.3s ease;
    }

    body.content-mode-safe .output-item[data-nsfw="true"]::after {
      content: '🔞 NSFW';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: #ff4d4d;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      z-index: 10;
      pointer-events: none;
    }

    /* NSFW badge indicator (always visible on NSFW content) */
    .output-item[data-nsfw="true"] .nsfw-badge {
      position: absolute;
      top: 8px;
      left: 8px;
      background: rgba(255, 77, 77, 0.9);
      color: #fff;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.65rem;
      font-weight: 600;
      z-index: 5;
    }

    /* Bulk Selection Mode Styles */
    .bulk-action-toolbar {
      display: none;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: linear-gradient(135deg, rgba(157, 78, 221, 0.15), rgba(255, 46, 187, 0.1));
      border: 1px solid rgba(157, 78, 221, 0.3);
      border-radius: 12px;
      margin-bottom: 16px;
      animation: slideDown 0.2s ease-out;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .bulk-action-toolbar.active {
      display: flex;
    }

    .bulk-action-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .bulk-action-count {
      font-size: 0.9rem;
      color: #fff;
      font-weight: 500;
    }

    .bulk-action-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .bulk-action-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .bulk-action-btn.select-all {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    .bulk-action-btn.select-all:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .bulk-action-btn.download {
      background: linear-gradient(135deg, #9d4edd, #ff2ebb);
      color: #fff;
    }

    .bulk-action-btn.download:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(157, 78, 221, 0.4);
    }

    .bulk-action-btn.delete {
      background: rgba(255, 68, 68, 0.2);
      color: #ff6666;
      border: 1px solid rgba(255, 68, 68, 0.3);
    }

    .bulk-action-btn.delete:hover {
      background: rgba(255, 68, 68, 0.3);
    }

    .bulk-action-btn.cancel {
      background: rgba(255, 255, 255, 0.05);
      color: #888;
    }

    .bulk-action-btn.cancel:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    .bulk-action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Selection checkbox on items */
    .output-item .select-checkbox {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 24px;
      height: 24px;
      background: rgba(0, 0, 0, 0.6);
      border: 2px solid rgba(255, 255, 255, 0.5);
      border-radius: 6px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 15;
      transition: all 0.2s;
      backdrop-filter: blur(4px);
    }

    .output-item .select-checkbox:hover {
      background: rgba(157, 78, 221, 0.6);
      border-color: #9d4edd;
    }

    .output-item .select-checkbox.checked {
      background: linear-gradient(135deg, #9d4edd, #ff2ebb);
      border-color: transparent;
    }

    .output-item .select-checkbox.checked::after {
      content: '✓';
      color: #fff;
      font-size: 14px;
      font-weight: bold;
    }

    /* Show checkboxes in selection mode */
    .output-grid.selection-mode .output-item .select-checkbox {
      display: flex;
    }

    /* Highlight selected items */
    .output-item.selected {
      outline: 3px solid #9d4edd;
      outline-offset: -3px;
    }

    .output-item.selected::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(157, 78, 221, 0.15);
      pointer-events: none;
      z-index: 5;
    }

    /* Toggle button for selection mode */
    .selection-mode-toggle {
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: #aaa;
      font-size: 0.8rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .selection-mode-toggle:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    .selection-mode-toggle.active {
      background: rgba(157, 78, 221, 0.2);
      border-color: rgba(157, 78, 221, 0.4);
      color: #9d4edd;
    }

    input[type="file"] {
      display: none;
    }

    .error-message {
      background: rgba(255, 68, 68, 0.1);
      border: 1px solid #ff4444;
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
      color: #ff6666;
      font-size: 0.85rem;
    }

    /* Image Modal */
    .image-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      cursor: zoom-out;
      animation: fadeIn 0.2s ease-out;
    }

    .image-modal.active {
      display: flex;
    }

    .image-modal img {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
      border-radius: 8px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .image-modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 48px;
      height: 48px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 50%;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      backdrop-filter: blur(10px);
    }

    .image-modal-close:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }

    /* Video Modal */
    .video-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s ease-out;
    }

    .video-modal.active {
      display: flex;
    }

    .video-modal video {
      max-width: 90%;
      max-height: 85%;
      border-radius: 8px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .video-modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 48px;
      height: 48px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 50%;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      backdrop-filter: blur(10px);
      z-index: 10000;
    }

    .video-modal-close:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }

    /* Video expand button overlay */
    #videoOutputGrid .output-item .video-expand-btn {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 36px;
      height: 36px;
      background: rgba(0, 0, 0, 0.7);
      border: none;
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s, transform 0.2s;
      z-index: 10;
      backdrop-filter: blur(4px);
    }

    #videoOutputGrid .output-item:hover .video-expand-btn {
      opacity: 1;
    }

    #videoOutputGrid .output-item .video-expand-btn:hover {
      background: rgba(255, 46, 187, 0.8);
      transform: scale(1.1);
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #0f0f0f;
    }

    ::-webkit-scrollbar-thumb {
      background: #2a2a2a;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #3a3a3a;
    }

    /* Caption Tab - ChatGPT Style */
    .caption-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #0f0f0f;
      position: relative;
      height: calc(100vh - 136px);
      overflow: hidden;
    }

    .caption-chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 40px 20px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }

    .caption-chat-area.has-messages {
      justify-content: flex-start;
    }

    .caption-chat-area:not(.has-messages) {
      justify-content: center;
    }

    .caption-welcome {
      max-width: 600px;
      text-align: center;
      margin-bottom: 40px;
    }

    .caption-welcome-icon {
      font-size: 4rem;
      margin-bottom: 20px;
    }

    .caption-welcome-title {
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 12px;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .caption-welcome-text {
      font-size: 1rem;
      color: #888;
    }

    .caption-input-container {
      padding: 20px;
      background: #0f0f0f;
      border-top: 1px solid #2a2a2a;
      display: flex;
      justify-content: center;
    }

    .caption-input-wrapper {
      max-width: 768px;
      width: 100%;
      display: flex;
      gap: 12px;
      align-items: center;
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 24px;
      padding: 8px 8px 8px 16px;
      transition: border-color 0.2s;
    }

    .caption-input-wrapper:focus-within {
      border-color: #ff2ebb;
    }

    .caption-attach-btn {
      background: transparent;
      border: none;
      color: #888;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s;
      border-radius: 8px;
    }

    .caption-attach-btn:hover {
      color: #fff;
      background: #2a2a2a;
    }

    .caption-input {
      flex: 1;
      background: transparent;
      border: none;
      color: #fff;
      font-size: 1rem;
      padding: 12px 8px;
      outline: none;
    }

    .caption-input::placeholder {
      color: #666;
    }

    .caption-input:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .caption-send-btn {
      width: 40px;
      height: 40px;
      background: #2a2a2a;
      border: none;
      border-radius: 50%;
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .caption-send-btn:hover:not(:disabled) {
      background: #ff2ebb;
      transform: scale(1.05);
    }

    .caption-send-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .caption-message {
      max-width: 768px;
      width: 100%;
      margin-bottom: 24px;
      display: flex;
      gap: 12px;
    }

    .caption-message.user {
      justify-content: flex-end;
    }

    .caption-message-content {
      max-width: 80%;
      padding: 16px 20px;
      border-radius: 18px;
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
    }

    .caption-message.user .caption-message-content {
      background: #2a2a2a;
    }

    .caption-message-image {
      max-width: 300px;
      border-radius: 12px;
      margin-bottom: 8px;
    }

    .caption-message-text {
      color: #fff;
      line-height: 1.6;
    }

    .caption-model-tab {
      padding: 8px 16px;
      background: transparent;
      border: none;
      color: #888;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      border-radius: 6px;
      font-weight: 500;
    }

    .caption-model-tab:hover {
      color: #fff;
      background: #2a2a2a;
    }

    .caption-model-tab.active {
      color: #fff;
      background: #ff2ebb;
    }

    /* Typing indicator animation */
    .typing-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 8px 0;
    }

    .typing-indicator span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ff2ebb;
      animation: typing-pulse 1.4s infinite;
      opacity: 0.6;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing-pulse {
      0%, 60%, 100% {
        opacity: 0.6;
        transform: scale(1);
      }
      30% {
        opacity: 1;
        transform: scale(1.2);
      }
    }

    /* Responsive */
    @media (max-width: 900px) {
      .container {
        flex-direction: column;
      }

      .left-panel {
        width: 100%;
        max-height: 50vh;
      }

      .output-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      }

      .caption-welcome {
        margin-top: 10vh;
      }

      .caption-input-wrapper {
        max-width: 100%;
      }
    }

    /* ===========================================
       ACCOUNT & BILLING PAGE STYLES
       =========================================== */
    #accountSection,
    #billingSection {
      overflow-y: auto;
      flex-direction: column;
    }

    .account-page {
      max-width: 900px;
      margin: 0 auto;
      padding: 30px 20px 100px;
    }

    .account-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .account-title {
      font-size: 2rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 8px;
    }

    .account-subtitle {
      color: #888;
      font-size: 1rem;
    }

    .account-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      align-items: start;
    }

    .account-card {
      background: #1a1a1a;
      border-radius: 12px;
      border: 1px solid #333;
      overflow: hidden;
    }

    .account-card.wide {
      grid-column: 1 / -1;
    }

    .account-card.danger {
      border-color: #ff4d4d33;
    }

    .account-card-header {
      padding: 16px 20px;
      border-bottom: 1px solid #333;
      background: #222;
    }

    .account-card-title {
      font-size: 1rem;
      font-weight: 600;
      color: #fff;
      margin: 0;
    }

    .account-card-body {
      padding: 20px;
    }

    .account-avatar-section {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }

    .account-avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
    }

    .account-field {
      margin-bottom: 16px;
    }

    .account-label {
      display: block;
      font-size: 0.85rem;
      color: #888;
      margin-bottom: 6px;
    }

    .account-input {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #111;
      color: #fff;
      font-size: 0.95rem;
      box-sizing: border-box;
    }

    .account-input:focus {
      outline: none;
      border-color: #ff2ebb;
    }

    .account-input:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .account-hint {
      display: block;
      font-size: 0.75rem;
      color: #666;
      margin-top: 4px;
    }

    .account-btn {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .account-btn.primary {
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      color: #fff;
    }

    .account-btn.primary:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .account-btn.secondary {
      background: #333;
      color: #fff;
    }

    .account-btn.secondary:hover {
      background: #444;
    }

    .account-btn.danger {
      background: #ff4d4d;
      color: #fff;
    }

    .account-btn.danger:hover {
      background: #ff3333;
    }

    .account-subscription-info {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
    }

    .account-plan-badge {
      padding: 8px 16px;
      border-radius: 20px;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      color: #fff;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .account-credits-display {
      text-align: center;
    }

    .account-credits-number {
      display: block;
      font-size: 1.5rem;
      font-weight: 700;
      color: #fff;
    }

    .account-credits-label {
      font-size: 0.75rem;
      color: #888;
    }

    .account-subscription-details {
      margin-bottom: 20px;
    }

    .account-detail-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #222;
    }

    .account-detail-label {
      color: #888;
    }

    .account-detail-value {
      color: #fff;
      font-weight: 500;
    }

    .account-warning-text {
      color: #ff6b6b;
      font-size: 0.9rem;
      margin-bottom: 16px;
      line-height: 1.5;
    }

    .account-back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      margin-top: 30px;
      border-radius: 8px;
      border: 1px solid #333;
      background: transparent;
      color: #fff;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .account-back-btn:hover {
      background: #222;
      border-color: #444;
    }

    /* Custom Orders List */
    #customOrdersList {
      max-height: 300px;
      overflow-y: auto;
    }

    /* Moderation Modal Styles */
    #flaggedImagePreview img {
      max-width: 200px;
      max-height: 200px;
      border-radius: 8px;
      border: 2px solid #ff6b6b40;
    }

    #flagReasonsList li {
      margin-bottom: 6px;
      line-height: 1.4;
    }

    /* Image Library Modal */
    .library-modal-filters {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .lib-filter-btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: 1px solid #333;
      background: transparent;
      color: #888;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .lib-filter-btn:hover {
      border-color: #555;
      color: #fff;
    }

    .lib-filter-btn.active {
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      border-color: transparent;
      color: #fff;
    }

    .library-modal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
    }

    .library-modal-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      background: #111;
      border: 2px solid #333;
      cursor: pointer;
      transition: all 0.2s;
    }

    .library-modal-item:hover {
      border-color: #555;
      transform: scale(1.02);
    }

    .library-modal-item.status-approved { border-color: #4ade8060; }
    .library-modal-item.status-pending { border-color: #fbbf2460; }
    .library-modal-item.status-rejected { border-color: #f8717160; }

    .library-modal-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .library-item-badge {
      position: absolute;
      top: 4px;
      right: 4px;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .library-item-badge.approved {
      background: #4ade8030;
      color: #4ade80;
    }

    .library-item-badge.pending {
      background: #fbbf2430;
      color: #fbbf24;
    }

    .library-item-badge.rejected {
      background: #f8717130;
      color: #f87171;
    }

    .library-modal-loading,
    .library-modal-empty {
      grid-column: 1 / -1;
      text-align: center;
      padding: 40px;
      color: #888;
    }

    /* Toast Animation */
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }

    /* Billing Page Specific Styles */
    .payment-method-display {
      margin-bottom: 16px;
    }

    .no-payment-method {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: #111;
      border-radius: 8px;
      border: 1px dashed #333;
    }

    .no-payment-icon {
      font-size: 1.5rem;
      opacity: 0.5;
    }

    .no-payment-text {
      color: #666;
    }

    .credits-balance-display {
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .credits-balance-number {
      display: block;
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #ff2ebb, #00b2ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .credits-balance-label {
      color: #888;
      font-size: 0.85rem;
    }

    .credits-packages {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .credits-package {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px;
      border-radius: 12px;
      border: 1px solid #333;
      background: #111;
      cursor: pointer;
      transition: all 0.2s;
    }

    .credits-package:hover {
      border-color: #ff2ebb;
      transform: translateY(-2px);
    }

    .credits-package.featured {
      border-color: #ff2ebb;
      background: linear-gradient(135deg, rgba(255, 46, 187, 0.1), rgba(0, 178, 255, 0.1));
    }

    .package-credits {
      font-size: 1.1rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 4px;
    }

    .package-price {
      font-size: 0.9rem;
      color: #ff2ebb;
      font-weight: 600;
    }

    /* Transaction Table Styles */
    .transaction-table-container {
      overflow-x: auto;
      overflow-y: auto;
      max-height: 400px;
    }

    .transaction-table {
      width: 100%;
      border-collapse: collapse;
    }

    .transaction-table th,
    .transaction-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #222;
    }

    .transaction-table th {
      color: #888;
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
    }

    .transaction-table td {
      color: #fff;
      font-size: 0.9rem;
    }

    .transaction-table tr:hover {
      background: #111;
    }

    .transaction-loading td {
      text-align: center;
      color: #666;
      padding: 30px;
    }

    .transaction-amount {
      font-weight: 600;
    }

    .transaction-amount.positive {
      color: #4ade80;
    }

    .transaction-amount.negative {
      color: #f87171;
    }

    .transaction-type {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .transaction-type.credit {
      background: rgba(74, 222, 128, 0.2);
      color: #4ade80;
    }

    .transaction-type.debit {
      background: rgba(248, 113, 113, 0.2);
      color: #f87171;
    }

    .transaction-type.purchase {
      background: rgba(255, 46, 187, 0.2);
      color: #ff2ebb;
    }

    .no-transactions {
      text-align: center;
      color: #666;
      padding: 30px;
    }

    /* Light theme overrides and cold-start banner now in external css/main.css */
  </style>
  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Socket.io Client -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <!-- Cropper.js for image cropping -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- FingerprintJS for browser fingerprinting (trial abuse prevention) -->
  <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@4/dist/fp.min.js"></script>
</head>
<body>
  <!-- Loading splash (shown while page loads) -->
  <div class="loading-splash" id="loadingSplash">
    <img src="/public/images/logos/Color_A.svg" alt="Vixxxen" class="loading-splash-logo" style="height: 48px; width: auto;">
    <div class="loading-splash-spinner"></div>
    <div class="loading-splash-text">Loading...</div>
  </div>

  <!-- Cold Start Banner (shown when server is waking up) -->
  <div class="cold-start-banner" id="coldStartBanner">
    <div class="spinner"></div>
    <span id="coldStartText">Waking up server... This may take up to 50 seconds on first visit.</span>
  </div>

  <!-- Landing Page (shown when not logged in) -->
  <div class="landing-page" id="landingPage" style="display: none;">
    <!-- Hero Section -->
    <section class="landing-hero" id="landingHero">
      <div class="landing-hero__content">
        <h1 class="landing-hero__headline landing-animate" id="heroHeadline">Build Your AI Content Empire</h1>
        <p class="landing-hero__subheadline landing-animate landing-animate--delay-1" id="heroSubheadline">Create a character. Generate content. Monetize everywhere.</p>
        <div class="landing-hero__ctas landing-animate landing-animate--delay-2">
          <a href="#signup" class="landing-btn landing-btn--primary" id="heroPrimaryCta">Start Building</a>
          <a href="#try" class="landing-btn landing-btn--secondary landing-btn--try" id="heroTrialCta">Try It Now</a>
          <a href="#pipeline" class="landing-btn landing-btn--ghost" id="heroSecondaryCta">See How It Works</a>
        </div>
        <p class="landing-hero__trust landing-animate landing-animate--delay-3" id="heroTrustBadge">Join 500+ creators building their AI empire</p>
      </div>
    </section>

    <!-- Stats Bar Section -->
    <section class="landing-stats" id="landingStats">
      <div class="landing-stats__grid" id="statsGrid">
        <!-- Stats populated by JS -->
      </div>
    </section>

    <!-- Featured Characters Section -->
    <section class="landing-section" id="landingCharacters">
      <div class="landing-section__header">
        <h2 class="landing-section__headline landing-animate" id="charactersHeadline">Creators Are Building Real Businesses</h2>
        <p class="landing-section__subheadline landing-animate landing-animate--delay-1" id="charactersSubheadline">See what's possible with Vixxxen</p>
      </div>
      <div class="landing-characters__grid" id="charactersGrid">
        <!-- Characters populated by JS -->
      </div>
    </section>

    <!-- Pipeline Section -->
    <section class="landing-section" id="landingPipeline">
      <div class="landing-section__header">
        <h2 class="landing-section__headline landing-animate" id="pipelineHeadline">Your Path to AI Creator Income</h2>
      </div>
      <div class="landing-pipeline__steps" id="pipelineSteps">
        <!-- Pipeline steps populated by JS -->
      </div>
    </section>

    <!-- Content Showcase Section -->
    <section class="landing-section" id="landingShowcase">
      <div class="landing-section__header">
        <h2 class="landing-section__headline landing-animate" id="showcaseHeadline">One Character. Unlimited Content.</h2>
        <p class="landing-section__subheadline landing-animate landing-animate--delay-1" id="showcaseSubheadline">Same face. Same style. Infinite variety.</p>
      </div>
      <div class="landing-showcase__grid" id="showcaseGrid">
        <!-- Showcase items populated by JS -->
      </div>
    </section>

    <!-- Capabilities Section -->
    <section class="landing-section" id="landingCapabilities">
      <div class="landing-section__header">
        <h2 class="landing-section__headline landing-animate" id="capabilitiesHeadline">Professional Tools. Stunning Results.</h2>
      </div>
      <div class="landing-capabilities__grid" id="capabilitiesGrid">
        <!-- Capabilities populated by JS -->
      </div>
    </section>

    <!-- Education Section -->
    <section class="landing-section landing-education" id="landingEducation">
      <div class="landing-education__content">
        <div class="landing-education__text">
          <h2 class="landing-education__headline landing-animate" id="educationHeadline">We Don't Just Give You Tools</h2>
          <h3 class="landing-education__subheadline landing-animate landing-animate--delay-1" id="educationSubheadline">We Teach You The Business</h3>
          <ul class="landing-education__bullets" id="educationBullets">
            <!-- Bullets populated by JS -->
          </ul>
          <a href="#courses" class="landing-btn landing-btn--primary landing-animate landing-animate--delay-2" id="educationCta">Explore Courses</a>
        </div>
        <div class="landing-education__preview landing-animate landing-animate--delay-1">
          <div class="landing-education__preview-header">Course Preview</div>
          <div class="landing-education__modules" id="educationModules">
            <div class="landing-education__module">
              <div class="landing-education__module-number">1</div>
              <div class="landing-education__module-title">Launch Your AI Instagram</div>
            </div>
            <div class="landing-education__module">
              <div class="landing-education__module-number">2</div>
              <div class="landing-education__module-title">Content Strategy That Converts</div>
            </div>
            <div class="landing-education__module">
              <div class="landing-education__module-number">3</div>
              <div class="landing-education__module-title">Fanvue Monetization Mastery</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Pricing Section -->
    <section class="landing-section" id="landingPricing">
      <div class="landing-section__header">
        <h2 class="landing-section__headline landing-animate" id="pricingHeadline">Choose Your Path</h2>
      </div>
      <div class="landing-pricing__grid" id="pricingGrid">
        <div class="landing-pricing-card landing-animate">
          <div class="landing-pricing-card__name">Starter</div>
          <div class="landing-pricing-card__price">$20</div>
          <div class="landing-pricing-card__period">/month</div>
          <div class="landing-pricing-card__feature">1,000 credits</div>
          <button class="landing-btn landing-btn--secondary landing-pricing-card__cta" onclick="openWizardWithTier('starter')">Get Started</button>
        </div>
        <div class="landing-pricing-card landing-pricing-card--featured landing-animate landing-animate--delay-1">
          <div class="landing-pricing-card__name">Creator</div>
          <div class="landing-pricing-card__price">$50</div>
          <div class="landing-pricing-card__period">/month</div>
          <div class="landing-pricing-card__feature">3,000 credits</div>
          <button class="landing-btn landing-btn--primary landing-pricing-card__cta" onclick="openWizardWithTier('creator')">Get Started</button>
        </div>
        <div class="landing-pricing-card landing-animate landing-animate--delay-2">
          <div class="landing-pricing-card__name">Pro</div>
          <div class="landing-pricing-card__price">$95</div>
          <div class="landing-pricing-card__period">/month</div>
          <div class="landing-pricing-card__feature">6,500 credits</div>
          <button class="landing-btn landing-btn--secondary landing-pricing-card__cta" onclick="openWizardWithTier('pro')">Get Started</button>
        </div>
        <div class="landing-pricing-card landing-animate landing-animate--delay-3">
          <div class="landing-pricing-card__name">Mentorship</div>
          <div class="landing-pricing-card__price">$100</div>
          <div class="landing-pricing-card__period">/month</div>
          <div class="landing-pricing-card__feature">1-on-1 guidance</div>
          <button class="landing-btn landing-btn--secondary landing-pricing-card__cta" onclick="openWizardWithTier('mentorship')">Apply Now</button>
        </div>
      </div>
    </section>

    <!-- Final CTA Section -->
    <section class="landing-final-cta" id="landingFinalCta">
      <div class="landing-final-cta__content">
        <h2 class="landing-final-cta__headline landing-animate" id="finalCtaHeadline">Ready to Build Your AI Creator Business?</h2>
        <p class="landing-final-cta__subheadline landing-animate landing-animate--delay-1" id="finalCtaSubheadline">Join hundreds of creators already building their empires</p>
        <div class="landing-final-cta__buttons landing-animate landing-animate--delay-2">
          <button class="landing-btn landing-btn--primary" id="finalCtaPrimary">Get Started Free</button>
          <a href="mailto:admin@digitaldivas.ai" class="landing-btn landing-btn--secondary" id="finalCtaSecondary">Talk to Us</a>
        </div>
      </div>
    </section>

    <!-- Landing Page Footer -->
    <footer class="landing-section" style="text-align: center; padding: 40px 20px; border-top: 1px solid var(--border-color);">
      <img src="/public/images/logos/Color_A.svg" alt="Vixxxen" style="height: 32px; margin-bottom: 16px;">
      <p style="color: var(--text-muted); font-size: 14px;">© 2025 Vixxxen. All rights reserved.</p>
    </footer>
  </div>

  <!-- Top Navbar -->
  <nav class="top-navbar" id="topNavbar">
    <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleSidebar()">
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
    </button>
    <img src="/public/images/logos/Color_A.svg" alt="Vixxxen" class="navbar-logo">
  </nav>

  <!-- Mobile overlay for sidebar -->
  <div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileSidebar()"></div>

  <div class="container">
    <!-- Main Navigation Sidebar -->
    <div class="main-nav">
      <div class="nav-tabs-container">
        <div class="nav-tab active" onclick="switchMainTab('image')" id="imageNavTab">
          <div class="nav-icon">🎨</div>
          <div class="nav-label">Image</div>
        </div>
        <div class="nav-tab" onclick="switchMainTab('video')" id="videoNavTab">
          <div class="nav-icon">🎬</div>
          <div class="nav-label">Video</div>
        </div>
        <div class="nav-tab" onclick="switchMainTab('edit')" id="editNavTab">
          <div class="nav-icon">✂️</div>
          <div class="nav-label">Edit</div>
        </div>
        <div class="nav-tab" onclick="switchMainTab('inpaint')" id="inpaintNavTab">
          <div class="nav-icon">🖌️</div>
          <div class="nav-label">Inpaint</div>
        </div>
        <div class="nav-tab" onclick="switchMainTab('caption')" id="captionNavTab">
          <div class="nav-icon">💬</div>
          <div class="nav-label">Caption</div>
        </div>
        <div class="nav-tab" onclick="switchMainTab('marketplace')" id="marketplaceNavTab">
          <div class="nav-icon">🛍️</div>
          <div class="nav-label">Marketplace</div>
        </div>
        <div class="nav-tab" onclick="switchMainTab('education')" id="educationNavTab">
          <div class="nav-icon">🎓</div>
          <div class="nav-label">Learn</div>
        </div>
      </div>

      <!-- User Area -->
      <div class="user-area">
        <div class="theme-toggle" onclick="toggleTheme()" id="themeToggle" title="Toggle light/dark mode">
          <span class="theme-icon" id="themeIcon">🌙</span>
        </div>
        <div class="user-avatar" onclick="toggleUserMenu()" id="userAvatar">
          👤
          <div class="user-status-dot" id="userStatusDot" style="display: none;"></div>
        </div>
        <div class="user-credits" id="userCreditsDisplay">Login</div>
      </div>
    </div>

    <!-- User Menu Dropdown -->
    <div class="user-menu" id="userMenu">
      <div class="user-menu-header">
        <div class="user-menu-name" id="userName">Demo User</div>
        <div class="user-menu-email" id="userEmail">demo@vixxxen.ai</div>
      </div>

      <div class="user-menu-section">
        <div class="user-menu-label">Credits</div>
        <div class="user-menu-value highlight" id="userCreditsDetail">1,250 Credits</div>
      </div>

      <div class="user-menu-section">
        <div class="user-menu-label">Subscription</div>
        <div class="user-menu-subscription" id="userSubscription">Pro Plan</div>
      </div>

      <button class="user-menu-btn primary" onclick="openSubscriptionPage()">💳 Upgrade Plan</button>
      <button class="user-menu-btn" onclick="openAccountPage()">Manage Account</button>
      <button class="user-menu-btn" onclick="openImageLibraryModal()">My Images</button>
      <button class="user-menu-btn" onclick="openBillingPage()">Billing</button>
      <button class="user-menu-btn" onclick="handleLogout()">Logout</button>
    </div>

    <!-- Login Modal -->
    <div class="login-modal" id="loginModal">
      <div class="login-modal-content">
        <div class="login-modal-title">Welcome to Vixxxen</div>
        <div class="login-modal-subtitle">Sign in or create an account to start creating</div>

        <!-- Google Sign-In Button -->
        <button class="google-signin-btn" onclick="handleGoogleSignIn()">
          <svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">
            <path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285F4"/>
            <path d="M9.003 18c2.43 0 4.467-.806 5.956-2.18l-2.909-2.26c-.806.54-1.836.86-3.047.86-2.344 0-4.328-1.584-5.036-3.711H.96v2.332C2.44 15.983 5.485 18 9.003 18z" fill="#34A853"/>
            <path d="M3.964 10.712c-.18-.54-.282-1.117-.282-1.71 0-.593.102-1.17.282-1.71V4.96H.957C.347 6.175 0 7.55 0 9.002c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/>
            <path d="M9.003 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.464.891 11.428 0 9.002 0 5.485 0 2.44 2.017.96 4.958L3.967 7.29c.708-2.127 2.692-3.71 5.036-3.71z" fill="#EA4335"/>
          </svg>
          Continue with Google
        </button>

        <div class="login-divider">
          <span>or use email</span>
        </div>

        <input type="email" class="login-input" placeholder="Email" id="loginEmail">
        <input type="password" class="login-input" placeholder="Password (min 6 characters)" id="loginPassword">

        <div style="display: flex; gap: 10px; width: 100%;">
          <button class="user-menu-btn primary" onclick="handleLogin()" style="flex: 1;">Sign In</button>
          <button class="user-menu-btn primary" onclick="handleSignUpFromModal()" style="flex: 1; background: linear-gradient(135deg, #00b2ff, #0088cc);">Create Account</button>
        </div>
        <div style="font-size: 0.8rem; color: #888; text-align: center; margin-top: 8px;">
          🎁 New accounts get <strong style="color: #00b2ff;">20 free credits</strong> to start!
        </div>
        <button class="user-menu-btn" onclick="closeLoginModal()" style="margin-top: 8px;">Cancel</button>
      </div>
    </div>

    <!-- Image Tab Section -->
    <div class="tab-section active" id="imageSection">
      <div class="left-panel">
      <div class="header">
        <!-- Content Mode Toggle -->
        <div class="content-mode-toggle" id="contentModeToggle">
          <span class="content-mode-label">Content Mode:</span>
          <div class="content-mode-switch">
            <button class="content-mode-btn active" id="safeModeBtn" onclick="setContentMode('safe')">
              Safe
            </button>
            <button class="content-mode-btn nsfw-btn" id="nsfwModeBtn" onclick="setContentMode('nsfw')">
              NSFW
            </button>
          </div>
          <span class="content-mode-info" id="contentModeInfo">All models • Content filtered</span>
        </div>

        <div class="model-tabs" id="imageModelTabs">
          <button class="model-tab active" onclick="selectModel('nano-banana')" id="nanoTab" data-safe-mode="true">
            🍌 Nano Banana Pro
          </button>
          <button class="model-tab" onclick="selectModel('seedream')" id="seedreamTab" data-safe-mode="true" data-nsfw-mode="true">
            🌊 Seedream 4.5
          </button>
          <button class="model-tab" onclick="selectModel('qwen')" id="qwenGenTab" data-safe-mode="true" data-nsfw-mode="true">
            🎨 Qwen
          </button>
        </div>
      </div>

      <div class="content">
        <!-- Reference Images (Nano Banana and Seedream) -->
        <div class="section" id="referenceSection">
          <div class="section-label">Reference Images (Optional - up to 14)</div>
          <input type="file" id="fileInput" accept="image/*" multiple onchange="handleFileUpload(event)">
          <div class="reference-upload" onclick="document.getElementById('fileInput').click()">
            <div class="reference-upload-icon">📸</div>
            <div class="reference-upload-text">Click to upload reference images</div>
            <div class="reference-upload-hint">or drag and drop</div>
          </div>
          <div id="referenceGrid" class="reference-grid"></div>
        </div>

        <!-- Prompt -->
        <div class="section">
          <div class="section-label">Prompt</div>
          <textarea
            id="promptInput"
            placeholder="Describe what you want to generate... (e.g., 'A serene mountain landscape at sunset with vibrant colors')"
          ></textarea>
        </div>

        <!-- Settings (Nano Banana & Seedream) -->
        <div class="section" id="standardSettings">
          <div class="section-label">Settings</div>
          <div class="settings-grid">
            <!-- Aspect Ratio - for Nano Banana only -->
            <div class="setting-item" id="aspectRatioSetting">
              <select id="aspectRatio">
                <option value="1:1">1:1 Square</option>
                <option value="16:9">16:9 Landscape</option>
                <option value="9:16">9:16 Portrait</option>
                <option value="4:3">4:3 Classic</option>
                <option value="3:4">3:4 Portrait</option>
              </select>
            </div>
            <!-- Seedream Aspect Ratio + Resolution -->
            <div class="setting-item" id="seedreamAspectSetting" style="display: none;">
              <select id="seedreamAspectRatio">
                <option value="1:1">1:1 Square</option>
                <option value="16:9">16:9 Landscape</option>
                <option value="9:16">9:16 Portrait</option>
                <option value="4:3">4:3 Classic</option>
                <option value="3:4">3:4 Portrait</option>
              </select>
            </div>
            <div class="setting-item" id="seedreamResolutionSetting" style="display: none;">
              <select id="seedreamResolution">
                <option value="1K">1K</option>
                <option value="2K" selected>2K</option>
                <option value="4K">4K</option>
              </select>
            </div>
            <div class="setting-item full">
              <select id="numGenerations">
                <option value="1" selected>1 Generation</option>
                <option value="2">2 Generations</option>
                <option value="3">3 Generations</option>
                <option value="4">4 Generations</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Qwen Generation Settings -->
        <div class="section" id="qwenGenSettings" style="display: none;">
          <div class="section-label">Settings</div>
          <div class="settings-grid">
            <div class="setting-item">
              <select id="qwenGenAspectRatio">
                <option value="1:1">1:1 Square</option>
                <option value="16:9">16:9 Landscape</option>
                <option value="9:16">9:16 Portrait</option>
                <option value="4:3">4:3 Classic</option>
                <option value="3:4">3:4 Portrait</option>
              </select>
            </div>
            <div class="setting-item">
              <select id="qwenGenNumGenerations">
                <option value="1" selected>1 Generation</option>
                <option value="2">2 Generations</option>
                <option value="3">3 Generations</option>
                <option value="4">4 Generations</option>
                <option value="5">5 Generations</option>
                <option value="6">6 Generations</option>
                <option value="7">7 Generations</option>
                <option value="8">8 Generations</option>
                <option value="9">9 Generations</option>
                <option value="10">10 Generations</option>
              </select>
            </div>
            <div class="setting-item full">
              <select id="qwenGenCharacter">
                <option value="none" selected>No Character (LoRA)</option>
                <option value="Saskia_QWEN_v1_000004500.safetensors">👩 Saskia</option>
                <option value="Nova_QWEN_v1_000004500.safetensors">💫 Nova</option>
                <option value="Amy_QWEN_v1_000003500.safetensors">🌸 Amy</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Generate Button -->
        <button class="generate-btn" id="generateBtn" onclick="generateImages()">
          <span id="generateText">⚡ Generate</span>
        </button>

        <div id="errorContainer"></div>
      </div>
    </div>

    <!-- Right Panel - Output -->
    <div class="right-panel">
      <div class="output-header-container">
        <div class="output-header">Generated Images</div>
        <div style="display: flex; align-items: center; gap: 12px;">
          <button class="selection-mode-toggle" id="imageSelectionToggle" onclick="toggleImageSelectionMode()">
            ☑️ Select
          </button>
          <div class="zoom-slider-container">
            <span class="zoom-icon">🔍-</span>
            <input type="range" class="zoom-slider" id="imageZoomSlider" min="150" max="400" value="250" oninput="updateImageGridZoom(this.value)">
            <span class="zoom-icon">🔍+</span>
          </div>
        </div>
      </div>
      <!-- Bulk Action Toolbar for Images -->
      <div class="bulk-action-toolbar" id="imageBulkToolbar">
        <div class="bulk-action-left">
          <span class="bulk-action-count"><span id="imageSelectedCount">0</span> selected</span>
          <button class="bulk-action-btn select-all" onclick="selectAllImages()">Select All</button>
          <button class="bulk-action-btn select-all" onclick="deselectAllImages()">Deselect All</button>
        </div>
        <div class="bulk-action-right">
          <button class="bulk-action-btn download" id="imageBulkDownloadBtn" onclick="bulkDownloadImages()" disabled>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Download
          </button>
          <button class="bulk-action-btn delete" id="imageBulkDeleteBtn" onclick="bulkDeleteImages()" disabled>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            Delete
          </button>
          <button class="bulk-action-btn cancel" onclick="toggleImageSelectionMode()">Cancel</button>
        </div>
      </div>
      <div class="output-grid" id="outputGrid">
        <div class="output-placeholder">
          <div class="output-placeholder-icon">🎨</div>
          <div class="output-placeholder-text">
            Your generated images will appear here<br>
            <span style="color: #666; font-size: 0.85rem;">Configure settings and click Generate to start</span>
          </div>
        </div>
      </div>
    </div>
    </div>
    <!-- End Image Tab Section -->

    <!-- Video Tab Section -->
    <div class="tab-section" id="videoSection">
      <div class="left-panel">
        <div class="header">
          <div class="logo-container">
            <div>
              <h1>Video Generation</h1>
              <div class="tagline">AI Video Models</div>
            </div>
          </div>

          <!-- Content Mode Toggle for Video -->
          <div class="content-mode-toggle" id="videoContentModeToggle">
            <span class="content-mode-label">Content Mode:</span>
            <div class="content-mode-switch">
              <button class="content-mode-btn active" id="videoSafeModeBtn" onclick="setContentMode('safe')">
                Safe
              </button>
              <button class="content-mode-btn nsfw-btn" id="videoNsfwModeBtn" onclick="setContentMode('nsfw')">
                NSFW
              </button>
            </div>
            <span class="content-mode-info" id="videoContentModeInfo">Kling & Veo available</span>
          </div>

          <div class="model-tabs" id="videoModelTabs">
            <button class="model-tab active" onclick="selectVideoModel('kling')" id="klingVideoTab" data-sfw="true">
              🎬 Kling 2.5
            </button>
            <button class="model-tab" onclick="selectVideoModel('wan')" id="wanVideoTab" data-nsfw="true" style="display: none;">
              🌊 Wan 2.2
            </button>
            <button class="model-tab" onclick="selectVideoModel('veo')" id="veoVideoTab" data-sfw="true">
              ⚡ Veo 3.1
            </button>
          </div>
        </div>

        <div class="content">
          <!-- Start Image (Optional) -->
          <div class="section" id="videoStartImageSection">
            <div class="section-label">Start Image (Optional)</div>
            <input type="file" id="videoStartImageInput" accept="image/*" onchange="handleVideoStartImageUpload(event)">
            <div class="reference-upload" onclick="document.getElementById('videoStartImageInput').click()">
              <div class="reference-upload-icon">📸</div>
              <div class="reference-upload-text">Click to upload start frame</div>
              <div class="reference-upload-hint">or drag and drop</div>
            </div>
            <div id="videoStartImagePreview" class="reference-grid"></div>
          </div>

          <!-- Last Frame (Veo only) -->
          <div class="section" id="veoLastFrameSection" style="display: none;">
            <div class="section-label">Last Frame (Optional - For Interpolation)</div>
            <input type="file" id="veoLastFrameInput" accept="image/*" onchange="handleVeoLastFrameUpload(event)">
            <div class="reference-upload" onclick="document.getElementById('veoLastFrameInput').click()">
              <div class="reference-upload-icon">🎞️</div>
              <div class="reference-upload-text">Click to upload ending frame</div>
              <div class="reference-upload-hint">or drag and drop</div>
            </div>
            <div id="veoLastFramePreview" class="reference-grid"></div>
          </div>

          <!-- Prompt -->
          <div class="section">
            <div class="section-label">Prompt</div>
            <textarea
              id="videoPromptInput"
              placeholder="Describe the video you want to generate... (e.g., 'A woman doing an impressive breakdancing performance, including flips and intense spins')"
            ></textarea>
          </div>

          <!-- Negative Prompt (Kling and Veo) -->
          <div class="section" id="negativePromptSection">
            <div class="section-label">Negative Prompt (Optional)</div>
            <textarea
              id="videoNegativePromptInput"
              placeholder="Things you don't want in the video..."
            ></textarea>
          </div>

          <!-- Kling Settings -->
          <div class="section" id="klingSettingsSection">
            <div class="section-label">Settings</div>
            <div class="settings-grid">
              <div class="setting-item">
                <select id="videoAspectRatio">
                  <option value="16:9" selected>16:9 Landscape</option>
                  <option value="9:16">9:16 Portrait</option>
                  <option value="1:1">1:1 Square</option>
                </select>
              </div>
              <div class="setting-item">
                <select id="videoDuration">
                  <option value="5" selected>5 Seconds</option>
                  <option value="10">10 Seconds</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Wan Settings -->
          <div class="section" id="wanSettingsSection" style="display: none;">
            <div class="section-label">Settings</div>
            <div class="settings-grid">
              <div class="setting-item">
                <select id="wanResolution">
                  <option value="480p" selected>480p (832x480 or 480x832)</option>
                  <option value="720p">720p (Higher Quality)</option>
                </select>
              </div>
              <div class="setting-item">
                <select id="wanNumFrames">
                  <option value="81" selected>81 Frames (Best Quality)</option>
                  <option value="41">41 Frames (Faster)</option>
                  <option value="61">61 Frames</option>
                </select>
              </div>
              <div class="setting-item">
                <select id="wanFps">
                  <option value="8">8 FPS</option>
                  <option value="16" selected>16 FPS (Recommended)</option>
                  <option value="24">24 FPS</option>
                </select>
              </div>
              <div class="setting-item">
                <select id="wanSampleSteps">
                  <option value="20">20 Steps (Faster)</option>
                  <option value="30" selected>30 Steps (Recommended)</option>
                  <option value="40">40 Steps (Better Quality)</option>
                </select>
              </div>
              <div class="setting-item full">
                <label style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #0f0f0f; border: 1px solid #2a2a2a; border-radius: 6px; cursor: pointer;">
                  <input type="checkbox" id="wanGoFast" style="width: 16px; height: 16px; cursor: pointer;">
                  <span style="color: #fff; font-size: 0.9rem;">Go Fast (Faster Generation)</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Veo Settings -->
          <div class="section" id="veoSettingsSection" style="display: none;">
            <div class="section-label">Settings</div>
            <div class="settings-grid">
              <div class="setting-item">
                <select id="veoAspectRatio">
                  <option value="16:9" selected>16:9 Landscape</option>
                  <option value="9:16">9:16 Portrait</option>
                </select>
              </div>
              <div class="setting-item">
                <select id="veoResolution">
                  <option value="720p" selected>720p</option>
                  <option value="1080p">1080p (Higher Quality)</option>
                </select>
              </div>
              <div class="setting-item">
                <select id="veoDuration">
                  <option value="4">4 Seconds</option>
                  <option value="8" selected>8 Seconds (Recommended)</option>
                  <option value="12">12 Seconds</option>
                </select>
              </div>
              <div class="setting-item full">
                <label style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #0f0f0f; border: 1px solid #2a2a2a; border-radius: 6px; cursor: pointer;">
                  <input type="checkbox" id="veoGenerateAudio" checked style="width: 16px; height: 16px; cursor: pointer;">
                  <span style="color: #fff; font-size: 0.9rem;">🔊 Generate Audio (Context-Aware)</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Generate Button -->
          <button class="generate-btn" id="videoGenerateBtn" onclick="generateVideo()">
            <span id="videoGenerateText">🎬 Generate Video</span>
          </button>

          <div id="videoErrorContainer"></div>
        </div>
      </div>

      <div class="right-panel">
        <div class="output-header-container">
          <div class="output-header">Generated Videos</div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <button class="selection-mode-toggle" id="videoSelectionToggle" onclick="toggleVideoSelectionMode()">
              ☑️ Select
            </button>
            <div class="zoom-slider-container">
              <span class="zoom-icon">🔍-</span>
              <input type="range" class="zoom-slider" id="videoZoomSlider" min="200" max="500" value="300" oninput="updateVideoGridZoom(this.value)">
              <span class="zoom-icon">🔍+</span>
            </div>
          </div>
        </div>
        <!-- Bulk Action Toolbar for Videos -->
        <div class="bulk-action-toolbar" id="videoBulkToolbar">
          <div class="bulk-action-left">
            <span class="bulk-action-count"><span id="videoSelectedCount">0</span> selected</span>
            <button class="bulk-action-btn select-all" onclick="selectAllVideos()">Select All</button>
            <button class="bulk-action-btn select-all" onclick="deselectAllVideos()">Deselect All</button>
          </div>
          <div class="bulk-action-right">
            <button class="bulk-action-btn download" id="videoBulkDownloadBtn" onclick="bulkDownloadVideos()" disabled>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
              Download
            </button>
            <button class="bulk-action-btn delete" id="videoBulkDeleteBtn" onclick="bulkDeleteVideos()" disabled>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              </svg>
              Delete
            </button>
            <button class="bulk-action-btn cancel" onclick="toggleVideoSelectionMode()">Cancel</button>
          </div>
        </div>
        <div class="output-grid" id="videoOutputGrid">
          <div class="output-placeholder">
            <div class="output-placeholder-icon">🎬</div>
            <div class="output-placeholder-text">
              Your generated videos will appear here<br>
              <span style="color: #666; font-size: 0.85rem;">Configure settings and click Generate to start</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- End Video Tab Section -->

    <!-- Edit Tab Section -->
    <div class="tab-section" id="editSection">
      <div class="left-panel">
        <div class="header">
          <div class="logo-container">
            <div>
              <h1>Image Editing</h1>
              <div class="tagline" id="editToolTagline">Object & Background Removal</div>
            </div>
          </div>
        </div>

        <!-- Edit Tool Selector -->
        <div class="tool-selector-container" style="margin: 16px 20px; display: flex; gap: 8px; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 8px; padding: 4px;">
          <button class="caption-model-tab active" onclick="selectEditTool('eraser')" id="eraserToolTab">
            ✂️ Object Eraser
          </button>
          <button class="caption-model-tab" onclick="selectEditTool('bg-remover')" id="bgRemoverToolTab">
            🎨 Background Remover
          </button>
          <button class="caption-model-tab" onclick="selectEditTool('crop')" id="cropToolTab">
            🖼️ Crop
          </button>
        </div>

        <div class="content">
          <!-- Source Image Upload -->
          <div class="section">
            <div class="section-label">Source Image (Required)</div>
            <input type="file" id="editSourceImageInput" accept="image/*" onchange="handleEditSourceImageUpload(event)">
            <div class="reference-upload" onclick="document.getElementById('editSourceImageInput').click()" id="editImageUploadArea">
              <div class="reference-upload-icon">🖼️</div>
              <div class="reference-upload-text">Click to upload image</div>
              <div class="reference-upload-hint">or drag and drop</div>
            </div>

            <!-- Image Preview (for Background Remover) -->
            <div id="editImagePreview" style="display: none;">
              <div style="position: relative; background: #0a0a0a; border-radius: 8px; overflow: hidden; border: 1px solid #2a2a2a; padding: 12px;">
                <img id="editPreviewImage" src="" alt="Source image" style="display: block; max-width: 100%; max-height: 400px; margin: 0 auto; border-radius: 4px;">
                <button onclick="clearEditImage()" style="position: absolute; top: 20px; right: 20px; padding: 8px 16px; background: rgba(255, 46, 187, 0.9); border: none; border-radius: 6px; color: #fff; cursor: pointer; font-size: 0.85rem; font-weight: 600;">
                  Clear Image
                </button>
              </div>
            </div>
          </div>

          <!-- Canvas for drawing mask (only for Eraser tool) -->
          <div class="section" id="maskCanvasSection" style="display: none;">
            <div class="section-label">Draw Mask - Paint areas to remove</div>
            <div style="font-size: 0.75rem; color: #666; margin-bottom: 8px;">
              Paint over objects you want to remove
            </div>

            <!-- Brush Controls -->
            <div style="margin-bottom: 12px; display: flex; gap: 12px; align-items: center;">
              <div style="flex: 1;">
                <div style="font-size: 0.75rem; color: #888; margin-bottom: 4px;">Brush Size: <span id="brushSizeValue">30</span>px</div>
                <input type="range" id="brushSize" min="5" max="100" value="30" style="width: 100%; cursor: pointer;" oninput="updateBrushSize(this.value)">
              </div>
              <button onclick="clearMask()" style="padding: 8px 16px; background: #2a2a2a; border: 1px solid #444; border-radius: 6px; color: #fff; cursor: pointer; font-size: 0.85rem;">
                Clear Mask
              </button>
              <button onclick="clearEditImage()" style="padding: 8px 16px; background: rgba(255, 46, 187, 0.9); border: none; border-radius: 6px; color: #fff; cursor: pointer; font-size: 0.85rem; font-weight: 600;">
                Clear Image
              </button>
            </div>

            <!-- Canvas Container -->
            <div style="position: relative; background: #0a0a0a; border-radius: 8px; overflow: hidden; border: 1px solid #2a2a2a;">
              <canvas id="maskCanvas" style="display: block; max-width: 100%; cursor: crosshair;"></canvas>
            </div>
          </div>

          <!-- Crop Tool Section (hidden by default) -->
          <div class="section" id="cropSection" style="display: none;">
            <div class="section-label">Crop Image</div>
            <div style="font-size: 0.75rem; color: #666; margin-bottom: 12px;">
              Drag to adjust the crop area, then click Apply Crop
            </div>

            <!-- Aspect Ratio Selector -->
            <div class="settings-grid" style="margin-bottom: 16px;">
              <div class="setting-item">
                <select id="cropAspectRatio" onchange="updateCropAspectRatio()">
                  <option value="free">Free</option>
                  <option value="1">1:1 Square</option>
                  <option value="0.8">4:5 Portrait</option>
                  <option value="1.25">5:4 Landscape</option>
                  <option value="0.75">3:4 Portrait</option>
                  <option value="1.333">4:3 Landscape</option>
                  <option value="0.5625">9:16 Story</option>
                  <option value="1.778">16:9 Widescreen</option>
                </select>
              </div>
              <div class="setting-item">
                <button onclick="resetCrop()" style="width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #444; border-radius: 6px; color: #fff; cursor: pointer; font-size: 0.9rem;">
                  Reset Crop
                </button>
              </div>
            </div>

            <!-- Crop Preview Container -->
            <div id="cropPreviewContainer" style="position: relative; background: #0a0a0a; border-radius: 8px; overflow: hidden; border: 1px solid #2a2a2a; display: none;">
              <img id="cropPreviewImage" src="" alt="Crop preview" style="display: block; max-width: 100%;">
            </div>
          </div>

          <!-- Action Button -->
          <button class="generate-btn" id="editActionBtn" onclick="performEditAction()">
            <span id="editActionText">✨ Remove Object</span>
          </button>

          <!-- Crop Action Button (hidden by default) -->
          <button class="generate-btn" id="cropActionBtn" onclick="applyCrop()" style="display: none;">
            <span id="cropActionText">✂️ Apply Crop</span>
          </button>

          <div id="editErrorContainer"></div>
        </div>
      </div>

      <div class="right-panel">
        <div class="output-header-container">
          <div class="output-header">Edited Images</div>
        </div>
        <div class="output-grid" id="editOutputGrid">
          <div class="output-placeholder">
            <div class="output-placeholder-icon">✨</div>
            <div class="output-placeholder-text">
              Your edited images will appear here<br>
              <span style="color: #666; font-size: 0.85rem;">Upload an image and mask to start</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- End Edit Tab Section -->

    <!-- Inpaint Tab Section -->
    <div class="tab-section" id="inpaintSection">
      <div class="inpaint-container">
        <!-- Main Canvas Area (Left) -->
        <div class="inpaint-canvas-area">
          <div class="inpaint-header">
            <h2>Inpaint</h2>
            <p class="inpaint-subtitle">Paint over areas you want to replace, then describe what should appear</p>
          </div>

          <!-- Canvas Container -->
          <div class="inpaint-canvas-wrapper" id="inpaintCanvasWrapper">
            <div class="inpaint-upload-placeholder" id="inpaintUploadPlaceholder" onclick="document.getElementById('inpaintImageInput').click()">
              <div class="inpaint-upload-icon">🖼️</div>
              <div class="inpaint-upload-text">Click to upload an image</div>
              <div class="inpaint-upload-hint">or drag and drop</div>
            </div>
            <input type="file" id="inpaintImageInput" accept="image/*" onchange="handleInpaintImageUpload(event)" style="display: none;">
            <canvas id="inpaintCanvas" style="display: none;"></canvas>
            <canvas id="inpaintMaskCanvas" style="display: none;"></canvas>
          </div>
        </div>

        <!-- Controls Sidebar (Right) -->
        <div class="inpaint-sidebar">
          <!-- Brush Controls -->
          <div class="inpaint-control-section">
            <div class="inpaint-control-label">Brush Size</div>
            <div class="inpaint-brush-size-container">
              <input type="range" id="inpaintBrushSize" min="5" max="100" value="30" oninput="updateInpaintBrushSize(this.value)">
              <span class="inpaint-brush-size-value" id="inpaintBrushSizeValue">30px</span>
            </div>
            <div class="inpaint-brush-preview" id="inpaintBrushPreview"></div>
          </div>

          <div class="inpaint-control-section">
            <div class="inpaint-button-row">
              <button class="inpaint-btn secondary" onclick="clearInpaintMask()">Clear Mask</button>
              <button class="inpaint-btn secondary" onclick="undoInpaintMask()">Undo</button>
            </div>
            <button class="inpaint-btn secondary" onclick="clearInpaintImage()" style="width: 100%; margin-top: 8px;">Clear Image</button>
          </div>

          <div class="inpaint-divider"></div>

          <!-- Prompt -->
          <div class="inpaint-control-section">
            <div class="inpaint-control-label">Prompt</div>
            <textarea id="inpaintPrompt" class="inpaint-textarea" placeholder="a beautiful woman"></textarea>
          </div>

          <!-- LoRA Selection (SFW only) -->
          <div class="inpaint-control-section" id="inpaintLoraSection">
            <div class="inpaint-control-label">LoRA (Optional)</div>
            <select id="inpaintLoraSelect" class="inpaint-select">
              <option value="">None</option>
            </select>
          </div>

          <!-- Mode Toggle -->
          <div class="inpaint-control-section">
            <div class="inpaint-control-label">Mode</div>
            <div class="inpaint-mode-toggle">
              <button class="inpaint-mode-btn active" id="inpaintSfwBtn" onclick="setInpaintMode('sfw')">SFW</button>
              <button class="inpaint-mode-btn" id="inpaintNsfwBtn" onclick="setInpaintMode('nsfw')">NSFW</button>
            </div>
          </div>

          <!-- Change Intensity -->
          <div class="inpaint-control-section">
            <div class="inpaint-control-label">Change Intensity</div>
            <div class="inpaint-intensity-slider">
              <input type="range" id="inpaintIntensity" min="0" max="100" value="25" oninput="updateInpaintIntensity(this.value)">
            </div>
            <div class="inpaint-intensity-labels">
              <span>Minor</span>
              <span>Major</span>
            </div>
          </div>

          <!-- Number of Generations -->
          <div class="inpaint-control-section">
            <div class="inpaint-control-label">Generations</div>
            <select id="inpaintNumGenerations" class="inpaint-select">
              <option value="1" selected>1 Image</option>
              <option value="2">2 Images</option>
              <option value="3">3 Images</option>
              <option value="4">4 Images</option>
            </select>
          </div>

          <div class="inpaint-divider"></div>

          <!-- Generate Button -->
          <button class="inpaint-generate-btn" id="inpaintGenerateBtn" onclick="generateInpaint()">
            <span class="inpaint-generate-icon">✨</span>
            <span>Generate Inpaint</span>
          </button>

          <!-- Loading State -->
          <div class="inpaint-loading" id="inpaintLoading" style="display: none;">
            <div class="inpaint-spinner"></div>
            <span id="inpaintLoadingText">Generating...</span>
            <div class="inpaint-loading-status" id="inpaintLoadingStatus"></div>
          </div>
        </div>

        <!-- Result Section (Right Panel) -->
        <div class="inpaint-result-section" id="inpaintResultSection">
          <div class="inpaint-result-header">
            <h3>Results</h3>
          </div>
          <div class="inpaint-results-grid" id="inpaintResultsGrid">
            <!-- Placeholder when no results -->
            <div class="inpaint-result-placeholder" id="inpaintResultPlaceholder">
              <div class="inpaint-result-placeholder-icon">✨</div>
              <div class="inpaint-result-placeholder-text">
                Your inpainted images will appear here<br>
                <span style="color: #555; font-size: 0.85rem;">Paint a mask and click Generate</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- End Inpaint Tab Section -->

    <!-- Caption Tab Section -->
    <div class="tab-section" id="captionSection">
      <div class="caption-container">
        <!-- Chat conversation area -->
        <div class="caption-chat-area" id="captionChatArea">
          <div class="caption-welcome">
            <div class="caption-welcome-icon">💬</div>
            <h2 class="caption-welcome-title">AI Chat</h2>
            <p class="caption-welcome-text">Ask me anything, with or without images</p>
          </div>
        </div>

        <!-- Input area at bottom -->
        <div class="caption-input-container">
          <div class="caption-input-wrapper">
            <input type="file" id="captionImageInput" accept="image/*" style="display: none;" onchange="handleCaptionImageUpload(event)">
            <button class="caption-attach-btn" onclick="document.getElementById('captionImageInput').click()" title="Upload image">
              📎
            </button>
            <input
              type="text"
              class="caption-input"
              id="captionInput"
              placeholder="Ask me anything..."
              onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); generateCaption(); }"
            />
            <button class="caption-send-btn" id="captionSendBtn" onclick="generateCaption()">
              ⬆
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- End Caption Tab Section -->

    <!-- Marketplace Tab Section -->
    <div class="tab-section" id="marketplaceSection">
      <div class="marketplace-page">
        <div class="marketplace-header">
          <div class="marketplace-title">AI Character Marketplace</div>
          <div class="marketplace-subtitle">Discover premium AI influencers and characters for your creations</div>
        </div>

        <div class="marketplace-tabs">
          <button class="marketplace-tab active" onclick="switchMarketplaceTab('browse')" id="browseTab">
            🛍️ Browse All
          </button>
          <button class="marketplace-tab" onclick="switchMarketplaceTab('library')" id="libraryTab">
            📚 My Characters
          </button>
          <!-- Admin Add Character Button -->
          <button class="admin-starthere-btn" id="adminCharacterBtn" onclick="openCharacterForm()" style="display: none;">
            <span>➕</span> Add Character
          </button>
        </div>

        <!-- Browse Marketplace -->
        <div id="browseMarketplace">
          <div class="marketplace-grid" id="marketplaceGrid">
            <!-- Loading state shown initially -->
            <div class="marketplace-loading" id="marketplaceLoading" style="grid-column: 1 / -1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; color: #888;">
              <div class="loading-spinner" style="width: 32px; height: 32px; border-width: 3px; margin-bottom: 16px;"></div>
              <div style="font-size: 1rem;">Loading characters...</div>
            </div>
          </div>
        </div>

        <!-- My Characters Library -->
        <div id="myCharactersLibrary" style="display: none;">
          <div class="library-grid" id="libraryGrid">
            <!-- Owned characters will be populated here -->
          </div>
        </div>
      </div>
    </div>
    <!-- End Marketplace Tab Section -->

    <!-- Education Tab Section -->
    <div class="tab-section" id="educationSection">
      <div class="education-page">
        <!-- No Membership State -->
        <div class="education-no-access" id="educationNoAccess">
          <div class="no-access-content">
            <div class="no-access-icon">🎓</div>
            <h2 class="no-access-title">Vixxxen Academy</h2>
            <p class="no-access-subtitle">Learn to create stunning AI influencers with expert guidance</p>

            <div class="membership-tiers">
              <div class="membership-card supernova">
                <div class="membership-badge">⭐</div>
                <h3 class="membership-name">Supernova</h3>
                <div class="membership-price">$49<span>/mo</span></div>
                <ul class="membership-features">
                  <li>✓ Access to Supernova community chat</li>
                  <li>✓ Resource library with tutorials</li>
                  <li>✓ Weekly group Q&A sessions</li>
                  <li>✓ Exclusive prompts & presets</li>
                </ul>
                <button class="membership-btn" onclick="selectMembership('supernova')">
                  <span class="crypto-icon">₿</span> Pay with Crypto
                </button>
              </div>

              <div class="membership-card mentorship featured">
                <div class="membership-popular">Most Popular</div>
                <div class="membership-badge">🚀</div>
                <h3 class="membership-name">Mentorship</h3>
                <div class="membership-price">$199<span>/mo</span></div>
                <ul class="membership-features">
                  <li>✓ Everything in Supernova</li>
                  <li>✓ Private 1-on-1 mentor channel</li>
                  <li>✓ Personalized feedback on your work</li>
                  <li>✓ Priority support & guidance</li>
                  <li>✓ Monthly strategy calls</li>
                </ul>
                <button class="membership-btn primary" onclick="selectMembership('mentorship')">
                  <span class="crypto-icon">₿</span> Pay with Crypto
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Member Content (shown when user has membership) -->
        <div class="education-member-content" id="educationMemberContent" style="display: none;">
          <!-- Sub-tab Navigation -->
          <div class="education-subtabs">
            <div class="education-subtab active" onclick="switchEducationSubtab('starthere')" id="starthereSubtab">
              <span class="education-subtab-icon">🚀</span>
              <span>Start Here</span>
            </div>
            <div class="education-subtab" onclick="switchEducationSubtab('community')" id="communitySubtab">
              <span class="education-subtab-icon">💬</span>
              <span>Community</span>
            </div>
            <div class="education-subtab" onclick="switchEducationSubtab('resources')" id="resourcesSubtab">
              <span class="education-subtab-icon">📚</span>
              <span>Resources</span>
            </div>
            <div class="education-subtab admin-only-tab" onclick="switchEducationSubtab('policies')" id="policiesSubtab" style="display: none;">
              <span class="education-subtab-icon">⚙️</span>
              <span>Admin</span>
            </div>
          </div>

          <!-- Start Here Sub-tab Content -->
          <div class="education-subtab-content active" id="starthereContent">
            <div class="starthere-container">
              <div class="starthere-header">
                <h2 class="starthere-title">Welcome to Vixxxen</h2>
                <p class="starthere-subtitle">Follow these guides to set up your AI influencer business the right way</p>
              </div>

              <div class="starthere-grid" id="starthereGrid">
                <!-- Cards will be loaded dynamically -->
                <div class="resource-empty">
                  <div class="resource-empty-icon">🚀</div>
                  <p>Loading guides...</p>
                </div>
              </div>
            </div>

            <!-- Admin Add Guide Button -->
            <button class="admin-starthere-btn" id="adminStarthereBtn" onclick="openStartHereForm()">
              <span>➕</span> Add Guide
            </button>
          </div>

          <!-- Start Here Form Modal (Add/Edit) -->
          <div class="resource-form-modal" id="starthereFormModal">
            <div class="resource-form-content">
              <div class="resource-form-header">
                <h3 class="resource-form-title" id="starthereFormTitle">Add New Guide</h3>
                <button class="resource-form-close" onclick="closeStartHereForm()">✕</button>
              </div>
              <div class="resource-form-body">
                <form id="starthereForm" onsubmit="saveStartHereGuide(event)">
                  <input type="hidden" id="starthereFormId" value="">

                  <div class="resource-form-group">
                    <label class="resource-form-label">Title *</label>
                    <input type="text" class="resource-form-input" id="starthereFormTitleInput" required placeholder="e.g., How to Create an Instagram Account">
                  </div>

                  <div class="resource-form-group">
                    <label class="resource-form-label">Description</label>
                    <input type="text" class="resource-form-input" id="starthereFormDescription" placeholder="Brief description of what users will learn">
                  </div>

                  <div class="resource-form-row">
                    <div class="resource-form-group">
                      <label class="resource-form-label">Icon (emoji)</label>
                      <input type="text" class="resource-form-input" id="starthereFormIcon" placeholder="📱" maxlength="4">
                    </div>
                    <div class="resource-form-group">
                      <label class="resource-form-label">Duration</label>
                      <input type="text" class="resource-form-input" id="starthereFormDuration" placeholder="e.g., 10 min read">
                    </div>
                  </div>

                  <div class="resource-form-group">
                    <label class="resource-form-label">Sort Order</label>
                    <input type="number" class="resource-form-input" id="starthereFormSortOrder" placeholder="1, 2, 3..." min="0">
                  </div>

                  <div class="resource-form-group">
                    <label class="resource-form-label">Thumbnail Image</label>
                    <div class="resource-thumbnail-upload">
                      <div class="resource-thumbnail-preview" id="starthereThumbnailPreview">
                        <span class="resource-thumbnail-placeholder">📷 No image</span>
                      </div>
                      <div class="resource-thumbnail-actions">
                        <input type="file" id="starthereThumbnailFile" accept="image/*" style="display: none;" onchange="handleStartHereThumbnailUpload(event)">
                        <button type="button" class="resource-form-btn cancel" onclick="document.getElementById('starthereThumbnailFile').click()">
                          📤 Upload Image
                        </button>
                        <span style="color: #666; font-size: 0.85rem;">or</span>
                        <input type="url" class="resource-form-input" id="starthereFormThumbnail" placeholder="Paste image URL" style="flex: 1;">
                      </div>
                    </div>
                  </div>

                  <div class="resource-form-group">
                    <label class="resource-form-label">Content URL (for videos)</label>
                    <input type="url" class="resource-form-input" id="starthereFormContentUrl" placeholder="https://youtube.com/watch?v=...">
                  </div>

                  <div class="resource-form-group">
                    <label class="resource-form-label">Content Body (HTML)</label>
                    <textarea class="resource-form-textarea" id="starthereFormContentBody" placeholder="<h2>Section Title</h2><p>Your content here...</p>"></textarea>
                  </div>

                  <div class="resource-form-actions">
                    <button type="button" class="resource-form-btn delete" id="starthereFormDelete" onclick="deleteStartHereGuide()" style="display: none;">Delete</button>
                    <button type="button" class="resource-form-btn cancel" onclick="closeStartHereForm()">Cancel</button>
                    <button type="submit" class="resource-form-btn save" id="starthereFormSave">Save Guide</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Community Sub-tab Content -->
          <div class="education-subtab-content" id="communityContent">
            <div class="education-chat" id="educationChat">
          <!-- Channel Sidebar -->
          <div class="channel-sidebar">
            <div class="channel-header">
              <div class="channel-tier-badge" id="channelTierBadge">⭐ Supernova</div>
              <button class="admin-members-toggle" id="adminMembersToggle" style="display: none;" onclick="toggleMembersPanel()">
                👥 Members
              </button>
              <button class="admin-channels-toggle" id="adminChannelsToggle" style="display: none;" onclick="openChannelManageModal()">
                ⚙️ Manage Channels
              </button>
            </div>

            <div class="channel-section">
              <div class="channel-section-title">Community</div>
              <div class="channel-list" id="channelList">
                <!-- Channels will be populated dynamically -->
              </div>
            </div>

            <div class="channel-section" id="privateChannelsSection" style="display: none;">
              <div class="channel-section-title">Private Mentorship</div>
              <div class="channel-list" id="privateChannelList">
                <!-- Private mentor channels -->
              </div>
            </div>

            <div class="channel-online">
              <div class="channel-section-title">Online Now</div>
              <div class="online-users-list" id="onlineUsersList">
                <!-- Online users will be populated -->
              </div>
            </div>
          </div>

          <!-- Chat Area -->
          <div class="chat-area">
            <div class="chat-header">
              <button class="chat-back-btn" onclick="closeMobileChat()" title="Back to channels">←</button>
              <div class="chat-header-info">
                <div class="chat-channel-name" id="chatChannelName"># supernova-general</div>
                <div class="chat-channel-desc" id="chatChannelDesc">General chat for Supernova members</div>
              </div>
              <div class="chat-header-actions">
                <button class="chat-call-btn" onclick="startVideoCall()" title="Start Video Call">📹 Call</button>
                <button class="chat-rules-btn" onclick="openRulesModal()">📋 Rules</button>
              </div>
            </div>

            <div class="chat-messages" id="chatMessages">
              <div class="chat-welcome">
                <div class="chat-welcome-icon">👋</div>
                <div class="chat-welcome-title">Welcome to Vixxxen Academy!</div>
                <div class="chat-welcome-text">Select a channel from the sidebar to start chatting with the community.</div>
              </div>
            </div>

            <div class="chat-typing" id="chatTyping" style="display: none;">
              <span id="typingUser">Someone</span> is typing...
            </div>

            <div class="chat-input-area" style="position: relative;">
              <div class="mention-autocomplete" id="mentionAutocomplete"></div>
              <input type="file" id="chatImageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
              <button class="chat-media-btn" onclick="document.getElementById('chatImageInput').click()" title="Upload image">
                📷
              </button>
              <button class="chat-media-btn" onclick="openGiphyModal()" title="Search GIFs">
                GIF
              </button>
              <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." onkeypress="handleChatKeypress(event)" oninput="handleChatInput(event)">
              <button class="chat-send-btn" onclick="sendChatMessage()">
                <span>Send</span>
              </button>
            </div>
          </div>

          <!-- Giphy Search Modal -->
          <div class="giphy-modal" id="giphyModal" style="display: none;">
            <div class="giphy-modal-content">
              <div class="giphy-modal-header">
                <h3>Search GIFs</h3>
                <button class="giphy-modal-close" onclick="closeGiphyModal()">✕</button>
              </div>
              <div class="giphy-search-area">
                <input type="text" class="giphy-search-input" id="giphySearchInput" placeholder="Search for GIFs..." onkeyup="handleGiphySearch(event)">
              </div>
              <div class="giphy-results" id="giphyResults">
                <div class="giphy-trending-label">Trending</div>
              </div>
              <div class="giphy-attribution">
                Powered by GIPHY
              </div>
            </div>
          </div>

          <!-- Admin Members Panel -->
          <div class="members-panel" id="membersPanel" style="display: none;">
            <div class="members-panel-header">
              <h3>All Members</h3>
              <button class="members-panel-close" onclick="toggleMembersPanel()">✕</button>
            </div>
            <div class="members-panel-stats" id="membersPanelStats">
              <div class="member-stat">
                <span class="stat-value" id="totalMembersCount">0</span>
                <span class="stat-label">Total</span>
              </div>
              <div class="member-stat">
                <span class="stat-value" id="onlineMembersCount">0</span>
                <span class="stat-label">Online</span>
              </div>
              <div class="member-stat">
                <span class="stat-value" id="mentorshipCount">0</span>
                <span class="stat-label">Mentorship</span>
              </div>
            </div>
            <div class="members-list" id="membersList">
              <!-- Members will be populated here -->
            </div>
          </div>

          <!-- Channel Management Modal -->
          <div class="channel-manage-modal" id="channelManageModal" style="display: none;">
            <div class="channel-manage-content">
              <div class="channel-manage-header">
                <h3>Manage Channels</h3>
                <button class="channel-manage-close" onclick="closeChannelManageModal()">✕</button>
              </div>
              <div class="channel-manage-body">
                <div class="channel-add-form">
                  <input type="text" id="newChannelName" placeholder="Channel name (e.g. general-chat)">
                  <input type="text" id="newChannelDescription" placeholder="Channel description">
                  <div class="channel-add-row">
                    <select id="newChannelTier">
                      <option value="">No tier required (public)</option>
                      <option value="supernova">Supernova only</option>
                      <option value="mentorship">Mentorship only</option>
                    </select>
                    <button class="channel-add-btn" onclick="addNewChannel()">Add Channel</button>
                  </div>
                </div>
                <div class="channel-list-manage">
                  <div class="channel-list-manage-title">Existing Channels</div>
                  <div id="channelManageList">
                    <!-- Channels will be listed here -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
          </div>
          <!-- End Community Sub-tab Content -->

          <!-- Resources Sub-tab Content -->
          <div class="education-subtab-content" id="resourcesContent">
            <div class="resource-library">
              <!-- No Access Overlay (shown for non-subscribers viewing resources) -->
              <div class="resource-no-access-overlay" id="resourceNoAccessOverlay" style="display: none;">
                <div class="resource-no-access-content">
                  <div class="resource-no-access-icon">🔒</div>
                  <div class="resource-no-access-title">Unlock the Resource Library</div>
                  <div class="resource-no-access-text">Get access to tutorials, guides, and exclusive video content by subscribing to Vixxxen Academy.</div>
                  <button class="resource-upgrade-btn" onclick="switchEducationSubtab('community'); document.getElementById('educationNoAccess').style.display = 'flex'; document.getElementById('educationMemberContent').style.display = 'none';">
                    View Membership Options
                  </button>
                </div>
              </div>

              <!-- Filters -->
              <div class="resource-filters">
                <div class="resource-filter-row">
                  <span class="resource-filter-label">Type:</span>
                  <button class="resource-filter-btn active" onclick="filterResources('type', 'all')" data-filter="type" data-value="all">All</button>
                  <button class="resource-filter-btn" onclick="filterResources('type', 'tutorial')" data-filter="type" data-value="tutorial">Tutorials</button>
                  <button class="resource-filter-btn" onclick="filterResources('type', 'guide')" data-filter="type" data-value="guide">Guides</button>
                  <button class="resource-filter-btn" onclick="filterResources('type', 'video')" data-filter="type" data-value="video">Videos</button>
                </div>
                <div class="resource-filter-row">
                  <span class="resource-filter-label">Topic:</span>
                  <button class="resource-filter-btn active" onclick="filterResources('topic', 'all')" data-filter="topic" data-value="all">All</button>
                  <button class="resource-filter-btn" onclick="filterResources('topic', 'prompts')" data-filter="topic" data-value="prompts">Prompts</button>
                  <button class="resource-filter-btn" onclick="filterResources('topic', 'techniques')" data-filter="topic" data-value="techniques">Techniques</button>
                  <button class="resource-filter-btn" onclick="filterResources('topic', 'tools')" data-filter="topic" data-value="tools">Tools</button>
                  <button class="resource-filter-btn" onclick="filterResources('topic', 'business')" data-filter="topic" data-value="business">Business</button>
                </div>
              </div>

              <!-- Resource Grid -->
              <div class="resource-grid-container">
                <div class="resource-grid" id="resourceGrid">
                  <!-- Resources will be populated dynamically -->
                  <div class="resource-empty" id="resourceEmpty">
                    <div class="resource-empty-icon">📚</div>
                    <p>Loading resources...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- End Resources Sub-tab Content -->

          <!-- Policies Sub-tab Content (Admin Only) -->
          <div class="education-subtab-content" id="policiesContent">
            <div class="admin-panel-layout">
              <!-- Admin Sidebar -->
              <div class="admin-sidebar">
                <div class="admin-sidebar-header">
                  <h3 class="admin-sidebar-title">Admin Panel</h3>
                </div>
                <nav class="admin-sidebar-nav">
                  <div class="admin-nav-item active" onclick="switchAdminSection('analytics')" data-section="analytics">
                    <span class="admin-nav-icon">📊</span>
                    <span>Analytics</span>
                  </div>
                  <div class="admin-nav-item" onclick="switchAdminSection('gpu')" data-section="gpu">
                    <span class="admin-nav-icon">⚡</span>
                    <span>GPU Config</span>
                  </div>
                  <div class="admin-nav-item" onclick="switchAdminSection('reports')" data-section="reports">
                    <span class="admin-nav-icon">🚨</span>
                    <span>Reports</span>
                    <span class="admin-nav-badge" id="adminReportsBadge" style="display: none;">0</span>
                  </div>
                  <div class="admin-nav-item" onclick="switchAdminSection('image-moderation')" data-section="image-moderation">
                    <span class="admin-nav-icon">🖼️</span>
                    <span>Image Moderation</span>
                    <span class="admin-nav-badge" id="imageModerationBadge" style="display: none;">0</span>
                  </div>
                  <div class="admin-nav-item" onclick="switchAdminSection('policies')" data-section="policies">
                    <span class="admin-nav-icon">📜</span>
                    <span>Policies</span>
                  </div>
                  <div class="admin-nav-item" onclick="switchAdminSection('content-filter')" data-section="content-filter">
                    <span class="admin-nav-icon">🚫</span>
                    <span>Content Filter</span>
                  </div>
                  <div class="admin-nav-item" onclick="switchAdminSection('characters')" data-section="characters">
                    <span class="admin-nav-icon">👤</span>
                    <span>Characters</span>
                  </div>
                  <div class="admin-nav-item" onclick="switchAdminSection('user-services')" data-section="user-services">
                    <span class="admin-nav-icon">🎁</span>
                    <span>User Services</span>
                  </div>
                  <div class="admin-nav-item" onclick="switchAdminSection('onboarding')" data-section="onboarding">
                    <span class="admin-nav-icon">🚀</span>
                    <span>Onboarding</span>
                  </div>
                  <div class="admin-nav-item" onclick="switchAdminSection('custom-orders')" data-section="custom-orders">
                    <span class="admin-nav-icon">🎨</span>
                    <span>Custom Orders</span>
                    <span class="admin-nav-badge" id="customOrdersBadge" style="display: none;">0</span>
                  </div>
                  <div class="admin-nav-item" onclick="switchAdminSection('landing-page')" data-section="landing-page">
                    <span class="admin-nav-icon">🏠</span>
                    <span>Landing Page</span>
                  </div>
                </nav>
              </div>

              <!-- Admin Content Area -->
              <div class="admin-content-area">
                <!-- Analytics Section -->
                <div class="admin-section active" id="adminAnalyticsSection">
                  <div class="admin-section-header">
                    <h2 class="admin-section-title">Analytics Dashboard</h2>
                    <p class="admin-section-subtitle">Platform metrics and usage statistics</p>
                  </div>

                  <!-- Analytics Sub-tabs -->
                  <div class="analytics-subtabs" style="display: flex; gap: 8px; margin-bottom: 24px; justify-content: center;">
                    <button class="analytics-subtab active" onclick="switchAnalyticsSubtab('platform')" id="platformSubtab">
                      📊 Platform Stats
                    </button>
                    <button class="analytics-subtab" onclick="switchAnalyticsSubtab('user')" id="userSubtab">
                      👥 User Analytics
                    </button>
                  </div>

                  <!-- Platform Stats Content -->
                  <div class="analytics-subtab-content active" id="platformStatsContent">

                <!-- Live Users Widget -->
                <div class="live-users-widget" id="liveUsersWidget">
                  <div class="live-users-header">
                    <div class="live-users-pulse"></div>
                    <span class="live-users-count" id="liveUsersCount">0</span>
                    <span class="live-users-label">users online now</span>
                  </div>
                  <div class="live-users-countries" id="liveUsersCountries">
                    <span class="live-users-loading">Loading...</span>
                  </div>
                </div>

                <!-- Summary Cards -->
                <div class="analytics-cards">
                  <div class="analytics-card">
                    <div class="analytics-card-icon">👥</div>
                    <div class="analytics-card-value" id="analyticsUserCount">-</div>
                    <div class="analytics-card-label">Total Users</div>
                  </div>
                  <div class="analytics-card">
                    <div class="analytics-card-icon">🖼️</div>
                    <div class="analytics-card-value" id="analyticsImageCount">-</div>
                    <div class="analytics-card-label">Images Generated</div>
                  </div>
                  <div class="analytics-card">
                    <div class="analytics-card-icon">🎬</div>
                    <div class="analytics-card-value" id="analyticsVideoCount">-</div>
                    <div class="analytics-card-label">Videos Generated</div>
                  </div>
                  <div class="analytics-card">
                    <div class="analytics-card-icon">📅</div>
                    <div class="analytics-card-value" id="analyticsTodayCount">-</div>
                    <div class="analytics-card-label">Generated Today</div>
                  </div>
                </div>

                <!-- Charts Row -->
                <div class="analytics-charts">
                  <div class="analytics-chart-container">
                    <h3 class="analytics-chart-title">Generation Trend (Last 7 Days)</h3>
                    <canvas id="generationTrendChart"></canvas>
                  </div>
                  <div class="analytics-chart-container">
                    <h3 class="analytics-chart-title">Model Usage</h3>
                    <canvas id="modelUsageChart"></canvas>
                  </div>
                </div>

                <!-- Serverless GPU Usage Section -->
                <h3 class="analytics-section-title">Serverless GPU Usage (Qwen + Inpaint)</h3>

                <!-- Hourly Bar Chart -->
                <div class="analytics-full-width">
                  <div class="analytics-chart-container">
                    <h3 class="analytics-chart-title">Generations by Hour of Day (Mountain Time)</h3>
                    <canvas id="serverlessHourlyChart"></canvas>
                  </div>
                </div>

                <!-- Weekly Heatmap -->
                <div class="analytics-full-width">
                  <div class="heatmap-container">
                    <h3 class="analytics-chart-title">Weekly Usage Heatmap (Last 7 Days)</h3>
                    <div class="heatmap-grid" id="serverlessHeatmap">
                      <!-- Header row with hours -->
                      <div class="heatmap-header"></div>
                      <!-- Hours 0-23 will be rendered by JS -->
                    </div>
                    <div class="heatmap-legend">
                      <span>Less</span>
                      <div class="heatmap-legend-item" style="background: rgba(157, 78, 221, 0.05);"></div>
                      <div class="heatmap-legend-item" style="background: rgba(157, 78, 221, 0.2);"></div>
                      <div class="heatmap-legend-item" style="background: rgba(157, 78, 221, 0.4);"></div>
                      <div class="heatmap-legend-item" style="background: rgba(157, 78, 221, 0.6);"></div>
                      <div class="heatmap-legend-item" style="background: rgba(255, 46, 187, 0.7);"></div>
                      <div class="heatmap-legend-item" style="background: rgba(255, 46, 187, 0.9);"></div>
                      <span>More</span>
                    </div>
                  </div>
                </div>
                <div class="heatmap-tooltip" id="heatmapTooltip"></div>

                <!-- Refresh Button -->
                <div style="text-align: center; margin-top: 20px;">
                  <button onclick="loadAnalyticsDashboard()" style="padding: 10px 24px; background: linear-gradient(135deg, #9d4edd, #ff2ebb); border: none; border-radius: 8px; color: #fff; cursor: pointer; font-weight: 500;">
                    🔄 Refresh Analytics
                  </button>
                </div>
                  </div>
                  <!-- End Platform Stats Content -->

                  <!-- User Analytics Content -->
                  <div class="analytics-subtab-content" id="userAnalyticsContent" style="display: none;">

                    <!-- Date Range Selector -->
                    <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                      <select id="userAnalyticsDateRange" onchange="loadUserAnalytics()" style="padding: 8px 16px; background: #1a1a1a; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 8px; color: #fff; font-size: 0.9rem; cursor: pointer;">
                        <option value="7">Last 7 Days</option>
                        <option value="14">Last 14 Days</option>
                        <option value="30" selected>Last 30 Days</option>
                        <option value="90">Last 90 Days</option>
                      </select>
                    </div>

                    <!-- User Analytics Summary Cards -->
                    <div class="analytics-cards">
                      <div class="analytics-card">
                        <div class="analytics-card-icon">📈</div>
                        <div class="analytics-card-value" id="uaTotalEvents">-</div>
                        <div class="analytics-card-label">Total Events</div>
                      </div>
                      <div class="analytics-card">
                        <div class="analytics-card-icon">👤</div>
                        <div class="analytics-card-value" id="uaUniqueUsers">-</div>
                        <div class="analytics-card-label">Unique Users</div>
                      </div>
                      <div class="analytics-card">
                        <div class="analytics-card-icon">🚀</div>
                        <div class="analytics-card-value" id="uaOnboardingRate">-</div>
                        <div class="analytics-card-label">Onboarding Rate</div>
                      </div>
                      <div class="analytics-card">
                        <div class="analytics-card-icon">💳</div>
                        <div class="analytics-card-value" id="uaConversionRate">-</div>
                        <div class="analytics-card-label">Trial Conversion</div>
                      </div>
                    </div>

                    <!-- Funnels Section -->
                    <h3 class="analytics-section-title" style="margin-top: 32px;">Conversion Funnels</h3>

                    <div class="analytics-charts">
                      <!-- Onboarding Funnel -->
                      <div class="analytics-chart-container">
                        <h3 class="analytics-chart-title">Onboarding Funnel</h3>
                        <div class="funnel-container" id="onboardingFunnel">
                          <div class="funnel-loading">Loading funnel data...</div>
                        </div>
                      </div>

                      <!-- Trial Funnel -->
                      <div class="analytics-chart-container">
                        <h3 class="analytics-chart-title">Trial Funnel</h3>
                        <div class="funnel-container" id="trialFunnel">
                          <div class="funnel-loading">Loading funnel data...</div>
                        </div>
                      </div>

                      <!-- Signup to Value Funnel -->
                      <div class="analytics-chart-container">
                        <h3 class="analytics-chart-title">Signup → Value Funnel</h3>
                        <div class="funnel-container" id="signupToValueFunnel">
                          <div class="funnel-loading">Loading funnel data...</div>
                        </div>
                      </div>
                    </div>

                    <!-- First Generation Metrics -->
                    <h3 class="analytics-section-title" style="margin-top: 32px;">First Generation Metrics</h3>
                    <div class="analytics-full-width">
                      <div class="analytics-chart-container" id="firstGenMetricsContainer">
                        <div class="funnel-loading">Loading first generation data...</div>
                      </div>
                    </div>

                    <!-- Daily Activity Chart -->
                    <h3 class="analytics-section-title" style="margin-top: 32px;">Daily Activity</h3>
                    <div class="analytics-full-width">
                      <div class="analytics-chart-container">
                        <h3 class="analytics-chart-title">Events & Users Over Time</h3>
                        <canvas id="dailyActivityChart"></canvas>
                      </div>
                    </div>

                    <!-- Events by Category -->
                    <h3 class="analytics-section-title" style="margin-top: 32px;">Events by Category</h3>
                    <div class="analytics-charts">
                      <div class="analytics-chart-container">
                        <h3 class="analytics-chart-title">Event Distribution</h3>
                        <canvas id="eventCategoryChart"></canvas>
                      </div>
                      <div class="analytics-chart-container">
                        <h3 class="analytics-chart-title">Top Events</h3>
                        <div class="top-events-list" id="topEventsList">
                          <div class="funnel-loading">Loading events...</div>
                        </div>
                      </div>
                    </div>

                    <!-- Session Stats Section -->
                    <div style="margin-top: 32px;">
                      <h3 style="font-size: 1.1rem; color: #fff; margin-bottom: 16px; font-weight: 600;">Session Analytics</h3>
                      <div class="analytics-chart-container" id="sessionStatsContainer">
                        <div class="funnel-loading">Loading session data...</div>
                      </div>
                    </div>

                    <!-- Retention Cohorts Section -->
                    <div style="margin-top: 32px;">
                      <h3 style="font-size: 1.1rem; color: #fff; margin-bottom: 16px; font-weight: 600;">User Retention</h3>
                      <div class="analytics-chart-container" id="retentionTableContainer">
                        <div class="funnel-loading">Loading retention data...</div>
                      </div>
                    </div>

                    <!-- Device Breakdown Section -->
                    <div style="margin-top: 32px;">
                      <h3 style="font-size: 1.1rem; color: #fff; margin-bottom: 16px; font-weight: 600;">Device Breakdown</h3>
                      <div class="analytics-chart-container" id="deviceBreakdownContainer">
                        <div class="funnel-loading">Loading device data...</div>
                      </div>
                    </div>

                    <!-- Refresh Button -->
                    <div style="text-align: center; margin-top: 20px;">
                      <button onclick="loadUserAnalytics()" style="padding: 10px 24px; background: linear-gradient(135deg, #9d4edd, #ff2ebb); border: none; border-radius: 8px; color: #fff; cursor: pointer; font-weight: 500;">
                        🔄 Refresh User Analytics
                      </button>
                    </div>
                  </div>
                  <!-- End User Analytics Content -->

                </div>
                <!-- End Analytics Section -->

                <!-- GPU Configuration Section -->
                <div class="admin-section" id="adminGpuSection">
                  <div class="admin-section-header">
                    <h2 class="admin-section-title">GPU Configuration</h2>
                    <p class="admin-section-subtitle">Manage GPU routing between dedicated and serverless infrastructure</p>
                  </div>

                <!-- GPU Status Cards -->
                <div class="gpu-status-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; max-width: 900px; margin-left: auto; margin-right: auto;">
                  <div class="report-stat-card" style="background: linear-gradient(135deg, rgba(157, 78, 221, 0.1), rgba(157, 78, 221, 0.05)); border: 1px solid rgba(157, 78, 221, 0.2); padding: 20px; border-radius: 16px; text-align: center;">
                    <div style="font-size: 1.3rem; margin-bottom: 8px;">🔀</div>
                    <div class="report-stat-value" id="gpuModeDisplay" style="font-size: 1.2rem; font-weight: 700; color: #9d4edd; text-transform: capitalize;">-</div>
                    <div class="report-stat-label" style="color: #888; font-size: 0.85rem; font-weight: 500;">Current Mode</div>
                  </div>
                  <div class="report-stat-card" style="background: linear-gradient(135deg, rgba(0, 178, 255, 0.1), rgba(0, 178, 255, 0.05)); border: 1px solid rgba(0, 178, 255, 0.2); padding: 20px; border-radius: 16px; text-align: center;">
                    <div style="font-size: 1.3rem; margin-bottom: 8px;">☁️</div>
                    <div class="report-stat-value" id="serverlessStatusDisplay" style="font-size: 1rem; font-weight: 700; color: #00b2ff;">-</div>
                    <div class="report-stat-label" style="color: #888; font-size: 0.85rem; font-weight: 500;">Serverless</div>
                  </div>
                  <div class="report-stat-card" style="background: linear-gradient(135deg, rgba(74, 222, 128, 0.1), rgba(74, 222, 128, 0.05)); border: 1px solid rgba(74, 222, 128, 0.2); padding: 20px; border-radius: 16px; text-align: center;">
                    <div style="font-size: 1.3rem; margin-bottom: 8px;">🖥️</div>
                    <div class="report-stat-value" id="dedicatedStatusDisplay" style="font-size: 1rem; font-weight: 700; color: #4ade80;">-</div>
                    <div class="report-stat-label" style="color: #888; font-size: 0.85rem; font-weight: 500;">Dedicated</div>
                  </div>
                </div>

                <!-- GPU Config Form -->
                <div class="gpu-config-form" style="max-width: 600px; margin: 0 auto; padding: 24px; background: rgba(255,255,255,0.02); border-radius: 16px; border: 1px solid var(--border-color);">
                  <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9rem; font-weight: 500;">Routing Mode</label>
                    <select id="gpuModeSelect" style="width: 100%; padding: 12px 16px; background: #1a1a1a; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 10px; color: #fff; font-size: 0.95rem; cursor: pointer;">
                      <option value="serverless">Serverless Only</option>
                      <option value="dedicated">Dedicated Only</option>
                      <option value="hybrid">Hybrid (Dedicated first, Serverless fallback)</option>
                      <option value="serverless-primary">Serverless Primary (Dedicated fallback)</option>
                    </select>
                    <p style="margin-top: 8px; font-size: 0.8rem; color: #666;">
                      <strong>Hybrid:</strong> Uses dedicated GPU, falls back to serverless if unavailable<br>
                      <strong>Serverless Primary:</strong> Uses serverless, falls back to dedicated if needed
                    </p>
                  </div>

                  <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9rem; font-weight: 500;">Dedicated GPU URL</label>
                    <input type="text" id="gpuDedicatedUrl" placeholder="https://your-pod-id-3000.proxy.runpod.net" style="width: 100%; padding: 12px 16px; background: #1a1a1a; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 10px; color: #fff; font-size: 0.95rem; box-sizing: border-box;">
                  </div>

                  <div style="margin-bottom: 24px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9rem; font-weight: 500;">Timeout (ms)</label>
                    <input type="number" id="gpuTimeout" value="5000" min="1000" max="30000" step="1000" style="width: 100%; padding: 12px 16px; background: #1a1a1a; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 10px; color: #fff; font-size: 0.95rem; box-sizing: border-box;">
                    <p style="margin-top: 8px; font-size: 0.8rem; color: #666;">How long to wait for dedicated GPU before falling back (1000-30000ms)</p>
                  </div>

                  <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button onclick="testGpuEndpoint()" style="flex: 1; min-width: 120px; padding: 12px 20px; background: linear-gradient(135deg, rgba(0, 178, 255, 0.2), rgba(0, 178, 255, 0.1)); border: 1px solid rgba(0, 178, 255, 0.3); border-radius: 10px; color: #00b2ff; cursor: pointer; font-weight: 500; font-size: 0.9rem; transition: all 0.2s;">
                      🧪 Test Connection
                    </button>
                    <button onclick="saveGpuConfig()" style="flex: 1; min-width: 120px; padding: 12px 20px; background: linear-gradient(135deg, #9d4edd, #ff2ebb); border: none; border-radius: 10px; color: #fff; cursor: pointer; font-weight: 500; font-size: 0.9rem; transition: all 0.2s;">
                      💾 Save Configuration
                    </button>
                    <button onclick="loadGpuConfigInline()" style="flex: 1; min-width: 120px; padding: 12px 20px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-secondary); cursor: pointer; font-weight: 500; font-size: 0.9rem; transition: all 0.2s;">
                      🔄 Refresh
                    </button>
                  </div>

                  <div id="gpuTestResult" style="margin-top: 16px; padding: 12px 16px; border-radius: 10px; display: none;"></div>
                </div>

                <!-- GPU Warmup Section -->
                <div style="margin-top: 32px; max-width: 600px; margin-left: auto; margin-right: auto;">
                  <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 16px; color: var(--text-primary);">Model Warmup</h3>
                  <div style="padding: 20px; background: rgba(255,255,255,0.02); border-radius: 16px; border: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                      <div id="warmupStatusDot" style="width: 10px; height: 10px; border-radius: 50%; background: #666; flex-shrink: 0;"></div>
                      <div>
                        <div id="warmupStatusText" style="font-weight: 500; color: var(--text-primary);">Unknown</div>
                        <div id="warmupStatusSubtext" style="font-size: 0.8rem; color: #888; margin-top: 2px;">Check status to see current state</div>
                      </div>
                    </div>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                      <button onclick="checkWarmupStatus()" style="flex: 1; min-width: 120px; padding: 12px 20px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-secondary); cursor: pointer; font-weight: 500; font-size: 0.9rem;">
                        🔍 Check Status
                      </button>
                      <button onclick="triggerWarmup()" id="warmupTriggerBtn" style="flex: 1; min-width: 120px; padding: 12px 20px; background: linear-gradient(135deg, rgba(255, 165, 0, 0.2), rgba(255, 165, 0, 0.1)); border: 1px solid rgba(255, 165, 0, 0.3); border-radius: 10px; color: #ffa500; cursor: pointer; font-weight: 500; font-size: 0.9rem;">
                        🔥 Trigger Warmup
                      </button>
                    </div>
                    <div id="warmupResult" style="margin-top: 16px; padding: 12px 16px; border-radius: 10px; display: none;"></div>
                  </div>
                </div>
                </div>
                <!-- End GPU Configuration Section -->

                <!-- Reports Section -->
                <div class="admin-section" id="adminReportsSection">
                  <div class="admin-section-header">
                    <h2 class="admin-section-title">Content Reports</h2>
                    <p class="admin-section-subtitle">Review and moderate reported content</p>
                  </div>

                <div class="reports-stats" id="reportsStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; max-width: 900px; margin-left: auto; margin-right: auto;">
                  <div class="report-stat-card" style="background: linear-gradient(135deg, rgba(255, 165, 0, 0.1), rgba(255, 165, 0, 0.05)); border: 1px solid rgba(255, 165, 0, 0.2); padding: 24px; border-radius: 16px; text-align: center; transition: transform 0.2s, border-color 0.2s;">
                    <div style="font-size: 1.5rem; margin-bottom: 8px;">🕐</div>
                    <div class="report-stat-value" id="pendingReportsCount" style="font-size: 2.2rem; font-weight: 700; color: #ffa500;">0</div>
                    <div class="report-stat-label" style="color: #888; font-size: 0.85rem; font-weight: 500;">Pending</div>
                  </div>
                  <div class="report-stat-card" style="background: linear-gradient(135deg, rgba(0, 178, 255, 0.1), rgba(0, 178, 255, 0.05)); border: 1px solid rgba(0, 178, 255, 0.2); padding: 24px; border-radius: 16px; text-align: center; transition: transform 0.2s, border-color 0.2s;">
                    <div style="font-size: 1.5rem; margin-bottom: 8px;">🔍</div>
                    <div class="report-stat-value" id="reviewingReportsCount" style="font-size: 2.2rem; font-weight: 700; color: #00b2ff;">0</div>
                    <div class="report-stat-label" style="color: #888; font-size: 0.85rem; font-weight: 500;">Reviewing</div>
                  </div>
                  <div class="report-stat-card" style="background: linear-gradient(135deg, rgba(74, 222, 128, 0.1), rgba(74, 222, 128, 0.05)); border: 1px solid rgba(74, 222, 128, 0.2); padding: 24px; border-radius: 16px; text-align: center; transition: transform 0.2s, border-color 0.2s;">
                    <div style="font-size: 1.5rem; margin-bottom: 8px;">✅</div>
                    <div class="report-stat-value" id="resolvedReportsCount" style="font-size: 2.2rem; font-weight: 700; color: #4ade80;">0</div>
                    <div class="report-stat-label" style="color: #888; font-size: 0.85rem; font-weight: 500;">Resolved</div>
                  </div>
                  <div class="report-stat-card" style="background: linear-gradient(135deg, rgba(255, 68, 68, 0.1), rgba(255, 68, 68, 0.05)); border: 1px solid rgba(255, 68, 68, 0.2); padding: 24px; border-radius: 16px; text-align: center; transition: transform 0.2s, border-color 0.2s;">
                    <div style="font-size: 1.5rem; margin-bottom: 8px;">🚫</div>
                    <div class="report-stat-value" id="autoHiddenCount" style="font-size: 2.2rem; font-weight: 700; color: #ff4444;">0</div>
                    <div class="report-stat-label" style="color: #888; font-size: 0.85rem; font-weight: 500;">Auto-Hidden</div>
                  </div>
                </div>

                <div class="reports-filters" style="display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; justify-content: center; align-items: center; padding: 16px; background: rgba(255,255,255,0.02); border-radius: 12px; max-width: 600px; margin-left: auto; margin-right: auto;">
                  <select id="reportStatusFilter" onchange="loadAdminReports()" style="padding: 12px 20px; background: #1a1a1a; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 10px; color: #fff; font-size: 0.9rem; cursor: pointer; min-width: 150px;">
                    <option value="">All Statuses</option>
                    <option value="pending" selected>Pending</option>
                    <option value="reviewing">Reviewing</option>
                    <option value="resolved">Resolved</option>
                    <option value="dismissed">Dismissed</option>
                  </select>
                  <select id="reportTypeFilter" onchange="loadAdminReports()" style="padding: 12px 20px; background: #1a1a1a; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 10px; color: #fff; font-size: 0.9rem; cursor: pointer; min-width: 150px;">
                    <option value="">All Types</option>
                    <option value="image">Images</option>
                    <option value="video">Videos</option>
                    <option value="audio">Audio</option>
                    <option value="chat_message">Chat Messages</option>
                  </select>
                  <button onclick="loadAdminReports()" style="padding: 12px 24px; background: linear-gradient(135deg, #9d4edd, #ff2ebb); border: none; border-radius: 10px; color: #fff; cursor: pointer; font-weight: 500; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; transition: transform 0.2s, box-shadow 0.2s;">
                    🔄 Refresh
                  </button>
                </div>

                <div class="reports-list" id="reportsList" style="display: flex; flex-direction: column; gap: 12px; max-width: 900px; margin: 0 auto;">
                  <div class="reports-empty-state" style="text-align: center; padding: 60px 20px; background: linear-gradient(135deg, rgba(74, 222, 128, 0.05), rgba(74, 222, 128, 0.02)); border: 1px solid rgba(74, 222, 128, 0.15); border-radius: 16px;">
                    <div style="font-size: 4rem; margin-bottom: 16px;">✅</div>
                    <div style="font-size: 1.3rem; font-weight: 600; color: #4ade80; margin-bottom: 8px;">All Clear!</div>
                    <div style="color: #888; font-size: 0.95rem;">No content reports to review at this time.</div>
                  </div>
                </div>
                </div>
                <!-- End Reports Section -->

                <!-- Image Moderation Section -->
                <div class="admin-section" id="adminImageModerationSection">
                  <div class="admin-section-header">
                    <h2 class="admin-section-title">Image Moderation Queue</h2>
                    <p class="admin-section-subtitle">Review flagged images and user appeals</p>
                  </div>

                  <!-- Stats Row -->
                  <div class="moderation-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div class="report-stat-card" style="background: linear-gradient(135deg, rgba(255, 165, 0, 0.1), rgba(255, 165, 0, 0.05)); border: 1px solid rgba(255, 165, 0, 0.2); padding: 20px; border-radius: 16px; text-align: center;">
                      <div style="font-size: 1.3rem; margin-bottom: 8px;">⏳</div>
                      <div class="report-stat-value" id="modStatPending" style="font-size: 2rem; font-weight: 700; color: #ffa500;">0</div>
                      <div class="report-stat-label" style="color: #888; font-size: 0.85rem; font-weight: 500;">Pending Review</div>
                    </div>
                    <div class="report-stat-card" style="background: linear-gradient(135deg, rgba(255, 46, 187, 0.1), rgba(255, 46, 187, 0.05)); border: 1px solid rgba(255, 46, 187, 0.2); padding: 20px; border-radius: 16px; text-align: center;">
                      <div style="font-size: 1.3rem; margin-bottom: 8px;">📝</div>
                      <div class="report-stat-value" id="modStatAppeals" style="font-size: 2rem; font-weight: 700; color: #ff2ebb;">0</div>
                      <div class="report-stat-label" style="color: #888; font-size: 0.85rem; font-weight: 500;">With Appeals</div>
                    </div>
                    <div class="report-stat-card" style="background: linear-gradient(135deg, rgba(74, 222, 128, 0.1), rgba(74, 222, 128, 0.05)); border: 1px solid rgba(74, 222, 128, 0.2); padding: 20px; border-radius: 16px; text-align: center;">
                      <div style="font-size: 1.3rem; margin-bottom: 8px;">✅</div>
                      <div class="report-stat-value" id="modStatApproved" style="font-size: 2rem; font-weight: 700; color: #4ade80;">0</div>
                      <div class="report-stat-label" style="color: #888; font-size: 0.85rem; font-weight: 500;">Approved (Manual)</div>
                    </div>
                    <div class="report-stat-card" style="background: linear-gradient(135deg, rgba(255, 68, 68, 0.1), rgba(255, 68, 68, 0.05)); border: 1px solid rgba(255, 68, 68, 0.2); padding: 20px; border-radius: 16px; text-align: center;">
                      <div style="font-size: 1.3rem; margin-bottom: 8px;">❌</div>
                      <div class="report-stat-value" id="modStatRejected" style="font-size: 2rem; font-weight: 700; color: #ff4444;">0</div>
                      <div class="report-stat-label" style="color: #888; font-size: 0.85rem; font-weight: 500;">Rejected (Total)</div>
                    </div>
                  </div>

                  <!-- Filter and Bulk Actions -->
                  <div class="moderation-controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
                    <div class="moderation-filters" style="display: flex; gap: 8px; flex-wrap: wrap;">
                      <button class="mod-filter-btn active" data-filter="all" onclick="filterModerationQueue('all')">All Pending</button>
                      <button class="mod-filter-btn" data-filter="appeals" onclick="filterModerationQueue('appeals')">With Appeals</button>
                      <button class="mod-filter-btn" data-filter="celebrity" onclick="filterModerationQueue('celebrity')">Celebrity Flags</button>
                      <button class="mod-filter-btn" data-filter="minor" onclick="filterModerationQueue('minor')">Minor Flags</button>
                    </div>
                    <div class="moderation-bulk-actions" style="display: flex; gap: 8px;">
                      <button class="mod-bulk-btn approve" onclick="bulkApproveModerationImages()" disabled id="bulkApproveBtn">
                        ✅ Approve Selected (<span id="selectedCount">0</span>)
                      </button>
                      <button class="mod-bulk-btn reject" onclick="bulkRejectModerationImages()" disabled id="bulkRejectBtn">
                        ❌ Reject Selected
                      </button>
                    </div>
                  </div>

                  <!-- Queue Grid -->
                  <div class="moderation-queue-grid" id="moderationQueueGrid">
                    <div class="moderation-loading">Loading moderation queue...</div>
                  </div>

                  <!-- Empty State -->
                  <div class="moderation-empty-state" id="moderationEmptyState" style="display: none; text-align: center; padding: 60px 20px; background: linear-gradient(135deg, rgba(74, 222, 128, 0.05), rgba(74, 222, 128, 0.02)); border: 1px solid rgba(74, 222, 128, 0.15); border-radius: 16px;">
                    <div style="font-size: 4rem; margin-bottom: 16px;">✅</div>
                    <div style="font-size: 1.3rem; font-weight: 600; color: #4ade80; margin-bottom: 8px;">Queue Clear!</div>
                    <div style="color: #888; font-size: 0.95rem;">No images pending review at this time.</div>
                  </div>

                  <!-- Pagination -->
                  <div class="moderation-pagination" id="moderationPagination" style="display: none; justify-content: center; gap: 8px; margin-top: 20px;">
                    <button class="mod-page-btn" onclick="loadModerationQueue(moderationCurrentPage - 1)" id="modPrevBtn">← Previous</button>
                    <span class="mod-page-info" id="modPageInfo">Page 1 of 1</span>
                    <button class="mod-page-btn" onclick="loadModerationQueue(moderationCurrentPage + 1)" id="modNextBtn">Next →</button>
                  </div>
                </div>
                <!-- End Image Moderation Section -->

                <!-- Policies Section -->
                <div class="admin-section" id="adminPoliciesSection">
                  <div class="admin-section-header">
                    <h2 class="admin-section-title">Site Policies</h2>
                    <p class="admin-section-subtitle">Edit your Terms of Service, Privacy Policy, and Refund Policy</p>
                  </div>
                  <div class="policies-admin-grid" id="policiesAdminGrid">
                    <!-- Policy cards will be rendered here -->
                  </div>
                </div>
                <!-- End Policies Section -->

                <!-- Content Filter Section -->
                <div class="admin-section" id="adminContentFilterSection">
                  <div class="admin-section-header">
                    <h2 class="admin-section-title">Content Filter - Blocked Words</h2>
                    <p class="admin-section-subtitle">Manage words/phrases blocked in Safe Mode and/or NSFW Mode prompts</p>
                  </div>

                <!-- Stats -->
                <div class="blocked-words-stats" id="blockedWordsStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px; max-width: 600px; margin-left: auto; margin-right: auto;">
                  <div class="report-stat-card" style="background: linear-gradient(135deg, rgba(157, 78, 221, 0.1), rgba(157, 78, 221, 0.05)); border: 1px solid rgba(157, 78, 221, 0.2); padding: 20px; border-radius: 16px; text-align: center;">
                    <div style="font-size: 1.3rem; margin-bottom: 8px;">📝</div>
                    <div class="report-stat-value" id="totalBlockedWords" style="font-size: 2rem; font-weight: 700; color: #9d4edd;">0</div>
                    <div class="report-stat-label" style="color: #888; font-size: 0.85rem; font-weight: 500;">Total Words</div>
                  </div>
                  <div class="report-stat-card" style="background: linear-gradient(135deg, rgba(74, 222, 128, 0.1), rgba(74, 222, 128, 0.05)); border: 1px solid rgba(74, 222, 128, 0.2); padding: 20px; border-radius: 16px; text-align: center;">
                    <div style="font-size: 1.3rem; margin-bottom: 8px;">✅</div>
                    <div class="report-stat-value" id="activeBlockedWords" style="font-size: 2rem; font-weight: 700; color: #4ade80;">0</div>
                    <div class="report-stat-label" style="color: #888; font-size: 0.85rem; font-weight: 500;">Active</div>
                  </div>
                  <div class="report-stat-card" style="background: linear-gradient(135deg, rgba(255, 165, 0, 0.1), rgba(255, 165, 0, 0.05)); border: 1px solid rgba(255, 165, 0, 0.2); padding: 20px; border-radius: 16px; text-align: center;">
                    <div style="font-size: 1.3rem; margin-bottom: 8px;">⏸️</div>
                    <div class="report-stat-value" id="inactiveBlockedWords" style="font-size: 2rem; font-weight: 700; color: #ffa500;">0</div>
                    <div class="report-stat-label" style="color: #888; font-size: 0.85rem; font-weight: 500;">Inactive</div>
                  </div>
                </div>

                <!-- Add Word Form -->
                <div class="add-word-form" style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; justify-content: center; align-items: center; padding: 20px; background: rgba(255,255,255,0.02); border-radius: 12px; max-width: 800px; margin-left: auto; margin-right: auto;">
                  <input type="text" id="newBlockedWord" placeholder="Enter word or phrase..." style="flex: 1; min-width: 200px; padding: 12px 20px; background: #1a1a1a; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 10px; color: #fff; font-size: 0.9rem;">
                  <select id="newWordCategory" style="padding: 12px 20px; background: #1a1a1a; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 10px; color: #fff; font-size: 0.9rem; cursor: pointer;">
                    <option value="explicit">Explicit</option>
                    <option value="celebrities">Celebrities</option>
                    <option value="violence">Violence</option>
                    <option value="other">Other</option>
                  </select>
                  <select id="newWordAppliesTo" style="padding: 12px 20px; background: #1a1a1a; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 10px; color: #fff; font-size: 0.9rem; cursor: pointer;">
                    <option value="safe">Safe Mode Only</option>
                    <option value="nsfw">NSFW Mode Only</option>
                    <option value="both">Both Modes</option>
                  </select>
                  <button onclick="addBlockedWord()" style="padding: 12px 24px; background: linear-gradient(135deg, #9d4edd, #ff2ebb); border: none; border-radius: 10px; color: #fff; cursor: pointer; font-weight: 500; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; transition: transform 0.2s, box-shadow 0.2s;">
                    ➕ Add Word
                  </button>
                </div>

                <!-- Bulk Add Toggle -->
                <div style="text-align: center; margin-bottom: 16px;">
                  <button onclick="toggleBulkEntry()" id="bulkEntryToggle" style="padding: 8px 16px; background: transparent; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 8px; color: #9d4edd; cursor: pointer; font-size: 0.85rem;">
                    📋 Bulk Add Multiple Words
                  </button>
                </div>

                <!-- Bulk Add Form (hidden by default) -->
                <div id="bulkEntryForm" style="display: none; margin-bottom: 24px; padding: 20px; background: rgba(255,255,255,0.02); border-radius: 12px; max-width: 700px; margin-left: auto; margin-right: auto;">
                  <div style="margin-bottom: 12px; color: #888; font-size: 0.85rem; text-align: center;">
                    Enter multiple words (one per line or comma-separated)
                  </div>
                  <textarea id="bulkBlockedWords" placeholder="nude&#10;naked&#10;explicit&#10;or: nude, naked, explicit" style="width: 100%; min-height: 120px; padding: 12px 16px; background: #1a1a1a; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 10px; color: #fff; font-size: 0.9rem; resize: vertical; font-family: inherit;"></textarea>
                  <div style="display: flex; gap: 12px; margin-top: 12px; justify-content: center; align-items: center; flex-wrap: wrap;">
                    <select id="bulkWordCategory" style="padding: 12px 20px; background: #1a1a1a; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 10px; color: #fff; font-size: 0.9rem; cursor: pointer;">
                      <option value="explicit">Explicit</option>
                      <option value="celebrities">Celebrities</option>
                      <option value="violence">Violence</option>
                      <option value="other">Other</option>
                    </select>
                    <select id="bulkWordAppliesTo" style="padding: 12px 20px; background: #1a1a1a; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 10px; color: #fff; font-size: 0.9rem; cursor: pointer;">
                      <option value="safe">Safe Mode Only</option>
                      <option value="nsfw">NSFW Mode Only</option>
                      <option value="both">Both Modes</option>
                    </select>
                    <button onclick="addBulkBlockedWords()" style="padding: 12px 24px; background: linear-gradient(135deg, #9d4edd, #ff2ebb); border: none; border-radius: 10px; color: #fff; cursor: pointer; font-weight: 500; font-size: 0.9rem;">
                      ➕ Add All Words
                    </button>
                    <span id="bulkWordCount" style="color: #888; font-size: 0.85rem;">0 words</span>
                  </div>
                </div>

                <!-- Filter and Search -->
                <div class="blocked-words-filters" style="display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; justify-content: center; align-items: center; max-width: 800px; margin-left: auto; margin-right: auto;">
                  <input type="text" id="searchBlockedWords" placeholder="Search words..." oninput="debouncedFilter('filterBlockedWordsList')()" style="flex: 1; min-width: 150px; padding: 12px 20px; background: #1a1a1a; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 10px; color: #fff; font-size: 0.9rem;">
                  <select id="categoryFilter" onchange="loadBlockedWordsAdmin()" style="padding: 12px 20px; background: #1a1a1a; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 10px; color: #fff; font-size: 0.9rem; cursor: pointer;">
                    <option value="all">All Categories</option>
                    <option value="explicit">Explicit</option>
                    <option value="celebrities">Celebrities</option>
                    <option value="violence">Violence</option>
                    <option value="other">Other</option>
                  </select>
                  <select id="appliesToFilter" onchange="loadBlockedWordsAdmin()" style="padding: 12px 20px; background: #1a1a1a; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 10px; color: #fff; font-size: 0.9rem; cursor: pointer;">
                    <option value="all">All Modes</option>
                    <option value="safe">Safe Mode Only</option>
                    <option value="nsfw">NSFW Mode Only</option>
                    <option value="both">Both Modes</option>
                  </select>
                  <button onclick="loadBlockedWordsAdmin()" style="padding: 12px 24px; background: rgba(157, 78, 221, 0.2); border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 10px; color: #fff; cursor: pointer; font-weight: 500; font-size: 0.9rem;">
                    🔄 Refresh
                  </button>
                </div>

                <!-- Words List (Collapsible) -->
                <div class="blocked-words-accordion" style="max-width: 900px; margin: 0 auto;">
                  <button onclick="toggleBlockedWordsPanel()" id="blockedWordsToggle" style="width: 100%; padding: 16px 24px; background: rgba(255,255,255,0.02); border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 12px; color: #fff; cursor: pointer; font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s;">
                    <span style="display: flex; align-items: center; gap: 10px;">
                      <span style="font-size: 1.2rem;">📋</span>
                      <span>View All Blocked Words</span>
                      <span id="blockedWordsToggleCount" style="background: rgba(157, 78, 221, 0.3); padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; color: #9d4edd;">0 words</span>
                    </span>
                    <span id="blockedWordsToggleIcon" style="font-size: 1.2rem; transition: transform 0.3s;">▼</span>
                  </button>
                  <div id="blockedWordsPanel" style="display: none; margin-top: 12px; animation: slideDown 0.3s ease-out;">
                    <div class="blocked-words-list" id="blockedWordsList" style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; padding: 20px; background: rgba(255,255,255,0.02); border-radius: 12px; min-height: 100px; max-height: 400px; overflow-y: auto;">
                      <div class="blocked-words-empty" style="text-align: center; padding: 40px 20px; width: 100%;">
                        <div style="font-size: 3rem; margin-bottom: 12px;">📝</div>
                        <div style="color: #888; font-size: 0.95rem;">Loading blocked words...</div>
                      </div>
                    </div>
                  </div>
                </div>
                </div>
                <!-- End Content Filter Section -->

                <!-- Characters Management Section -->
                <div class="admin-section" id="adminCharactersSection">
                  <div class="admin-section-header">
                    <h2 class="admin-section-title">Character & LoRA Management</h2>
                    <p class="admin-section-subtitle">Create, edit, and manage marketplace characters and private LoRAs</p>
                  </div>

                  <!-- Action Bar -->
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 12px;">
                    <div style="display: flex; gap: 12px; align-items: center;">
                      <input type="text" id="adminCharSearchInput" placeholder="Search characters..." oninput="debouncedFilter('filterCharactersList')()" style="padding: 10px 16px; background: #1a1a1a; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 8px; color: #fff; font-size: 0.9rem; width: 200px;">
                      <select id="adminCharListFilter" onchange="filterCharactersList()" style="padding: 10px 16px; background: #1a1a1a; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 8px; color: #fff; font-size: 0.9rem;">
                        <option value="all">All Characters</option>
                        <option value="listed">Listed Only</option>
                        <option value="unlisted">Unlisted/Private Only</option>
                      </select>
                    </div>
                    <button onclick="showAddCharacterModal()" style="padding: 10px 20px; background: linear-gradient(135deg, #9d4edd, #ff2ebb); border: none; border-radius: 8px; color: #fff; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 8px;">
                      <span>+</span> Add Character
                    </button>
                  </div>

                  <!-- Characters List -->
                  <div id="adminCharactersList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; color: #888; grid-column: 1 / -1;">
                      <div class="loading-spinner" style="width: 32px; height: 32px; border-width: 3px; margin-bottom: 16px;"></div>
                      <div style="font-size: 1rem;">Loading characters...</div>
                    </div>
                  </div>
                </div>
                <!-- End Characters Section -->

                <!-- Admin Character Add/Edit Modal -->
                <div id="adminCharModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center; padding: 20px;">
                  <div style="background: #1a1a1a; border-radius: 16px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; border: 1px solid rgba(157, 78, 221, 0.3);">
                    <div style="padding: 24px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                      <h3 id="adminCharModalTitle" style="margin: 0; font-size: 1.25rem;">Add New Character</h3>
                    </div>
                    <form id="adminCharForm" onsubmit="saveAdminCharacter(event)" style="padding: 24px;">
                      <input type="hidden" id="adminCharId">

                      <div style="display: grid; gap: 16px;">
                        <!-- Name -->
                        <div>
                          <label style="display: block; margin-bottom: 6px; color: #888; font-size: 0.85rem;">Name *</label>
                          <input type="text" id="adminCharName" required style="width: 100%; padding: 10px 14px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 0.9rem;">
                        </div>

                        <!-- Category -->
                        <div>
                          <label style="display: block; margin-bottom: 6px; color: #888; font-size: 0.85rem;">Category *</label>
                          <input type="text" id="adminCharCategory" required placeholder="e.g. Fashion & Lifestyle" style="width: 100%; padding: 10px 14px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 0.9rem;">
                        </div>

                        <!-- Description -->
                        <div>
                          <label style="display: block; margin-bottom: 6px; color: #888; font-size: 0.85rem;">Description</label>
                          <textarea id="adminCharDescription" rows="3" style="width: 100%; padding: 10px 14px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 0.9rem; resize: vertical;"></textarea>
                        </div>

                        <!-- Image URL -->
                        <div>
                          <label style="display: block; margin-bottom: 6px; color: #888; font-size: 0.85rem;">Image URL</label>
                          <input type="url" id="adminCharImageUrl" placeholder="https://..." style="width: 100%; padding: 10px 14px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 0.9rem;">
                        </div>

                        <!-- LoRA URL -->
                        <div>
                          <label style="display: block; margin-bottom: 6px; color: #888; font-size: 0.85rem;">LoRA URL / Path</label>
                          <input type="text" id="adminCharLoraUrl" placeholder="URL or path to .safetensors file" style="width: 100%; padding: 10px 14px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 0.9rem;">
                        </div>

                        <!-- Trigger Word -->
                        <div>
                          <label style="display: block; margin-bottom: 6px; color: #888; font-size: 0.85rem;">Trigger Word</label>
                          <input type="text" id="adminCharTriggerWord" placeholder="e.g. ohwx woman" style="width: 100%; padding: 10px 14px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 0.9rem;">
                        </div>

                        <!-- Price -->
                        <div>
                          <label style="display: block; margin-bottom: 6px; color: #888; font-size: 0.85rem;">Price (0 = free)</label>
                          <input type="number" id="adminCharPrice" value="0" min="0" step="0.01" style="width: 100%; padding: 10px 14px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 0.9rem;">
                        </div>

                        <!-- Toggles Row -->
                        <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                          <!-- Is Listed Toggle -->
                          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="adminCharIsListed" checked style="width: 18px; height: 18px; accent-color: #9d4edd;">
                            <span style="color: #fff; font-size: 0.9rem;">Listed on Marketplace</span>
                          </label>

                          <!-- Is Active Toggle -->
                          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="adminCharIsActive" checked style="width: 18px; height: 18px; accent-color: #9d4edd;">
                            <span style="color: #fff; font-size: 0.9rem;">Active</span>
                          </label>
                        </div>

                        <!-- Help Text -->
                        <div style="background: rgba(157, 78, 221, 0.1); border-radius: 8px; padding: 12px; font-size: 0.85rem; color: #888;">
                          <strong style="color: #9d4edd;">Unlisted Characters:</strong> Uncheck "Listed on Marketplace" to create a private LoRA that won't appear in the public marketplace. You can then grant access to specific users via User Services.
                        </div>
                      </div>

                      <!-- Buttons -->
                      <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <button type="button" onclick="closeAdminCharModal()" style="padding: 10px 20px; background: transparent; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; cursor: pointer;">Cancel</button>
                        <button type="submit" id="adminCharSubmitBtn" style="padding: 10px 20px; background: linear-gradient(135deg, #9d4edd, #ff2ebb); border: none; border-radius: 8px; color: #fff; cursor: pointer; font-weight: 500;">Save Character</button>
                      </div>
                    </form>
                  </div>
                </div>

                <!-- User Services Section -->
                <div class="admin-section" id="adminUserServicesSection">
                  <div class="admin-section-header">
                    <h2 class="admin-section-title">User Services</h2>
                    <p class="admin-section-subtitle">Grant credits and LoRA/character access to users</p>
                  </div>

                  <!-- User Search -->
                  <div style="max-width: 600px; margin: 0 auto 24px;">
                    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                      <input type="email" id="grantUserSearch" placeholder="Search user by email..." style="flex: 1; padding: 12px 20px; background: #1a1a1a; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 10px; color: #fff; font-size: 0.9rem;">
                      <button onclick="searchUserForGrant()" style="padding: 12px 24px; background: linear-gradient(135deg, #9d4edd, #ff2ebb); border: none; border-radius: 10px; color: #fff; cursor: pointer; font-weight: 500; font-size: 0.9rem;">
                        Search
                      </button>
                    </div>

                    <!-- Search Results -->
                    <div id="grantUserSearchResults" style="display: none; background: rgba(255,255,255,0.02); border-radius: 12px; padding: 12px; margin-bottom: 16px;">
                      <!-- User results will be inserted here -->
                    </div>
                  </div>

                  <!-- Selected User & Services -->
                  <div id="grantUserSelected" style="display: none; max-width: 800px; margin: 0 auto;">
                    <!-- User Info Card -->
                    <div style="background: rgba(157, 78, 221, 0.1); border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                      <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                        <div>
                          <div style="font-weight: 600; color: #fff; font-size: 1.1rem;" id="grantUserEmail">user@example.com</div>
                          <div style="color: #888; font-size: 0.85rem;" id="grantUserInfo">Plan: Free | Role: user</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 16px;">
                          <div style="text-align: right;">
                            <div style="font-size: 0.75rem; color: #888;">Current Balance</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: #4ade80;" id="grantUserCredits">0</div>
                          </div>
                          <button onclick="clearSelectedUser()" style="padding: 8px 16px; background: transparent; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #888; cursor: pointer; font-size: 0.85rem;">
                            Clear
                          </button>
                        </div>
                      </div>
                    </div>

                    <!-- Gift Credits Section -->
                    <div style="background: rgba(255,255,255,0.02); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                      <h3 style="margin: 0 0 16px; font-size: 1rem; color: #fff;">Gift Credits</h3>
                      <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                          <input type="number" id="giftCreditsAmount" placeholder="Amount" min="1" style="width: 120px; padding: 12px 20px; background: #1a1a1a; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 10px; color: #fff; font-size: 0.9rem;">
                          <input type="text" id="giftCreditsReason" placeholder="Reason (required)" style="flex: 1; min-width: 200px; padding: 12px 20px; background: #1a1a1a; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 10px; color: #fff; font-size: 0.9rem;">
                          <button onclick="giftCredits()" style="padding: 12px 24px; background: linear-gradient(135deg, #f59e0b, #d97706); border: none; border-radius: 10px; color: #fff; cursor: pointer; font-weight: 500; font-size: 0.9rem;">
                            Gift Credits
                          </button>
                        </div>
                        <div style="font-size: 0.8rem; color: #666;">Will appear on user's bill as a gift with admin name and reason</div>
                      </div>
                    </div>

                    <!-- Grant Character Access -->
                    <div style="background: rgba(255,255,255,0.02); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                      <h3 style="margin: 0 0 16px; font-size: 1rem; color: #fff;">Grant Character Access</h3>
                      <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <select id="grantCharacterSelect" style="flex: 1; min-width: 200px; padding: 12px 20px; background: #1a1a1a; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 10px; color: #fff; font-size: 0.9rem; cursor: pointer;">
                          <option value="">Select a character...</option>
                        </select>
                        <button onclick="grantCharacterAccess()" style="padding: 12px 24px; background: linear-gradient(135deg, #4ade80, #22c55e); border: none; border-radius: 10px; color: #fff; cursor: pointer; font-weight: 500; font-size: 0.9rem;">
                          Grant Access
                        </button>
                      </div>
                    </div>

                    <!-- User's Owned Characters -->
                    <div style="background: rgba(255,255,255,0.02); border-radius: 12px; padding: 20px;">
                      <h3 style="margin: 0 0 16px; font-size: 1rem; color: #fff;">Owned Characters</h3>
                      <div id="grantUserCharacters" style="display: flex; flex-wrap: wrap; gap: 12px;">
                        <div style="color: #888; font-size: 0.9rem;">Select a user to view their characters</div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- End Character Grants Section -->

                <!-- Onboarding Wizard Admin Section -->
                <div class="admin-section" id="adminOnboardingSection">
                  <div class="admin-section-header">
                    <h2 class="admin-section-title">Onboarding Wizard Configuration</h2>
                    <p class="admin-section-subtitle">Manage wizard steps, plans, education tiers, and starter characters</p>
                  </div>

                  <!-- Tab Navigation -->
                  <div class="onboarding-admin-tabs" style="display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; justify-content: center;">
                    <button class="onboarding-tab-btn active" onclick="switchOnboardingTab('plans')" data-tab="plans" style="padding: 12px 24px; background: linear-gradient(135deg, #9d4edd, #ff2ebb); border: none; border-radius: 10px; color: #fff; cursor: pointer; font-weight: 500; font-size: 0.9rem; transition: all 0.2s;">
                      Plans
                    </button>
                    <button class="onboarding-tab-btn" onclick="switchOnboardingTab('education')" data-tab="education" style="padding: 12px 24px; background: rgba(255,255,255,0.05); border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 10px; color: #888; cursor: pointer; font-weight: 500; font-size: 0.9rem; transition: all 0.2s;">
                      Education
                    </button>
                    <button class="onboarding-tab-btn" onclick="switchOnboardingTab('characters')" data-tab="characters" style="padding: 12px 24px; background: rgba(255,255,255,0.05); border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 10px; color: #888; cursor: pointer; font-weight: 500; font-size: 0.9rem; transition: all 0.2s;">
                      Characters
                    </button>
                    <button class="onboarding-tab-btn" onclick="switchOnboardingTab('steps')" data-tab="steps" style="padding: 12px 24px; background: rgba(255,255,255,0.05); border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 10px; color: #888; cursor: pointer; font-weight: 500; font-size: 0.9rem; transition: all 0.2s;">
                      Steps
                    </button>
                    <button onclick="previewOnboardingWizard()" style="padding: 12px 24px; background: rgba(74, 222, 128, 0.2); border: 1px solid rgba(74, 222, 128, 0.3); border-radius: 10px; color: #4ade80; cursor: pointer; font-weight: 500; font-size: 0.9rem; margin-left: 16px;">
                      👁️ Preview Wizard
                    </button>
                  </div>

                  <!-- Plans Tab -->
                  <div class="onboarding-tab-content active" id="onboardingPlansTab">
                    <!-- Stats Row -->
                    <div class="onboarding-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px; max-width: 600px; margin-left: auto; margin-right: auto;">
                      <div style="background: linear-gradient(135deg, rgba(157, 78, 221, 0.1), rgba(157, 78, 221, 0.05)); border: 1px solid rgba(157, 78, 221, 0.2); padding: 20px; border-radius: 16px; text-align: center;">
                        <div style="font-size: 1.3rem; margin-bottom: 8px;">📦</div>
                        <div id="plansActiveCount" style="font-size: 2rem; font-weight: 700; color: #9d4edd;">0</div>
                        <div style="color: #888; font-size: 0.85rem; font-weight: 500;">Active Plans</div>
                      </div>
                      <div style="background: linear-gradient(135deg, rgba(74, 222, 128, 0.1), rgba(74, 222, 128, 0.05)); border: 1px solid rgba(74, 222, 128, 0.2); padding: 20px; border-radius: 16px; text-align: center;">
                        <div style="font-size: 1.3rem; margin-bottom: 8px;">💰</div>
                        <div id="plansRevenueRange" style="font-size: 1.2rem; font-weight: 700; color: #4ade80;">$0-$0</div>
                        <div style="color: #888; font-size: 0.85rem; font-weight: 500;">Price Range</div>
                      </div>
                      <div style="background: linear-gradient(135deg, rgba(0, 178, 255, 0.1), rgba(0, 178, 255, 0.05)); border: 1px solid rgba(0, 178, 255, 0.2); padding: 20px; border-radius: 16px; text-align: center;">
                        <div style="font-size: 1.3rem; margin-bottom: 8px;">⚡</div>
                        <div id="plansCreditsRange" style="font-size: 1.2rem; font-weight: 700; color: #00b2ff;">0-0</div>
                        <div style="color: #888; font-size: 0.85rem; font-weight: 500;">Credits Range</div>
                      </div>
                    </div>

                    <!-- Add Plan Button -->
                    <div style="text-align: center; margin-bottom: 24px;">
                      <button onclick="openPlanModal()" style="padding: 12px 24px; background: linear-gradient(135deg, #9d4edd, #ff2ebb); border: none; border-radius: 10px; color: #fff; cursor: pointer; font-weight: 500; font-size: 0.9rem;">
                        ➕ Add New Plan
                      </button>
                    </div>

                    <!-- Plans List -->
                    <div id="plansListContainer" style="max-width: 900px; margin: 0 auto;">
                      <div style="text-align: center; padding: 40px; color: #888;">Loading plans...</div>
                    </div>
                  </div>

                  <!-- Education Tab -->
                  <div class="onboarding-tab-content" id="onboardingEducationTab" style="display: none;">
                    <!-- Stats Row -->
                    <div class="onboarding-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px; max-width: 600px; margin-left: auto; margin-right: auto;">
                      <div style="background: linear-gradient(135deg, rgba(157, 78, 221, 0.1), rgba(157, 78, 221, 0.05)); border: 1px solid rgba(157, 78, 221, 0.2); padding: 20px; border-radius: 16px; text-align: center;">
                        <div style="font-size: 1.3rem; margin-bottom: 8px;">🎓</div>
                        <div id="tiersActiveCount" style="font-size: 2rem; font-weight: 700; color: #9d4edd;">0</div>
                        <div style="color: #888; font-size: 0.85rem; font-weight: 500;">Active Tiers</div>
                      </div>
                      <div style="background: linear-gradient(135deg, rgba(255, 165, 0, 0.1), rgba(255, 165, 0, 0.05)); border: 1px solid rgba(255, 165, 0, 0.2); padding: 20px; border-radius: 16px; text-align: center;">
                        <div style="font-size: 1.3rem; margin-bottom: 8px;">📹</div>
                        <div id="tiersWithWorkshops" style="font-size: 2rem; font-weight: 700; color: #ffa500;">0</div>
                        <div style="color: #888; font-size: 0.85rem; font-weight: 500;">With Workshops</div>
                      </div>
                      <div style="background: linear-gradient(135deg, rgba(74, 222, 128, 0.1), rgba(74, 222, 128, 0.05)); border: 1px solid rgba(74, 222, 128, 0.2); padding: 20px; border-radius: 16px; text-align: center;">
                        <div style="font-size: 1.3rem; margin-bottom: 8px;">🧑‍🏫</div>
                        <div id="tiersWithMentorship" style="font-size: 2rem; font-weight: 700; color: #4ade80;">0</div>
                        <div style="color: #888; font-size: 0.85rem; font-weight: 500;">With Mentorship</div>
                      </div>
                    </div>

                    <!-- Add Tier Button -->
                    <div style="text-align: center; margin-bottom: 24px;">
                      <button onclick="openTierModal()" style="padding: 12px 24px; background: linear-gradient(135deg, #9d4edd, #ff2ebb); border: none; border-radius: 10px; color: #fff; cursor: pointer; font-weight: 500; font-size: 0.9rem;">
                        ➕ Add New Tier
                      </button>
                    </div>

                    <!-- Tiers List -->
                    <div id="tiersListContainer" style="max-width: 900px; margin: 0 auto;">
                      <div style="text-align: center; padding: 40px; color: #888;">Loading education tiers...</div>
                    </div>
                  </div>

                  <!-- Characters Tab -->
                  <div class="onboarding-tab-content" id="onboardingCharactersTab" style="display: none;">
                    <!-- Stats Row -->
                    <div class="onboarding-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px; max-width: 600px; margin-left: auto; margin-right: auto;">
                      <div style="background: linear-gradient(135deg, rgba(74, 222, 128, 0.1), rgba(74, 222, 128, 0.05)); border: 1px solid rgba(74, 222, 128, 0.2); padding: 20px; border-radius: 16px; text-align: center;">
                        <div style="font-size: 1.3rem; margin-bottom: 8px;">⭐</div>
                        <div id="starterCharactersCount" style="font-size: 2rem; font-weight: 700; color: #4ade80;">0</div>
                        <div style="color: #888; font-size: 0.85rem; font-weight: 500;">Starter Characters</div>
                      </div>
                      <div style="background: linear-gradient(135deg, rgba(255, 46, 187, 0.1), rgba(255, 46, 187, 0.05)); border: 1px solid rgba(255, 46, 187, 0.2); padding: 20px; border-radius: 16px; text-align: center;">
                        <div style="font-size: 1.3rem; margin-bottom: 8px;">💎</div>
                        <div id="premiumCharactersCount" style="font-size: 2rem; font-weight: 700; color: #ff2ebb;">0</div>
                        <div style="color: #888; font-size: 0.85rem; font-weight: 500;">Premium Characters</div>
                      </div>
                      <div style="background: linear-gradient(135deg, rgba(0, 178, 255, 0.1), rgba(0, 178, 255, 0.05)); border: 1px solid rgba(0, 178, 255, 0.2); padding: 20px; border-radius: 16px; text-align: center;">
                        <div style="font-size: 1.3rem; margin-bottom: 8px;">🎭</div>
                        <div id="totalCharactersCount" style="font-size: 2rem; font-weight: 700; color: #00b2ff;">0</div>
                        <div style="color: #888; font-size: 0.85rem; font-weight: 500;">Total Characters</div>
                      </div>
                    </div>

                    <!-- Starter Characters Section -->
                    <div style="max-width: 900px; margin: 0 auto 24px;">
                      <div style="background: rgba(74, 222, 128, 0.05); border: 1px solid rgba(74, 222, 128, 0.2); border-radius: 16px; padding: 20px;">
                        <h3 style="margin: 0 0 16px; font-size: 1.1rem; color: #4ade80; display: flex; align-items: center; gap: 8px;">
                          <span>⭐</span> Starter Characters
                          <span style="font-size: 0.8rem; color: #888; font-weight: normal;">(Free in wizard - drag to reorder)</span>
                        </h3>
                        <div id="starterCharactersList" style="display: flex; flex-wrap: wrap; gap: 16px; min-height: 100px;">
                          <div style="color: #888; font-size: 0.9rem; padding: 20px;">Loading starter characters...</div>
                        </div>
                      </div>
                    </div>

                    <!-- Premium Characters Section -->
                    <div style="max-width: 900px; margin: 0 auto;">
                      <div style="background: rgba(255, 46, 187, 0.05); border: 1px solid rgba(255, 46, 187, 0.2); border-radius: 16px; padding: 20px;">
                        <h3 style="margin: 0 0 16px; font-size: 1.1rem; color: #ff2ebb; display: flex; align-items: center; gap: 8px;">
                          <span>💎</span> Premium Characters
                          <span style="font-size: 0.8rem; color: #888; font-weight: normal;">(Click to make starter)</span>
                        </h3>
                        <!-- Search/Filter -->
                        <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                          <input type="text" id="characterSearchInput" placeholder="Search characters..." oninput="debouncedFilter('filterPremiumCharacters')()" style="flex: 1; min-width: 200px; padding: 10px 16px; background: #1a1a1a; border: 1px solid rgba(255, 46, 187, 0.3); border-radius: 8px; color: #fff; font-size: 0.9rem;">
                          <select id="characterCategoryFilter" onchange="filterPremiumCharacters()" style="padding: 10px 16px; background: #1a1a1a; border: 1px solid rgba(255, 46, 187, 0.3); border-radius: 8px; color: #fff; font-size: 0.9rem; cursor: pointer;">
                            <option value="">All Categories</option>
                          </select>
                        </div>
                        <div id="premiumCharactersList" style="display: flex; flex-wrap: wrap; gap: 16px; max-height: 400px; overflow-y: auto;">
                          <div style="color: #888; font-size: 0.9rem; padding: 20px;">Loading premium characters...</div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Steps Tab -->
                  <div class="onboarding-tab-content" id="onboardingStepsTab" style="display: none;">
                    <div style="max-width: 700px; margin: 0 auto;">
                      <div style="background: rgba(255,255,255,0.02); border-radius: 16px; padding: 24px;">
                        <h3 style="margin: 0 0 20px; font-size: 1.1rem; color: #fff;">Wizard Flow Configuration</h3>
                        <p style="color: #888; font-size: 0.9rem; margin-bottom: 24px;">Enable/disable steps and customize text shown to users</p>
                        <div id="stepsListContainer">
                          <div style="text-align: center; padding: 40px; color: #888;">Loading wizard steps...</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- End Onboarding Wizard Admin Section -->

                <!-- Custom Character Orders Admin Section -->
                <div class="admin-section" id="adminCustomOrdersSection">
                  <div class="admin-section-header">
                    <h2 class="admin-section-title">Custom Character Orders</h2>
                    <p class="admin-section-subtitle">Manage custom character creation requests and pricing</p>
                  </div>

                  <!-- Tab Navigation -->
                  <div class="custom-orders-tabs" style="display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; justify-content: center;">
                    <button class="custom-orders-tab-btn active" onclick="switchCustomOrdersTab('orders')" data-tab="orders" style="padding: 12px 24px; background: linear-gradient(135deg, #9d4edd, #ff2ebb); border: none; border-radius: 10px; color: #fff; cursor: pointer; font-weight: 500; font-size: 0.9rem; transition: all 0.2s;">
                      Orders
                    </button>
                    <button class="custom-orders-tab-btn" onclick="switchCustomOrdersTab('pricing')" data-tab="pricing" style="padding: 12px 24px; background: rgba(255,255,255,0.05); border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 10px; color: #888; cursor: pointer; font-weight: 500; font-size: 0.9rem; transition: all 0.2s;">
                      Pricing & Config
                    </button>
                  </div>

                  <!-- Orders Tab -->
                  <div class="custom-orders-tab-content active" id="customOrdersOrdersTab">
                    <!-- Stats Row -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px; margin-bottom: 24px; max-width: 800px; margin-left: auto; margin-right: auto;">
                      <div style="background: linear-gradient(135deg, rgba(255, 165, 0, 0.1), rgba(255, 165, 0, 0.05)); border: 1px solid rgba(255, 165, 0, 0.2); padding: 16px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 1.1rem; margin-bottom: 6px;">⏳</div>
                        <div id="customOrdersPending" style="font-size: 1.5rem; font-weight: 700; color: #ffa500;">0</div>
                        <div style="color: #888; font-size: 0.75rem;">Pending</div>
                      </div>
                      <div style="background: linear-gradient(135deg, rgba(0, 178, 255, 0.1), rgba(0, 178, 255, 0.05)); border: 1px solid rgba(0, 178, 255, 0.2); padding: 16px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 1.1rem; margin-bottom: 6px;">🔄</div>
                        <div id="customOrdersInProgress" style="font-size: 1.5rem; font-weight: 700; color: #00b2ff;">0</div>
                        <div style="color: #888; font-size: 0.75rem;">In Progress</div>
                      </div>
                      <div style="background: linear-gradient(135deg, rgba(255, 46, 187, 0.1), rgba(255, 46, 187, 0.05)); border: 1px solid rgba(255, 46, 187, 0.2); padding: 16px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 1.1rem; margin-bottom: 6px;">📝</div>
                        <div id="customOrdersRevision" style="font-size: 1.5rem; font-weight: 700; color: #ff2ebb;">0</div>
                        <div style="color: #888; font-size: 0.75rem;">Revision</div>
                      </div>
                      <div style="background: linear-gradient(135deg, rgba(74, 222, 128, 0.1), rgba(74, 222, 128, 0.05)); border: 1px solid rgba(74, 222, 128, 0.2); padding: 16px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 1.1rem; margin-bottom: 6px;">✅</div>
                        <div id="customOrdersCompleted" style="font-size: 1.5rem; font-weight: 700; color: #4ade80;">0</div>
                        <div style="color: #888; font-size: 0.75rem;">Completed</div>
                      </div>
                    </div>

                    <!-- Filters -->
                    <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; align-items: center;">
                      <select id="customOrdersStatusFilter" onchange="loadCustomOrders()" style="padding: 10px 16px; background: #1a1a1a; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 8px; color: #fff; font-size: 0.9rem; cursor: pointer;">
                        <option value="all">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="in_progress">In Progress</option>
                        <option value="delivered">Delivered</option>
                        <option value="revision_requested">Revision Requested</option>
                        <option value="completed">Completed</option>
                      </select>
                      <input type="text" id="customOrdersSearch" placeholder="Search by email or name..." oninput="debouncedFilter('filterCustomOrders')()" style="padding: 10px 16px; background: #1a1a1a; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 8px; color: #fff; font-size: 0.9rem; min-width: 200px;">
                      <button onclick="loadCustomOrders()" style="padding: 10px 20px; background: rgba(157, 78, 221, 0.2); border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 8px; color: #9d4edd; cursor: pointer; font-size: 0.9rem;">
                        🔄 Refresh
                      </button>
                    </div>

                    <!-- Orders List -->
                    <div id="customOrdersListContainer" style="max-width: 1000px; margin: 0 auto;">
                      <div style="text-align: center; padding: 40px; color: #888;">Loading orders...</div>
                    </div>
                  </div>

                  <!-- Pricing Tab -->
                  <div class="custom-orders-tab-content" id="customOrdersPricingTab" style="display: none;">
                    <div style="max-width: 600px; margin: 0 auto;">
                      <div style="background: rgba(255,255,255,0.02); border-radius: 16px; padding: 24px;">
                        <h3 style="margin: 0 0 24px; font-size: 1.1rem; color: #fff;">Custom Character Pricing</h3>

                        <div style="display: grid; gap: 20px;">
                          <!-- Base Price -->
                          <div>
                            <label style="display: block; color: #888; font-size: 0.85rem; margin-bottom: 6px;">Base Price ($)</label>
                            <input type="number" id="customConfigBasePrice" min="0" step="0.01" style="width: 100%; padding: 12px; background: #252525; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 8px; color: #fff; font-size: 0.9rem;">
                          </div>

                          <!-- Revision Price -->
                          <div>
                            <label style="display: block; color: #888; font-size: 0.85rem; margin-bottom: 6px;">Price Per Revision ($)</label>
                            <input type="number" id="customConfigRevisionPrice" min="0" step="0.01" style="width: 100%; padding: 12px; background: #252525; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 8px; color: #fff; font-size: 0.9rem;">
                          </div>

                          <!-- Rush Fee -->
                          <div>
                            <label style="display: block; color: #888; font-size: 0.85rem; margin-bottom: 6px;">Rush Order Fee ($)</label>
                            <input type="number" id="customConfigRushFee" min="0" step="0.01" style="width: 100%; padding: 12px; background: #252525; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 8px; color: #fff; font-size: 0.9rem;">
                          </div>

                          <!-- Max Revisions -->
                          <div>
                            <label style="display: block; color: #888; font-size: 0.85rem; margin-bottom: 6px;">Maximum Revisions</label>
                            <input type="number" id="customConfigMaxRevisions" min="0" max="10" style="width: 100%; padding: 12px; background: #252525; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 8px; color: #fff; font-size: 0.9rem;">
                          </div>

                          <!-- Delivery Times -->
                          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                            <div>
                              <label style="display: block; color: #888; font-size: 0.85rem; margin-bottom: 6px;">Standard Min (days)</label>
                              <input type="number" id="customConfigStandardMin" min="1" style="width: 100%; padding: 12px; background: #252525; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 8px; color: #fff; font-size: 0.9rem;">
                            </div>
                            <div>
                              <label style="display: block; color: #888; font-size: 0.85rem; margin-bottom: 6px;">Standard Max (days)</label>
                              <input type="number" id="customConfigStandardMax" min="1" style="width: 100%; padding: 12px; background: #252525; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 8px; color: #fff; font-size: 0.9rem;">
                            </div>
                            <div>
                              <label style="display: block; color: #888; font-size: 0.85rem; margin-bottom: 6px;">Rush (days)</label>
                              <input type="number" id="customConfigRushDays" min="1" style="width: 100%; padding: 12px; background: #252525; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 8px; color: #fff; font-size: 0.9rem;">
                            </div>
                          </div>

                          <!-- Upload Limits -->
                          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                              <label style="display: block; color: #888; font-size: 0.85rem; margin-bottom: 6px;">Max Upload Images</label>
                              <input type="number" id="customConfigMaxImages" min="1" style="width: 100%; padding: 12px; background: #252525; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 8px; color: #fff; font-size: 0.9rem;">
                            </div>
                            <div>
                              <label style="display: block; color: #888; font-size: 0.85rem; margin-bottom: 6px;">Max Image Size (MB)</label>
                              <input type="number" id="customConfigMaxSize" min="1" style="width: 100%; padding: 12px; background: #252525; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 8px; color: #fff; font-size: 0.9rem;">
                            </div>
                          </div>

                          <!-- Active Toggle -->
                          <div style="display: flex; align-items: center; gap: 12px; padding-top: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                              <input type="checkbox" id="customConfigIsActive" style="width: 18px; height: 18px; accent-color: #9d4edd;">
                              <span style="color: #fff; font-size: 0.9rem;">Feature Enabled (visible to users)</span>
                            </label>
                          </div>

                          <!-- Requirements Text -->
                          <div>
                            <label style="display: block; color: #888; font-size: 0.85rem; margin-bottom: 6px;">Requirements Text (shown to users)</label>
                            <textarea id="customConfigRequirements" rows="6" style="width: 100%; padding: 12px; background: #252525; border: 1px solid rgba(157, 78, 221, 0.3); border-radius: 8px; color: #fff; font-size: 0.9rem; resize: vertical;"></textarea>
                          </div>

                          <!-- Save Button -->
                          <div style="display: flex; gap: 12px; margin-top: 8px;">
                            <button onclick="saveCustomConfig()" style="flex: 1; padding: 14px 24px; background: linear-gradient(135deg, #9d4edd, #ff2ebb); border: none; border-radius: 10px; color: #fff; cursor: pointer; font-weight: 500; font-size: 0.95rem;">
                              Save Configuration
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- End Custom Character Orders Admin Section -->

                <!-- Landing Page Admin Section -->
                <div class="admin-section" id="adminLandingPageSection">
                  <div class="admin-section-header">
                    <h2 class="admin-section-title">Landing Page CMS</h2>
                    <p class="admin-section-subtitle">Edit your landing page content without code changes</p>
                  </div>
                  <div id="adminLandingContent">
                    <div style="text-align: center; padding: 40px; color: #888;">
                      Loading landing page content...
                    </div>
                  </div>
                </div>
                <!-- End Landing Page Admin Section -->

              </div>
              <!-- End Admin Content Area -->
            </div>
            <!-- End Admin Panel Layout -->
          </div>
          <!-- End Policies Sub-tab Content -->

        </div>
        <!-- End Member Content -->

      </div>
    </div>
    <!-- End Education Tab Section -->

    <!-- Resource Detail Modal -->
    <div class="resource-modal" id="resourceModal">
      <div class="resource-modal-content">
        <button class="resource-modal-close" onclick="closeResourceModal()">✕</button>
        <div class="resource-modal-header" id="resourceModalHeader">
          <div class="resource-modal-type" id="resourceModalType">Tutorial</div>
          <h2 class="resource-modal-title" id="resourceModalTitle">Resource Title</h2>
          <div class="resource-modal-meta">
            <span id="resourceModalTopic">Topic</span>
            <span id="resourceModalDuration">10 min read</span>
          </div>
        </div>
        <div class="resource-modal-body" id="resourceModalBody">
          <!-- Content or video will be inserted here -->
        </div>
      </div>
    </div>

    <!-- Admin Add Resource Button -->
    <button class="admin-resources-btn" id="adminResourcesBtn" onclick="openResourceForm()">
      <span>➕</span> Add Resource
    </button>

    <!-- Admin Preview Toggle -->
    <button class="admin-preview-toggle" id="adminPreviewToggle" onclick="togglePreviewMode()">
      <span>👁️</span> Preview as Non-Subscriber
    </button>

    <!-- Preview Mode Indicator -->
    <div class="preview-indicator" id="previewIndicator">
      ⚠️ Preview Mode Active
    </div>

    <!-- Resource Form Modal (Add/Edit) -->
    <div class="resource-form-modal" id="resourceFormModal">
      <div class="resource-form-content">
        <div class="resource-form-header">
          <h3 class="resource-form-title" id="resourceFormTitle">Add New Resource</h3>
          <button class="resource-form-close" onclick="closeResourceForm()">✕</button>
        </div>
        <div class="resource-form-body">
          <form id="resourceForm" onsubmit="saveResource(event)">
            <input type="hidden" id="resourceFormId" value="">

            <div class="resource-form-group">
              <label class="resource-form-label">Title *</label>
              <input type="text" class="resource-form-input" id="resourceFormTitleInput" required placeholder="Enter resource title">
            </div>

            <div class="resource-form-group">
              <label class="resource-form-label">Description</label>
              <input type="text" class="resource-form-input" id="resourceFormDescription" placeholder="Brief description of the resource">
            </div>

            <div class="resource-form-row">
              <div class="resource-form-group">
                <label class="resource-form-label">Type *</label>
                <select class="resource-form-select" id="resourceFormType" required>
                  <option value="tutorial">Tutorial</option>
                  <option value="guide">Guide</option>
                  <option value="video">Video</option>
                </select>
              </div>
              <div class="resource-form-group">
                <label class="resource-form-label">Topic *</label>
                <select class="resource-form-select" id="resourceFormTopic" required>
                  <option value="prompts">Prompts</option>
                  <option value="techniques">Techniques</option>
                  <option value="tools">Tools</option>
                  <option value="business">Business</option>
                </select>
              </div>
            </div>

            <div class="resource-form-row">
              <div class="resource-form-group">
                <label class="resource-form-label">Free For Tiers *</label>
                <div class="tier-checkboxes">
                  <label class="tier-checkbox">
                    <input type="checkbox" id="resourceFormFreeSupernova" checked>
                    <span class="tier-checkbox-label supernova">Supernova</span>
                  </label>
                  <label class="tier-checkbox">
                    <input type="checkbox" id="resourceFormFreeMentorship" checked>
                    <span class="tier-checkbox-label mentorship">Mentorship</span>
                  </label>
                </div>
                <small style="color: #888; margin-top: 4px; display: block;">Select which membership tiers get this resource for free</small>
              </div>
              <div class="resource-form-group">
                <label class="resource-form-label">Duration</label>
                <input type="text" class="resource-form-input" id="resourceFormDuration" placeholder="e.g., 10 min read or 5:30">
              </div>
            </div>

            <div class="resource-form-group">
              <label class="resource-form-label">Thumbnail Image</label>
              <div class="resource-thumbnail-upload">
                <div class="resource-thumbnail-preview" id="resourceThumbnailPreview">
                  <span class="resource-thumbnail-placeholder">📷 No image</span>
                </div>
                <div class="resource-thumbnail-actions">
                  <input type="file" id="resourceThumbnailFile" accept="image/*" style="display: none;" onchange="handleThumbnailUpload(event)">
                  <button type="button" class="resource-form-btn cancel" onclick="document.getElementById('resourceThumbnailFile').click()">
                    📤 Upload Image
                  </button>
                  <span style="color: #666; font-size: 0.85rem;">or</span>
                  <input type="url" class="resource-form-input" id="resourceFormThumbnail" placeholder="Paste image URL" style="flex: 1;">
                </div>
              </div>
            </div>

            <div class="resource-form-group">
              <label class="resource-form-label">Content URL (for videos)</label>
              <input type="url" class="resource-form-input" id="resourceFormContentUrl" placeholder="https://youtube.com/watch?v=...">
            </div>

            <div class="resource-form-group">
              <label class="resource-form-label">Content Body (HTML for tutorials/guides)</label>
              <textarea class="resource-form-textarea" id="resourceFormContentBody" placeholder="<h2>Section Title</h2><p>Your content here...</p>"></textarea>
            </div>

            <!-- Pricing Section -->
            <div class="resource-form-section">
              <div class="resource-form-section-title">Pricing (Optional)</div>

              <div class="resource-form-group">
                <label class="resource-form-label">
                  <input type="checkbox" id="resourceFormPurchasable" onchange="togglePricingFields()">
                  Allow individual purchase
                </label>
              </div>

              <div id="pricingFields" style="display: none;">
                <div class="resource-form-row">
                  <div class="resource-form-group">
                    <label class="resource-form-label">Price ($)</label>
                    <input type="number" class="resource-form-input" id="resourceFormPrice" placeholder="e.g., 25.00" step="0.01" min="0">
                  </div>
                  <div class="resource-form-group">
                    <label class="resource-form-label">Sale Price ($)</label>
                    <input type="number" class="resource-form-input" id="resourceFormSalePrice" placeholder="Leave empty for no sale" step="0.01" min="0">
                  </div>
                </div>

                <div class="resource-form-group">
                  <label class="resource-form-label">Sale Ends At</label>
                  <input type="datetime-local" class="resource-form-input" id="resourceFormSaleEnds">
                </div>

                <div class="resource-form-group">
                  <label class="resource-form-label">Revenue Share % (for creators)</label>
                  <input type="number" class="resource-form-input" id="resourceFormRevenueShare" placeholder="70" value="70" min="0" max="100">
                </div>
              </div>
            </div>

            <div class="resource-form-actions">
              <button type="button" class="resource-form-btn delete" id="resourceFormDelete" onclick="deleteResource()" style="display: none;">Delete</button>
              <button type="button" class="resource-form-btn cancel" onclick="closeResourceForm()">Cancel</button>
              <button type="submit" class="resource-form-btn save" id="resourceFormSave">Save Resource</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Community Rules Modal (for viewing rules anytime) -->
    <div class="rules-modal" id="rulesModal">
      <div class="rules-modal-content">
        <button class="rules-modal-close" onclick="closeRulesModal()">✕</button>
        <div class="rules-modal-header">
          <div class="rules-icon">📋</div>
          <h2 class="rules-title">Community Rules</h2>
          <p class="rules-subtitle">Welcome to Vixxxen Academy! Please familiarize yourself with our rules:</p>
        </div>
        <div class="rules-list" id="rulesListContent">
          <!-- Rules will be loaded from database -->
          <div style="text-align: center; padding: 40px; color: #666;">Loading rules...</div>
        </div>
        <button class="rules-accept-btn" onclick="closeRulesModal()">I Understand</button>
      </div>
    </div>

    <!-- Rules Acknowledgment Modal (for first-time subscribers) -->
    <div class="rules-modal" id="rulesAcknowledgeModal" style="z-index: 100001;">
      <div class="rules-modal-content">
        <div class="rules-modal-header">
          <div class="rules-icon">📋</div>
          <h2 class="rules-title">Community Rules</h2>
          <p class="rules-subtitle">Before accessing the community, please read and acknowledge our rules:</p>
        </div>
        <div class="rules-list" id="rulesAcknowledgeContent">
          <!-- Rules will be loaded from database -->
          <div style="text-align: center; padding: 40px; color: #666;">Loading rules...</div>
        </div>
        <div style="margin-top: 20px; padding: 16px; background: rgba(255, 46, 187, 0.1); border-radius: 8px; border: 1px solid rgba(255, 46, 187, 0.2);">
          <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer;">
            <input type="checkbox" id="rulesAcknowledgeCheckbox" style="margin-top: 4px; width: 18px; height: 18px; cursor: pointer;">
            <span style="color: #ccc; font-size: 0.9rem; line-height: 1.5;">I have read and agree to abide by these community rules. I understand that violating these rules may result in removal from the community.</span>
          </label>
        </div>
        <button class="rules-accept-btn" id="rulesAcknowledgeBtn" onclick="acknowledgeRules()" disabled style="opacity: 0.5;">
          Accept & Continue
        </button>
      </div>
    </div>

    <!-- Character Detail Modal -->
    <div class="character-modal" id="characterModal">
      <div class="character-modal-content">
        <button class="character-modal-close" onclick="closeCharacterModal()">✕</button>

        <div class="character-modal-header">
          <img id="modalCharacterImage" class="character-modal-image" src="" alt="">
          <div class="character-modal-info">
            <div class="character-modal-name" id="modalCharacterName"></div>
            <div class="character-modal-category" id="modalCharacterCategory"></div>
            <div class="character-modal-description" id="modalCharacterDescription"></div>

            <div class="character-modal-tags" id="modalCharacterTags"></div>

            <div class="character-modal-purchase">
              <div class="character-modal-price" id="modalCharacterPrice">$14.99</div>
              <button class="character-modal-buy-btn" id="modalBuyBtn" onclick="purchaseCharacter()">
                💳 Purchase Character
              </button>
            </div>
          </div>
        </div>

        <div class="character-modal-gallery">
          <div class="character-modal-gallery-title">Example Gallery</div>
          <div class="character-gallery-grid" id="modalCharacterGallery">
            <!-- Gallery images will be populated here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Image Lightbox Modal -->
    <div class="lightbox-modal" id="imageLightbox">
      <button class="lightbox-close" onclick="closeLightbox()">✕</button>
      <button class="lightbox-nav lightbox-prev" onclick="navigateLightbox(-1)">‹</button>
      <button class="lightbox-nav lightbox-next" onclick="navigateLightbox(1)">›</button>
      <img id="lightboxImage" class="lightbox-image" src="" alt="">
      <div class="lightbox-counter" id="lightboxCounter">1 / 1</div>
    </div>

    <!-- Payment Success Modal -->
    <div class="payment-modal" id="paymentSuccessModal">
      <div class="payment-modal-content success">
        <div class="payment-modal-icon">🎉</div>
        <h2 class="payment-modal-title">Payment Successful!</h2>
        <p class="payment-modal-message" id="paymentSuccessMessage">
          Your subscription is now active!
        </p>
        <button class="payment-modal-button success" onclick="closePaymentModal()">Start Creating</button>
      </div>
    </div>

    <!-- Payment Failure Modal -->
    <div class="payment-modal" id="paymentFailureModal">
      <div class="payment-modal-content failure">
        <div class="payment-modal-icon">⚠️</div>
        <h2 class="payment-modal-title">Payment Failed</h2>
        <p class="payment-modal-message">
          Your payment could not be processed. Please try again or contact support if the problem persists.
        </p>
        <button class="payment-modal-button failure" onclick="closePaymentModal()">Try Again</button>
      </div>
    </div>

    <!-- Payment Modal Test Panel -->
    <div style="position: fixed; bottom: 20px; right: 20px; z-index: 60000; background: rgba(0,0,0,0.9); padding: 16px; border-radius: 12px; border: 1px solid #333; display: none; max-height: 80vh; overflow-y: auto;" id="paymentTestPanel">
      <div style="color: white; font-size: 0.9rem; margin-bottom: 4px; font-weight: 600;">🧪 Payment Modal Tests</div>
      <div style="color: #666; font-size: 0.75rem; margin-bottom: 12px;">Press 'p' 3 times to toggle</div>

      <div style="color: #888; font-size: 0.8rem; margin-bottom: 8px; font-weight: 600;">Subscriptions:</div>
      <button onclick="showPaymentSuccess('starter')" style="display: block; width: 100%; margin-bottom: 6px; padding: 6px 12px; background: #00ff88; border: none; border-radius: 6px; color: #0f0f0f; font-weight: 600; cursor: pointer; font-size: 0.85rem;">Starter Plan</button>
      <button onclick="showPaymentSuccess('creator')" style="display: block; width: 100%; margin-bottom: 6px; padding: 6px 12px; background: #00ff88; border: none; border-radius: 6px; color: #0f0f0f; font-weight: 600; cursor: pointer; font-size: 0.85rem;">Creator Plan</button>
      <button onclick="showPaymentSuccess('pro')" style="display: block; width: 100%; margin-bottom: 6px; padding: 6px 12px; background: #00ff88; border: none; border-radius: 6px; color: #0f0f0f; font-weight: 600; cursor: pointer; font-size: 0.85rem;">Pro Plan</button>
      <button onclick="showPaymentSuccess('supernova')" style="display: block; width: 100%; margin-bottom: 6px; padding: 6px 12px; background: #00ff88; border: none; border-radius: 6px; color: #0f0f0f; font-weight: 600; cursor: pointer; font-size: 0.85rem;">Supernova Membership</button>
      <button onclick="showPaymentSuccess('mentorship')" style="display: block; width: 100%; margin-bottom: 12px; padding: 6px 12px; background: #00ff88; border: none; border-radius: 6px; color: #0f0f0f; font-weight: 600; cursor: pointer; font-size: 0.85rem;">Mentorship Program</button>

      <div style="color: #888; font-size: 0.8rem; margin-bottom: 8px; font-weight: 600;">Credit Packages:</div>
      <button onclick="showPaymentSuccess('credits_500')" style="display: block; width: 100%; margin-bottom: 6px; padding: 6px 12px; background: #00b2ff; border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; font-size: 0.85rem;">500 Credits</button>
      <button onclick="showPaymentSuccess('credits_1000')" style="display: block; width: 100%; margin-bottom: 6px; padding: 6px 12px; background: #00b2ff; border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; font-size: 0.85rem;">1,000 Credits</button>
      <button onclick="showPaymentSuccess('credits_2500')" style="display: block; width: 100%; margin-bottom: 12px; padding: 6px 12px; background: #00b2ff; border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; font-size: 0.85rem;">2,500 Credits</button>

      <div style="color: #888; font-size: 0.8rem; margin-bottom: 8px; font-weight: 600;">Marketplace:</div>
      <button onclick="showPaymentSuccess('character')" style="display: block; width: 100%; margin-bottom: 12px; padding: 6px 12px; background: #ff2ebb; border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; font-size: 0.85rem;">Character Purchase</button>

      <button onclick="showPaymentFailure()" style="display: block; width: 100%; margin-bottom: 8px; padding: 8px 16px; background: #ff4444; border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer;">Test Failure</button>
      <button onclick="document.getElementById('paymentTestPanel').style.display='none'" style="display: block; width: 100%; padding: 6px 12px; background: #333; border: none; border-radius: 6px; color: #888; font-size: 0.8rem; cursor: pointer;">Close</button>
    </div>

    <!-- Character Form Modal (Add/Edit) -->
    <div class="resource-form-modal" id="characterFormModal">
      <div class="resource-form-content" style="max-width: 700px;">
        <div class="resource-form-header">
          <h3 class="resource-form-title" id="characterFormTitle">Add New Character</h3>
          <button class="resource-form-close" onclick="closeCharacterForm()">✕</button>
        </div>
        <div class="resource-form-body">
          <form id="characterForm" onsubmit="saveCharacter(event)">
            <input type="hidden" id="characterFormId" value="">

            <div class="resource-form-row">
              <div class="resource-form-group">
                <label class="resource-form-label">Name *</label>
                <input type="text" class="resource-form-input" id="characterFormName" required placeholder="e.g., Aika">
              </div>
              <div class="resource-form-group">
                <label class="resource-form-label">Category *</label>
                <input type="text" class="resource-form-input" id="characterFormCategory" required placeholder="e.g., Fitness & Athletic">
              </div>
            </div>

            <div class="resource-form-group">
              <label class="resource-form-label">Description</label>
              <textarea class="resource-form-textarea" id="characterFormDescription" placeholder="A brief description of this AI character..." style="height: 80px;"></textarea>
            </div>

            <div class="resource-form-row">
              <div class="resource-form-group">
                <label class="resource-form-label">Price ($)</label>
                <input type="number" class="resource-form-input" id="characterFormPrice" placeholder="0 for free" min="0" step="0.01">
              </div>
              <div class="resource-form-group">
                <label class="resource-form-label">Sort Order</label>
                <input type="number" class="resource-form-input" id="characterFormSortOrder" placeholder="1, 2, 3..." min="0">
              </div>
            </div>

            <div class="resource-form-group">
              <label class="resource-form-label">Tags (comma-separated)</label>
              <input type="text" class="resource-form-input" id="characterFormTags" placeholder="Fitness, Athletic, Healthy">
            </div>

            <div class="resource-form-group">
              <label class="resource-form-label">Character Image</label>
              <div class="resource-thumbnail-upload">
                <div class="resource-thumbnail-preview" id="characterThumbnailPreview">
                  <span class="resource-thumbnail-placeholder">👤 No image</span>
                </div>
                <div class="resource-thumbnail-actions">
                  <input type="file" id="characterThumbnailFile" accept="image/*" style="display: none;" onchange="handleCharacterThumbnailUpload(event)">
                  <button type="button" class="resource-form-btn cancel" onclick="document.getElementById('characterThumbnailFile').click()">
                    📤 Upload Image
                  </button>
                  <span style="color: #666; font-size: 0.85rem;">or</span>
                  <input type="url" class="resource-form-input" id="characterFormImageUrl" placeholder="Paste image URL" style="flex: 1;">
                </div>
              </div>
            </div>

            <div class="resource-form-row">
              <div class="resource-form-group">
                <label class="resource-form-label">LoRA Filename</label>
                <input type="text" class="resource-form-input" id="characterFormLoraUrl" placeholder="character_lora.safetensors">
              </div>
              <div class="resource-form-group">
                <label class="resource-form-label">Trigger Word</label>
                <input type="text" class="resource-form-input" id="characterFormTriggerWord" placeholder="e.g., aika_style">
              </div>
            </div>

            <div class="resource-form-group">
              <label class="resource-form-label">Example Gallery Images</label>
              <div id="characterGalleryContainer" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
                <!-- Gallery images will be rendered here -->
              </div>
              <div style="display: flex; gap: 10px; align-items: center;">
                <input type="url" class="resource-form-input" id="characterGalleryUrlInput" placeholder="Paste image URL and click Add" style="flex: 1;">
                <button type="button" class="resource-form-btn cancel" onclick="addCharacterGalleryImage()" style="white-space: nowrap;">+ Add Image</button>
              </div>
              <input type="file" id="characterGalleryFileInput" accept="image/*" multiple style="display: none;" onchange="handleCharacterGalleryUpload(event)">
              <button type="button" class="resource-form-btn cancel" onclick="document.getElementById('characterGalleryFileInput').click()" style="margin-top: 8px; width: 100%;">
                📤 Upload Multiple Images
              </button>
            </div>

            <div class="resource-form-group">
              <label class="resource-form-label" style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="characterFormIsActive" checked style="width: auto;">
                Active (visible in marketplace)
              </label>
            </div>

            <div class="resource-form-actions">
              <button type="button" class="resource-form-btn delete" id="characterFormDelete" onclick="deleteCharacter()" style="display: none;">Delete</button>
              <button type="button" class="resource-form-btn cancel" onclick="closeCharacterForm()">Cancel</button>
              <button type="submit" class="resource-form-btn save" id="characterFormSave">Save Character</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Subscription Page Section -->
    <div class="tab-section" id="subscriptionSection">
      <div class="subscription-page">
        <div class="subscription-header">
          <h1 class="subscription-title">Choose Your Plan</h1>
          <p class="subscription-subtitle">Select the perfect plan for your creative needs. All plans include access to all AI models.</p>
        </div>

        <div class="pricing-cards">
          <!-- Starter Plan -->
          <div class="pricing-card">
            <div class="pricing-tier">Starter</div>
            <div class="pricing-name">Basic</div>
            <div class="pricing-price">$20<span>/mo</span></div>
            <div class="pricing-period">Billed monthly</div>

            <div class="pricing-credits">
              <div class="pricing-credits-amount">1,000</div>
              <div class="pricing-credits-label">Credits per month</div>
            </div>

            <ul class="pricing-features">
              <li class="pricing-feature">166 Qwen HD Images (1152x1536)</li>
              <li class="pricing-feature">166 Seedream Images</li>
              <li class="pricing-feature">142 Qwen Inpaints</li>
              <li class="pricing-feature">76 Nano Banana Images</li>
              <li class="pricing-feature">Image Editing Tools</li>
              <li class="pricing-feature">AI Chat (Grok-4)</li>
              <li class="pricing-feature">Standard Support</li>
              <li class="pricing-feature disabled">Priority Processing</li>
            </ul>

            <button class="pricing-cta" onclick="selectPlan('starter', 20)">Get Started</button>
          </div>

          <!-- Creator Plan (Featured) -->
          <div class="pricing-card featured">
            <div class="pricing-tier">Most Popular</div>
            <div class="pricing-name">Creator</div>
            <div class="pricing-price">$50<span>/mo</span></div>
            <div class="pricing-period">Billed monthly</div>

            <div class="pricing-credits">
              <div class="pricing-credits-amount">3,000</div>
              <div class="pricing-credits-label">Credits per month</div>
            </div>

            <ul class="pricing-features">
              <li class="pricing-feature">500 Qwen HD Images (1152x1536)</li>
              <li class="pricing-feature">500 Seedream Images</li>
              <li class="pricing-feature">428 Qwen Inpaints</li>
              <li class="pricing-feature">230 Nano Banana Images</li>
              <li class="pricing-feature">25 Veo Videos (720p/1080p)</li>
              <li class="pricing-feature">Priority Support</li>
              <li class="pricing-feature">Priority Processing</li>
              <li class="pricing-feature">All AI Models Access</li>
            </ul>

            <button class="pricing-cta" onclick="selectPlan('creator', 50)">Get Creator</button>
          </div>

          <!-- Pro Plan -->
          <div class="pricing-card">
            <div class="pricing-tier">Professional</div>
            <div class="pricing-name">Pro</div>
            <div class="pricing-price">$95<span>/mo</span></div>
            <div class="pricing-period">Billed monthly</div>

            <div class="pricing-credits">
              <div class="pricing-credits-amount">6,500</div>
              <div class="pricing-credits-label">Credits per month</div>
            </div>

            <ul class="pricing-features">
              <li class="pricing-feature">1,083 Qwen HD Images (1152x1536)</li>
              <li class="pricing-feature">1,083 Seedream Images</li>
              <li class="pricing-feature">928 Qwen Inpaints</li>
              <li class="pricing-feature">500 Nano Banana Images</li>
              <li class="pricing-feature">54 Veo Videos (720p/1080p)</li>
              <li class="pricing-feature">24/7 Premium Support</li>
              <li class="pricing-feature">Priority Processing</li>
              <li class="pricing-feature">All AI Models + API Access</li>
            </ul>

            <button class="pricing-cta" onclick="selectPlan('pro', 95)">Go Pro</button>
          </div>
        </div>
      </div>
    </div>
    <!-- End Subscription Page Section -->

    <!-- Account Page Section -->
    <div class="tab-section" id="accountSection">
      <div class="account-page">
        <div class="account-header">
          <h1 class="account-title">Manage Account</h1>
          <p class="account-subtitle">Update your profile and account settings</p>
        </div>

        <div class="account-grid">
          <!-- Profile Card -->
          <div class="account-card">
            <div class="account-card-header">
              <h2 class="account-card-title">👤 Profile Information</h2>
            </div>
            <div class="account-card-body">
              <div class="account-avatar-section">
                <div class="account-avatar" id="accountAvatar">
                  <img id="accountAvatarImg" src="" alt="Avatar" style="display: none; width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                  <span id="accountAvatarText">👤</span>
                </div>
                <input type="file" id="avatarFileInput" accept="image/*" onchange="handleAvatarUpload(event)" style="display: none;">
                <button class="account-btn secondary" onclick="document.getElementById('avatarFileInput').click()" id="avatarUploadBtn">Change Avatar</button>
              </div>

              <div class="account-field">
                <label class="account-label">Display Name</label>
                <input type="text" class="account-input" id="accountName" placeholder="Your name">
              </div>

              <div class="account-field">
                <label class="account-label">Email</label>
                <input type="email" class="account-input" id="accountEmail" disabled placeholder="your@email.com">
                <span class="account-hint">Email cannot be changed</span>
              </div>

              <button class="account-btn primary" onclick="updateProfile()">Save Changes</button>
            </div>
          </div>

          <!-- Security Card -->
          <div class="account-card">
            <div class="account-card-header">
              <h2 class="account-card-title">🔒 Security</h2>
            </div>
            <div class="account-card-body">
              <div class="account-field">
                <label class="account-label">Current Password</label>
                <input type="password" class="account-input" id="currentPassword" placeholder="Enter current password">
              </div>

              <div class="account-field">
                <label class="account-label">New Password</label>
                <input type="password" class="account-input" id="newPassword" placeholder="Enter new password">
              </div>

              <div class="account-field">
                <label class="account-label">Confirm New Password</label>
                <input type="password" class="account-input" id="confirmPassword" placeholder="Confirm new password">
              </div>

              <button class="account-btn primary" onclick="changePassword()">Change Password</button>
            </div>
          </div>

          <!-- Subscription Status Card -->
          <div class="account-card">
            <div class="account-card-header">
              <h2 class="account-card-title">⭐ Subscription</h2>
            </div>
            <div class="account-card-body">
              <div class="account-subscription-info">
                <div class="account-plan-badge" id="accountPlanBadge">Free Plan</div>
                <div class="account-credits-display">
                  <span class="account-credits-number" id="accountCredits">0</span>
                  <span class="account-credits-label">Credits Remaining</span>
                </div>
              </div>

              <div class="account-subscription-details">
                <div class="account-detail-row">
                  <span class="account-detail-label">Plan:</span>
                  <span class="account-detail-value" id="accountPlanName">Free</span>
                </div>
                <div class="account-detail-row">
                  <span class="account-detail-label">Member since:</span>
                  <span class="account-detail-value" id="accountMemberSince">-</span>
                </div>
              </div>

              <button class="account-btn primary" onclick="openSubscriptionPage()">Upgrade Plan</button>
            </div>
          </div>

          <!-- Custom Character Orders Card -->
          <div class="account-card">
            <div class="account-card-header">
              <h2 class="account-card-title">🎨 Custom Character Orders</h2>
            </div>
            <div class="account-card-body">
              <div id="customOrdersSection">
                <div id="customOrdersList" style="margin-bottom: 16px;">
                  <!-- Orders will be populated here -->
                  <div style="text-align: center; color: #888; padding: 20px 0;">
                    Loading orders...
                  </div>
                </div>
                <button class="account-btn secondary" onclick="loadCustomCharacterOrders()" style="margin-bottom: 12px;">Refresh Orders</button>
                <button class="account-btn primary" onclick="openCustomCharacterOrderModal()">Order Custom Character</button>
              </div>
            </div>
          </div>

          <!-- Danger Zone Card -->
          <div class="account-card danger">
            <div class="account-card-header">
              <h2 class="account-card-title">⚠️ Danger Zone</h2>
            </div>
            <div class="account-card-body">
              <p class="account-warning-text">Once you delete your account, there is no going back. All your data, credits, and generated content will be permanently deleted.</p>
              <button class="account-btn danger" onclick="confirmDeleteAccount()">Delete Account</button>
            </div>
          </div>
        </div>

        <button class="account-back-btn" onclick="goBackFromAccount()">← Back</button>
      </div>
    </div>
    <!-- End Account Page Section -->

    <!-- Unified Image Library Modal (handles both flagged images and library view) -->
    <div class="modal-overlay" id="imageLibraryModal">
      <div class="modal-content">
        <div class="modal-header" id="libraryModalHeader">
          <h2 id="libraryModalTitle">My Images</h2>
          <button class="modal-close" onclick="closeImageLibraryModal()">&times;</button>
        </div>
        <div class="modal-body">
          <!-- Flagged Image View (shown when image is flagged) -->
          <div id="flaggedImageView" style="display: none;">
            <div class="flagged-view-content">
              <div class="flagged-icon">⚠️</div>
              <p style="color: #ccc; margin-bottom: 12px;">
                This image was flagged by our content moderation system:
              </p>
              <div class="flagged-reasons">
                <ul id="flagReasonsList">
                  <!-- Reasons inserted by JS -->
                </ul>
              </div>
              <!-- Flagged image preview -->
              <div id="flaggedImagePreview" style="display: none; margin: 16px 0; max-height: 200px; overflow: hidden; border-radius: 8px;">
                <!-- Image inserted by JS -->
              </div>
              <!-- Appeal form -->
              <div id="appealSection" class="appeal-form" style="display: none;">
                <p style="color: #888; font-size: 0.9rem; margin-bottom: 12px;">
                  If you believe this was flagged in error, you can submit an appeal. We'll review it within 24-48 hours.
                </p>
                <label>Why should this image be approved?</label>
                <textarea id="appealReasonInput" rows="3" placeholder="Explain why you think this image should be approved..."></textarea>
              </div>
            </div>
          </div>

          <!-- Library View (shown when viewing image library) -->
          <div id="libraryGridView">
            <!-- Filter tabs -->
            <div class="library-modal-filters">
              <button class="lib-filter-btn active" data-filter="all" onclick="filterLibraryModal('all')">All</button>
              <button class="lib-filter-btn" data-filter="approved" onclick="filterLibraryModal('approved')">Approved</button>
              <button class="lib-filter-btn" data-filter="pending" onclick="filterLibraryModal('pending_review')">Pending</button>
              <button class="lib-filter-btn" data-filter="rejected" onclick="filterLibraryModal('rejected')">Rejected</button>
            </div>
            <!-- Image grid -->
            <div id="libraryModalGrid" class="library-modal-grid">
              <div class="library-modal-loading">Loading...</div>
            </div>
          </div>
        </div>
        <div class="modal-footer" id="libraryModalFooter">
          <button class="account-btn secondary" onclick="closeImageLibraryModal()">Close</button>
          <button class="account-btn primary" id="submitAppealBtn" onclick="submitModerationAppeal()" style="display: none;">Submit Appeal</button>
        </div>
      </div>
    </div>

    <!-- Billing Page Section -->
    <div class="tab-section" id="billingSection">
      <div class="account-page">
        <div class="account-header">
          <h1 class="account-title">Billing</h1>
          <p class="account-subtitle">Purchase credits and view transaction history</p>
        </div>

        <div class="account-grid">
          <!-- Buy Credits Card -->
          <div class="account-card">
            <div class="account-card-header">
              <h2 class="account-card-title">🪙 Buy Credits</h2>
            </div>
            <div class="account-card-body">
              <div class="credits-balance-display">
                <span class="credits-balance-number" id="billingCredits">0</span>
                <span class="credits-balance-label">Current Balance</span>
              </div>

              <!-- TEST PRICES - CHANGE BACK FOR PRODUCTION -->
              <div class="credits-packages">
                <button class="credits-package" onclick="purchaseCredits(500, 1.00)">
                  <span class="package-credits">500</span>
                  <span class="package-price">$1</span>
                </button>
                <button class="credits-package" onclick="purchaseCredits(1000, 1.50)">
                  <span class="package-credits">1,000</span>
                  <span class="package-price">$1.50</span>
                </button>
                <button class="credits-package featured" onclick="purchaseCredits(2500, 2.00)">
                  <span class="package-credits">2,500</span>
                  <span class="package-price">$2</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Transaction History Card -->
          <div class="account-card wide">
            <div class="account-card-header">
              <h2 class="account-card-title">📜 Transaction History</h2>
            </div>
            <div class="account-card-body">
              <div class="transaction-table-container">
                <table class="transaction-table">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Type</th>
                      <th>Amount</th>
                      <th>Description</th>
                    </tr>
                  </thead>
                  <tbody id="transactionTableBody">
                    <tr class="transaction-loading">
                      <td colspan="4">Loading transactions...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <button class="account-back-btn" onclick="goBackFromBilling()">← Back</button>
      </div>
    </div>
    <!-- End Billing Page Section -->

  </div>

  <!-- Site Footer -->
  <footer class="site-footer">
    <div class="footer-content">
      <div class="footer-ai-disclosure">
        <span class="ai-badge">🤖 AI</span>
        <span>All characters and content on this platform are entirely AI-generated. No real persons are depicted.</span>
      </div>
      <div class="footer-main">
        <span class="footer-copyright">&copy; 2025 Vixxxen</span>
        <div class="footer-links">
          <a href="#" onclick="openPolicyModal('terms'); return false;">Terms</a>
          <a href="#" onclick="openPolicyModal('privacy'); return false;">Privacy</a>
          <a href="#" onclick="openPolicyModal('refund'); return false;">Refunds</a>
          <a href="#" onclick="openPolicyModal('prohibited'); return false;">Prohibited Content</a>
          <a href="#" onclick="open2257Modal(); return false;">2257</a>
          <a href="#" onclick="openPolicyModal('faq'); return false;">FAQ</a>
          <a href="#" onclick="openPolicyModal('contact'); return false;">Contact</a>
        </div>
      </div>
    </div>
  </footer>

  <!-- Policy Modal -->
  <div class="policy-modal" id="policyModal">
    <div class="policy-modal-content">
      <button class="policy-modal-close" onclick="closePolicyModal()">✕</button>
      <div class="policy-modal-body" id="policyModalBody">
        <!-- Policy content will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Policy Editor Modal (Admin) -->
  <div class="resource-form-modal" id="policyEditorModal">
    <div class="resource-form-content" style="max-width: 800px;">
      <div class="resource-form-header">
        <h3 class="resource-form-title" id="policyEditorTitle">Edit Policy</h3>
        <button class="resource-form-close" onclick="closePolicyEditor()">✕</button>
      </div>
      <div class="resource-form-body">
        <form id="policyEditorForm" onsubmit="savePolicy(event)">
          <input type="hidden" id="policyEditorType" value="">

          <div class="resource-form-group">
            <label class="resource-form-label">Title</label>
            <input type="text" class="resource-form-input" id="policyEditorTitleInput" required placeholder="Policy Title">
          </div>

          <div class="resource-form-group">
            <label class="resource-form-label">Content (HTML)</label>
            <textarea class="resource-form-textarea" id="policyEditorContent" style="height: 400px; font-family: monospace;" placeholder="<h2>Policy Title</h2><p>Content...</p>"></textarea>
          </div>

          <div class="resource-form-actions">
            <button type="button" class="resource-form-btn cancel" onclick="closePolicyEditor()">Cancel</button>
            <button type="submit" class="resource-form-btn save" id="policyEditorSave">Save Policy</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Age Verification Modal -->
  <div class="age-verification-modal" id="ageVerificationModal">
    <div class="age-verification-content">
      <div class="age-verification-header">
        <h2 class="age-verification-title">Age Verification Required</h2>
      </div>
      <div class="age-verification-body" id="ageVerificationBody">
        <div class="age-verification-icon">🔞</div>
        <p class="age-verification-text">
          NSFW content is intended for adults only. By enabling NSFW mode, you confirm that:
        </p>
        <ul class="age-verification-list">
          <li>You are at least 18 years of age</li>
          <li>It is legal to view adult content in your jurisdiction</li>
          <li>You wish to view content that may include nudity or mature themes</li>
        </ul>
        <label class="age-verification-checkbox">
          <input type="checkbox" id="ageConfirmCheckbox">
          <span>I confirm that I am 18 years of age or older</span>
        </label>
        <div class="age-verification-actions">
          <button class="age-verification-btn cancel" onclick="closeAgeVerificationModal()">Cancel</button>
          <button class="age-verification-btn confirm" id="ageVerifyBtn" onclick="submitAgeVerification()" disabled>
            Verify & Enable NSFW
          </button>
        </div>
      </div>
      <div class="age-verification-blocked" id="ageVerificationBlocked" style="display: none;">
        <div class="age-verification-icon">🚫</div>
        <p class="age-verification-text">
          NSFW content is not available in your region due to local regulations.
        </p>
        <p class="age-verification-subtext">
          We comply with age verification laws in your jurisdiction.
        </p>
        <div class="age-verification-actions">
          <button class="age-verification-btn cancel" onclick="closeAgeVerificationModal()">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Report Modal -->
  <div class="report-modal" id="reportModal">
    <div class="report-modal-content">
      <div class="report-modal-header">
        <h3 class="report-modal-title">Report Content</h3>
        <button class="report-modal-close" onclick="closeReportModal()">&times;</button>
      </div>
      <form id="reportForm" onsubmit="submitReport(event)">
        <input type="hidden" id="reportContentType" value="">
        <input type="hidden" id="reportContentId" value="">
        <input type="hidden" id="reportContentUrl" value="">
        <input type="hidden" id="reportContentPreview" value="">
        <input type="hidden" id="reportedUserId" value="">

        <div class="report-form-group">
          <label class="report-form-label">Reason for report *</label>
          <select class="report-form-select" id="reportReason" required>
            <option value="">Select a reason...</option>
            <option value="illegal_content">Illegal content</option>
            <option value="underage_depiction">Underage depiction</option>
            <option value="non_consensual">Non-consensual content</option>
            <option value="harassment">Harassment or bullying</option>
            <option value="hate_speech">Hate speech</option>
            <option value="impersonation">Impersonation</option>
            <option value="spam">Spam or scam</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="report-form-group">
          <label class="report-form-label">Additional details (optional)</label>
          <textarea class="report-form-textarea" id="reportDetails" placeholder="Provide any additional context that might help us review this report..."></textarea>
        </div>

        <div class="report-form-group">
          <label class="report-form-checkbox">
            <input type="checkbox" id="reportAnonymous">
            <span>Submit anonymously (your identity won't be shared with the reported user)</span>
          </label>
        </div>

        <div class="report-form-actions">
          <button type="button" class="report-btn-cancel" onclick="closeReportModal()">Cancel</button>
          <button type="submit" class="report-btn-submit" id="reportSubmitBtn">Submit Report</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Image Modal -->
  <div class="image-modal" id="imageModal" onclick="closeImageModal()">
    <button class="image-modal-close" onclick="closeImageModal()">✕</button>
    <img id="modalImage" src="" alt="Full size preview">
  </div>

  <!-- Video Modal -->
  <div class="video-modal" id="videoModal" onclick="closeVideoModal(event)">
    <button class="video-modal-close" onclick="closeVideoModal(event)">✕</button>
    <video id="modalVideo" controls autoplay>
      <source id="modalVideoSource" src="" type="video/mp4">
      Your browser does not support video playback.
    </video>
  </div>

  <!-- GPU Configuration Modal (Admin) -->
  <div class="resource-form-modal" id="gpuConfigModal">
    <div class="resource-form-content" style="max-width: 600px;">
      <div class="resource-form-header">
        <h3 class="resource-form-title">GPU Configuration</h3>
        <button class="resource-form-close" onclick="closeGpuConfigModal()">✕</button>
      </div>
      <div class="resource-form-body">
        <!-- Status Indicators -->
        <div class="gpu-status-grid" id="gpuStatusGrid">
          <div class="gpu-status-card">
            <div class="gpu-status-label">Serverless</div>
            <div class="gpu-status-indicator" id="serverlessStatus">
              <span class="status-dot"></span>
              <span class="status-text">Checking...</span>
            </div>
          </div>
          <div class="gpu-status-card">
            <div class="gpu-status-label">Dedicated</div>
            <div class="gpu-status-indicator" id="dedicatedStatus">
              <span class="status-dot"></span>
              <span class="status-text">Not configured</span>
            </div>
          </div>
        </div>

        <!-- Configuration Form -->
        <form id="gpuConfigForm" onsubmit="saveGpuConfig(event)">
          <div class="resource-form-group">
            <label class="resource-form-label">Routing Mode</label>
            <select class="resource-form-input" id="gpuModeSelect">
              <option value="serverless">Serverless Only (Current)</option>
              <option value="dedicated">Dedicated Only</option>
              <option value="hybrid">Hybrid (Dedicated + Serverless Overflow)</option>
              <option value="serverless-primary">Serverless Primary (Dedicated Overflow)</option>
            </select>
            <div class="resource-form-hint" id="gpuModeHint">All jobs route to RunPod Serverless</div>
          </div>

          <div class="resource-form-group">
            <label class="resource-form-label">Dedicated GPU URL</label>
            <div style="display: flex; gap: 8px;">
              <input type="url" class="resource-form-input" id="gpuDedicatedUrlModal" placeholder="https://your-pod-id.runpod.ai" style="flex: 1;">
              <button type="button" class="resource-form-btn" onclick="testDedicatedGpu()" style="width: auto; padding: 0 16px;">Test</button>
            </div>
            <div class="resource-form-hint">URL of your dedicated ComfyUI Pod wrapper</div>
          </div>

          <div class="resource-form-group">
            <label class="resource-form-label">Fallback Timeout (ms)</label>
            <input type="number" class="resource-form-input" id="gpuTimeoutModal" value="5000" min="1000" max="30000" step="500">
            <div class="resource-form-hint">How long to wait for dedicated GPU before falling back (1000-30000ms)</div>
          </div>

          <div class="resource-form-actions">
            <button type="button" class="resource-form-btn cancel" onclick="closeGpuConfigModal()">Cancel</button>
            <button type="submit" class="resource-form-btn save" id="gpuConfigSaveBtn">Save Configuration</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- External JavaScript Modules (load in order) -->
  <script src="js/config.js?v=20260115"></script>
  <script src="js/analytics-tracker.js?v=20260115"></script>
  <script src="js/landing-page.js?v=20260115"></script>
  <script src="js/utils.js?v=20260115"></script>
  <script src="js/zoom-controls.js?v=20260115"></script>
  <script src="js/reporting.js?v=20260115"></script>
  <script src="js/theme.js?v=20260115"></script>
  <script src="js/admin-reports.js?v=20260115"></script>
  <script src="js/character-cache.js?v=20260115"></script>
  <script src="js/admin-characters.js?v=20260115"></script>
  <script src="js/admin-onboarding.js?v=20260115"></script>
  <script src="js/admin-custom-characters.js?v=20260115"></script>
  <script src="js/admin-landing.js?v=20260115"></script>
  <script src="js/custom-character-order.js?v=20260115"></script>
  <script src="js/payment-modals.js?v=20260115"></script>
  <script src="js/analytics.js?v=20260115"></script>
  <script src="js/admin-user-analytics.js?v=20260115"></script>
  <script src="js/modals.js?v=20260115"></script>
  <script src="js/bulk-selection.js?v=20260115"></script>
  <script src="js/account-page.js?v=20260115"></script>
  <script src="js/user-images.js?v=20260117"></script>
  <script src="js/billing-page.js?v=20260115"></script>
  <script src="js/delete-functions.js?v=20260115"></script>
  <script src="js/onboarding-wizard.js?v=20260115"></script>

  <script>
    // ===========================================
    // INLINE APPLICATION CODE
    // ===========================================
    // External modules: config, utils, zoom-controls, reporting, theme,
    // admin-reports, payment-modals, analytics, modals, bulk-selection,
    // account-page, billing-page, delete-functions

    // ===========================================
    // SIDEBAR TOGGLE
    // ===========================================
    function toggleSidebar() {
      const mainNav = document.querySelector('.main-nav');
      const siteFooter = document.querySelector('.site-footer');
      const mobileOverlay = document.getElementById('mobileOverlay');
      const isMobile = window.innerWidth <= 900;

      if (isMobile) {
        // On mobile, toggle mobile-open class (sidebar slides in/out)
        mainNav.classList.toggle('mobile-open');
        if (mobileOverlay) {
          mobileOverlay.classList.toggle('active');
        }
      } else {
        // On desktop, toggle collapsed class
        mainNav.classList.toggle('collapsed');
        if (siteFooter) {
          siteFooter.classList.toggle('sidebar-collapsed');
        }
      }
    }

    // Close mobile sidebar when selecting a tab
    function closeMobileSidebar() {
      const mainNav = document.querySelector('.main-nav');
      const mobileOverlay = document.getElementById('mobileOverlay');
      if (window.innerWidth <= 900) {
        mainNav.classList.remove('mobile-open');
        if (mobileOverlay) {
          mobileOverlay.classList.remove('active');
        }
      }
    }

    // ===========================================
    // SUPABASE STORAGE FUNCTIONS
    // ===========================================

    // Log generation for 2257 compliance
    async function logGeneration(contentType, model, prompt, nsfwMode, outputCount = 1, contentIdentifier = null) {
      try {
        const response = await fetch(`${API_BASE_URL}/api/compliance/log-generation`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: currentUser?.id || null,
            content_identifier: contentIdentifier || `${contentType}-${Date.now()}`,
            content_type: contentType,
            model_used: model,
            prompt: prompt,
            nsfw_mode: nsfwMode || contentMode === 'nsfw',
            output_count: outputCount
          })
        });
        const data = await response.json();
        if (data.logged) {
          console.log('📋 Generation logged for compliance:', data.content_hash);
        }
      } catch (error) {
        // Don't fail generation if logging fails
        console.warn('Failed to log generation:', error);
      }
    }

    // Upload image to Supabase Storage
    async function uploadImageToStorage(imageUrl, metadata = {}) {
      if (!currentUser) {
        console.log('📁 Not logged in, skipping storage upload');
        return null;
      }

      try {
        console.log('📁 Uploading image to Supabase Storage...');

        // Fetch the image from URL
        const response = await fetch(imageUrl);
        const blob = await response.blob();

        // Generate unique filename
        const timestamp = Date.now();
        const randomId = Math.random().toString(36).substring(7);
        const extension = blob.type.includes('png') ? 'png' : 'jpg';
        const fileName = `${currentUser.id}/${timestamp}-${randomId}.${extension}`;

        // Upload to Supabase Storage
        const { data: uploadData, error: uploadError } = await supabaseClient.storage
          .from('generated-images')
          .upload(fileName, blob, {
            contentType: blob.type,
            upsert: false
          });

        if (uploadError) {
          console.error('Storage upload error:', uploadError);
          return null;
        }

        // Get public URL
        const { data: urlData } = supabaseClient.storage
          .from('generated-images')
          .getPublicUrl(fileName);

        const publicUrl = urlData.publicUrl;
        console.log('📁 Image uploaded:', publicUrl);

        // Save metadata to database
        const { data: dbData, error: dbError } = await supabaseClient
          .from('generated_images')
          .insert({
            user_id: currentUser.id,
            storage_path: fileName,
            public_url: publicUrl,
            prompt: metadata.prompt || '',
            negative_prompt: metadata.negativePrompt || '',
            model: metadata.model || 'unknown',
            aspect_ratio: metadata.aspectRatio || '',
            resolution: metadata.resolution || '',
            character_id: metadata.characterId || null,
            credits_used: metadata.creditsUsed || 0,
            is_nsfw: metadata.isNsfw || false,
            metadata: metadata
          })
          .select()
          .single();

        if (dbError) {
          console.error('Database insert error:', dbError);
          return publicUrl; // Still return URL even if DB insert fails
        }

        console.log('📁 Image metadata saved to database');

        // Track save for value moment analysis
        if (window.VxAnalytics && window.VxAnalytics.engagement) {
          window.VxAnalytics.engagement.saved('image', { model: metadata.model });
        }

        return publicUrl;

      } catch (err) {
        console.error('Error uploading image:', err);
        return null;
      }
    }

    // Upload video to Supabase Storage
    async function uploadVideoToStorage(videoUrl, metadata = {}) {
      if (!currentUser) {
        console.log('🎬 Not logged in, skipping video storage upload');
        return null;
      }

      try {
        console.log('🎬 Uploading video to Supabase Storage...');

        // Fetch the video from URL
        const response = await fetch(videoUrl);
        const blob = await response.blob();

        // Generate unique filename
        const timestamp = Date.now();
        const randomId = Math.random().toString(36).substring(7);
        const extension = 'mp4';
        const fileName = `${currentUser.id}/${timestamp}-${randomId}.${extension}`;

        // Upload to Supabase Storage
        const { data: uploadData, error: uploadError } = await supabaseClient.storage
          .from('generated-videos')
          .upload(fileName, blob, {
            contentType: 'video/mp4',
            upsert: false
          });

        if (uploadError) {
          console.error('Video storage upload error:', uploadError);
          return null;
        }

        // Get public URL
        const { data: urlData } = supabaseClient.storage
          .from('generated-videos')
          .getPublicUrl(fileName);

        const publicUrl = urlData.publicUrl;
        console.log('🎬 Video uploaded:', publicUrl);

        // Save metadata to database
        const { data: dbData, error: dbError } = await supabaseClient
          .from('generated_videos')
          .insert({
            user_id: currentUser.id,
            storage_path: fileName,
            public_url: publicUrl,
            prompt: metadata.prompt || '',
            model: metadata.model || 'unknown',
            character_id: metadata.characterId || null,
            duration: metadata.duration || null,
            is_nsfw: metadata.isNsfw || false
          })
          .select()
          .single();

        if (dbError) {
          console.error('Video database insert error:', dbError);
          return publicUrl; // Still return URL even if DB insert fails
        }

        console.log('🎬 Video metadata saved to database');

        // Track save for value moment analysis
        if (window.VxAnalytics && window.VxAnalytics.engagement) {
          window.VxAnalytics.engagement.saved('video', { model: metadata.model });
        }

        return publicUrl;

      } catch (err) {
        console.error('Error uploading video:', err);
        return null;
      }
    }

    // Pagination state for video infinite scroll
    const VIDEO_PAGE_SIZE = 30;
    let videoHistoryOffset = 0;
    let videoHistoryHasMore = true;
    let videoHistoryLoading = false;
    let videoHistoryObserver = null;

    // Load user's video history from Supabase with pagination
    async function loadVideoHistory(offset = 0, limit = VIDEO_PAGE_SIZE) {
      if (!currentUser) return [];

      try {
        console.log(`🎬 Loading video history (offset: ${offset}, limit: ${limit})...`);

        const { data, error } = await supabaseClient
          .from('generated_videos')
          .select('*')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false })
          .range(offset, offset + limit - 1);

        if (error) {
          console.error('Error loading video history:', error);
          return [];
        }

        console.log(`🎬 Loaded ${data.length} videos from history`);
        return data;

      } catch (err) {
        console.error('Error loading video history:', err);
        return [];
      }
    }

    // Create video item HTML
    function createVideoItemHTML(video) {
      // Use pre-computed NSFW flag if available, otherwise check model
      const modelName = video.model || '';
      const isNsfw = video._computedNsfw !== undefined
        ? video._computedNsfw
        : (video.is_nsfw || NSFW_ONLY_MODELS.includes(modelName.toLowerCase()));
      return `
        <div class="select-checkbox" onclick="toggleVideoSelection(event, this)"></div>
        ${isNsfw ? '<span class="nsfw-badge">NSFW</span>' : ''}
        <button class="video-expand-btn" onclick="event.stopPropagation(); showVideoModal('${video.public_url}')" title="Expand video">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 3 21 3 21 9"></polyline>
            <polyline points="9 21 3 21 3 15"></polyline>
            <line x1="21" y1="3" x2="14" y2="10"></line>
            <line x1="3" y1="21" x2="10" y2="14"></line>
          </svg>
        </button>
        <video controls preload="metadata" style="width: 100%; display: block; background: #000;">
          <source src="${video.public_url}" type="video/mp4">
          Your browser does not support video playback.
        </video>
        <div class="output-item-overlay">
          <div class="output-item-info">
            ${video.model || 'Video'}
          </div>
          <div class="output-item-actions">
            <a href="${video.public_url}" download class="icon-btn" title="Download">
              <svg class="download-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
            </a>
            <button class="report-btn" onclick="event.stopPropagation(); openReportModal('video', '${video.id}', '${video.public_url}')" title="Report">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                <line x1="4" y1="22" x2="4" y2="15"></line>
              </svg>
            </button>
            <button class="icon-btn delete-btn" onclick="deleteVideo(this.closest('.output-item'))" title="Delete">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
              </svg>
            </button>
          </div>
        </div>
      `;
    }

    // Add videos to the grid
    function addHistoryVideosToGrid(videos, append = false) {
      const videoOutputGrid = document.getElementById('videoOutputGrid');
      if (!videoOutputGrid) return 0;

      // Get URLs of videos already in the grid
      const existingUrls = new Set();
      videoOutputGrid.querySelectorAll('.output-item').forEach(item => {
        const video = item.querySelector('video source');
        if (video && video.src) existingUrls.add(video.src);
        if (item.dataset.videoUrl) existingUrls.add(item.dataset.videoUrl);
      });

      // Filter out videos that are already displayed
      const newVideos = videos.filter(v => !existingUrls.has(v.public_url));
      let addedCount = 0;

      newVideos.forEach(video => {
        // Skip if already in generatedVideos array
        if (generatedVideos.some(gv => gv.url === video.public_url || gv.id === video.id)) {
          return;
        }

        // Check NSFW: use DB flag OR check if model is NSFW-only (fixes old records)
        const modelName = video.model || '';
        const isNsfw = video.is_nsfw || NSFW_ONLY_MODELS.includes(modelName.toLowerCase());
        video._computedNsfw = isNsfw; // Pass to createVideoItemHTML
        const videoItem = document.createElement('div');
        videoItem.className = 'output-item';
        videoItem.dataset.videoId = video.id || '';
        videoItem.dataset.videoUrl = video.public_url;
        if (isNsfw) {
          videoItem.dataset.nsfw = 'true';
        }
        videoItem.innerHTML = createVideoItemHTML(video);

        // For append (infinite scroll), add before sentinel; otherwise append
        const sentinel = videoOutputGrid.querySelector('.load-more-sentinel');
        if (append && sentinel) {
          videoOutputGrid.insertBefore(videoItem, sentinel);
        } else {
          videoOutputGrid.appendChild(videoItem);
        }

        // Add to generatedVideos array for local tracking
        generatedVideos.push({
          url: video.public_url,
          model: video.model,
          id: video.id,
          timestamp: new Date(video.created_at).getTime()
        });
        addedCount++;
      });

      return addedCount;
    }

    // Load more videos (called by infinite scroll)
    async function loadMoreVideos() {
      if (videoHistoryLoading || !videoHistoryHasMore) return;

      videoHistoryLoading = true;
      const sentinel = document.querySelector('#videoOutputGrid .load-more-sentinel');
      if (sentinel) {
        sentinel.innerHTML = '<div class="loading-spinner"></div> Loading more...';
      }

      try {
        const videos = await loadVideoHistory(videoHistoryOffset, VIDEO_PAGE_SIZE);

        if (videos.length < VIDEO_PAGE_SIZE) {
          videoHistoryHasMore = false;
          if (sentinel) sentinel.remove();
        }

        if (videos.length > 0) {
          addHistoryVideosToGrid(videos, true);
          videoHistoryOffset += videos.length;
        }

        console.log(`🎬 Loaded ${videos.length} more videos. Total offset: ${videoHistoryOffset}, hasMore: ${videoHistoryHasMore}`);
      } catch (err) {
        console.error('Error loading more videos:', err);
      } finally {
        videoHistoryLoading = false;
        if (sentinel && videoHistoryHasMore) {
          sentinel.innerHTML = 'Scroll for more...';
        }
      }
    }

    // Set up infinite scroll observer for videos
    function setupVideoInfiniteScroll() {
      const videoOutputGrid = document.getElementById('videoOutputGrid');
      if (!videoOutputGrid) return;

      // Remove existing sentinel if any
      const existingSentinel = videoOutputGrid.querySelector('.load-more-sentinel');
      if (existingSentinel) existingSentinel.remove();

      // Only add sentinel if there might be more videos
      if (!videoHistoryHasMore) return;

      // Create sentinel element
      const sentinel = document.createElement('div');
      sentinel.className = 'load-more-sentinel';
      sentinel.innerHTML = 'Scroll for more...';
      sentinel.style.cssText = 'grid-column: 1 / -1; text-align: center; padding: 20px; color: #666; font-size: 0.9rem;';
      videoOutputGrid.appendChild(sentinel);

      // Disconnect existing observer
      if (videoHistoryObserver) {
        videoHistoryObserver.disconnect();
      }

      // Create intersection observer
      videoHistoryObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && videoHistoryHasMore && !videoHistoryLoading) {
            loadMoreVideos();
          }
        });
      }, {
        root: videoOutputGrid.closest('.right-panel'),
        rootMargin: '200px',
        threshold: 0.1
      });

      videoHistoryObserver.observe(sentinel);
    }

    // Display video history in the video output grid (initial load)
    async function displayVideoHistory() {
      const videoOutputGrid = document.getElementById('videoOutputGrid');
      if (!videoOutputGrid) return;

      // Check for existing session videos - skip reload to prevent duplicates
      const existingItems = videoOutputGrid.querySelectorAll('.output-item').length;
      if (existingItems > 0) {
        console.log('🎬 Skipping history load - session videos already present');
        return;
      }

      // Reset pagination state
      videoHistoryOffset = 0;
      videoHistoryHasMore = true;
      videoHistoryLoading = false;

      videoOutputGrid.innerHTML = '';
      generatedVideos.length = 0;

      // Load first batch
      const videos = await loadVideoHistory(0, VIDEO_PAGE_SIZE);
      if (videos.length === 0) {
        console.log('🎬 No video history to display');
        return;
      }

      // Update offset
      videoHistoryOffset = videos.length;
      videoHistoryHasMore = videos.length >= VIDEO_PAGE_SIZE;

      // Add videos
      const added = addHistoryVideosToGrid(videos, false);

      console.log(`🎬 Initial video history displayed: ${added} videos, hasMore: ${videoHistoryHasMore}`);

      // Set up infinite scroll
      setupVideoInfiniteScroll();
    }

    // Pagination state for infinite scroll
    const IMAGE_PAGE_SIZE = 50;
    let imageHistoryOffset = 0;
    let imageHistoryHasMore = true;
    let imageHistoryLoading = false;
    let imageHistoryObserver = null;

    // Load user's image history from Supabase with pagination
    async function loadImageHistory(offset = 0, limit = IMAGE_PAGE_SIZE) {
      if (!currentUser) return [];

      try {
        console.log(`📁 Loading image history (offset: ${offset}, limit: ${limit})...`);

        const { data, error } = await supabaseClient
          .from('generated_images')
          .select('*')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false })
          .range(offset, offset + limit - 1);

        if (error) {
          console.error('Error loading image history:', error);
          return [];
        }

        console.log(`📁 Loaded ${data.length} images from history`);
        return data;

      } catch (err) {
        console.error('Error loading image history:', err);
        return [];
      }
    }

    // Add images to the grid (used by both initial load and infinite scroll)
    function addHistoryImagesToGrid(images, append = false) {
      const outputGrid = document.getElementById('outputGrid');
      if (!outputGrid) return;

      // Get URLs of images already in the grid
      const existingUrls = new Set();
      outputGrid.querySelectorAll('.output-item').forEach(item => {
        const img = item.querySelector('img');
        if (img && img.src) existingUrls.add(img.src);
        if (item.dataset.imageUrl) existingUrls.add(item.dataset.imageUrl);
      });

      // Filter out images that are already displayed
      const newImages = images.filter(img => !existingUrls.has(img.public_url));

      newImages.forEach(img => {
        // Skip if already in generatedImages array
        if (generatedImages.some(gi => gi.url === img.public_url || gi.id === img.id)) {
          return;
        }

        // Check NSFW: use DB flag OR check if model is NSFW-only (fixes old records)
        const modelName = img.model || 'Unknown';
        const isNsfwContent = img.is_nsfw || NSFW_ONLY_MODELS.includes(modelName.toLowerCase());

        const imageData = {
          url: img.public_url,
          prompt: img.prompt,
          model: modelName,
          aspectRatio: img.aspect_ratio || 'Square',
          timestamp: new Date(img.created_at).getTime(),
          fromHistory: true,
          id: img.id,
          isNsfw: isNsfwContent
        };
        generatedImages.push(imageData);

        // For append (infinite scroll), add at the end; for initial load, use addImageToGrid
        if (append) {
          addImageToGridEnd(imageData);
        } else if (typeof addImageToGrid === 'function') {
          addImageToGrid(imageData);
        }
      });

      return newImages.length;
    }

    // Add image to end of grid (for infinite scroll - older images go at bottom)
    function addImageToGridEnd(image) {
      const outputGrid = document.getElementById('outputGrid');
      if (!outputGrid) return;

      const imageDiv = document.createElement('div');
      imageDiv.className = 'output-item';
      imageDiv.dataset.imageId = image.id || '';
      imageDiv.dataset.imageUrl = image.url;

      if (image.isNsfw) {
        imageDiv.dataset.nsfw = 'true';
      }

      imageDiv.innerHTML = `
        <div class="select-checkbox" onclick="toggleImageSelection(event, this)"></div>
        ${image.isNsfw ? '<span class="nsfw-badge">NSFW</span>' : ''}
        <img src="${image.url}" alt="Generated image" crossorigin="anonymous" onclick="showImageModal('${image.url}')" title="Click to view full size" loading="lazy">
        <div class="output-item-overlay">
          <div class="output-item-info">
            ${image.model} · ${image.aspectRatio || 'Square'}
          </div>
          <div class="output-item-actions">
            <button class="icon-btn" onclick="downloadImage('${image.url}', ${image.timestamp})" title="Download">
              <svg class="download-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
            </button>
            <div class="send-to-container">
              <button class="icon-btn" onclick="toggleSendToMenu(event, this)" title="Send to...">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
              </button>
              <div class="send-to-menu">
                <button class="send-to-option" onclick="sendToVideo('${image.url}', event)">📹 Send to Video</button>
                <button class="send-to-option" onclick="sendToEdit('${image.url}', event)">✂️ Send to Edit</button>
                <button class="send-to-option" onclick="sendToCaption('${image.url}', event)">💬 Send to Caption</button>
                <button class="send-to-option" onclick="sendToInpaint('${image.url}', event)">🖌️ Send to Inpaint</button>
              </div>
            </div>
            <button class="report-btn" onclick="event.stopPropagation(); openReportModal('image', '${image.timestamp}', '${image.url}')" title="Report">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                <line x1="4" y1="22" x2="4" y2="15"></line>
              </svg>
            </button>
            <button class="icon-btn delete-btn" onclick="deleteImage(this.closest('.output-item'))" title="Delete">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
              </svg>
            </button>
          </div>
        </div>
      `;

      // Insert before the load-more sentinel if it exists, otherwise append
      const sentinel = outputGrid.querySelector('.load-more-sentinel');
      if (sentinel) {
        outputGrid.insertBefore(imageDiv, sentinel);
      } else {
        outputGrid.appendChild(imageDiv);
      }
    }

    // Load more images (called by infinite scroll)
    async function loadMoreImages() {
      if (imageHistoryLoading || !imageHistoryHasMore) return;

      imageHistoryLoading = true;
      const sentinel = document.querySelector('#outputGrid .load-more-sentinel');
      if (sentinel) {
        sentinel.innerHTML = '<div class="loading-spinner"></div> Loading more...';
      }

      try {
        const images = await loadImageHistory(imageHistoryOffset, IMAGE_PAGE_SIZE);

        if (images.length < IMAGE_PAGE_SIZE) {
          imageHistoryHasMore = false;
          if (sentinel) sentinel.remove();
        }

        if (images.length > 0) {
          addHistoryImagesToGrid(images, true);
          imageHistoryOffset += images.length;
        }

        console.log(`📁 Loaded ${images.length} more images. Total offset: ${imageHistoryOffset}, hasMore: ${imageHistoryHasMore}`);
      } catch (err) {
        console.error('Error loading more images:', err);
      } finally {
        imageHistoryLoading = false;
        if (sentinel && imageHistoryHasMore) {
          sentinel.innerHTML = 'Scroll for more...';
        }
      }
    }

    // Set up infinite scroll observer for images
    function setupImageInfiniteScroll() {
      const outputGrid = document.getElementById('outputGrid');
      if (!outputGrid) return;

      // Remove existing sentinel if any
      const existingSentinel = outputGrid.querySelector('.load-more-sentinel');
      if (existingSentinel) existingSentinel.remove();

      // Only add sentinel if there might be more images
      if (!imageHistoryHasMore) return;

      // Create sentinel element
      const sentinel = document.createElement('div');
      sentinel.className = 'load-more-sentinel';
      sentinel.innerHTML = 'Scroll for more...';
      sentinel.style.cssText = 'grid-column: 1 / -1; text-align: center; padding: 20px; color: #666; font-size: 0.9rem;';
      outputGrid.appendChild(sentinel);

      // Disconnect existing observer
      if (imageHistoryObserver) {
        imageHistoryObserver.disconnect();
      }

      // Create intersection observer
      imageHistoryObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && imageHistoryHasMore && !imageHistoryLoading) {
            loadMoreImages();
          }
        });
      }, {
        root: outputGrid.closest('.right-panel'),
        rootMargin: '200px',
        threshold: 0.1
      });

      imageHistoryObserver.observe(sentinel);
    }

    // Display image history in the grid (initial load)
    async function displayImageHistory() {
      const outputGrid = document.getElementById('outputGrid');
      if (!outputGrid) return;

      // Check for existing session images - skip reload to prevent duplicates
      const existingItems = outputGrid.querySelectorAll('.output-item').length;
      if (existingItems > 0) {
        console.log('📁 Skipping history load - session images already present');
        return;
      }

      // Reset pagination state
      imageHistoryOffset = 0;
      imageHistoryHasMore = true;
      imageHistoryLoading = false;

      outputGrid.innerHTML = '';
      generatedImages.length = 0;

      // Load first batch
      const history = await loadImageHistory(0, IMAGE_PAGE_SIZE);
      if (history.length === 0) {
        console.log('📁 No image history to display');
        return;
      }

      // Update offset
      imageHistoryOffset = history.length;
      imageHistoryHasMore = history.length >= IMAGE_PAGE_SIZE;

      // Add images (reversed so newest appear first when using addImageToGrid)
      const added = addHistoryImagesToGrid(history.reverse(), false);

      console.log(`📁 Initial image history displayed: ${added} images, hasMore: ${imageHistoryHasMore}`);

      // Set up infinite scroll
      setupImageInfiniteScroll();
    }

    // Load user's edit history from Supabase (crops, eraser, bg-remover)
    async function loadEditHistory() {
      if (!currentUser) return [];

      try {
        console.log('✂️ Loading edit history...');

        const { data, error } = await supabaseClient
          .from('generated_images')
          .select('*')
          .eq('user_id', currentUser.id)
          .or('metadata->>type.eq.crop,metadata->>type.eq.eraser,metadata->>type.eq.bg-remover')
          .order('created_at', { ascending: false })
          .limit(50);

        if (error) {
          console.error('Error loading edit history:', error);
          return [];
        }

        console.log(`✂️ Loaded ${data.length} edited images from history`);
        return data;

      } catch (err) {
        console.error('Error loading edit history:', err);
        return [];
      }
    }

    // Display edit history in the grid
    async function displayEditHistory() {
      // Get the edit output grid
      const outputGrid = document.getElementById('editOutputGrid');
      if (!outputGrid) return;

      // Check for existing session items - skip reload to prevent duplicates
      const existingItems = outputGrid.querySelectorAll('.output-item').length;
      if (existingItems > 0) {
        console.log('✂️ Skipping history load - session edits already present');
        return;
      }

      const history = await loadEditHistory();
      if (history.length === 0) {
        console.log('✂️ No edit history to display');
        return;
      }

      // Clear placeholder if it exists
      const placeholder = outputGrid.querySelector('.output-placeholder');
      if (placeholder) {
        outputGrid.innerHTML = '';
      }

      // Add history images to the grid (newest first, so we reverse)
      history.reverse().forEach(img => {
        const metadata = img.metadata || {};
        // Check NSFW: use DB flag OR check if model is NSFW-only (fixes old records)
        const modelName = img.model || metadata.model || '';
        const isNsfw = img.is_nsfw || NSFW_ONLY_MODELS.includes(modelName.toLowerCase());
        const editType = metadata.type || 'Edit';
        const typeLabel = editType.charAt(0).toUpperCase() + editType.slice(1);

        const outputItem = document.createElement('div');
        outputItem.className = 'output-item';
        outputItem.dataset.imageUrl = img.public_url;
        outputItem.dataset.imageId = img.id || '';
        if (isNsfw) {
          outputItem.dataset.nsfw = 'true';
        }

        outputItem.innerHTML = `
          ${isNsfw ? '<span class="nsfw-badge">NSFW</span>' : ''}
          <img src="${img.public_url}" alt="Edited image" onclick="showImageModal('${img.public_url}')" loading="lazy">
          <div class="output-item-overlay">
            <div class="output-item-info">
              ${typeLabel} · ${metadata.aspectRatio || 'Edited'}
            </div>
            <div class="output-item-actions">
              <button class="icon-btn" onclick="downloadImage('${img.public_url}', ${new Date(img.created_at).getTime()})" title="Download">
                <svg class="download-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
              </button>
              <div class="send-to-container">
                <button class="icon-btn" onclick="toggleSendToMenu(event, this)" title="Send to...">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                  </svg>
                </button>
                <div class="send-to-menu">
                  <button class="send-to-option" onclick="sendToVideo('${img.public_url}', event)">📹 Send to Video</button>
                  <button class="send-to-option" onclick="sendToEdit('${img.public_url}', event)">✂️ Send to Edit</button>
                  <button class="send-to-option" onclick="sendToCaption('${img.public_url}', event)">💬 Send to Caption</button>
                  <button class="send-to-option" onclick="sendToInpaint('${img.public_url}', event)">🖌️ Send to Inpaint</button>
                </div>
              </div>
              <button class="icon-btn delete-btn" onclick="deleteEditHistoryImage(this.closest('.output-item'))" title="Delete">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  <line x1="10" y1="11" x2="10" y2="17"></line>
                  <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
              </button>
            </div>
          </div>
        `;
        outputGrid.insertBefore(outputItem, outputGrid.firstChild);
      });

      console.log(`✂️ Edit history displayed: ${history.length} images`);
    }

    // Delete an image from edit history
    async function deleteEditHistoryImage(element) {
      const imageId = element.dataset.imageId;

      if (imageId) {
        try {
          const { error } = await supabaseClient
            .from('generated_images')
            .delete()
            .eq('id', imageId);

          if (error) console.error('Error deleting from database:', error);
        } catch (err) {
          console.error('Error deleting edit history image:', err);
        }
      }

      // Remove from DOM with animation
      element.style.transition = 'opacity 0.3s, transform 0.3s';
      element.style.opacity = '0';
      element.style.transform = 'scale(0.8)';
      setTimeout(() => element.remove(), 300);
    }

    // Note: isLocal, API_BASE_URL, NSFW_ONLY_MODELS are defined in js/config.js

    let currentModel = 'nano-banana';
    let generatedImages = [];
    let referenceImages = [];
    let qwenImages = []; // For Qwen Image Edit
    let isGenerating = false;

    // Resolution lookup table: aspectRatio + quality -> { width, height }
    const RESOLUTION_TABLE = {
      '1:1': {
        '1K': { width: 1024, height: 1024 },
        '2K': { width: 2048, height: 2048 },
        '4K': { width: 4096, height: 4096 }
      },
      '16:9': {
        '1K': { width: 1280, height: 720 },
        '2K': { width: 2560, height: 1440 },
        '4K': { width: 3840, height: 2160 }
      },
      '9:16': {
        '1K': { width: 720, height: 1280 },
        '2K': { width: 1440, height: 2560 },
        '4K': { width: 2160, height: 3840 }
      },
      '4:3': {
        '1K': { width: 1536, height: 1152 },
        '2K': { width: 2048, height: 1536 },
        '4K': { width: 4096, height: 3072 }
      },
      '3:4': {
        '1K': { width: 1152, height: 1536 },
        '2K': { width: 1536, height: 2048 },
        '4K': { width: 3072, height: 4096 }
      }
    };

    // Get pixel dimensions from aspect ratio and resolution
    function getResolutionDimensions(aspectRatio, resolution) {
      const ar = RESOLUTION_TABLE[aspectRatio] || RESOLUTION_TABLE['1:1'];
      const dims = ar[resolution] || ar['2K'];
      return dims;
    }

    // Helper to check if content should be tagged NSFW (based on mode OR model)
    function isNsfwContent(model) {
      return contentMode === 'nsfw' || NSFW_ONLY_MODELS.includes(model);
    }

    // ===========================================
    // CONTENT FILTER (Safe & NSFW modes)
    // ===========================================
    let blockedWords = []; // Cached list of blocked words for current mode
    let blockedWordsMode = null; // Track which mode the cache is for

    // Fetch blocked words from API for specific mode
    async function loadBlockedWords(mode = null) {
      const targetMode = mode || contentMode || 'safe';
      try {
        const response = await fetch(`${API_BASE_URL}/api/content-filter/blocked-words?mode=${targetMode}`);
        if (response.ok) {
          const data = await response.json();
          blockedWords = data.words || [];
          blockedWordsMode = targetMode;
          console.log(`📝 Loaded ${blockedWords.length} blocked words for ${targetMode} mode`);
        }
      } catch (error) {
        console.error('Failed to load blocked words:', error);
        // Use empty array - allow generation if API fails
        blockedWords = [];
        blockedWordsMode = targetMode;
      }
    }

    // Validate prompt against blocked words (substring match, case insensitive)
    function validatePrompt(prompt) {
      // Skip validation if no blocked words loaded or mode mismatch
      if (!prompt || blockedWords.length === 0) {
        return { valid: true };
      }

      // Reload blocked words if mode changed
      if (blockedWordsMode !== contentMode) {
        // Async reload - for now, allow the request but reload for next time
        loadBlockedWords(contentMode);
      }

      const lowerPrompt = prompt.toLowerCase();
      for (const word of blockedWords) {
        if (lowerPrompt.includes(word.toLowerCase())) {
          return { valid: false, blocked: true };
        }
      }

      return { valid: true };
    }

    // Legacy alias for backwards compatibility
    function validatePromptForSafeMode(prompt) {
      return validatePrompt(prompt);
    }

    // Show restricted content error modal
    function showRestrictedContentError() {
      const modeText = contentMode === 'safe' ? 'Safe Mode' : 'NSFW Mode';
      showError(`This prompt contains restricted content for ${modeText}. Please modify your prompt.`);
    }

    // Cold start check - detect slow server response on Render free tier
    let serverReady = false;

    async function checkServerHealth() {
      const banner = document.getElementById('coldStartBanner');
      const bannerText = document.getElementById('coldStartText');
      if (!banner || isLocal) return; // Skip on localhost

      const startTime = Date.now();
      let showBannerTimeout;

      // Show banner after 3 seconds if still waiting
      showBannerTimeout = setTimeout(() => {
        banner.classList.add('active');
        bannerText.textContent = 'Waking up server... This may take up to 50 seconds on first visit.';
      }, 3000);

      try {
        const response = await fetch(`${API_BASE_URL}/health`, {
          method: 'GET',
          signal: AbortSignal.timeout(60000) // 60 second timeout
        });

        clearTimeout(showBannerTimeout);
        const elapsed = Date.now() - startTime;

        if (response.ok) {
          serverReady = true;
          // If banner was shown, briefly show success message
          if (banner.classList.contains('active')) {
            banner.classList.add('ready');
            bannerText.textContent = `Server ready! (took ${Math.round(elapsed / 1000)}s)`;
            setTimeout(() => {
              banner.classList.remove('active', 'ready');
            }, 2000);
          }
          console.log(`✅ Server health check passed in ${elapsed}ms`);
        }
      } catch (error) {
        clearTimeout(showBannerTimeout);
        console.error('❌ Server health check failed:', error);
        banner.classList.add('active');
        bannerText.textContent = 'Server unavailable. Please refresh or try again later.';
      }
    }

    // Run health check on page load
    document.addEventListener('DOMContentLoaded', checkServerHealth);

    // Initialize onboarding system on page load
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof initializeOnboarding === 'function') {
        initializeOnboarding().then(() => {
          console.log('Onboarding system initialized');
        }).catch(err => {
          console.warn('Onboarding initialization failed:', err);
        });
      }
    });

    // Hide loading splash when page is ready
    function hideLoadingSplash() {
      const splash = document.getElementById('loadingSplash');
      if (splash) {
        splash.classList.add('hidden');
        // Remove from DOM after animation
        setTimeout(() => splash.remove(), 300);
      }
    }

    // Hide splash when DOM is ready (most content loaded)
    document.addEventListener('DOMContentLoaded', () => {
      // Small delay to ensure styles are applied
      setTimeout(hideLoadingSplash, 100);
    });

    // Initialize landing page or main app on page load based on auth state
    document.addEventListener('DOMContentLoaded', async () => {
      // Check current auth session
      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) {
          // No session - show landing page
          console.log('🏠 No session found, showing landing page');
          if (typeof initLandingPage === 'function') {
            initLandingPage();
          }
        } else {
          // Has session - main app will be shown (handled by onAuthStateChange)
          console.log('🔐 Session found, main app will load');
        }
      } catch (err) {
        console.error('❌ Error checking session:', err);
        // On error, default to showing landing page
        if (typeof initLandingPage === 'function') {
          initLandingPage();
        }
      }
    });

    // Check if session is still valid before starting generation
    async function checkSessionValid() {
      try {
        const { data: { session }, error } = await supabaseClient.auth.getSession();
        if (error || !session) {
          console.warn('⚠️ Session check failed - user may need to re-login');
          return false;
        }

        // Check if session is about to expire (within 5 minutes)
        const expiresAt = session.expires_at;
        if (expiresAt) {
          const expiresIn = (expiresAt * 1000) - Date.now();
          if (expiresIn < 5 * 60 * 1000) { // Less than 5 minutes
            console.warn('⚠️ Session expiring soon, attempting refresh...');
            const { error: refreshError } = await supabaseClient.auth.refreshSession();
            if (refreshError) {
              console.error('❌ Session refresh failed:', refreshError);
              return false;
            }
          }
        }
        return true;
      } catch (err) {
        console.error('❌ Session check error:', err);
        return false;
      }
    }

    // Active generation jobs tracking (persisted to survive tab switches)
    let activeGenerationJobs = {};

    // Persist and restore generation state for tab switching
    function saveGenerationState() {
      if (Object.keys(activeGenerationJobs).length > 0) {
        sessionStorage.setItem('activeGenerationJobs', JSON.stringify(activeGenerationJobs));
        sessionStorage.setItem('isGenerating', isGenerating.toString());
      }
    }

    function restoreGenerationState() {
      const savedJobs = sessionStorage.getItem('activeGenerationJobs');
      const savedIsGenerating = sessionStorage.getItem('isGenerating');

      if (savedJobs) {
        try {
          activeGenerationJobs = JSON.parse(savedJobs);
          console.log('📥 Restored active generation jobs:', Object.keys(activeGenerationJobs).length);
        } catch (e) {
          activeGenerationJobs = {};
        }
      }

      if (savedIsGenerating === 'true') {
        isGenerating = true;
        // Re-check active jobs and restore UI
        restorePlaceholdersForActiveJobs();
      }
    }

    function clearGenerationState() {
      activeGenerationJobs = {};
      sessionStorage.removeItem('activeGenerationJobs');
      sessionStorage.removeItem('isGenerating');
    }

    function restorePlaceholdersForActiveJobs() {
      const outputGrid = document.getElementById('outputGrid');
      const btn = document.getElementById('generateBtn');
      const btnText = document.getElementById('generateText');

      // Count active jobs
      const activeCount = Object.values(activeGenerationJobs).filter(j => j.status === 'pending' || j.status === 'processing').length;

      if (activeCount > 0) {
        console.log(`🔄 Restoring ${activeCount} active generation placeholder(s)`);

        // Update button state
        btn.classList.add('generating');
        btnText.textContent = `⏳ Generating (${activeCount} active)...`;
        btn.disabled = true;

        // Add placeholders for jobs that don't have visible elements
        Object.entries(activeGenerationJobs).forEach(([jobId, job]) => {
          if ((job.status === 'pending' || job.status === 'processing') && !document.querySelector(`[data-job-id="${jobId}"]`)) {
            const placeholder = createLoadingPlaceholder();
            placeholder.dataset.jobId = jobId;
            outputGrid.insertBefore(placeholder, outputGrid.firstChild);
          }
        });
      }
    }

    // Handle page visibility changes (tab switch, minimize, etc.)
    document.addEventListener('visibilitychange', function() {
      if (document.visibilityState === 'visible') {
        console.log('👁️ Tab became visible, checking generation state...');
        restoreGenerationState();
        restorePlaceholdersForActiveJobs();
      } else {
        // Tab is hidden - save state
        saveGenerationState();
      }
    });

    // Also handle window focus/blur for additional coverage
    window.addEventListener('focus', function() {
      if (isGenerating) {
        console.log('🔄 Window focused, ensuring placeholders are visible...');
        restorePlaceholdersForActiveJobs();
      }
    });

    // Video generation state
    let currentVideoModel = 'kling';
    let videoStartImage = null;
    let veoLastFrame = null;
    let generatedVideos = [];
    let isGeneratingVideo = false;

    // ===========================================
    // CONTENT MODE & AGE VERIFICATION
    // ===========================================
    let contentMode = 'safe'; // 'safe' or 'nsfw'
    let ageVerified = false;
    let ageBlocked = false;

    // Initialize content mode on page load
    function initContentMode() {
      // Start in safe mode
      contentMode = 'safe';
      updateContentModeUI();
      filterModelsByContentMode();

      // Load blocked words for safe mode content filtering
      loadBlockedWords();

      // Set up checkbox listener
      const checkbox = document.getElementById('ageConfirmCheckbox');
      if (checkbox) {
        checkbox.addEventListener('change', function() {
          document.getElementById('ageVerifyBtn').disabled = !this.checked;
        });
      }

      // Restore last active tab from localStorage
      restoreLastActiveTab();
    }

    // Restore the last active tab from localStorage
    function restoreLastActiveTab() {
      const savedTab = localStorage.getItem('vixxxen_activeTab');
      if (savedTab && savedTab !== 'image') {
        // Small delay to ensure DOM is ready
        setTimeout(() => {
          switchMainTab(savedTab);

          // If education tab, also restore the subtab
          if (savedTab === 'education') {
            const savedSubtab = localStorage.getItem('vixxxen_educationSubtab');
            if (savedSubtab) {
              setTimeout(() => {
                switchEducationSubtab(savedSubtab);
              }, 100);
            }
          }
        }, 50);
      }
    }

    // Set content mode (called by toggle buttons)
    async function setContentMode(mode) {
      if (mode === 'nsfw') {
        // Check if user is logged in
        if (!currentUser) {
          showLoginRequiredModal();
          return;
        }

        // Check if already verified
        if (!ageVerified) {
          // Check verification status from server (uses JWT auth)
          try {
            const response = await authFetch(`${API_BASE_URL}/api/age-verification/status`);
            const data = await response.json();

            if (data.verified) {
              ageVerified = true;
            } else {
              // Need to verify - check location first
              const locationResponse = await fetch(`${API_BASE_URL}/api/age-verification/check-location`);
              const locationData = await locationResponse.json();

              if (locationData.restricted) {
                // Show blocked modal
                showAgeVerificationModal(true);
                return;
              } else {
                // Show verification modal
                showAgeVerificationModal(false);
                return;
              }
            }
          } catch (error) {
            console.error('Error checking verification:', error);
            // Show verification modal on error
            showAgeVerificationModal(false);
            return;
          }
        }
      }

      // Set the mode
      contentMode = mode;
      updateContentModeUI();
      filterModelsByContentMode();
      // Reload blocked words for the new mode
      loadBlockedWords(mode);
      // Note: filterModelsByContentMode() handles auto-selection when switching modes
    }

    // Update content mode UI (toggle buttons)
    function updateContentModeUI() {
      // Toggle body class for NSFW content blur
      document.body.classList.toggle('content-mode-safe', contentMode === 'safe');
      document.body.classList.toggle('content-mode-nsfw', contentMode === 'nsfw');
      console.log('🔞 Content mode updated:', contentMode, '- Body classes:', document.body.className);

      // Image section toggle
      const safeBtn = document.getElementById('safeModeBtn');
      const nsfwBtn = document.getElementById('nsfwModeBtn');
      const infoText = document.getElementById('contentModeInfo');

      if (safeBtn && nsfwBtn) {
        safeBtn.classList.toggle('active', contentMode === 'safe');
        nsfwBtn.classList.toggle('active', contentMode === 'nsfw');
      }

      if (infoText) {
        infoText.textContent = contentMode === 'safe'
          ? 'All models • Content filtered'
          : 'Seedream & Qwen only';
      }

      // Video section toggle
      const videoSafeBtn = document.getElementById('videoSafeModeBtn');
      const videoNsfwBtn = document.getElementById('videoNsfwModeBtn');
      const videoInfoText = document.getElementById('videoContentModeInfo');

      if (videoSafeBtn && videoNsfwBtn) {
        videoSafeBtn.classList.toggle('active', contentMode === 'safe');
        videoNsfwBtn.classList.toggle('active', contentMode === 'nsfw');
      }

      if (videoInfoText) {
        videoInfoText.textContent = contentMode === 'safe'
          ? 'Kling & Veo available'
          : 'Wan 2.2 only';
      }
    }

    // Filter models based on content mode
    function filterModelsByContentMode() {
      // Image models - use data-safe-mode and data-nsfw-mode attributes
      const imageModelTabs = document.getElementById('imageModelTabs');
      if (imageModelTabs) {
        const tabs = imageModelTabs.querySelectorAll('.model-tab');
        tabs.forEach(tab => {
          const showInSafe = tab.dataset.safeMode === 'true';
          const showInNsfw = tab.dataset.nsfwMode === 'true';

          if (contentMode === 'safe') {
            tab.style.display = showInSafe ? 'block' : 'none';
          } else {
            tab.style.display = showInNsfw ? 'block' : 'none';
          }
        });

        // Auto-select appropriate model when switching modes
        if (contentMode === 'nsfw') {
          // In NSFW mode, if current model is nano-banana (not available), switch to seedream
          if (currentModel === 'nano-banana') {
            selectModel('seedream');
          }
        } else {
          // In safe mode, all models available - no need to switch
        }
      }

      // Video models - In NSFW mode, only Wan 2.2 is available
      const videoModelTabs = document.getElementById('videoModelTabs');
      if (videoModelTabs) {
        const tabs = videoModelTabs.querySelectorAll('.model-tab');
        tabs.forEach(tab => {
          if (tab.dataset.nsfw === 'true') {
            // NSFW-only models (Wan) - show in NSFW, hide in safe
            tab.style.display = contentMode === 'nsfw' ? 'block' : 'none';
          } else if (tab.dataset.sfw === 'true') {
            // SFW-only models (Kling, Veo) - hide in NSFW, show in safe
            tab.style.display = contentMode === 'nsfw' ? 'none' : 'block';
          }
        });

        // Auto-select appropriate model when switching modes
        if (contentMode === 'nsfw') {
          // In NSFW mode, if current model is not Wan, switch to Wan
          if (currentVideoModel !== 'wan') {
            selectVideoModel('wan');
          }
        } else {
          // In safe mode, if current model is Wan (not available), switch to Kling
          if (currentVideoModel === 'wan') {
            selectVideoModel('kling');
          }
        }
      }
    }

    // Show age verification modal
    function showAgeVerificationModal(blocked = false) {
      const modal = document.getElementById('ageVerificationModal');
      const bodySection = document.getElementById('ageVerificationBody');
      const blockedSection = document.getElementById('ageVerificationBlocked');

      if (blocked) {
        bodySection.style.display = 'none';
        blockedSection.style.display = 'block';
        ageBlocked = true;
      } else {
        bodySection.style.display = 'block';
        blockedSection.style.display = 'none';
        // Reset checkbox
        const checkbox = document.getElementById('ageConfirmCheckbox');
        if (checkbox) checkbox.checked = false;
        document.getElementById('ageVerifyBtn').disabled = true;
      }

      modal.classList.add('active');
    }

    // Close age verification modal
    function closeAgeVerificationModal() {
      const modal = document.getElementById('ageVerificationModal');
      modal.classList.remove('active');
    }

    // Submit age verification
    async function submitAgeVerification() {
      if (!currentUser) return;

      const verifyBtn = document.getElementById('ageVerifyBtn');
      verifyBtn.disabled = true;
      verifyBtn.textContent = 'Verifying...';

      try {
        const response = await authFetch(`${API_BASE_URL}/api/age-verification/verify`, {
          method: 'POST',
          body: JSON.stringify({
            user_id: currentUser.id,
            confirmed: true
          })
        });

        const data = await response.json();

        if (data.blocked) {
          // Show blocked state
          showAgeVerificationModal(true);
          verifyBtn.textContent = 'Verify & Enable NSFW';
          return;
        }

        if (data.verified) {
          ageVerified = true;
          closeAgeVerificationModal();

          // Now set to NSFW mode
          contentMode = 'nsfw';
          updateContentModeUI();
          filterModelsByContentMode();

          console.log('✅ Age verified, NSFW mode enabled');
        }
      } catch (error) {
        console.error('Error verifying age:', error);
        alert('Error verifying age. Please try again.');
      } finally {
        verifyBtn.disabled = false;
        verifyBtn.textContent = 'Verify & Enable NSFW';
      }
    }

    // Note: Reporting system functions are in js/reporting.js

    // Note: Admin reports dashboard functions are in js/admin-reports.js

    // Initialize content mode when DOM is ready
    document.addEventListener('DOMContentLoaded', initContentMode);

    // Edit/Eraser state
    let currentEditTool = 'eraser'; // 'eraser' or 'bg-remover'
    let editSourceImage = null;
    let editMaskImage = null;
    let editedImages = [];
    let isErasing = false;
    let maskCanvas = null;
    let maskCtx = null;
    let isDrawing = false;
    let brushSize = 30;
    let loadedImage = null;

    // Caption state
    let captionImage = null;
    let isCaptioning = false;
    let currentCaptionModel = 'grok-4'; // Using Grok-4 for AI chat
    let conversationHistory = []; // Store conversation messages for context

    // Switch between main navigation tabs (Image, Video, Edit, Inpaint, Caption)
    function switchMainTab(tab) {
      // Close mobile sidebar when switching tabs
      closeMobileSidebar();

      // Save current tab to localStorage for persistence
      localStorage.setItem('vixxxen_activeTab', tab);

      // Hide all tab sections
      document.querySelectorAll('.tab-section').forEach(section => {
        section.classList.remove('active');
      });

      // Deactivate all nav tabs
      document.querySelectorAll('.nav-tab').forEach(navTab => {
        navTab.classList.remove('active');
      });

      // Reset left panel width when switching away from Edit tab
      const leftPanel = document.querySelector('.left-panel');
      if (tab !== 'edit' && leftPanel) {
        leftPanel.classList.remove('canvas-active');
      }

      // Hide all admin buttons first
      hideAllAdminButtons();

      // Show selected tab section
      if (tab === 'image') {
        document.getElementById('imageSection').classList.add('active');
        document.getElementById('imageNavTab').classList.add('active');
      } else if (tab === 'video') {
        document.getElementById('videoSection').classList.add('active');
        document.getElementById('videoNavTab').classList.add('active');
      } else if (tab === 'edit') {
        document.getElementById('editSection').classList.add('active');
        document.getElementById('editNavTab').classList.add('active');
      } else if (tab === 'inpaint') {
        document.getElementById('inpaintSection').classList.add('active');
        document.getElementById('inpaintNavTab').classList.add('active');
      } else if (tab === 'caption') {
        document.getElementById('captionSection').classList.add('active');
        document.getElementById('captionNavTab').classList.add('active');
      } else if (tab === 'marketplace') {
        document.getElementById('marketplaceSection').classList.add('active');
        document.getElementById('marketplaceNavTab').classList.add('active');
        // Show admin character button if user is admin
        if (isUserAdmin) {
          const adminCharBtn = document.getElementById('adminCharacterBtn');
          if (adminCharBtn) adminCharBtn.style.display = 'flex';
        }
      } else if (tab === 'education') {
        document.getElementById('educationSection').classList.add('active');
        document.getElementById('educationNavTab').classList.add('active');
        // Initialize chat if user has membership
        initializeEducationTab();
        // Show admin resource/starthere buttons if user is admin
        if (isUserAdmin) {
          showAdminButton();
          showStartHereAdminButton();
        }
      }
    }

    // Helper function to hide all admin buttons when switching tabs
    function hideAllAdminButtons() {
      // Hide marketplace admin button
      const adminCharBtn = document.getElementById('adminCharacterBtn');
      if (adminCharBtn) adminCharBtn.style.display = 'none';

      // Hide education admin buttons
      const adminResourcesBtn = document.getElementById('adminResourcesBtn');
      if (adminResourcesBtn) adminResourcesBtn.classList.remove('visible');

      const adminPreviewToggle = document.getElementById('adminPreviewToggle');
      if (adminPreviewToggle) adminPreviewToggle.classList.remove('visible');

      const adminStarthereBtn = document.getElementById('adminStarthereBtn');
      if (adminStarthereBtn) adminStarthereBtn.classList.remove('visible');
    }

    function selectModel(model) {
      currentModel = model;
      const nanoTab = document.getElementById('nanoTab');
      const seedreamTab = document.getElementById('seedreamTab');
      const qwenGenTab = document.getElementById('qwenGenTab');
      const referenceSection = document.getElementById('referenceSection');
      const standardSettings = document.getElementById('standardSettings');
      const qwenGenSettings = document.getElementById('qwenGenSettings');
      const aspectRatioSetting = document.getElementById('aspectRatioSetting');
      const seedreamAspectSetting = document.getElementById('seedreamAspectSetting');
      const seedreamResolutionSetting = document.getElementById('seedreamResolutionSetting');

      // Reset all tabs
      nanoTab.classList.remove('active');
      seedreamTab.classList.remove('active');
      qwenGenTab.classList.remove('active');

      // Hide all settings sections
      standardSettings.style.display = 'none';
      qwenGenSettings.style.display = 'none';

      // Reset prompt placeholder
      document.getElementById('promptInput').placeholder =
        "Describe what you want to generate... (e.g., 'A serene mountain landscape at sunset with vibrant colors')";

      // Show/hide sections based on model
      if (model === 'nano-banana') {
        nanoTab.classList.add('active');
        referenceSection.style.display = 'block';
        standardSettings.style.display = 'block';
        // Nano Banana: Show aspect ratio, hide Seedream settings
        if (aspectRatioSetting) aspectRatioSetting.style.display = 'block';
        if (seedreamAspectSetting) seedreamAspectSetting.style.display = 'none';
        if (seedreamResolutionSetting) seedreamResolutionSetting.style.display = 'none';
      } else if (model === 'seedream') {
        seedreamTab.classList.add('active');
        referenceSection.style.display = 'block';
        standardSettings.style.display = 'block';
        // Seedream: Hide Nano aspect ratio, show Seedream aspect + resolution
        if (aspectRatioSetting) aspectRatioSetting.style.display = 'none';
        if (seedreamAspectSetting) seedreamAspectSetting.style.display = 'block';
        if (seedreamResolutionSetting) seedreamResolutionSetting.style.display = 'block';
      } else if (model === 'qwen') {
        qwenGenTab.classList.add('active');
        referenceSection.style.display = 'none';
        qwenGenSettings.style.display = 'block';
      }

      // Update button cost display
      updateImageGenerateButtonCost();
    }

    function selectVideoModel(model) {
      currentVideoModel = model;
      const klingTab = document.getElementById('klingVideoTab');
      const wanTab = document.getElementById('wanVideoTab');
      const veoTab = document.getElementById('veoVideoTab');
      const negativePrompt = document.getElementById('negativePromptSection');
      const klingSettings = document.getElementById('klingSettingsSection');
      const wanSettings = document.getElementById('wanSettingsSection');
      const veoSettings = document.getElementById('veoSettingsSection');
      const veoLastFrameSection = document.getElementById('veoLastFrameSection');

      // Reset all tabs
      klingTab.classList.remove('active');
      wanTab.classList.remove('active');
      veoTab.classList.remove('active');
      klingSettings.style.display = 'none';
      wanSettings.style.display = 'none';
      veoSettings.style.display = 'none';
      veoLastFrameSection.style.display = 'none';

      if (model === 'kling') {
        klingTab.classList.add('active');
        negativePrompt.style.display = 'block';
        klingSettings.style.display = 'block';
      } else if (model === 'wan') {
        wanTab.classList.add('active');
        negativePrompt.style.display = 'none';
        wanSettings.style.display = 'block';
      } else if (model === 'veo') {
        veoTab.classList.add('active');
        negativePrompt.style.display = 'block';
        veoSettings.style.display = 'block';
        veoLastFrameSection.style.display = 'block';
      }

      // Update button cost display
      updateVideoGenerateButtonCost();
    }

    // ===============================================
    // Drag and Drop Upload Functionality
    // ===============================================

    /**
     * Setup drag-and-drop functionality for an upload zone
     * @param {string} dropZoneId - ID of the element to make droppable (can be null if dropZone element is passed)
     * @param {string} fileInputId - ID of the hidden file input
     * @param {Function} handleUpload - Function to call with the files (receives a fake event with files)
     * @param {HTMLElement} dropZone - Optional: direct element reference instead of ID
     */
    function setupDropZone(dropZoneId, fileInputId, handleUpload, dropZone = null) {
      const zone = dropZone || document.getElementById(dropZoneId);
      const fileInput = document.getElementById(fileInputId);

      if (!zone) {
        console.warn(`Drop zone not found: ${dropZoneId}`);
        return;
      }

      // Prevent default drag behaviors on the zone
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        zone.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
        }, false);
      });

      // Highlight drop zone when dragging over
      ['dragenter', 'dragover'].forEach(eventName => {
        zone.addEventListener(eventName, () => {
          zone.classList.add('drag-over');
        }, false);
      });

      // Remove highlight when leaving or dropping
      ['dragleave', 'drop'].forEach(eventName => {
        zone.addEventListener(eventName, () => {
          zone.classList.remove('drag-over');
        }, false);
      });

      // Handle dropped files
      zone.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          // Filter for image files only
          const imageFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
          if (imageFiles.length === 0) {
            showError('Please drop image files only');
            return;
          }

          // Create a fake event object to pass to existing handlers
          const fakeEvent = {
            target: {
              files: imageFiles,
              value: ''
            }
          };
          handleUpload(fakeEvent);
        }
      }, false);
    }

    // Initialize all drop zones after DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      // Reference images upload (Image tab)
      const refUpload = document.querySelector('#referenceSection .reference-upload');
      if (refUpload) {
        setupDropZone(null, 'fileInput', handleFileUpload, refUpload);
      }

      // Video start frame upload
      const videoStartUpload = document.querySelector('#videoStartImageSection .reference-upload');
      if (videoStartUpload) {
        setupDropZone(null, 'videoStartImageInput', handleVideoStartImageUpload, videoStartUpload);
      }

      // Veo last frame upload
      const veoLastFrameUpload = document.querySelector('#veoLastFrameSection .reference-upload');
      if (veoLastFrameUpload) {
        setupDropZone(null, 'veoLastFrameInput', handleVeoLastFrameUpload, veoLastFrameUpload);
      }

      // Edit source image upload
      setupDropZone('editImageUploadArea', 'editSourceImageInput', handleEditSourceImageUpload);

      // Inpaint image upload
      setupDropZone('inpaintUploadPlaceholder', 'inpaintImageInput', handleInpaintImageUpload);

      console.log('Drag-and-drop upload zones initialized');
    });

    function handleFileUpload(event) {
      // Require login for uploads
      if (!isUserLoggedIn) {
        showLoginRequiredModal();
        event.target.value = ''; // Clear the file input
        return;
      }

      const files = Array.from(event.target.files);

      if (referenceImages.length + files.length > 14) {
        showError('Maximum 14 reference images allowed');
        return;
      }

      files.forEach(file => {
        if (!file.type.startsWith('image/')) {
          showError('Please upload only image files');
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          referenceImages.push({
            dataUrl: e.target.result,
            name: file.name
          });
          updateReferenceGrid();
        };
        reader.readAsDataURL(file);
      });

      // Reset input
      event.target.value = '';
    }

    function updateReferenceGrid() {
      const grid = document.getElementById('referenceGrid');
      grid.innerHTML = '';

      referenceImages.forEach((img, index) => {
        const item = document.createElement('div');
        item.className = 'reference-item';
        item.innerHTML = `
          <img src="${img.dataUrl}" alt="${img.name}">
          <button class="reference-remove" onclick="removeReference(${index})" title="Remove">×</button>
        `;
        grid.appendChild(item);
      });
    }

    function removeReference(index) {
      referenceImages.splice(index, 1);
      updateReferenceGrid();
    }

    // Qwen Image Edit file upload
    function handleQwenFileUpload(event) {
      const files = Array.from(event.target.files);

      if (qwenImages.length + files.length > 3) {
        showError('Maximum 3 images allowed for Qwen Image Edit');
        return;
      }

      files.forEach(file => {
        if (!file.type.startsWith('image/')) {
          showError('Please upload only image files');
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          qwenImages.push({
            dataUrl: e.target.result,
            name: file.name
          });
          updateQwenImageGrid();
        };
        reader.readAsDataURL(file);
      });

      // Reset input
      event.target.value = '';
    }

    function updateQwenImageGrid() {
      const grid = document.getElementById('qwenImageGrid');
      grid.innerHTML = '';

      qwenImages.forEach((img, index) => {
        const item = document.createElement('div');
        item.className = 'reference-item';
        item.innerHTML = `
          <img src="${img.dataUrl}" alt="${img.name}">
          <button class="reference-remove" onclick="removeQwenImage(${index})" title="Remove">×</button>
        `;
        grid.appendChild(item);
      });
    }

    function removeQwenImage(index) {
      qwenImages.splice(index, 1);
      updateQwenImageGrid();
    }

    // Video Tab Functions
    function handleVideoStartImageUpload(event) {
      // Require login for uploads
      if (!isUserLoggedIn) {
        showLoginRequiredModal();
        event.target.value = ''; // Clear the file input
        return;
      }

      const file = event.target.files[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        showVideoError('Please upload only image files');
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        videoStartImage = e.target.result;
        updateVideoStartImagePreview();
      };
      reader.readAsDataURL(file);

      // Reset input
      event.target.value = '';
    }

    function updateVideoStartImagePreview() {
      const preview = document.getElementById('videoStartImagePreview');

      if (videoStartImage) {
        preview.innerHTML = `
          <div class="reference-item">
            <img src="${videoStartImage}" alt="Start frame">
            <button class="reference-remove" onclick="removeVideoStartImage()" title="Remove">×</button>
          </div>
        `;
      } else {
        preview.innerHTML = '';
      }
    }

    function removeVideoStartImage() {
      videoStartImage = null;
      updateVideoStartImagePreview();
    }

    function handleVeoLastFrameUpload(event) {
      // Require login for uploads
      if (!isUserLoggedIn) {
        showLoginRequiredModal();
        event.target.value = ''; // Clear the file input
        return;
      }

      const file = event.target.files[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        showVideoError('Please upload only image files');
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        veoLastFrame = e.target.result;
        updateVeoLastFramePreview();
      };
      reader.readAsDataURL(file);

      // Reset input
      event.target.value = '';
    }

    function updateVeoLastFramePreview() {
      const preview = document.getElementById('veoLastFramePreview');

      if (veoLastFrame) {
        preview.innerHTML = `
          <div class="reference-item">
            <img src="${veoLastFrame}" alt="Last frame">
            <button class="reference-remove" onclick="removeVeoLastFrame()" title="Remove">×</button>
          </div>
        `;
      } else {
        preview.innerHTML = '';
      }
    }

    function removeVeoLastFrame() {
      veoLastFrame = null;
      updateVeoLastFramePreview();
    }

    async function generateVideo() {
      if (isGeneratingVideo) return;

      // Debounce rapid clicks (prevent accidental double-clicks)
      const now = Date.now();
      if (now - lastVideoGenClick < CLICK_DEBOUNCE_MS) {
        console.log('⏳ Ignoring rapid click - please wait');
        return;
      }
      lastVideoGenClick = now;

      // Show immediate visual feedback
      const btn = document.getElementById('videoGenerateBtn');
      const btnText = document.getElementById('videoGenerateText');
      const originalText = btnText.textContent;
      btnText.textContent = '⏳ Starting...';
      btn.disabled = true;

      // Helper to reset button on early return
      const resetButton = () => {
        btnText.textContent = originalText;
        btn.disabled = false;
      };

      // Check if user is logged in
      if (!isUserLoggedIn || !currentUser) {
        showLoginRequiredModal();
        resetButton();
        return;
      }

      // Verify session is still valid (prevents mid-generation expiry issues)
      const sessionValid = await checkSessionValid();
      if (!sessionValid) {
        alert('Your session has expired. Please log in again.');
        openSubscriptionPage();
        resetButton();
        return;
      }

      const prompt = document.getElementById('videoPromptInput').value.trim();
      if (!prompt) {
        showVideoError('Please enter a prompt first!');
        resetButton();
        return;
      }

      // Calculate and check credits
      let duration;
      if (currentVideoModel === 'kling') {
        const durationValue = document.getElementById('videoDuration')?.value || '5';
        duration = durationValue + 's';
      } else if (currentVideoModel === 'wan') {
        const numFrames = parseInt(document.getElementById('wanNumFrames')?.value || 81);
        const fps = parseInt(document.getElementById('wanFps')?.value || 8);
        const seconds = Math.round(numFrames / fps);
        duration = seconds + 's';
      } else if (currentVideoModel === 'veo') {
        const durationValue = document.getElementById('veoDuration')?.value || '8';
        duration = durationValue + 's';
      }

      const cost = calculateCreditCost('video', currentVideoModel, { duration });

      if (!hasEnoughCredits(cost)) {
        showInsufficientCreditsError(cost);
        resetButton();
        return;
      }

      // Deduct credits before generation
      const deducted = await deductCredits(cost, `Video generation (${currentVideoModel})`);
      if (!deducted) {
        showInsufficientCreditsError(cost);
        resetButton();
        return;
      }

      isGeneratingVideo = true;

      // Capture model and NSFW flag at START of generation (before any async operations)
      const capturedVideoModel = currentVideoModel;
      const isNsfwAtStart = isNsfwContent(capturedVideoModel);

      btn.classList.add('generating');
      btnText.textContent = '⏳ Generating...';
      btn.disabled = true;

      // Clear placeholder if it's first generation
      const videoOutputGrid = document.getElementById('videoOutputGrid');
      if (generatedVideos.length === 0) {
        videoOutputGrid.innerHTML = '';
      }

      // Clear any previous errors
      document.getElementById('videoErrorContainer').innerHTML = '';

      // Create loading placeholder (insert at top)
      const placeholder = createVideoLoadingPlaceholder();
      videoOutputGrid.insertBefore(placeholder, videoOutputGrid.firstChild);

      try {
        let endpoint, payload, modelName;

        if (capturedVideoModel === 'kling') {
          // Kling model
          const aspectRatio = document.getElementById('videoAspectRatio').value;
          const duration = parseInt(document.getElementById('videoDuration').value);
          const negativePrompt = document.getElementById('videoNegativePromptInput').value.trim();

          endpoint = `${API_BASE_URL}/api/kling/generate`;
          payload = {
            prompt,
            aspectRatio,
            duration
          };

          // Add start image if uploaded
          if (videoStartImage) {
            payload.startImage = videoStartImage;
          }

          // Add negative prompt if provided
          if (negativePrompt) {
            payload.negativePrompt = negativePrompt;
          }

          modelName = 'kling-2.5-turbo-pro';

        } else if (capturedVideoModel === 'wan') {
          // Wan model
          const resolution = document.getElementById('wanResolution').value;
          const numFrames = parseInt(document.getElementById('wanNumFrames').value);
          const fps = parseInt(document.getElementById('wanFps').value);
          const sampleSteps = parseInt(document.getElementById('wanSampleSteps').value);
          const goFast = document.getElementById('wanGoFast').checked;

          endpoint = `${API_BASE_URL}/api/wan/generate`;
          payload = {
            prompt,
            resolution,
            numFrames,
            framesPerSecond: fps,
            sampleSteps,
            sampleShift: 5, // Default value
            goFast
          };

          // Add start image if uploaded
          if (videoStartImage) {
            payload.image = videoStartImage;
          }

          modelName = 'wan-2.2-i2v-a14b';

        } else {
          // Veo model
          const aspectRatio = document.getElementById('veoAspectRatio').value;
          const resolution = document.getElementById('veoResolution').value;
          const duration = parseInt(document.getElementById('veoDuration').value);
          const generateAudio = document.getElementById('veoGenerateAudio').checked;
          const negativePrompt = document.getElementById('videoNegativePromptInput').value.trim();

          endpoint = `${API_BASE_URL}/api/veo/generate`;
          payload = {
            prompt,
            aspectRatio,
            resolution,
            duration,
            generateAudio
          };

          // Add start image if uploaded
          if (videoStartImage) {
            payload.image = videoStartImage;
          }

          // Add last frame if uploaded
          if (veoLastFrame) {
            payload.lastFrame = veoLastFrame;
          }

          // Add negative prompt if provided
          if (negativePrompt) {
            payload.negativePrompt = negativePrompt;
          }

          modelName = 'veo-3.1-fast';
        }

        console.log(`Generating video with ${modelName}:`, { endpoint, payload: { ...payload, image: videoStartImage ? '[data...]' : null, startImage: videoStartImage ? '[data...]' : null } });

        // Track generation started
        if (window.VxAnalytics && window.VxAnalytics.generation) {
          window.VxAnalytics.generation.started(modelName, { content_type: 'video' });
        }

        // Add timeout to fetch request (5 minutes for video generation)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 300000); // 5 minute timeout

        const response = await authFetch(endpoint, {
          method: 'POST',
          body: JSON.stringify(payload),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Video generation failed');
        }

        console.log('Video generation successful:', data);

        // Create new video object (use NSFW flag captured at start)
        const newVideo = {
          url: data.videoUrl,
          model: modelName,
          timestamp: Date.now(),
          isNsfw: isNsfwAtStart
        };

        // Add model-specific metadata
        if (capturedVideoModel === 'kling') {
          newVideo.aspectRatio = payload.aspectRatio;
          newVideo.duration = payload.duration;
        } else if (capturedVideoModel === 'wan') {
          newVideo.resolution = payload.resolution;
          newVideo.frames = payload.numFrames;
          newVideo.fps = payload.framesPerSecond;
        } else {
          // Veo
          newVideo.aspectRatio = payload.aspectRatio;
          newVideo.resolution = payload.resolution;
          newVideo.duration = payload.duration;
          newVideo.hasAudio = payload.generateAudio;
        }

        generatedVideos.push(newVideo);
        replaceVideoPlaceholderWithVideo(placeholder, newVideo);

        // Upload video to Supabase Storage (don't wait, do in background)
        uploadVideoToStorage(data.videoUrl, {
          prompt: prompt,
          model: modelName,
          duration: newVideo.duration || null,
          isNsfw: isNsfwAtStart
        });

        // Log generation for 2257 compliance
        logGeneration('video', modelName, prompt, isNsfwAtStart, 1, data.videoUrl);

        // Track generation completed
        if (window.VxAnalytics && window.VxAnalytics.generation) {
          window.VxAnalytics.generation.completed(modelName, { content_type: 'video' });
        }

      } catch (error) {
        console.error('Video generation failed:', error);

        // Handle timeout specifically
        let errorMessage = error.message || 'Failed to generate video';
        if (error.name === 'AbortError') {
          errorMessage = 'Request timed out - video generation took too long';
        } else if (error.message?.includes('Failed to fetch')) {
          errorMessage = 'Connection failed - make sure the backend server is running';
        }

        // Refund credits on failure
        await refundCredits(cost, `Video generation failed: ${errorMessage}`);

        // Mark placeholder as failed
        updateVideoPlaceholderWithError(placeholder, errorMessage);
        showVideoError(errorMessage);

        // Track generation failed
        if (window.VxAnalytics && window.VxAnalytics.generation) {
          window.VxAnalytics.generation.failed(capturedVideoModel, errorMessage, { content_type: 'video' });
        }
      } finally {
        isGeneratingVideo = false;
        btn.classList.remove('generating');
        updateVideoGenerateButtonCost(); // Update button with cost again
        btn.disabled = false;
      }
    }

    function createVideoLoadingPlaceholder() {
      const placeholderDiv = document.createElement('div');
      placeholderDiv.className = 'output-item';
      placeholderDiv.innerHTML = `
        <div class="output-placeholder-loading">
          <div class="loading-static-overlay"></div>
          <div class="loading-text">Generating video...</div>
        </div>
      `;
      return placeholderDiv;
    }

    function updateVideoPlaceholderWithError(placeholder, errorMessage) {
      placeholder.innerHTML = `
        <div class="output-placeholder-failed">
          <button class="failed-dismiss-btn" onclick="this.closest('.output-item').remove()" title="Dismiss">×</button>
          <div class="failed-icon">⚠️</div>
          <div class="failed-text">${errorMessage || 'Video generation failed'}</div>
        </div>
      `;
    }

    function replaceVideoPlaceholderWithVideo(placeholder, video) {
      // Build metadata string based on model
      let modelLabel, metadataStr;

      if (video.model.includes('kling')) {
        modelLabel = 'Kling 2.5';
        metadataStr = `${video.aspectRatio} · ${video.duration}s`;
      } else if (video.model.includes('wan')) {
        modelLabel = 'Wan 2.2';
        metadataStr = `${video.resolution} · ${video.frames}f @ ${video.fps}fps`;
      } else {
        // Veo
        modelLabel = 'Veo 3.1';
        metadataStr = `${video.aspectRatio} · ${video.resolution} · ${video.duration}s${video.hasAudio ? ' 🔊' : ''}`;
      }

      placeholder.dataset.videoUrl = video.url;

      // Set NSFW flag if present
      if (video.isNsfw) {
        placeholder.dataset.nsfw = 'true';
      }

      placeholder.innerHTML = `
        <div class="select-checkbox" onclick="toggleVideoSelection(event, this)"></div>
        ${video.isNsfw ? '<span class="nsfw-badge">NSFW</span>' : ''}
        <button class="video-expand-btn" onclick="event.stopPropagation(); showVideoModal('${video.url}')" title="Expand video">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 3 21 3 21 9"></polyline>
            <polyline points="9 21 3 21 3 15"></polyline>
            <line x1="21" y1="3" x2="14" y2="10"></line>
            <line x1="3" y1="21" x2="10" y2="14"></line>
          </svg>
        </button>
        <video controls autoplay style="width: 100%; display: block; background: #000;">
          <source src="${video.url}" type="video/mp4">
          Your browser does not support the video tag.
        </video>
        <div class="output-item-overlay">
          <div class="output-item-info">
            ${modelLabel} · ${metadataStr}
          </div>
          <div class="output-item-actions">
            <button class="icon-btn" onclick="downloadVideo('${video.url}', ${video.timestamp})" title="Download">
              <svg class="download-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
            </button>
            <button class="report-btn" onclick="event.stopPropagation(); openReportModal('video', '${video.timestamp}', '${video.url}')" title="Report">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                <line x1="4" y1="22" x2="4" y2="15"></line>
              </svg>
            </button>
            <button class="icon-btn delete-btn" onclick="deleteVideo(this.closest('.output-item'))" title="Delete">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
              </svg>
            </button>
          </div>
        </div>
      `;
    }

    function downloadVideo(url, timestamp) {
      fetch(url)
        .then(response => response.blob())
        .then(blob => {
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `vixxxen-video-${timestamp}.mp4`;
          link.click();
          URL.revokeObjectURL(link.href);
          // Track download for value moment analysis
          if (window.VxAnalytics && window.VxAnalytics.engagement) {
            window.VxAnalytics.engagement.downloaded('video');
          }
        })
        .catch(err => {
          console.error('Download failed:', err);
          showVideoError('Failed to download video');
        });
    }

    // deleteVideo moved to js/delete-functions.js
    // showVideoError moved to js/utils.js

    // Edit/Eraser Tab Functions with Canvas Mask Drawing
    function handleEditSourceImageUpload(event) {
      // Require login for uploads
      if (!isUserLoggedIn) {
        showLoginRequiredModal();
        event.target.value = ''; // Clear the file input
        return;
      }

      const file = event.target.files[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        showEditError('Please upload only image files');
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        editSourceImage = e.target.result;

        if (currentEditTool === 'eraser') {
          // For eraser tool, load to canvas
          loadImageToCanvas(e.target.result);
        } else if (currentEditTool === 'crop') {
          // For crop tool, initialize cropper
          document.getElementById('editImageUploadArea').style.display = 'none';
          initCropper(e.target.result);
        } else {
          // For background remover, show preview
          showImagePreview(e.target.result);
        }
      };
      reader.readAsDataURL(file);

      event.target.value = '';
    }

    function showImagePreview(imageSrc) {
      // Set preview image
      document.getElementById('editPreviewImage').src = imageSrc;

      // Hide upload area, show preview
      document.getElementById('editImageUploadArea').style.display = 'none';
      document.getElementById('editImagePreview').style.display = 'block';
    }

    function clearEditImage() {
      editSourceImage = null;
      loadedImage = null;

      // Reset upload area
      document.getElementById('editImageUploadArea').style.display = 'flex';
      document.getElementById('editImagePreview').style.display = 'none';
      document.getElementById('maskCanvasSection').style.display = 'none';

      // Clear canvas if it exists
      if (maskCanvas) {
        const ctx = maskCanvas.getContext('2d');
        ctx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
      }

      // Remove canvas-active class
      const leftPanel = document.querySelector('.left-panel');
      if (leftPanel) {
        leftPanel.classList.remove('canvas-active');
      }

      console.log('Edit image cleared');
    }

    function loadImageToCanvas(imageSrc) {
      const img = new Image();
      img.onload = function() {
        loadedImage = img;

        // Initialize canvas
        maskCanvas = document.getElementById('maskCanvas');
        maskCtx = maskCanvas.getContext('2d');

        // Set canvas size to match image (scale down if too large)
        const maxWidth = 700; // Larger canvas for better visibility
        const scale = Math.min(1, maxWidth / img.width);
        maskCanvas.width = img.width * scale;
        maskCanvas.height = img.height * scale;

        // Draw the image on canvas
        maskCtx.drawImage(img, 0, 0, maskCanvas.width, maskCanvas.height);

        // Show canvas section and hide upload area
        document.getElementById('maskCanvasSection').style.display = 'block';
        document.getElementById('editImageUploadArea').style.display = 'none';
        document.getElementById('editImagePreview').style.display = 'none';

        // Expand left panel for better canvas visibility
        const leftPanel = document.querySelector('.left-panel');
        if (leftPanel) {
          leftPanel.classList.add('canvas-active');
        }

        // Set up drawing events
        setupCanvasDrawing();
      };
      img.src = imageSrc;
    }

    function setupCanvasDrawing() {
      let rect = maskCanvas.getBoundingClientRect();

      // Mouse events
      maskCanvas.addEventListener('mousedown', startDrawing);
      maskCanvas.addEventListener('mousemove', draw);
      maskCanvas.addEventListener('mouseup', stopDrawing);
      maskCanvas.addEventListener('mouseout', stopDrawing);

      // Touch events for mobile
      maskCanvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousedown', {
          clientX: touch.clientX,
          clientY: touch.clientY
        });
        maskCanvas.dispatchEvent(mouseEvent);
      });

      maskCanvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousemove', {
          clientX: touch.clientX,
          clientY: touch.clientY
        });
        maskCanvas.dispatchEvent(mouseEvent);
      });

      maskCanvas.addEventListener('touchend', (e) => {
        e.preventDefault();
        const mouseEvent = new MouseEvent('mouseup', {});
        maskCanvas.dispatchEvent(mouseEvent);
      });
    }

    function startDrawing(e) {
      isDrawing = true;
      draw(e);
    }

    function draw(e) {
      if (!isDrawing) return;

      const rect = maskCanvas.getBoundingClientRect();

      // Calculate scaling ratio between canvas internal size and displayed size
      const scaleX = maskCanvas.width / rect.width;
      const scaleY = maskCanvas.height / rect.height;

      // Get mouse position relative to canvas and scale to internal coordinates
      const x = (e.clientX - rect.left) * scaleX;
      const y = (e.clientY - rect.top) * scaleY;

      maskCtx.globalCompositeOperation = 'source-over';
      maskCtx.fillStyle = 'rgba(255, 46, 187, 0.5)'; // Semi-transparent pink
      maskCtx.strokeStyle = 'rgba(255, 46, 187, 0.5)';
      maskCtx.lineWidth = brushSize;
      maskCtx.lineCap = 'round';
      maskCtx.lineJoin = 'round';

      maskCtx.lineTo(x, y);
      maskCtx.stroke();
      maskCtx.beginPath();
      maskCtx.arc(x, y, brushSize / 2, 0, Math.PI * 2);
      maskCtx.fill();
      maskCtx.beginPath();
      maskCtx.moveTo(x, y);
    }

    function stopDrawing() {
      if (isDrawing) {
        isDrawing = false;
        maskCtx.beginPath();
      }
    }

    function updateBrushSize(value) {
      brushSize = parseInt(value);
      document.getElementById('brushSizeValue').textContent = value;
    }

    function clearMask() {
      if (!loadedImage || !maskCanvas) return;

      // Redraw the original image to clear the mask
      maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
      maskCtx.drawImage(loadedImage, 0, 0, maskCanvas.width, maskCanvas.height);
    }

    function generateMaskFromCanvas() {
      // Create a new canvas for the mask
      const maskOnlyCanvas = document.createElement('canvas');
      maskOnlyCanvas.width = maskCanvas.width;
      maskOnlyCanvas.height = maskCanvas.height;
      const maskOnlyCtx = maskOnlyCanvas.getContext('2d');

      // Fill with black background
      maskOnlyCtx.fillStyle = '#000000';
      maskOnlyCtx.fillRect(0, 0, maskOnlyCanvas.width, maskOnlyCanvas.height);

      // Get the current canvas pixels
      const imageData = maskCtx.getImageData(0, 0, maskCanvas.width, maskCanvas.height);
      const data = imageData.data;

      // Create mask: white where pink paint is, black elsewhere
      const maskData = maskOnlyCtx.getImageData(0, 0, maskOnlyCanvas.width, maskOnlyCanvas.height);
      const mask = maskData.data;

      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        const a = data[i + 3];

        // Check if this pixel is pink (our mask color)
        // Pink is approximately RGB(255, 46, 187)
        const isPink = r > 200 && g < 100 && b > 150 && a > 100;

        if (isPink) {
          // White in mask (areas to remove)
          mask[i] = 255;     // R
          mask[i + 1] = 255; // G
          mask[i + 2] = 255; // B
          mask[i + 3] = 255; // A
        }
        // else stays black (from the initial fill)
      }

      maskOnlyCtx.putImageData(maskData, 0, 0);

      // Convert to base64
      return maskOnlyCanvas.toDataURL('image/png');
    }

    // Cropper instance
    let cropperInstance = null;

    // Edit Tool Functions
    function selectEditTool(tool) {
      currentEditTool = tool;

      // Update tab styling
      const eraserTab = document.getElementById('eraserToolTab');
      const bgRemoverTab = document.getElementById('bgRemoverToolTab');
      const cropTab = document.getElementById('cropToolTab');

      // Remove active from all tabs
      eraserTab.classList.remove('active');
      bgRemoverTab.classList.remove('active');
      cropTab.classList.remove('active');

      // Hide all tool-specific sections
      document.getElementById('cropSection').style.display = 'none';
      document.getElementById('editActionBtn').style.display = 'none';
      document.getElementById('cropActionBtn').style.display = 'none';
      document.getElementById('maskCanvasSection').style.display = 'none';

      // Destroy cropper if switching away from crop
      if (tool !== 'crop' && cropperInstance) {
        cropperInstance.destroy();
        cropperInstance = null;
      }

      if (tool === 'eraser') {
        eraserTab.classList.add('active');

        // If an image is loaded, switch to canvas view
        if (editSourceImage) {
          if (loadedImage) {
            document.getElementById('maskCanvasSection').style.display = 'block';
            document.getElementById('editImagePreview').style.display = 'none';
            document.getElementById('editImageUploadArea').style.display = 'none';
          } else {
            loadImageToCanvas(editSourceImage);
          }
        }

        document.getElementById('editActionBtn').style.display = 'block';
        document.getElementById('editActionText').textContent = '✨ Remove Object';
      } else if (tool === 'bg-remover') {
        bgRemoverTab.classList.add('active');

        // If an image is loaded, switch to preview view
        if (editSourceImage) {
          showImagePreview(editSourceImage);
        }

        document.getElementById('editActionBtn').style.display = 'block';
        document.getElementById('editActionText').textContent = '🎨 Remove Background';
      } else if (tool === 'crop') {
        cropTab.classList.add('active');

        // Show crop section
        document.getElementById('cropSection').style.display = 'block';
        document.getElementById('cropActionBtn').style.display = 'block';

        // If an image is loaded, initialize cropper
        if (editSourceImage) {
          document.getElementById('editImagePreview').style.display = 'none';
          document.getElementById('editImageUploadArea').style.display = 'none';
          initCropper(editSourceImage);
        }
      }

      // Update button cost display
      updateEditButtonCost();
    }

    // Initialize Cropper.js on the image
    function initCropper(imageSrc) {
      const cropPreviewContainer = document.getElementById('cropPreviewContainer');
      const cropPreviewImage = document.getElementById('cropPreviewImage');

      // Set image source
      cropPreviewImage.src = imageSrc;
      cropPreviewContainer.style.display = 'block';

      // Wait for image to load before initializing cropper
      cropPreviewImage.onload = function() {
        // Destroy existing cropper if any
        if (cropperInstance) {
          cropperInstance.destroy();
        }

        // Get initial aspect ratio
        const aspectRatioValue = document.getElementById('cropAspectRatio').value;
        const aspectRatio = aspectRatioValue === 'free' ? NaN : parseFloat(aspectRatioValue);

        // Initialize cropper
        cropperInstance = new Cropper(cropPreviewImage, {
          aspectRatio: aspectRatio,
          viewMode: 1,
          dragMode: 'move',
          autoCropArea: 0.8,
          restore: false,
          guides: true,
          center: true,
          highlight: true,
          cropBoxMovable: true,
          cropBoxResizable: true,
          toggleDragModeOnDblclick: false,
          background: true,
        });
      };
    }

    // Update aspect ratio of cropper
    function updateCropAspectRatio() {
      if (!cropperInstance) return;

      const aspectRatioValue = document.getElementById('cropAspectRatio').value;
      const aspectRatio = aspectRatioValue === 'free' ? NaN : parseFloat(aspectRatioValue);
      cropperInstance.setAspectRatio(aspectRatio);
    }

    // Reset crop to default
    function resetCrop() {
      if (!cropperInstance) return;
      cropperInstance.reset();
    }

    // Apply the crop and update the image
    function applyCrop() {
      // Require login for crop
      if (!isUserLoggedIn) {
        showLoginRequiredModal();
        return;
      }

      if (!cropperInstance) {
        showEditError('Please upload an image first');
        return;
      }

      // Get cropped canvas
      const croppedCanvas = cropperInstance.getCroppedCanvas({
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high',
      });

      if (!croppedCanvas) {
        showEditError('Failed to crop image');
        return;
      }

      // Convert to data URL
      const croppedImageUrl = croppedCanvas.toDataURL('image/png');

      // Update the edit source image with cropped version
      editSourceImage = croppedImageUrl;

      // Add cropped image to output grid
      const outputGrid = document.getElementById('editOutputGrid');

      // Clear placeholder if it exists
      const placeholder = outputGrid.querySelector('.output-placeholder');
      if (placeholder) {
        outputGrid.innerHTML = '';
      }

      // Get crop dimensions for info display
      const cropData = cropperInstance.getData();
      const aspectLabel = document.getElementById('cropAspectRatio').selectedOptions[0].text;
      const timestamp = Date.now();

      // Create output item with overlay structure matching image tab
      const outputItem = document.createElement('div');
      outputItem.className = 'output-item';
      outputItem.dataset.imageUrl = croppedImageUrl;
      outputItem.dataset.timestamp = timestamp;

      // Create image element
      const imgEl = document.createElement('img');
      imgEl.src = croppedImageUrl;
      imgEl.alt = 'Cropped image';
      imgEl.crossOrigin = 'anonymous';
      imgEl.onclick = () => showImageModal(croppedImageUrl);
      outputItem.appendChild(imgEl);

      // Create overlay
      const overlay = document.createElement('div');
      overlay.className = 'output-item-overlay';
      overlay.innerHTML = `
        <div class="output-item-info">
          Crop · ${aspectLabel}
        </div>
        <div class="output-item-actions">
          <button class="icon-btn" title="Download">
            <svg class="download-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
          </button>
          <div class="send-to-container">
            <button class="icon-btn" title="Send to...">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
              </svg>
            </button>
            <div class="send-to-menu">
              <button class="send-to-option">📹 Send to Video</button>
              <button class="send-to-option">✂️ Send to Edit</button>
              <button class="send-to-option">💬 Send to Caption</button>
              <button class="send-to-option">🖌️ Send to Inpaint</button>
            </div>
          </div>
          <button class="icon-btn delete-btn" title="Delete">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              <line x1="10" y1="11" x2="10" y2="17"></line>
              <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
          </button>
        </div>
      `;
      outputItem.appendChild(overlay);

      // Attach event handlers using the data attribute
      const downloadBtn = overlay.querySelector('.icon-btn');
      downloadBtn.onclick = (e) => {
        e.stopPropagation();
        downloadImage(outputItem.dataset.imageUrl, timestamp);
      };

      const sendToBtn = overlay.querySelector('.send-to-container > .icon-btn');
      sendToBtn.onclick = (e) => toggleSendToMenu(e, sendToBtn);

      const sendToOptions = overlay.querySelectorAll('.send-to-option');
      sendToOptions[0].onclick = (e) => sendToVideo(outputItem.dataset.imageUrl, e);
      sendToOptions[1].onclick = (e) => sendToEdit(outputItem.dataset.imageUrl, e);
      sendToOptions[2].onclick = (e) => sendToCaption(outputItem.dataset.imageUrl, e);

      const deleteBtn = overlay.querySelector('.delete-btn');
      deleteBtn.onclick = (e) => {
        e.stopPropagation();
        outputItem.style.transition = 'opacity 0.3s, transform 0.3s';
        outputItem.style.opacity = '0';
        outputItem.style.transform = 'scale(0.8)';
        setTimeout(() => outputItem.remove(), 300);
      };

      outputGrid.insertBefore(outputItem, outputGrid.firstChild);

      // Upload to storage for persistence
      uploadImageToStorage(croppedImageUrl, {
        type: 'crop',
        aspectRatio: aspectLabel,
        width: Math.round(cropData.width),
        height: Math.round(cropData.height)
      });

      // Reinitialize cropper with cropped image
      initCropper(croppedImageUrl);

      console.log('✂️ Image cropped successfully');
    }

    function performEditAction() {
      // Require login for edit actions
      if (!isUserLoggedIn) {
        showLoginRequiredModal();
        return;
      }

      console.log('performEditAction called, currentEditTool:', currentEditTool);
      console.log('editSourceImage:', !!editSourceImage);
      console.log('maskCanvas:', !!maskCanvas);
      console.log('loadedImage:', !!loadedImage);

      if (currentEditTool === 'eraser') {
        eraseObject();
      } else {
        removeBackground();
      }
    }

    async function removeBackground() {
      console.log('removeBackground called');
      if (isErasing) {
        console.log('Already erasing, returning');
        return;
      }

      if (!editSourceImage) {
        showEditError('Please upload a source image first!');
        return;
      }

      // Calculate and check credits
      const cost = calculateCreditCost('edit', 'bg-remover');

      if (!hasEnoughCredits(cost)) {
        showInsufficientCreditsError(cost);
        return;
      }

      // Deduct credits before operation
      const deducted = await deductCredits(cost, 'Background removal');
      if (!deducted) {
        showInsufficientCreditsError(cost);
        return;
      }

      isErasing = true;
      const btn = document.getElementById('editActionBtn');
      const btnText = document.getElementById('editActionText');

      btn.classList.add('generating');
      btnText.textContent = '⏳ Removing background...';
      btn.disabled = true;

      // Clear placeholder if it's first edit
      const outputGrid = document.getElementById('editOutputGrid');
      if (editedImages.length === 0) {
        outputGrid.innerHTML = '';
      }

      // Clear any previous errors
      document.getElementById('editErrorContainer').innerHTML = '';

      // Create loading placeholder
      const placeholder = createLoadingPlaceholder();
      outputGrid.insertBefore(placeholder, outputGrid.firstChild);

      try {
        const endpoint = `${API_BASE_URL}/api/bg-remover/remove`;
        const payload = {
          image: editSourceImage
        };

        console.log('Calling 851 Labs Background Remover...');

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 180000); // 3 minute timeout

        const response = await authFetch(endpoint, {
          method: 'POST',
          body: JSON.stringify(payload),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        const data = await response.json();

        if (!response.ok || !data.success) {
          throw new Error(data.error || 'Background removal failed');
        }

        console.log('Background removed successfully');

        // Remove loading placeholder
        placeholder.remove();

        // Add result to output
        const resultImage = data.image;
        const timestamp = Date.now();
        editedImages.unshift({ url: resultImage, model: 'bg-remover', timestamp });

        const imageCard = document.createElement('div');
        imageCard.className = 'output-item';
        imageCard.innerHTML = `
          <img src="${resultImage}" alt="Edited image" crossorigin="anonymous" onclick="showImageModal('${resultImage}')" title="Click to view full size">
          <div class="output-item-overlay">
            <div class="output-item-info">
              851 Labs BG Remover
            </div>
            <div class="output-item-actions">
              <button class="icon-btn" onclick="downloadImage('${resultImage}', 'bg-removed-${timestamp}.png')" title="Download">
                <svg class="download-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
              </button>
              <div class="send-to-container">
                <button class="icon-btn" onclick="toggleSendToMenu(event, this)" title="Send to...">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                  </svg>
                </button>
                <div class="send-to-menu">
                  <button class="send-to-option" onclick="sendToVideo('${resultImage}', event)">📹 Send to Video</button>
                  <button class="send-to-option" onclick="sendToEdit('${resultImage}', event)">✂️ Send to Edit</button>
                  <button class="send-to-option" onclick="sendToCaption('${resultImage}', event)">💬 Send to Caption</button>
                  <button class="send-to-option" onclick="sendToInpaint('${resultImage}', event)">🖌️ Send to Inpaint</button>
                </div>
              </div>
            </div>
          </div>
        `;

        outputGrid.insertBefore(imageCard, outputGrid.firstChild);

      } catch (error) {
        console.error('Background removal failed:', error);

        let errorMessage = 'Background removal failed - please try again';
        if (error.name === 'AbortError') {
          errorMessage = 'Request timed out - background removal took too long';
        } else if (error.message?.includes('Failed to fetch')) {
          errorMessage = 'Connection failed - make sure the backend server is running';
        } else if (error.message) {
          errorMessage = error.message;
        }

        showEditError(errorMessage);
        placeholder.remove();
      } finally {
        isErasing = false;
        btn.classList.remove('generating');
        updateEditButtonCost(); // Update button with cost again
        btn.disabled = false;
      }
    }

    async function eraseObject() {
      console.log('eraseObject called');
      console.log('isErasing:', isErasing);
      console.log('editSourceImage:', !!editSourceImage);
      console.log('maskCanvas:', !!maskCanvas);
      console.log('loadedImage:', !!loadedImage);

      if (isErasing) {
        console.log('Already erasing, returning');
        return;
      }

      if (!editSourceImage) {
        console.log('No editSourceImage, showing error');
        showEditError('Please upload a source image first!');
        return;
      }

      if (!maskCanvas || !loadedImage) {
        console.log('No maskCanvas or loadedImage, showing error');
        showEditError('Please draw a mask on the image first!');
        return;
      }

      console.log('All checks passed, generating mask...');
      // Generate mask from canvas drawings
      editMaskImage = generateMaskFromCanvas();
      console.log('Mask generated:', !!editMaskImage);

      // Calculate and check credits
      const cost = calculateCreditCost('edit', 'object-eraser');

      if (!hasEnoughCredits(cost)) {
        showInsufficientCreditsError(cost);
        return;
      }

      // Deduct credits before operation
      const deducted = await deductCredits(cost, 'Object removal');
      if (!deducted) {
        showInsufficientCreditsError(cost);
        return;
      }

      isErasing = true;
      const btn = document.getElementById('editActionBtn');
      const btnText = document.getElementById('editActionText');

      btn.classList.add('generating');
      btnText.textContent = '⏳ Erasing...';
      btn.disabled = true;

      // Use sensible defaults (settings removed from UI)
      const preserveAlpha = true;
      const contentModeration = false;

      // Clear placeholder if it's first edit
      const editOutputGrid = document.getElementById('editOutputGrid');
      if (editedImages.length === 0) {
        editOutputGrid.innerHTML = '';
      }

      // Clear any previous errors
      document.getElementById('editErrorContainer').innerHTML = '';

      // Create loading placeholder (insert at top)
      const placeholder = createEditLoadingPlaceholder();
      editOutputGrid.insertBefore(placeholder, editOutputGrid.firstChild);

      try {
        const endpoint = `${API_BASE_URL}/api/eraser/erase`;
        const payload = {
          image: editSourceImage,
          mask: editMaskImage,
          preserveAlpha,
          contentModeration,
          sync: true
        };

        console.log('Erasing object with Bria Eraser...');

        // Add timeout to fetch request (2 minutes for image editing)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 120000); // 2 minute timeout

        const response = await authFetch(endpoint, {
          method: 'POST',
          body: JSON.stringify(payload),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Object removal failed');
        }

        console.log('Object removal successful:', data);

        // Create new edited image object
        const newEditedImage = {
          url: data.imageUrl,
          model: 'bria-eraser',
          timestamp: Date.now(),
          preserveAlpha,
          contentModeration
        };

        editedImages.push(newEditedImage);
        replaceEditPlaceholderWithImage(placeholder, newEditedImage);

      } catch (error) {
        console.error('Object removal failed:', error);

        let errorMessage = error.message || 'Failed to remove object';
        if (error.name === 'AbortError') {
          errorMessage = 'Request timed out - object removal took too long';
        } else if (error.message?.includes('Failed to fetch')) {
          errorMessage = 'Connection failed - make sure the backend server is running';
        }

        updateEditPlaceholderWithError(placeholder, errorMessage);
        showEditError(errorMessage);
      } finally {
        isErasing = false;
        btn.classList.remove('generating');
        updateEditButtonCost(); // Update button with cost again
        btn.disabled = false;
      }
    }

    function createEditLoadingPlaceholder() {
      const placeholderDiv = document.createElement('div');
      placeholderDiv.className = 'output-item';
      placeholderDiv.innerHTML = `
        <div class="output-placeholder-loading">
          <div class="loading-static-overlay"></div>
          <div class="loading-text">Removing object...</div>
        </div>
      `;
      return placeholderDiv;
    }

    function updateEditPlaceholderWithError(placeholder, errorMessage) {
      placeholder.innerHTML = `
        <div class="output-placeholder-failed">
          <button class="failed-dismiss-btn" onclick="this.closest('.output-item').remove()" title="Dismiss">×</button>
          <div class="failed-icon">⚠️</div>
          <div class="failed-text">${errorMessage || 'Object removal failed'}</div>
        </div>
      `;
    }

    function replaceEditPlaceholderWithImage(placeholder, editedImage) {
      placeholder.innerHTML = `
        <img src="${editedImage.url}" alt="Edited image" crossorigin="anonymous" onclick="showImageModal('${editedImage.url}')" title="Click to view full size">
        <div class="output-item-overlay">
          <div class="output-item-info">
            Bria Eraser${editedImage.preserveAlpha ? ' · Alpha' : ''}
          </div>
          <div class="output-item-actions">
            <button class="icon-btn" onclick="downloadImage('${editedImage.url}', ${editedImage.timestamp})" title="Download">
              <svg class="download-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
            </button>
            <div class="send-to-container">
              <button class="icon-btn" onclick="toggleSendToMenu(event, this)" title="Send to...">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
              </button>
              <div class="send-to-menu">
                <button class="send-to-option" onclick="sendToVideo('${editedImage.url}', event)">📹 Send to Video</button>
                <button class="send-to-option" onclick="sendToEdit('${editedImage.url}', event)">✂️ Send to Edit</button>
                <button class="send-to-option" onclick="sendToCaption('${editedImage.url}', event)">💬 Send to Caption</button>
                <button class="send-to-option" onclick="sendToInpaint('${editedImage.url}', event)">🖌️ Send to Inpaint</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function showEditError(message, type = 'error') {
      const errorContainer = document.getElementById('editErrorContainer');
      const icon = type === 'warning' ? '⚠️' : '❌';
      errorContainer.innerHTML = `
        <div class="error-message" style="${type === 'warning' ? 'background: rgba(255, 165, 0, 0.1); border-color: rgba(255, 165, 0, 0.3);' : ''}">
          ${icon} ${message}
        </div>
      `;

      // Auto-hide after 7 seconds
      setTimeout(() => {
        errorContainer.innerHTML = '';
      }, 7000);
    }

    // ==========================================
    // Inpaint Tab Functions
    // ==========================================

    let inpaintImage = null;
    let inpaintMode = 'sfw';
    let inpaintBrushSize = 30;
    let inpaintIntensity = 25; // 0-100 maps to 0.5-0.9 denoise
    let isInpaintDrawing = false;
    let inpaintMaskHistory = [];
    let inpaintResultUrl = null;

    function handleInpaintImageUpload(event) {
      // Require login for uploads
      if (!isUserLoggedIn) {
        showLoginRequiredModal();
        event.target.value = ''; // Clear the file input
        return;
      }

      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        loadInpaintImage(e.target.result);
      };
      reader.readAsDataURL(file);
    }

    function loadInpaintImage(src) {
      const img = new Image();
      img.crossOrigin = "anonymous"; // Enable CORS for cross-origin images
      img.onload = function() {
        inpaintImage = img;

        const canvas = document.getElementById('inpaintCanvas');
        const maskCanvas = document.getElementById('inpaintMaskCanvas');
        const wrapper = document.getElementById('inpaintCanvasWrapper');
        const placeholder = document.getElementById('inpaintUploadPlaceholder');

        // Calculate size to fit in wrapper while maintaining aspect ratio
        const maxWidth = wrapper.clientWidth - 40;
        const maxHeight = wrapper.clientHeight - 40;
        const scale = Math.min(maxWidth / img.width, maxHeight / img.height, 1);
        const width = img.width * scale;
        const height = img.height * scale;

        // Setup canvases
        canvas.width = img.width;
        canvas.height = img.height;
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';
        canvas.style.display = 'block';

        maskCanvas.width = img.width;
        maskCanvas.height = img.height;
        maskCanvas.style.width = width + 'px';
        maskCanvas.style.height = height + 'px';
        maskCanvas.style.display = 'block';

        // Draw image
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);

        // Clear mask
        const maskCtx = maskCanvas.getContext('2d', { willReadFrequently: true });
        maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);

        // Hide placeholder
        placeholder.style.display = 'none';

        // Setup drawing
        setupInpaintDrawing(canvas, maskCanvas);

        // Clear history
        inpaintMaskHistory = [];
      };
      img.onerror = function() {
        // If CORS fails, try loading through a proxy or show error
        console.error('Failed to load image with CORS. Image may not support cross-origin access.');
        showError('Failed to load image. The image server may not support cross-origin access.');
      };
      img.src = src;
    }

    function setupInpaintDrawing(canvas, maskCanvas) {
      const maskCtx = maskCanvas.getContext('2d', { willReadFrequently: true });
      maskCtx.strokeStyle = 'rgba(255, 46, 187, 0.7)';
      maskCtx.lineCap = 'round';
      maskCtx.lineJoin = 'round';

      // Get scale factor
      function getScale() {
        return canvas.width / canvas.offsetWidth;
      }

      function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const scale = getScale();
        return {
          x: (e.clientX - rect.left) * scale,
          y: (e.clientY - rect.top) * scale
        };
      }

      // Mouse events
      canvas.onmousedown = function(e) {
        isInpaintDrawing = true;
        // Save current state for undo
        inpaintMaskHistory.push(maskCtx.getImageData(0, 0, maskCanvas.width, maskCanvas.height));
        if (inpaintMaskHistory.length > 20) inpaintMaskHistory.shift();

        const pos = getPos(e);
        maskCtx.beginPath();
        maskCtx.moveTo(pos.x, pos.y);
        maskCtx.lineWidth = inpaintBrushSize * getScale();
      };

      canvas.onmousemove = function(e) {
        if (!isInpaintDrawing) return;
        const pos = getPos(e);
        maskCtx.lineTo(pos.x, pos.y);
        maskCtx.stroke();
        maskCtx.beginPath();
        maskCtx.moveTo(pos.x, pos.y);
      };

      canvas.onmouseup = function() {
        isInpaintDrawing = false;
      };

      canvas.onmouseleave = function() {
        isInpaintDrawing = false;
      };

      // Touch events for mobile
      canvas.ontouchstart = function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        canvas.onmousedown({ clientX: touch.clientX, clientY: touch.clientY });
      };

      canvas.ontouchmove = function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        canvas.onmousemove({ clientX: touch.clientX, clientY: touch.clientY });
      };

      canvas.ontouchend = function() {
        isInpaintDrawing = false;
      };
    }

    function updateInpaintBrushSize(value) {
      inpaintBrushSize = parseInt(value);
      document.getElementById('inpaintBrushSizeValue').textContent = value + 'px';

      // Update preview - scale to fit in 100px container
      const preview = document.getElementById('inpaintBrushPreview');
      const size = Math.round(value * 1); // 1:1 scale, container is now 110px
      preview.innerHTML = `<div style="width:${size}px;height:${size}px;border-radius:50%;background:rgba(255,46,187,0.7);"></div>`;
    }

    function updateInpaintIntensity(value) {
      inpaintIntensity = parseInt(value);
    }

    // Initialize brush preview on page load
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(function() {
        updateInpaintBrushSize(30);
      }, 100);
    });

    function clearInpaintMask() {
      const maskCanvas = document.getElementById('inpaintMaskCanvas');
      if (!maskCanvas) return;
      const ctx = maskCanvas.getContext('2d');
      ctx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
      inpaintMaskHistory = [];
    }

    function undoInpaintMask() {
      if (inpaintMaskHistory.length === 0) return;
      const maskCanvas = document.getElementById('inpaintMaskCanvas');
      const ctx = maskCanvas.getContext('2d');
      const previousState = inpaintMaskHistory.pop();
      ctx.putImageData(previousState, 0, 0);
    }

    function clearInpaintImage() {
      // Reset inpaint image state
      inpaintImage = null;
      inpaintMaskHistory = [];

      // Hide canvases
      const canvas = document.getElementById('inpaintCanvas');
      const maskCanvas = document.getElementById('inpaintMaskCanvas');
      if (canvas) canvas.style.display = 'none';
      if (maskCanvas) maskCanvas.style.display = 'none';

      // Show upload placeholder
      const placeholder = document.getElementById('inpaintUploadPlaceholder');
      if (placeholder) placeholder.style.display = 'flex';

      // Clear file input
      const fileInput = document.getElementById('inpaintImageInput');
      if (fileInput) fileInput.value = '';
    }

    function setInpaintMode(mode) {
      inpaintMode = mode;
      document.getElementById('inpaintSfwBtn').classList.toggle('active', mode === 'sfw');
      document.getElementById('inpaintNsfwBtn').classList.toggle('active', mode === 'nsfw');

      // Hide LoRA dropdown in NSFW mode (not needed for NSFW inpaint)
      const loraSection = document.getElementById('inpaintLoraSection');
      if (loraSection) {
        loraSection.style.display = mode === 'nsfw' ? 'none' : 'flex';
      }

      // Clear LoRA selection when switching to NSFW
      if (mode === 'nsfw') {
        const loraSelect = document.getElementById('inpaintLoraSelect');
        if (loraSelect) loraSelect.value = '';
      }
    }

    function createMaskedImage() {
      // Create TWO separate images:
      // 1. Original image (full RGB, no alpha modification)
      // 2. Mask image (white=inpaint, black=keep)
      const canvas = document.getElementById('inpaintCanvas');
      const maskCanvas = document.getElementById('inpaintMaskCanvas');

      // Calculate resize dimensions (max 2048px to preserve quality)
      const MAX_DIMENSION = 2048;
      let outputWidth = canvas.width;
      let outputHeight = canvas.height;
      const scale = Math.min(MAX_DIMENSION / outputWidth, MAX_DIMENSION / outputHeight, 1);

      if (scale < 1) {
        outputWidth = Math.round(outputWidth * scale);
        outputHeight = Math.round(outputHeight * scale);
        console.log(`📐 Resizing from ${canvas.width}x${canvas.height} to ${outputWidth}x${outputHeight}`);
      }

      // 1. Original image (no alpha modification - preserve RGB values)
      const imageCanvas = document.createElement('canvas');
      imageCanvas.width = outputWidth;
      imageCanvas.height = outputHeight;
      const imageCtx = imageCanvas.getContext('2d');
      imageCtx.drawImage(inpaintImage, 0, 0, outputWidth, outputHeight);

      // 2. Mask image (white=inpaint, black=keep)
      const maskOutputCanvas = document.createElement('canvas');
      maskOutputCanvas.width = outputWidth;
      maskOutputCanvas.height = outputHeight;
      const maskCtx = maskOutputCanvas.getContext('2d');

      // Start with black (keep everything)
      maskCtx.fillStyle = '#000000';
      maskCtx.fillRect(0, 0, outputWidth, outputHeight);

      // Scale the painted mask
      const scaledMaskCanvas = document.createElement('canvas');
      scaledMaskCanvas.width = outputWidth;
      scaledMaskCanvas.height = outputHeight;
      const scaledMaskCtx = scaledMaskCanvas.getContext('2d');
      scaledMaskCtx.drawImage(maskCanvas, 0, 0, outputWidth, outputHeight);

      // Get mask strokes and create white where painted
      const maskData = scaledMaskCtx.getImageData(0, 0, outputWidth, outputHeight);
      const outputMaskData = maskCtx.getImageData(0, 0, outputWidth, outputHeight);

      for (let i = 0; i < maskData.data.length; i += 4) {
        if (maskData.data[i + 3] > 0) {
          // White = inpaint this area
          outputMaskData.data[i] = 255;     // R
          outputMaskData.data[i + 1] = 255; // G
          outputMaskData.data[i + 2] = 255; // B
          outputMaskData.data[i + 3] = 255; // A
        }
      }
      maskCtx.putImageData(outputMaskData, 0, 0);

      return {
        image: imageCanvas.toDataURL('image/png').split(',')[1],
        mask: maskOutputCanvas.toDataURL('image/png').split(',')[1]
      };
    }

    // Poll async inpaint job until completion
    async function pollInpaintJob(statusUrl, jobId) {
      const maxAttempts = 60; // 5 minutes max (5 sec intervals)
      const pollInterval = 5000; // 5 seconds

      for (let attempt = 0; attempt < maxAttempts; attempt++) {
        try {
          console.log(`🖌️ Polling inpaint job (attempt ${attempt + 1}/${maxAttempts})...`);

          // Update loading status
          const elapsedSecs = attempt * 5;
          if (elapsedSecs < 10) {
            updateLoadingStatus('Queued, waiting for GPU...');
          } else if (elapsedSecs < 30) {
            updateLoadingStatus('Processing image...');
          } else {
            updateLoadingStatus(`Processing... (${elapsedSecs}s)`);
          }

          const response = await fetch(statusUrl);
          const data = await response.json();

          console.log(`🖌️ Job status:`, data.status, data);

          if (data.status === 'completed' || data.status === 'success') {
            // Job complete - extract image URL
            let imageUrl = data.image || data.imageUrl || data.url || data.result ||
                           (data.images && data.images[0]) || (data.outputs && data.outputs[0]) ||
                           (data.output && data.output.images && data.output.images[0]);

            // Handle output.message format (raw base64 without data URI prefix)
            if (!imageUrl && data.output) {
              if (typeof data.output === 'string') {
                imageUrl = data.output;
              } else if (data.output.message) {
                const base64Data = data.output.message;
                if (base64Data.startsWith('data:')) {
                  imageUrl = base64Data;
                } else {
                  imageUrl = `data:image/png;base64,${base64Data}`;
                }
              }
            }

            if (imageUrl) {
              console.log(`✅ Inpaint job completed, image URL:`, imageUrl.substring(0, 80) + '...');
              return imageUrl;
            } else {
              console.error('Job completed but no image URL found:', data);
              return null;
            }
          } else if (data.status === 'failed' || data.status === 'error') {
            console.error('Inpaint job failed:', data.error || data.message);
            return null;
          }

          // Job still processing, wait and retry
          await new Promise(resolve => setTimeout(resolve, pollInterval));

        } catch (err) {
          console.error(`Polling error (attempt ${attempt + 1}):`, err);
          await new Promise(resolve => setTimeout(resolve, pollInterval));
        }
      }

      console.error('Inpaint job timed out after 5 minutes');
      return null;
    }

    function updateLoadingStatus(text) {
      const statusEl = document.getElementById('inpaintLoadingStatus');
      if (statusEl) {
        statusEl.textContent = text;
      }
    }

    async function generateInpaint() {
      // Require login for inpaint generation
      if (!isUserLoggedIn) {
        showLoginRequiredModal();
        return;
      }

      if (!inpaintImage) {
        showError('Please upload an image first');
        return;
      }

      const prompt = document.getElementById('inpaintPrompt').value.trim();
      if (!prompt) {
        showError('Please enter a prompt describing what should appear');
        return;
      }

      // Check if mask has been drawn
      const maskCanvas = document.getElementById('inpaintMaskCanvas');
      const maskCtx = maskCanvas.getContext('2d');
      const maskData = maskCtx.getImageData(0, 0, maskCanvas.width, maskCanvas.height);
      let hasMask = false;
      for (let i = 0; i < maskData.data.length; i += 4) {
        if (maskData.data[i + 3] > 0) {
          hasMask = true;
          break;
        }
      }
      if (!hasMask) {
        showError('Please paint over the area you want to inpaint');
        return;
      }

      // Get LoRA - handle both built-in and marketplace characters
      const loraSelect = document.getElementById('inpaintLoraSelect');
      const loraValue = loraSelect.value;
      const loras = [];
      let inpaintPrompt = prompt;

      if (loraValue) {
        // Check if it's a built-in LoRA (filename ending in .safetensors)
        if (loraValue.endsWith('.safetensors')) {
          loras.push(loraValue);
        } else {
          // Look up in marketplace characters
          const character = allMarketplaceCharacters.find(c => c.id === loraValue);
          if (character && character.lora_url) {
            loras.push(character.lora_url);
            // Prepend trigger word to prompt if available
            if (character.trigger_word) {
              inpaintPrompt = `${character.trigger_word} ${prompt}`;
            }
          }
        }
      }

      // Get number of generations
      const numGenerations = parseInt(document.getElementById('inpaintNumGenerations').value) || 1;

      console.log('🖌️ Inpaint generation:', { prompt: inpaintPrompt, loras, mode: inpaintMode, count: numGenerations });

      // Create original image and separate mask (white=inpaint, black=keep)
      const { image: imageBase64, mask: maskBase64 } = createMaskedImage();
      console.log('🖌️ Image:', Math.round(imageBase64.length / 1024), 'KB, Mask:', Math.round(maskBase64.length / 1024), 'KB');

      // Show loading with GPU status
      document.getElementById('inpaintGenerateBtn').disabled = true;
      document.getElementById('inpaintLoading').style.display = 'flex';

      // Update loading text
      const loadingText = document.getElementById('inpaintLoadingText');
      loadingText.textContent = 'Generating...';

      // Add loading placeholders
      const grid = document.getElementById('inpaintResultsGrid');
      const emptyPlaceholder = document.getElementById('inpaintResultPlaceholder');
      if (emptyPlaceholder) emptyPlaceholder.style.display = 'none';

      const loadingPlaceholders = [];
      for (let i = 0; i < numGenerations; i++) {
        const placeholder = createInpaintLoadingPlaceholder();
        loadingPlaceholders.push(placeholder);
        grid.insertBefore(placeholder, grid.firstChild);
      }

      const endpoint = inpaintMode === 'sfw' ? '/api/inpaint/inpaint-sfw' : '/api/inpaint/inpaint-nsfw';
      const results = [];
      let successCount = 0;

      try {
        // Generate images sequentially
        for (let i = 0; i < numGenerations; i++) {
          console.log(`🖌️ Generating inpaint ${i + 1}/${numGenerations}...`);

          try {
            // Map intensity 0-100 to denoise 0.5-0.9
            const denoise = 0.5 + (inpaintIntensity / 100) * 0.4;

            const response = await authFetch(`${API_BASE_URL}${endpoint}`, {
              method: 'POST',
              body: JSON.stringify({
                image: imageBase64,
                mask: maskBase64,
                prompt: inpaintPrompt,
                loras: loras,
                denoise: denoise
              })
            });

            const data = await response.json();
            console.log(`🖌️ Inpaint API response:`, data);

            if (!response.ok) {
              console.error(`Generation ${i + 1} failed:`, data.error);

              // Check for moderation error - show modal if image was saved for appeal
              if (data.canAppeal && data.savedImageIds?.length > 0) {
                showModerationModal(data, imageBase64);
              }

              continue;
            }

            // Check if this is an async job response (has statusUrl)
            let imageUrl = null;
            if (data.statusUrl || data.jobId) {
              console.log(`🖌️ Async job started, polling for completion...`);
              imageUrl = await pollInpaintJob(data.statusUrl, data.jobId);
            } else {
              // Direct response with image
              imageUrl = data.image || data.imageUrl || data.output || data.url || data.result || (data.images && data.images[0]) || (data.outputs && data.outputs[0]);
            }

            if (imageUrl) {
              results.push(imageUrl);
              successCount++;
              // Replace placeholder with actual result
              replaceInpaintPlaceholder(loadingPlaceholders[i], imageUrl);
            } else {
              console.warn(`Generation ${i + 1}: No image URL found in response. Keys:`, Object.keys(data));
              // Remove failed placeholder
              loadingPlaceholders[i].remove();
            }
          } catch (err) {
            console.error(`Generation ${i + 1} error:`, err);
            // Remove failed placeholder
            loadingPlaceholders[i].remove();
          }
        }

        // Store first result for backward compatibility
        if (results.length > 0) {
          inpaintResultUrl = results[0];
        }

        // Show empty placeholder if no results
        if (results.length === 0) {
          const emptyPlaceholder = document.getElementById('inpaintResultPlaceholder');
          if (emptyPlaceholder && grid.querySelectorAll('.output-item:not(.inpaint-loading-placeholder)').length === 0) {
            emptyPlaceholder.style.display = '';
          }
          throw new Error('No images were generated');
        }

        console.log(`✅ Inpaint complete: ${successCount}/${numGenerations} images generated`);

      } catch (error) {
        console.error('Inpaint error:', error);
        showError(error.message || 'Inpaint failed');
        // Remove any remaining loading placeholders on error
        loadingPlaceholders.forEach(p => p.remove());
      } finally {
        document.getElementById('inpaintGenerateBtn').disabled = false;
        document.getElementById('inpaintLoading').style.display = 'none';
        // Clean up any remaining loading placeholders
        document.querySelectorAll('.inpaint-loading-placeholder').forEach(p => p.remove());
      }
    }

    function createInpaintLoadingPlaceholder() {
      const placeholderDiv = document.createElement('div');
      placeholderDiv.className = 'output-item inpaint-loading-placeholder';
      placeholderDiv.innerHTML = `
        <div class="output-placeholder-loading">
          <div class="loading-static-overlay"></div>
          <div class="loading-text">Inpainting...</div>
        </div>
      `;
      return placeholderDiv;
    }

    function replaceInpaintPlaceholder(placeholder, imageUrl) {
      const timestamp = Date.now();
      const resultDiv = document.createElement('div');
      resultDiv.className = 'output-item inpaint-output-item';
      resultDiv.dataset.imageUrl = imageUrl;
      resultDiv.dataset.timestamp = timestamp;
      resultDiv.innerHTML = `
        <img src="${imageUrl}" alt="Inpaint result" onclick="showImageModal('${imageUrl}')" title="Click to view full size">
        <div class="output-item-overlay">
          <div class="output-item-info">
            Inpaint Result
          </div>
          <div class="output-item-actions">
            <button class="icon-btn" onclick="downloadInpaintResultUrl('${imageUrl}', ${timestamp})" title="Download">
              <svg class="download-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
            </button>
            <div class="send-to-container">
              <button class="icon-btn" onclick="toggleSendToMenu(event, this)" title="Send to...">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
              </button>
              <div class="send-to-menu">
                <button class="send-to-option" onclick="sendToVideo('${imageUrl}', event)">📹 Send to Video</button>
                <button class="send-to-option" onclick="sendToEdit('${imageUrl}', event)">✂️ Send to Edit</button>
                <button class="send-to-option" onclick="sendToCaption('${imageUrl}', event)">💬 Send to Caption</button>
                <button class="send-to-option" onclick="sendToInpaint('${imageUrl}', event)">🖌️ Send to Inpaint</button>
              </div>
            </div>
            <button class="icon-btn delete-btn" onclick="deleteInpaintResult(this.closest('.output-item'))" title="Delete">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
              </svg>
            </button>
          </div>
        </div>
      `;
      placeholder.replaceWith(resultDiv);

      // Upload to Supabase Storage for analytics tracking (async, don't block UI)
      const inpaintPromptValue = document.getElementById('inpaintPrompt')?.value || '';
      uploadImageToStorage(imageUrl, {
        prompt: inpaintPromptValue,
        model: inpaintMode === 'nsfw' ? 'inpaint-nsfw' : 'inpaint-sfw',
        type: 'inpaint'
      });
    }

    function displayInpaintResults(results) {
      const grid = document.getElementById('inpaintResultsGrid');
      const placeholder = document.getElementById('inpaintResultPlaceholder');

      // Hide placeholder
      if (placeholder) {
        placeholder.style.display = 'none';
      }

      // Generate result items HTML (matching image output format)
      const timestamp = Date.now();
      results.forEach((url, index) => {
        const resultDiv = document.createElement('div');
        resultDiv.className = 'output-item inpaint-output-item';
        resultDiv.dataset.imageUrl = url;
        resultDiv.dataset.timestamp = timestamp + index;
        resultDiv.innerHTML = `
          <img src="${url}" alt="Inpaint result" onclick="showImageModal('${url}')" title="Click to view full size">
          <div class="output-item-overlay">
            <div class="output-item-info">
              Inpaint Result
            </div>
            <div class="output-item-actions">
              <button class="icon-btn" onclick="downloadInpaintResultUrl('${url}', ${timestamp + index})" title="Download">
                <svg class="download-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
              </button>
              <div class="send-to-container">
                <button class="icon-btn" onclick="toggleSendToMenu(event, this)" title="Send to...">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                  </svg>
                </button>
                <div class="send-to-menu">
                  <button class="send-to-option" onclick="sendToVideo('${url}', event)">📹 Send to Video</button>
                  <button class="send-to-option" onclick="sendToEdit('${url}', event)">✂️ Send to Edit</button>
                  <button class="send-to-option" onclick="sendToCaption('${url}', event)">💬 Send to Caption</button>
                  <button class="send-to-option" onclick="sendToInpaint('${url}', event)">🖌️ Send to Inpaint</button>
                </div>
              </div>
              <button class="icon-btn delete-btn" onclick="deleteInpaintResult(this.closest('.output-item'))" title="Delete">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  <line x1="10" y1="11" x2="10" y2="17"></line>
                  <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
              </button>
            </div>
          </div>
        `;
        // Prepend new results (newest first)
        grid.insertBefore(resultDiv, grid.firstChild);
      });
    }


    function downloadInpaintResultUrl(url, index) {
      const a = document.createElement('a');
      a.href = url;
      a.download = `inpaint-result-${index}.png`;
      a.click();
    }

    function deleteInpaintResult(element) {
      if (element) {
        element.remove();
        // Show placeholder if no results left
        const grid = document.getElementById('inpaintResultsGrid');
        const remainingResults = grid.querySelectorAll('.output-item');
        if (remainingResults.length === 0) {
          const placeholder = document.getElementById('inpaintResultPlaceholder');
          if (placeholder) {
            placeholder.style.display = '';
          }
        }
      }
    }

    // Send image to inpaint from other tabs
    function sendToInpaint(imageUrl) {
      switchMainTab('inpaint');
      // Use proxy for external URLs to bypass CORS
      if (imageUrl.startsWith('http') && !imageUrl.startsWith(window.location.origin)) {
        const proxyUrl = `${API_BASE_URL}/api/inpaint/proxy-image?url=${encodeURIComponent(imageUrl)}`;
        loadInpaintImage(proxyUrl);
      } else {
        loadInpaintImage(imageUrl);
      }
    }

    // Caption Tab Functions
    function selectCaptionModel(model) {
      currentCaptionModel = model;
      console.log(`Switched to ${model.toUpperCase()} model`);

      // Update tab styling
      const gpt5Tab = document.getElementById('gpt5CaptionTab');
      const grok4Tab = document.getElementById('grok4CaptionTab');

      if (model === 'gpt-5') {
        gpt5Tab.classList.add('active');
        grok4Tab.classList.remove('active');
      } else {
        grok4Tab.classList.add('active');
        gpt5Tab.classList.remove('active');
      }
    }

    function handleCaptionImageUpload(event) {
      // Require login for uploads
      if (!isUserLoggedIn) {
        showLoginRequiredModal();
        event.target.value = ''; // Clear the file input
        return;
      }

      const file = event.target.files[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        alert('Please upload only image files');
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        captionImage = e.target.result;

        // Add the image to chat
        addCaptionMessage('user', null, captionImage);
      };
      reader.readAsDataURL(file);

      // Reset input
      event.target.value = '';
    }

    function addCaptionMessage(role, text, image = null) {
      const chatArea = document.getElementById('captionChatArea');
      const welcome = chatArea.querySelector('.caption-welcome');

      // Remove welcome message if it exists and add has-messages class
      if (welcome) {
        welcome.remove();
        chatArea.classList.add('has-messages');
      }

      const messageDiv = document.createElement('div');
      messageDiv.className = `caption-message ${role}`;

      let content = '<div class="caption-message-content">';
      if (image) {
        content += `<img src="${image}" class="caption-message-image" alt="Uploaded image">`;
      }
      if (text) {
        content += `<div class="caption-message-text">${text}</div>`;
      }
      content += '</div>';

      messageDiv.innerHTML = content;
      chatArea.appendChild(messageDiv);

      // Scroll to bottom
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    async function generateCaption() {
      // Require login for caption generation
      if (!isUserLoggedIn) {
        showLoginRequiredModal();
        return;
      }

      if (isCaptioning) return;

      const input = document.getElementById('captionInput');
      const userMessage = input.value.trim();

      if (!userMessage) return;

      // Add user message to chat
      addCaptionMessage('user', userMessage);

      // Add user message to conversation history
      const userMsg = {
        role: 'user',
        content: userMessage
      };
      if (captionImage) {
        userMsg.image = captionImage;
      }
      conversationHistory.push(userMsg);

      // Clear input
      input.value = '';

      isCaptioning = true;
      const sendBtn = document.getElementById('captionSendBtn');
      sendBtn.disabled = true;
      input.disabled = true;

      // Add assistant message placeholder for streaming
      const chatArea = document.getElementById('captionChatArea');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'caption-message assistant';
      messageDiv.innerHTML = `
        <div class="caption-message-content">
          <div class="caption-message-text" id="streamingText">
            <div class="typing-indicator">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        </div>
      `;
      chatArea.appendChild(messageDiv);
      chatArea.scrollTop = chatArea.scrollHeight;

      const streamingText = document.getElementById('streamingText');
      let fullText = '';
      let firstChunk = true;

      try {
        const endpoint = `${API_BASE_URL}/api/deepseek/caption`;
        const payload = {
          messages: conversationHistory, // Send full conversation history
          model: currentCaptionModel,
          maxTokens: 4096,
          stream: true
        };

        console.log(`Calling Grok for ${captionImage ? 'vision' : 'text-only'} query (streaming)...`);

        // Get auth token for streaming request
        const { data: { session } } = await supabaseClient.auth.getSession();
        const token = session?.access_token;

        if (!token) {
          throw new Error('Please log in to use AI chat');
        }

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error('Caption generation failed');
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();

          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop(); // Keep incomplete line in buffer

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.slice(6);
              if (data === '[DONE]') {
                console.log('Streaming completed');
                continue;
              }

              try {
                const parsed = JSON.parse(data);
                if (parsed.content) {
                  // Remove typing indicator on first chunk
                  if (firstChunk) {
                    streamingText.innerHTML = '';
                    firstChunk = false;
                  }

                  fullText += parsed.content;
                  streamingText.textContent = fullText;
                  chatArea.scrollTop = chatArea.scrollHeight;
                }
              } catch (e) {
                // Skip invalid JSON
              }
            }
          }
        }

        // Remove the streaming ID to prevent conflicts
        streamingText.removeAttribute('id');

        if (!fullText) {
          streamingText.innerHTML = '';
          streamingText.textContent = 'No response received';
        } else {
          // Add assistant response to conversation history
          conversationHistory.push({
            role: 'assistant',
            content: fullText
          });
        }

      } catch (error) {
        console.error('Caption generation failed:', error);

        let errorMessage = 'Sorry, there was an error. Please try again.';
        if (error.message?.includes('Failed to fetch')) {
          errorMessage = 'Connection failed - make sure the backend server is running';
        } else if (error.message?.includes('API')) {
          errorMessage = 'AI service error - please try again in a moment';
        }

        // Clear typing indicator before showing error
        streamingText.innerHTML = '';
        streamingText.textContent = errorMessage;
      } finally {
        isCaptioning = false;
        sendBtn.disabled = false;
        input.disabled = false;
        input.focus();
      }
    }

    // Track active generation batches for concurrent generation support
    let activeGenerationBatches = 0;

    function updateGenerateButtonState() {
      const btn = document.getElementById('generateBtn');
      const btnText = document.getElementById('generateText');

      if (activeGenerationBatches > 0) {
        btn.classList.add('generating');
        btnText.textContent = `⏳ ${activeGenerationBatches} generating...`;
        btn.disabled = false; // Keep enabled for more generations
      } else {
        btn.classList.remove('generating');
        updateImageGenerateButtonCost();
        btn.disabled = false;
      }
    }

    // Async Qwen generation that runs in background
    async function runQwenGeneration(placeholders, prompt, numOutputs, aspectRatio, resolution, capturedContentMode, costPerImage, batchId) {
      const btn = document.getElementById('generateBtn');
      const btnText = document.getElementById('generateText');

      // Capture NSFW flag at START of generation (not when response arrives)
      const isNsfwAtStart = capturedContentMode === 'nsfw' || NSFW_ONLY_MODELS.includes('qwen');
      const totalCost = costPerImage * numOutputs;

      try {
        // Get selected character/LoRA
        const loraValue = document.getElementById('qwenGenCharacter')?.value;
        const loras = [];
        let qwenPrompt = prompt;

        if (loraValue && loraValue !== 'none') {
          if (loraValue.endsWith('.safetensors')) {
            loras.push(loraValue);
          } else {
            const character = allMarketplaceCharacters.find(c => c.id === loraValue);
            if (character && character.lora_url) {
              loras.push(character.lora_url);
              if (character.trigger_word) {
                qwenPrompt = `${character.trigger_word} ${prompt}`;
              }
            }
          }
        }

        // Calculate pixel dimensions from aspect ratio and resolution
        const dimensions = getResolutionDimensions(aspectRatio, resolution);
        console.log('🎨 Qwen generation via ComfyUI:', { prompt: qwenPrompt, loras, numOutputs, batchId, dimensions });

        // Track generation started
        if (window.VxAnalytics && window.VxAnalytics.generation) {
          window.VxAnalytics.generation.started('qwen', { content_type: 'image', num_outputs: numOutputs });
        }

        // Reverse placeholders array so first generation fills the top placeholder
        const qwenPlaceholders = [...placeholders].reverse();

        // Loop through each generation request sequentially
        for (let genIndex = 0; genIndex < numOutputs; genIndex++) {
          console.log(`🎨 [Batch ${batchId}] Starting generation ${genIndex + 1} of ${numOutputs}`);

          // Submit job via backend proxy
          const submitResponse = await authFetch(`${API_BASE_URL}/api/qwen/generate`, {
            method: 'POST',
            body: JSON.stringify({
              prompt: qwenPrompt,
              loras,
              width: dimensions.width,
              height: dimensions.height
            })
          });

          if (!submitResponse.ok) {
            const errorData = await submitResponse.json().catch(() => ({}));

            // Check for moderation error - show modal if image was saved for appeal
            if (errorData.canAppeal && errorData.savedImageIds?.length > 0) {
              showModerationModal(errorData);
            }

            throw new Error(errorData.error || 'Failed to submit job to ComfyUI');
          }

          const submitData = await submitResponse.json();
          const jobId = submitData.job_id || submitData.jobId || submitData.id;

          if (!jobId) {
            throw new Error('No job ID returned from ComfyUI');
          }

          console.log(`📋 [Batch ${batchId}] ComfyUI job ${genIndex + 1} submitted:`, jobId);

          // Track job for persistence across tab switches
          activeGenerationJobs[jobId] = {
            status: 'pending',
            index: genIndex + 1,
            model: 'qwen',
            prompt: qwenPrompt,
            startTime: Date.now(),
            batchId
          };

          // Mark placeholder with job ID for recovery
          if (qwenPlaceholders[genIndex]) {
            qwenPlaceholders[genIndex].dataset.jobId = jobId;
          }

          saveGenerationState();

          // Poll for job completion
          const maxPolls = 300;
          let pollCount = 0;
          let jobComplete = false;
          let resultData = null;

          while (!jobComplete && pollCount < maxPolls) {
            const pollDelay = document.visibilityState === 'visible' ? 1000 : 3000;
            await new Promise(resolve => setTimeout(resolve, pollDelay));
            pollCount++;

            if (activeGenerationJobs[jobId]) {
              activeGenerationJobs[jobId].status = 'processing';
              activeGenerationJobs[jobId].pollCount = pollCount;
              saveGenerationState();
            }

            try {
              const statusResponse = await authFetch(`${API_BASE_URL}/api/qwen/status/${jobId}`);
              if (!statusResponse.ok) continue;

              const statusData = await statusResponse.json();
              if (pollCount % 10 === 0) {
                console.log(`⏳ [Batch ${batchId}] Gen ${genIndex + 1} Poll ${pollCount}: status =`, statusData.status || statusData.state);
              }

              if (statusData.status === 'completed' || statusData.state === 'completed' || statusData.status === 'success') {
                jobComplete = true;
                resultData = statusData;
              } else if (statusData.status === 'failed' || statusData.state === 'failed' || statusData.error) {
                delete activeGenerationJobs[jobId];
                saveGenerationState();
                throw new Error(statusData.error || 'ComfyUI generation failed');
              }
            } catch (fetchError) {
              console.warn('Poll fetch error:', fetchError.message);
            }
          }

          if (!jobComplete) {
            delete activeGenerationJobs[jobId];
            saveGenerationState();
            updatePlaceholderWithError(qwenPlaceholders[genIndex], `Generation ${genIndex + 1} timed out`);
            continue;
          }

          // Job completed - remove from tracking
          delete activeGenerationJobs[jobId];
          saveGenerationState();

          // Extract image from result
          let imageUrl = null;
          console.log(`🔍 [Batch ${batchId}] Result data keys:`, Object.keys(resultData));
          console.log(`🔍 [Batch ${batchId}] Full resultData:`, JSON.stringify(resultData).substring(0, 500));
          if (resultData.imageUrl) {
            // Backend already extracted and formatted the image URL
            imageUrl = resultData.imageUrl;
            console.log(`✅ [Batch ${batchId}] ComfyUI generation ${genIndex + 1} complete (imageUrl)`);
            console.log(`   imageUrl length: ${imageUrl.length}`);
            console.log(`   imageUrl preview: ${imageUrl.substring(0, 100)}`);
          } else if (resultData.images?.[0]) {
            imageUrl = resultData.images[0];
            console.log(`✅ [Batch ${batchId}] ComfyUI generation ${genIndex + 1} complete (images array)`);
          } else if (resultData.output?.message && typeof resultData.output.message === 'string') {
            // Fallback: handle raw base64 from output.message
            const base64Data = resultData.output.message;
            // Check if data already has prefix to avoid double-prefix
            imageUrl = base64Data.startsWith('data:') ? base64Data : `data:image/png;base64,${base64Data}`;
            console.log(`✅ [Batch ${batchId}] ComfyUI generation ${genIndex + 1} complete (output.message)`);
          } else if (resultData.output?.images?.[0]) {
            imageUrl = resultData.output.images[0];
            console.log(`✅ [Batch ${batchId}] ComfyUI generation ${genIndex + 1} complete (output.images)`);
          }

          if (!imageUrl) {
            console.error('No image in response:', resultData);
            updatePlaceholderWithError(qwenPlaceholders[genIndex], `Generation ${genIndex + 1} failed - no image`);
            continue;
          }

          // Process this image - use NSFW flag captured at start, not current mode
          const newImage = {
            url: imageUrl,
            model: 'qwen-comfyui',
            aspectRatio: aspectRatio,
            timestamp: Date.now() + genIndex,
            isNsfw: isNsfwAtStart
          };
          generatedImages.push(newImage);
          replacePlaceholderWithImage(qwenPlaceholders[genIndex], newImage);

          // Upload to Supabase Storage
          uploadImageToStorage(imageUrl, {
            prompt: qwenPrompt,
            model: 'qwen',
            isNsfw: isNsfwAtStart,
            aspectRatio: aspectRatio,
            resolution: resolution,
            creditsUsed: costPerImage
          }).then(storedUrl => {
            if (storedUrl) {
              newImage.storedUrl = storedUrl;
              console.log('📁 Image saved to permanent storage');
            }
          });
        }

        // Log generation for compliance
        logGeneration('image', 'qwen', qwenPrompt, isNsfwAtStart, numOutputs);
        console.log(`✅ [Batch ${batchId}] Qwen generation complete`);

        // Track generation completed
        if (window.VxAnalytics && window.VxAnalytics.generation) {
          window.VxAnalytics.generation.completed('qwen', { content_type: 'image', num_outputs: numOutputs });
        }

      } catch (error) {
        console.error(`❌ [Batch ${batchId}] Qwen generation error:`, error);
        showError(error.message || 'Generation failed');

        // Track generation failed
        if (window.VxAnalytics && window.VxAnalytics.generation) {
          window.VxAnalytics.generation.failed('qwen', error.message || 'Generation failed', { content_type: 'image' });
        }

        // Refund credits on failure
        await refundCredits(totalCost, `Qwen generation failed: ${error.message || 'Unknown error'}`);
      } finally {
        // Decrement batch counter and update button
        activeGenerationBatches--;
        clearGenerationState();
        updateGenerateButtonState();
      }
    }

    // Debounce tracking to prevent rapid double-clicks
    let lastImageGenClick = 0;
    let lastVideoGenClick = 0;
    const CLICK_DEBOUNCE_MS = 1000; // 1 second between clicks

    async function generateImages() {
      // Debounce rapid clicks (prevent accidental double-clicks)
      const now = Date.now();
      if (now - lastImageGenClick < CLICK_DEBOUNCE_MS) {
        console.log('⏳ Ignoring rapid click - please wait');
        return;
      }
      lastImageGenClick = now;

      // Show immediate visual feedback
      const btn = document.getElementById('generateBtn');
      const btnText = document.getElementById('generateText');
      const originalText = btnText.textContent;
      btnText.textContent = '⏳ Starting...';
      btn.disabled = true;

      // Helper to reset button on early return
      const resetButton = () => {
        btnText.textContent = originalText;
        btn.disabled = false;
      };

      // Check if user is logged in
      if (!isUserLoggedIn || !currentUser) {
        showLoginRequiredModal();
        resetButton();
        return;
      }

      // Verify session is still valid (prevents mid-generation expiry issues)
      const sessionValid = await checkSessionValid();
      if (!sessionValid) {
        alert('Your session has expired. Please log in again.');
        openSubscriptionPage();
        resetButton();
        return;
      }

      const prompt = document.getElementById('promptInput').value.trim();
      if (!prompt) {
        showError('Please enter a prompt first!');
        resetButton();
        return;
      }

      // Validate prompt for safe mode content restrictions
      const promptValidation = validatePromptForSafeMode(prompt);
      if (!promptValidation.valid) {
        showRestrictedContentError();
        resetButton();
        return;
      }

      // Calculate and check credits
      let aspectRatio, numOutputs, resolution, seedreamWidth, seedreamHeight;
      if (currentModel === 'qwen') {
        aspectRatio = document.getElementById('qwenGenAspectRatio')?.value || '1:1';
        numOutputs = parseInt(document.getElementById('qwenGenNumGenerations')?.value || 1);
        resolution = '1K'; // Qwen always uses 1K resolution
      } else if (currentModel === 'seedream') {
        // Seedream uses aspect ratio + resolution selectors
        aspectRatio = document.getElementById('seedreamAspectRatio')?.value || '1:1';
        resolution = document.getElementById('seedreamResolution')?.value || '2K';
        numOutputs = parseInt(document.getElementById('numGenerations')?.value || 1);
        // Get exact dimensions from resolution table
        const dims = getResolutionDimensions(aspectRatio, resolution);
        seedreamWidth = dims.width;
        seedreamHeight = dims.height;
      } else {
        // Nano Banana uses aspect ratio only
        aspectRatio = document.getElementById('aspectRatio')?.value || '1:1';
        numOutputs = parseInt(document.getElementById('numGenerations')?.value || 1);
        resolution = '1K'; // Nano Banana doesn't support resolution control
      }

      const costPerImage = calculateCreditCost('image', currentModel, { aspectRatio, resolution });
      const totalCost = costPerImage * numOutputs;

      if (!hasEnoughCredits(totalCost)) {
        showInsufficientCreditsError(totalCost);
        resetButton();
        return;
      }

      // Deduct credits before generation
      const deducted = await deductCredits(totalCost, `Image generation (${currentModel})`);
      if (!deducted) {
        showInsufficientCreditsError(totalCost);
        resetButton();
        return;
      }

      // Track this generation batch
      activeGenerationBatches++;
      const batchId = Date.now();

      // Show generating state - re-enable button for concurrent generations
      btn.classList.add('generating');
      btn.disabled = false;
      updateGenerateButtonState();

      // Clear placeholder if it's first generation (no images yet)
      const outputGrid = document.getElementById('outputGrid');
      const placeholder = outputGrid.querySelector('.output-placeholder');
      if (placeholder) {
        placeholder.remove();
      }

      // Clear any previous errors
      document.getElementById('errorContainer').innerHTML = '';

      // Create loading placeholders for each image (insert at top)
      const placeholders = [];
      for (let i = 0; i < numOutputs; i++) {
        const placeholderEl = createLoadingPlaceholder();
        placeholderEl.dataset.batchId = batchId;
        // Insert at the beginning so newest images appear at top
        outputGrid.insertBefore(placeholderEl, outputGrid.firstChild);
        placeholders.unshift(placeholderEl); // Add to beginning of array
      }

      // Capture model and NSFW flag at START of generation (before any async operations)
      const capturedModel = currentModel;
      const isNsfwAtStart = isNsfwContent(capturedModel);

      // For Qwen, run generation in background and return immediately
      if (capturedModel === 'qwen') {
        // Start Qwen generation asynchronously (non-blocking)
        runQwenGeneration(placeholders, prompt, numOutputs, aspectRatio, resolution, contentMode, costPerImage, batchId);
        return; // Return immediately - button is re-enabled
      }

      try {
        let endpoint, payload;

        if (capturedModel === 'seedream') {
          // Seedream: Use direct width/height from user input
          endpoint = `${API_BASE_URL}/api/seedream/generate`;
          payload = {
            prompt,
            width: seedreamWidth,
            height: seedreamHeight,
            numOutputs
          };
          console.log(`🌊 Seedream request: ${seedreamWidth}x${seedreamHeight}`);

          // Add reference images if any are uploaded
          if (referenceImages.length > 0) {
            payload.referenceImages = referenceImages.map(img => img.dataUrl);
          }
        } else {
          // Nano Banana Pro - only supports aspect ratio, not custom dimensions
          endpoint = `${API_BASE_URL}/api/nano-banana/generate`;
          payload = {
            prompt,
            aspectRatio: aspectRatio,
            numOutputs
          };
          console.log(`🍌 Nano Banana request: AR=${aspectRatio}`);

          // Add reference images if any are uploaded
          if (referenceImages.length > 0) {
            payload.referenceImages = referenceImages.map(img => img.dataUrl);
          }
        }

        console.log('Generating with:', { endpoint, payload });

        // Track generation started
        if (window.VxAnalytics && window.VxAnalytics.generation) {
          window.VxAnalytics.generation.started(capturedModel, { content_type: 'image', num_outputs: numOutputs });
        }

        // Add timeout to fetch request (2 minutes for image generation)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 120000); // 2 minute timeout

        const response = await authFetch(endpoint, {
          method: 'POST',
          body: JSON.stringify(payload),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        const data = await response.json();

        if (!response.ok) {
          // Check for content filter error with suggestion
          if (data.code === 'CONTENT_FILTER' && data.suggestion === 'seedream') {
            throw new Error('🚫 Content blocked by Nano Banana\'s safety filter. Switch to Seedream for this type of content.');
          }

          // Check for moderation error - show modal if image was saved for appeal
          if (data.canAppeal && data.savedImageIds?.length > 0) {
            // Get the first reference image to show in the modal (if available)
            const imagePreview = referenceImages.length > 0 ? referenceImages[0].dataUrl : null;
            showModerationModal(data, imagePreview);
          }

          throw new Error(data.message || data.error || 'Generation failed');
        }

        console.log('Generation successful:', data);

        // Log generation for 2257 compliance
        logGeneration('image', capturedModel, prompt, isNsfwAtStart, data.images?.length || 1);

        // Track generation completed
        if (window.VxAnalytics && window.VxAnalytics.generation) {
          window.VxAnalytics.generation.completed(capturedModel, { content_type: 'image', num_images: data.images?.length || 1 });
        }

        // Replace placeholders with actual images
        let imageIndex = 0;
        let warningIndex = 0;

        // Update each placeholder - first with successful images, then with failures
        for (let i = 0; i < numOutputs; i++) {
          if (imageIndex < data.images.length) {
            // This image succeeded - replace with actual image (use NSFW flag captured at start)
            const newImage = {
              url: data.images[imageIndex],
              model: data.model,
              aspectRatio: aspectRatio,
              timestamp: Date.now() + imageIndex,
              isNsfw: isNsfwAtStart
            };
            console.log('🔞 Image generated with NSFW flag:', isNsfwAtStart);
            generatedImages.push(newImage);
            replacePlaceholderWithImage(placeholders[i], newImage);

            // Upload to Supabase Storage (async, don't block UI)
            uploadImageToStorage(data.images[imageIndex], {
              prompt: prompt,
              model: capturedModel,
              aspectRatio: aspectRatio,
              resolution: resolution,
              creditsUsed: costPerImage,
              isNsfw: isNsfwAtStart
            }).then(storedUrl => {
              if (storedUrl) {
                newImage.storedUrl = storedUrl;
                console.log('📁 Image saved to permanent storage');
              }
            });
            imageIndex++;
          } else if (data.warnings && warningIndex < data.warnings.length) {
            // This image failed - show warning in placeholder
            updatePlaceholderWithError(placeholders[i], data.warnings[warningIndex]);
            warningIndex++;
          } else {
            // No image and no warning - unknown error
            updatePlaceholderWithError(placeholders[i], 'Generation failed - no response');
          }
        }

      } catch (error) {
        console.error('Generation failed:', error);

        // Handle timeout specifically
        let errorMessage = error.message || 'Failed to generate images';
        if (error.name === 'AbortError') {
          errorMessage = 'Request timed out - generation took too long';
        } else if (error.message?.includes('Failed to fetch')) {
          errorMessage = 'Connection failed - make sure the backend server is running';
        }

        // Refund credits on failure
        await refundCredits(totalCost, `Image generation failed: ${errorMessage}`);

        // Mark all placeholders as failed
        placeholders.forEach(placeholder => {
          updatePlaceholderWithError(placeholder, errorMessage);
        });
        showError(errorMessage);

        // Track generation failed
        if (window.VxAnalytics && window.VxAnalytics.generation) {
          window.VxAnalytics.generation.failed(capturedModel, errorMessage, { content_type: 'image' });
        }
      } finally {
        // Decrement batch counter and update button state
        activeGenerationBatches--;
        clearGenerationState();
        updateGenerateButtonState();
      }
    }

    function createLoadingPlaceholder() {
      const placeholderDiv = document.createElement('div');
      placeholderDiv.className = 'output-item';
      placeholderDiv.innerHTML = `
        <div class="output-placeholder-loading">
          <div class="loading-static-overlay"></div>
          <div class="loading-text">Generating...</div>
        </div>
      `;
      return placeholderDiv;
    }

    function updatePlaceholderWithError(placeholder, errorMessage) {
      placeholder.innerHTML = `
        <div class="output-placeholder-failed">
          <button class="failed-dismiss-btn" onclick="this.closest('.output-item').remove()" title="Dismiss">×</button>
          <div class="failed-icon">⚠️</div>
          <div class="failed-text">${errorMessage || 'Generation failed'}</div>
        </div>
      `;
    }

    function replacePlaceholderWithImage(placeholder, image) {
      // Set NSFW flag based on image metadata or current mode at generation time
      if (image.isNsfw) {
        placeholder.dataset.nsfw = 'true';
        console.log('🔞 Setting data-nsfw=true on placeholder');
      }
      // Store image data on placeholder for click handlers (avoids inline URL issues with base64)
      placeholder.dataset.imageUrl = image.url;
      placeholder.dataset.timestamp = image.timestamp;

      placeholder.innerHTML = `
        <div class="select-checkbox" onclick="toggleImageSelection(event, this)"></div>
        ${image.isNsfw ? '<span class="nsfw-badge">NSFW</span>' : ''}
        <img src="${image.url}" alt="Generated image" crossorigin="anonymous" onclick="showImageModal(this.src)" title="Click to view full size" loading="lazy">
        <div class="output-item-overlay">
          <div class="output-item-info">
            ${image.model} · ${image.aspectRatio || 'Square'}
          </div>
          <div class="output-item-actions">
            <button class="icon-btn" onclick="downloadImageFromParent(this)" title="Download">
              <svg class="download-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
            </button>
            <div class="send-to-container">
              <button class="icon-btn" onclick="toggleSendToMenu(event, this)" title="Send to...">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
              </button>
              <div class="send-to-menu">
                <button class="send-to-option" onclick="sendToVideoFromParent(this, event)">📹 Send to Video</button>
                <button class="send-to-option" onclick="sendToEditFromParent(this, event)">✂️ Send to Edit</button>
                <button class="send-to-option" onclick="sendToCaptionFromParent(this, event)">💬 Send to Caption</button>
                <button class="send-to-option" onclick="sendToInpaintFromParent(this, event)">🖌️ Send to Inpaint</button>
              </div>
            </div>
            <button class="report-btn" onclick="event.stopPropagation(); openReportModalFromParent(this)" title="Report">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                <line x1="4" y1="22" x2="4" y2="15"></line>
              </svg>
            </button>
          </div>
        </div>
      `;
    }

    function addImageToGrid(image) {
      const outputGrid = document.getElementById('outputGrid');

      const imageDiv = document.createElement('div');
      imageDiv.className = 'output-item';
      imageDiv.dataset.imageId = image.id || '';
      imageDiv.dataset.imageUrl = image.url;
      imageDiv.dataset.timestamp = image.timestamp;

      // Set NSFW flag if present
      if (image.isNsfw) {
        imageDiv.dataset.nsfw = 'true';
      }

      imageDiv.innerHTML = `
        <div class="select-checkbox" onclick="toggleImageSelection(event, this)"></div>
        ${image.isNsfw ? '<span class="nsfw-badge">NSFW</span>' : ''}
        <img src="${image.url}" alt="Generated image" crossorigin="anonymous" onclick="showImageModal(this.src)" title="Click to view full size" loading="lazy">
        <div class="output-item-overlay">
          <div class="output-item-info">
            ${image.model} · ${image.aspectRatio || 'Square'}
          </div>
          <div class="output-item-actions">
            <button class="icon-btn" onclick="downloadImageFromParent(this)" title="Download">
              <svg class="download-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
            </button>
            <div class="send-to-container">
              <button class="icon-btn" onclick="toggleSendToMenu(event, this)" title="Send to...">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
              </button>
              <div class="send-to-menu">
                <button class="send-to-option" onclick="sendToVideoFromParent(this, event)">📹 Send to Video</button>
                <button class="send-to-option" onclick="sendToEditFromParent(this, event)">✂️ Send to Edit</button>
                <button class="send-to-option" onclick="sendToCaptionFromParent(this, event)">💬 Send to Caption</button>
                <button class="send-to-option" onclick="sendToInpaintFromParent(this, event)">🖌️ Send to Inpaint</button>
              </div>
            </div>
            <button class="report-btn" onclick="event.stopPropagation(); openReportModalFromParent(this)" title="Report">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                <line x1="4" y1="22" x2="4" y2="15"></line>
              </svg>
            </button>
            <button class="icon-btn delete-btn" onclick="deleteImage(this.closest('.output-item'))" title="Delete">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
              </svg>
            </button>
          </div>
        </div>
      `;

      // Find first non-placeholder element to insert before
      // This prevents history images from being inserted above active generation placeholders
      const placeholders = outputGrid.querySelectorAll('.output-item .output-placeholder-loading, .output-item .output-placeholder-failed');
      if (placeholders.length > 0) {
        // Find the last placeholder's parent and insert after it
        const lastPlaceholder = placeholders[placeholders.length - 1].closest('.output-item');
        if (lastPlaceholder && lastPlaceholder.nextSibling) {
          outputGrid.insertBefore(imageDiv, lastPlaceholder.nextSibling);
        } else {
          outputGrid.appendChild(imageDiv);
        }
      } else {
        // No placeholders, insert at beginning
        outputGrid.insertBefore(imageDiv, outputGrid.firstChild);
      }
    }

    function downloadImage(url, timestamp) {
      fetch(url)
        .then(response => response.blob())
        .then(blob => {
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `vixxxen-${timestamp}.png`;
          link.click();
          URL.revokeObjectURL(link.href);
          // Track download for value moment analysis
          if (window.VxAnalytics && window.VxAnalytics.engagement) {
            window.VxAnalytics.engagement.downloaded('image');
          }
        })
        .catch(err => {
          console.error('Download failed:', err);
          showError('Failed to download image');
        });
    }

    // Helper functions that get URL from parent data attributes (avoids base64 in onclick)
    function getImageDataFromParent(element) {
      const container = element.closest('.output-item');
      return {
        url: container.dataset.imageUrl,
        timestamp: container.dataset.timestamp
      };
    }

    function downloadImageFromParent(element) {
      const data = getImageDataFromParent(element);
      downloadImage(data.url, data.timestamp);
    }

    function sendToVideoFromParent(element, event) {
      const data = getImageDataFromParent(element);
      sendToVideo(data.url, event);
    }

    function sendToEditFromParent(element, event) {
      const data = getImageDataFromParent(element);
      sendToEdit(data.url, event);
    }

    function sendToCaptionFromParent(element, event) {
      const data = getImageDataFromParent(element);
      sendToCaption(data.url, event);
    }

    function sendToInpaintFromParent(element, event) {
      const data = getImageDataFromParent(element);
      sendToInpaint(data.url, event);
    }

    function openReportModalFromParent(element) {
      const data = getImageDataFromParent(element);
      openReportModal('image', data.timestamp, data.url);
    }

    // Bulk selection functions moved to js/bulk-selection.js
    // deleteImage moved to js/delete-functions.js
    // Modal functions moved to js/modals.js

    // Toggle send-to dropdown menu
    function toggleSendToMenu(event, button) {
      event.stopPropagation();

      // Close all other open menus
      document.querySelectorAll('.send-to-menu.active').forEach(menu => {
        if (menu !== button.nextElementSibling) {
          menu.classList.remove('active');
        }
      });

      // Toggle this menu
      const menu = button.nextElementSibling;
      menu.classList.toggle('active');
    }

    // Close all send-to menus when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.send-to-container')) {
        document.querySelectorAll('.send-to-menu.active').forEach(menu => {
          menu.classList.remove('active');
        });
      }
    });

    // Send image to Video tab
    async function sendToVideo(imageUrl, event) {
      if (event) event.stopPropagation();

      console.log('sendToVideo called with:', imageUrl);

      // Close the menu
      document.querySelectorAll('.send-to-menu.active').forEach(menu => {
        menu.classList.remove('active');
      });

      // Convert URL to base64 if needed
      try {
        const response = await fetch(imageUrl);
        const blob = await response.blob();
        const reader = new FileReader();

        reader.onloadend = function() {
          videoStartImage = reader.result;

          // Switch to Video tab
          switchMainTab('video');

          // Update the preview
          updateVideoStartImagePreview();

          console.log('Image sent to Video tab successfully');
        };

        reader.readAsDataURL(blob);
      } catch (error) {
        console.error('Failed to send image to Video tab:', error);
        alert('Failed to send image to Video tab: ' + error.message);
      }
    }

    // Send image to Edit tab
    async function sendToEdit(imageUrl, event) {
      if (event) event.stopPropagation();

      console.log('sendToEdit called with:', imageUrl);

      // Close the menu
      document.querySelectorAll('.send-to-menu.active').forEach(menu => {
        menu.classList.remove('active');
      });

      // Convert URL to base64 if needed
      try {
        const response = await fetch(imageUrl);
        const blob = await response.blob();
        const reader = new FileReader();

        reader.onloadend = function() {
          editSourceImage = reader.result;

          // Switch to Edit tab
          switchMainTab('edit');

          // Show the image based on current tool
          if (currentEditTool === 'eraser') {
            loadImageToCanvas(editSourceImage);
          } else if (currentEditTool === 'crop') {
            document.getElementById('editImageUploadArea').style.display = 'none';
            initCropper(editSourceImage);
          } else {
            showImagePreview(editSourceImage);
          }

          console.log('Image sent to Edit tab successfully');
        };

        reader.readAsDataURL(blob);
      } catch (error) {
        console.error('Failed to send image to Edit tab:', error);
        alert('Failed to send image to Edit tab: ' + error.message);
      }
    }

    // Send image to Caption tab
    async function sendToCaption(imageUrl, event) {
      if (event) event.stopPropagation();

      console.log('sendToCaption called with:', imageUrl);

      // Close the menu
      document.querySelectorAll('.send-to-menu.active').forEach(menu => {
        menu.classList.remove('active');
      });

      // Convert URL to base64 if needed
      try {
        const response = await fetch(imageUrl);
        const blob = await response.blob();
        const reader = new FileReader();

        reader.onloadend = function() {
          captionImage = reader.result;

          // Switch to Caption tab
          switchMainTab('caption');

          // Add the image to the chat
          addCaptionMessage('user', null, captionImage);

          console.log('Image sent to Caption tab successfully');
        };

        reader.readAsDataURL(blob);
      } catch (error) {
        console.error('Failed to send image to Caption tab:', error);
        alert('Failed to send image to Caption tab: ' + error.message);
      }
    }

    // Escape key handler moved to js/modals.js
    // showError moved to js/utils.js

    // Keyboard shortcut: Ctrl/Cmd + Enter to generate
    document.getElementById('promptInput').addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        generateImages();
      }
    });

    // Keyboard shortcut for video prompt
    document.getElementById('videoPromptInput').addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        generateVideo();
      }
    });

    // User Area Functions
    let isUserLoggedIn = false;
    let userCredits = 1250;
    let userPlan = 'Pro Plan';

    // Credit System - Costs per operation (ready for Supabase integration)
    const CREDIT_COSTS = {
      // Image generation costs
      image: {
        'nano-banana': {
          base: 13,
          '1:1': 13,
          '16:9': 13,
          '9:16': 13,
          '4:3': 13,
          '3:4': 13
        },
        'seedream': {
          base: 6,
          '1K': 6,
          '2K': 6,
          '4K': 6
        },
        'flux': {
          base: 20,
          '1:1': 20,
          '16:9': 25,
          '9:16': 25,
          '4:3': 22,
          '3:4': 22
        },
        'qwen': {
          base: 6,
          '1:1': 6,
          '16:9': 6,
          '9:16': 6,
          '4:3': 6,
          '3:4': 6
        },
        'qwen-image-edit': 7
      },
      // Video generation costs (more expensive)
      video: {
        'kling': {
          '5s': 35,
          '10s': 70
        },
        'wan': {
          '5s': 40,
          '10s': 80
        },
        'veo': {
          '4s': 120,
          '8s': 120,
          '12s': 120
        }
      },
      // Editing costs
      edit: {
        'object-eraser': 4,
        'bg-remover': 1
      },
      // Caption/AI chat costs
      caption: {
        'grok-4': 3
      }
    };

    // Calculate credit cost for current operation
    function calculateCreditCost(type, model, options = {}) {
      try {
        if (type === 'image') {
          if (model === 'qwen-image-edit') {
            return CREDIT_COSTS.image[model];
          }
          const modelCosts = CREDIT_COSTS.image[model];
          if (!modelCosts) return 0;

          if (model === 'seedream') {
            return modelCosts[options.resolution || '2K'];
          } else {
            return modelCosts[options.aspectRatio || '1:1'];
          }
        } else if (type === 'video') {
          const modelCosts = CREDIT_COSTS.video[model];
          if (!modelCosts) return 0;
          return modelCosts[options.duration || '5s'];
        } else if (type === 'edit') {
          return CREDIT_COSTS.edit[model] || 0;
        } else if (type === 'caption') {
          return CREDIT_COSTS.caption[model] || 0;
        }
      } catch (error) {
        console.error('Error calculating credit cost:', error);
        return 0;
      }
      return 0;
    }

    // Deduct credits using Supabase
    async function deductCredits(amount, operation) {
      if (!isUserLoggedIn || !currentUser) {
        console.warn('User not logged in, cannot deduct credits');
        showLoginRequiredModal();
        return false; // Block operation - login required
      }

      if (userCredits < amount) {
        return false; // Not enough credits
      }

      try {
        // Call the Supabase function to deduct credits
        const { data, error } = await supabaseClient.rpc('deduct_credits', {
          p_user_id: currentUser.id,
          p_amount: amount,
          p_description: operation
        });

        if (error) {
          console.error('Error deducting credits:', error);
          return false;
        }

        if (data === false) {
          console.warn('Insufficient credits (server-side check)');
          return false;
        }

        // Update local state
        userCredits -= amount;
        updateCreditsDisplay();

        console.log(`💳 Deducted ${amount} credits for ${operation}. Remaining: ${userCredits}`);
        return true;

      } catch (err) {
        console.error('Error deducting credits:', err);
        return false;
      }
    }

    // Update credits display in UI
    function updateCreditsDisplay() {
      if (isUserLoggedIn) {
        document.getElementById('userCreditsDisplay').textContent = userCredits.toLocaleString();
        document.getElementById('userCreditsDetail').textContent = `${userCredits.toLocaleString()} Credits`;
      }
    }

    // Refund credits on failed generation
    async function refundCredits(amount, reason) {
      if (!isUserLoggedIn || !currentUser) {
        console.warn('User not logged in, skipping credit refund');
        return true;
      }

      try {
        // Call the Supabase function to add credits back
        const { data, error } = await supabaseClient.rpc('add_credits', {
          p_user_id: currentUser.id,
          p_amount: amount,
          p_description: `Refund: ${reason}`
        });

        if (error) {
          console.error('Error refunding credits:', error);
          return false;
        }

        // Update local state
        userCredits += amount;
        updateCreditsDisplay();

        console.log(`💳 Refunded ${amount} credits (${reason}). Balance: ${userCredits}`);
        return true;

      } catch (err) {
        console.error('Error refunding credits:', err);
        return false;
      }
    }

    // Check if user has enough credits (requires login)
    function hasEnoughCredits(amount) {
      if (!isUserLoggedIn) {
        showLoginRequiredModal();
        return false; // Block - login required
      }
      return userCredits >= amount;
    }

    // Show insufficient credits error and auto-redirect
    function showInsufficientCreditsError(required) {
      // Check if user has a subscription (not free plan)
      const hasSubscription = userPlan && !userPlan.toLowerCase().includes('free');

      if (hasSubscription) {
        // User has subscription - redirect to buy credits
        alert(`Insufficient credits! This operation requires ${required} credits, but you only have ${userCredits}.\n\nRedirecting to purchase more credits...`);
        openBillingPage();
      } else {
        // No subscription - redirect to subscription page
        alert(`Insufficient credits! This operation requires ${required} credits, but you only have ${userCredits}.\n\nRedirecting to subscription plans...`);
        openSubscriptionPage();
      }
    }

    // Update button text to show credit costs
    function updateImageGenerateButtonCost() {
      let aspectRatio, resolution, numOutputs;

      // Get settings based on current model
      if (currentModel === 'flux') {
        aspectRatio = document.getElementById('fluxAspectRatio')?.value || '1:1';
        numOutputs = parseInt(document.getElementById('fluxNumGenerations')?.value || 1);
        resolution = '2K'; // Default for cost calculation
      } else if (currentModel === 'qwen') {
        aspectRatio = document.getElementById('qwenGenAspectRatio')?.value || '1:1';
        numOutputs = parseInt(document.getElementById('qwenGenNumGenerations')?.value || 1);
        resolution = '2K'; // Default for cost calculation
      } else if (currentModel === 'qwen-image-edit') {
        aspectRatio = document.getElementById('qwenAspectRatio')?.value || '1:1';
        numOutputs = 1; // Qwen Image Edit only generates 1 image
        resolution = '2K'; // Default for cost calculation
      } else if (currentModel === 'seedream') {
        // Seedream uses its own aspect ratio and resolution selectors
        aspectRatio = document.getElementById('seedreamAspectRatio')?.value || '1:1';
        resolution = document.getElementById('seedreamResolution')?.value || '2K';
        numOutputs = parseInt(document.getElementById('numGenerations')?.value || 1);
      } else {
        // Nano Banana uses standard aspect ratio only
        aspectRatio = document.getElementById('aspectRatio')?.value || '1:1';
        resolution = '1K'; // Nano Banana is always 1K
        numOutputs = parseInt(document.getElementById('numGenerations')?.value || 1);
      }

      const costPerImage = calculateCreditCost('image', currentModel, {
        aspectRatio,
        resolution
      });
      const totalCost = costPerImage * numOutputs;

      const btnText = document.getElementById('generateText');
      if (btnText && !isGenerating) {
        btnText.textContent = `⚡ Generate (${totalCost} credits)`;
      }
    }

    function updateVideoGenerateButtonCost() {
      let duration;

      if (currentVideoModel === 'kling') {
        const durationValue = document.getElementById('videoDuration')?.value || '5';
        duration = durationValue + 's';
      } else if (currentVideoModel === 'wan') {
        // Wan uses frames and fps to calculate duration
        const numFrames = parseInt(document.getElementById('wanNumFrames')?.value || 81);
        const fps = parseInt(document.getElementById('wanFps')?.value || 8);
        const seconds = Math.round(numFrames / fps);
        duration = seconds + 's';
      } else if (currentVideoModel === 'veo') {
        const durationValue = document.getElementById('veoDuration')?.value || '8';
        duration = durationValue + 's';
      }

      const cost = calculateCreditCost('video', currentVideoModel, { duration });

      const btnText = document.getElementById('videoGenerateText');
      if (btnText && !isGeneratingVideo) {
        btnText.textContent = `🎬 Generate Video (${cost} credits)`;
      }
    }

    function updateEditButtonCost() {
      const cost = calculateCreditCost('edit', currentEditTool === 'eraser' ? 'object-eraser' : 'bg-remover');

      const btnText = document.getElementById('editActionText');
      if (btnText && !isErasing) {
        if (currentEditTool === 'eraser') {
          btnText.textContent = `✨ Remove Object (${cost} credits)`;
        } else {
          btnText.textContent = `🎨 Remove Background (${cost} credits)`;
        }
      }
    }

    // Note: Theme toggle functions are in js/theme.js
    // Note: Payment modal functions are in js/payment-modals.js

    function toggleUserMenu() {
      const userMenu = document.getElementById('userMenu');

      if (!isUserLoggedIn) {
        openLoginModal();
        return;
      }

      // Close all send-to menus if any are open
      document.querySelectorAll('.send-to-menu.active').forEach(menu => {
        menu.classList.remove('active');
      });

      userMenu.classList.toggle('active');
    }

    // Close user menu when clicking outside
    document.addEventListener('click', function(e) {
      const userMenu = document.getElementById('userMenu');
      const userAvatar = document.getElementById('userAvatar');

      if (!userMenu.contains(e.target) && !userAvatar.contains(e.target)) {
        userMenu.classList.remove('active');
      }
    });

    function openLoginModal() {
      document.getElementById('loginModal').classList.add('active');
    }

    // Show login required modal with message
    // Now shows the onboarding wizard for new users
    function showLoginRequiredModal() {
      // Check if onboarding wizard is initialized
      if (typeof showOnboardingWizard === 'function' && typeof isWizardReady === 'function' && isWizardReady()) {
        showOnboardingWizard('create_account');
        return;
      }

      // Fallback: Initialize onboarding and then show wizard
      if (typeof initializeOnboarding === 'function') {
        initializeOnboarding().then(() => {
          if (typeof showOnboardingWizard === 'function') {
            showOnboardingWizard('create_account');
          } else {
            openLoginModal();
          }
        }).catch(() => {
          openLoginModal();
        });
        return;
      }

      // Ultimate fallback: show regular login modal
      openLoginModal();
    }

    // Show the traditional login modal (for returning users)
    function showLoginModal() {
      openLoginModal();
    }

    function closeLoginModal() {
      document.getElementById('loginModal').classList.remove('active');

      // If user is not logged in and came from landing page, restore landing page view
      if (!currentUser) {
        const landingPage = document.getElementById('landingPage');
        const container = document.querySelector('.container');
        if (landingPage) {
          landingPage.style.display = 'block';
          // Enable scrolling on body for landing page
          document.body.style.overflow = 'auto';
          document.body.style.height = 'auto';
        }
        if (container) {
          container.style.display = 'none';
        }
      }
    }

    async function handleGoogleSignIn() {
      const btn = document.querySelector('.google-signin-btn');
      const originalContent = btn.innerHTML;
      btn.innerHTML = '<span>Connecting...</span>';
      btn.disabled = true;

      try {
        const { data, error } = await supabaseClient.auth.signInWithOAuth({
          provider: 'google',
          options: {
            redirectTo: window.location.origin
          }
        });

        if (error) {
          console.error('Google sign-in error:', error);
          alert('Failed to connect with Google: ' + error.message);
          btn.innerHTML = originalContent;
          btn.disabled = false;
        }
        // If successful, user will be redirected to Google
      } catch (err) {
        console.error('Google sign-in error:', err);
        alert('An error occurred during Google sign-in');
        btn.innerHTML = originalContent;
        btn.disabled = false;
      }
    }

    async function handleLogin() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      if (!email || !password) {
        alert('Please enter both email and password');
        return;
      }

      // Show loading state
      const loginBtn = document.querySelector('#loginModal button[onclick="handleLogin()"]');
      const originalText = loginBtn.textContent;
      loginBtn.textContent = 'Signing in...';
      loginBtn.disabled = true;

      try {
        console.log('🔐 Attempting login for:', email);

        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email,
          password
        });

        console.log('🔐 Login response:', { data, error });

        if (error) {
          console.log('🔐 Login error:', error.message);

          // If user doesn't exist, offer to sign up
          // Check for various error message formats
          const isInvalidCredentials =
            error.message.includes('Invalid login credentials') ||
            error.message.includes('invalid') ||
            error.message.includes('not found') ||
            error.message.includes('No user');

          if (isInvalidCredentials) {
            const signUp = confirm('Account not found. Would you like to create a new account with this email?');
            if (signUp) {
              await handleSignUp(email, password);
            }
          } else {
            alert('Login error: ' + error.message);
          }
          return;
        }

        // Login successful - session will be handled by onAuthStateChange
        closeLoginModal();
        console.log('✅ Logged in as:', email);

      } catch (err) {
        console.error('Login error:', err);
        alert('An error occurred during login');
      } finally {
        loginBtn.textContent = originalText;
        loginBtn.disabled = false;
      }
    }

    async function handleSignUp(email, password) {
      try {
        const { data, error } = await supabaseClient.auth.signUp({
          email,
          password
        });

        if (error) {
          alert('Sign up error: ' + error.message);
          return;
        }

        if (data.user && !data.session) {
          alert('Please check your email to confirm your account!');
        } else {
          // Auto-confirmed (if email confirmation is disabled)
          closeLoginModal();
          console.log('✅ Account created and logged in as:', email);

          // Send welcome email (async, don't wait for it)
          try {
            authFetch(`${API_BASE_URL}/api/email/welcome`, { method: 'POST' })
              .then(res => {
                if (res.ok) console.log('📧 Welcome email sent');
              })
              .catch(err => console.log('📧 Welcome email skipped:', err.message));
          } catch (e) {
            // Ignore email errors - non-critical
          }

          // Start the onboarding wizard for new users (skip account creation step)
          if (typeof initializeOnboarding === 'function') {
            initializeOnboarding().then(() => {
              if (typeof showOnboardingWizard === 'function') {
                showOnboardingWizard();
                // Skip to character selection (step 1) since account already created
                if (typeof startWizardAtStep === 'function') {
                  startWizardAtStep(1);
                }
              }
            }).catch(err => {
              console.warn('Could not start onboarding wizard:', err);
            });
          }
        }
      } catch (err) {
        console.error('Sign up error:', err);
        alert('An error occurred during sign up');
      }
    }

    // Handle Google OAuth Sign-In (works for both login and signup)
    async function handleGoogleSignIn() {
      const googleBtn = document.querySelector('.google-signin-btn');
      const originalHTML = googleBtn.innerHTML;
      googleBtn.innerHTML = '<span class="loading-spinner-small"></span> Connecting...';
      googleBtn.disabled = true;

      try {
        const { data, error } = await supabaseClient.auth.signInWithOAuth({
          provider: 'google',
          options: {
            redirectTo: window.location.origin,
            queryParams: {
              access_type: 'offline',
              prompt: 'consent'
            }
          }
        });

        if (error) {
          console.error('Google sign-in error:', error);
          alert('Google sign-in failed: ' + error.message);
          googleBtn.innerHTML = originalHTML;
          googleBtn.disabled = false;
          return;
        }

        // If we get here, Supabase will redirect to Google
        // The auth state change listener will handle the rest after redirect back
        console.log('🔄 Redirecting to Google for authentication...');

      } catch (err) {
        console.error('Google sign-in error:', err);
        alert('An error occurred during Google sign-in');
        googleBtn.innerHTML = originalHTML;
        googleBtn.disabled = false;
      }
    }

    // Handle signup from the modal directly
    async function handleSignUpFromModal() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      if (!email || !password) {
        alert('Please enter both email and password');
        return;
      }

      if (password.length < 6) {
        alert('Password must be at least 6 characters');
        return;
      }

      // Show loading state
      const signupBtn = document.querySelector('#loginModal button[onclick="handleSignUpFromModal()"]');
      const originalText = signupBtn.textContent;
      signupBtn.textContent = 'Creating...';
      signupBtn.disabled = true;

      try {
        await handleSignUp(email, password);
      } finally {
        signupBtn.textContent = originalText;
        signupBtn.disabled = false;
      }
    }

    async function handleLogout() {
      try {
        const { error } = await supabaseClient.auth.signOut();
        // Ignore "session missing" errors - user is already logged out
        if (error && !error.message?.includes('session')) {
          throw error;
        }
      } catch (err) {
        // Only log non-session errors, don't alert for expected cases
        if (!err.message?.includes('session')) {
          console.error('Logout error:', err);
        }
      }

      // Always reset local state regardless of signOut result
      isUserLoggedIn = false;
      currentUser = null;
      userCredits = 0;
      ownedCharacters = ['aika', 'jessica', 'alexis']; // Reset to defaults

      // Reset wizard state so next user starts fresh
      if (typeof resetWizard === 'function') {
        resetWizard();
      }

      // Reset UI (with null checks)
      const userAvatar = document.getElementById('userAvatar');
      const userStatusDot = document.getElementById('userStatusDot');
      const userCreditsDisplay = document.getElementById('userCreditsDisplay');
      const userMenu = document.getElementById('userMenu');

      if (userAvatar) userAvatar.classList.add('logged-out');
      if (userStatusDot) userStatusDot.style.display = 'none';
      if (userCreditsDisplay) userCreditsDisplay.textContent = 'Login';
      if (userMenu) userMenu.classList.remove('active');

      // Clear login form
      document.getElementById('loginEmail').value = '';
      document.getElementById('loginPassword').value = '';

      // Update dropdowns
      updateCharacterDropdowns();

      console.log('👋 Logged out');

      // Force page reload to ensure clean state
      window.location.reload();
    }

    // Load user profile data from Supabase (with optional bootstrap optimization)
    async function loadUserProfile(userId) {
      console.log('📊 Loading profile for user:', userId);
      try {
        // Try bootstrap endpoint first for faster loading (uses JWT auth, not URL param)
        try {
          console.log('📊 Calling bootstrap endpoint...');
          const response = await authFetch(`${API_BASE_URL}/api/resources/bootstrap`);
          console.log('📊 Bootstrap response status:', response.status);
          if (response.ok) {
            const data = await response.json();
            console.log('📊 Bootstrap data received:', data);

            userCredits = data.profile.credits || 0;
            userPlan = data.plan || 'Free Plan';
            ownedCharacters = data.characters || [];

            document.getElementById('userName').textContent = data.profile.full_name || data.profile.email?.split('@')[0] || 'User';
            document.getElementById('userEmail').textContent = data.profile.email;
            document.getElementById('userSubscription').textContent = userPlan;
            updateCreditsDisplay();
            updateCharacterDropdowns();
            renderMarketplace();

            const userMenuAvatar = document.querySelector('.user-avatar');
            if (userMenuAvatar && data.profile.avatar_url) {
              userMenuAvatar.innerHTML = `<img src="${data.profile.avatar_url}" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
            } else if (userMenuAvatar) {
              const name = data.profile.full_name || data.profile.email || 'U';
              userMenuAvatar.textContent = name.charAt(0).toUpperCase();
            }

            console.log('📊 Profile loaded:', { credits: userCredits, plan: userPlan, characters: ownedCharacters });

            // Merge profile data into currentUser for chat and other features
            if (currentUser) {
              currentUser.display_name = data.profile.display_name;
              currentUser.full_name = data.profile.full_name;
              currentUser.avatar_url = data.profile.avatar_url;
            }

            // Load history in parallel
            Promise.all([
              displayImageHistory().catch(err => console.warn('📁 Could not load image history:', err.message)),
              displayVideoHistory().catch(err => console.warn('🎬 Could not load video history:', err.message)),
              displayEditHistory().catch(err => console.warn('✂️ Could not load edit history:', err.message))
            ]);

            return; // Success - exit early
          } else {
            // Log the error response for debugging
            const errorText = await response.text().catch(() => 'Could not read error response');
            console.warn('📊 Bootstrap returned error:', response.status, errorText);
          }
        } catch (bootstrapErr) {
          console.warn('📊 Bootstrap unavailable, using direct queries:', bootstrapErr.message);
        }

        // Fallback: Direct Supabase queries
        console.log('📊 Fetching profile from database...');
        const { data: profile, error: profileError } = await supabaseClient
          .from('profiles')
          .select('*')
          .eq('id', userId)
          .single();

        if (profileError) throw profileError;
        console.log('📊 Profile fetched:', profile);

        const { data: characters } = await supabaseClient
          .from('user_characters')
          .select('character_id')
          .eq('user_id', userId);

        const { data: membership } = await supabaseClient
          .from('memberships')
          .select('tier, is_active')
          .eq('user_id', userId)
          .single();

        userCredits = profile.credits || 0;
        if (membership && membership.is_active && membership.tier) {
          const tierNames = { 'rising_star': 'Rising Star', 'supernova': 'Supernova', 'mentorship': 'Mentorship' };
          userPlan = tierNames[membership.tier] || membership.tier.charAt(0).toUpperCase() + membership.tier.slice(1);
        } else {
          userPlan = profile.plan ? profile.plan.charAt(0).toUpperCase() + profile.plan.slice(1) + ' Plan' : 'Free Plan';
        }
        ownedCharacters = (characters || []).map(c => c.character_id);

        document.getElementById('userName').textContent = profile.full_name || profile.email?.split('@')[0] || 'User';
        document.getElementById('userEmail').textContent = profile.email;
        document.getElementById('userSubscription').textContent = userPlan;
        updateCreditsDisplay();
        updateCharacterDropdowns();
        renderMarketplace();

        const userMenuAvatar = document.querySelector('.user-avatar');
        if (userMenuAvatar && profile.avatar_url) {
          userMenuAvatar.innerHTML = `<img src="${profile.avatar_url}" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
        } else if (userMenuAvatar) {
          const name = profile.full_name || profile.email || 'U';
          userMenuAvatar.textContent = name.charAt(0).toUpperCase();
        }

        console.log('📊 Profile loaded:', { credits: userCredits, plan: userPlan, characters: ownedCharacters });

        // Merge profile data into currentUser for chat and other features
        if (currentUser) {
          currentUser.display_name = profile.display_name;
          currentUser.full_name = profile.full_name;
          currentUser.avatar_url = profile.avatar_url;
        }

        // Load history
        try { await displayImageHistory(); } catch (e) { console.warn('📁 Could not load image history:', e.message); }
        try { await displayVideoHistory(); } catch (e) { console.warn('🎬 Could not load video history:', e.message); }
        try { await displayEditHistory(); } catch (e) { console.warn('✂️ Could not load edit history:', e.message); }

      } catch (err) {
        console.error('❌ Error loading profile:', err);
      }
    }

    // Listen for auth state changes
    supabaseClient.auth.onAuthStateChange(async (event, session) => {
      console.log('🔐 Auth state changed:', event, 'Session:', session ? 'exists' : 'null');

      // Cache the session immediately for use by authFetch (avoids race condition)
      setCachedSession(session);

      if (session?.user) {
        console.log('🔐 User found in session:', session.user.email);
        currentUser = session.user;
        isUserLoggedIn = true;

        // Preload characters in background (starts fetching while profile loads)
        if (typeof preloadCharacters === 'function') {
          preloadCharacters();
        }

        // Update UI to logged in state (with null checks)
        console.log('🔐 Updating UI to logged in state...');
        const userAvatar = document.getElementById('userAvatar');
        const userStatusDot = document.getElementById('userStatusDot');
        if (userAvatar) userAvatar.classList.remove('logged-out');
        if (userStatusDot) userStatusDot.style.display = 'block';

        // Load user profile data
        console.log('🔐 Calling loadUserProfile...');
        try {
          await loadUserProfile(session.user.id);
          console.log('🔐 loadUserProfile completed');

          // Check for prompts/reminders after profile load
          if (typeof checkAndShowPrompts === 'function') {
            setTimeout(() => checkAndShowPrompts(), 2000);
          }
        } catch (err) {
          console.error('🔐 loadUserProfile failed:', err);
        }

        // Reload marketplace with user's ownership data and admin status (will use preloaded cache)
        loadMarketplaceCharacters();

        // Hide landing page and show main app when logged in
        if (typeof hideLandingPage === 'function') {
          hideLandingPage();
        }
      } else {
        console.log('🔐 No user in session, logging out...');

        // Reset wizard state for fresh start
        if (typeof resetWizard === 'function') {
          resetWizard();
        }

        // Check if there were active generations - warn user
        const hadActiveGenerations = Object.keys(activeGenerationJobs).length > 0 ||
                                      isGenerating || isGeneratingVideo;

        if (hadActiveGenerations) {
          console.warn('⚠️ Session expired during active generation');
          alert('Your session has expired. Any in-progress generations may not be saved. Please log in again.');
          // Clear generation state since user is logged out
          activeGenerationJobs = {};
          isGenerating = false;
          isGeneratingVideo = false;
          clearGenerationState();
        }

        currentUser = null;
        isUserLoggedIn = false;
        userCredits = 0;

        // Update UI to logged out state (with null checks)
        const userAvatar = document.getElementById('userAvatar');
        const userStatusDot = document.getElementById('userStatusDot');
        const userCreditsDisplay = document.getElementById('userCreditsDisplay');

        if (userAvatar) userAvatar.classList.add('logged-out');
        if (userStatusDot) userStatusDot.style.display = 'none';
        if (userCreditsDisplay) userCreditsDisplay.textContent = 'Login';

        // Reload marketplace to hide admin controls and reset ownership
        loadMarketplaceCharacters();

        // Show landing page when logged out
        if (typeof initLandingPage === 'function') {
          initLandingPage();
        }
      }
    });

    // Open subscription page
    function openSubscriptionPage() {
      // Close user menu
      document.getElementById('userMenu').classList.remove('active');

      // Hide all tab sections
      document.querySelectorAll('.tab-section').forEach(section => {
        section.classList.remove('active');
      });

      // Deactivate all nav tabs
      document.querySelectorAll('.nav-tab').forEach(navTab => {
        navTab.classList.remove('active');
      });

      // Show subscription page
      document.getElementById('subscriptionSection').classList.add('active');

      console.log('📋 Opened subscription page');
    }

    // Handle plan selection (ready for CCBill integration)
    async function selectPlan(plan, price) {
      console.log(`Selected plan: ${plan} at $${price}/mo`);

      if (!currentUser) {
        alert('Please log in first to subscribe.');
        return;
      }

      const planNames = {
        'starter': 'Starter Plan',
        'creator': 'Creator Plan',
        'pro': 'Pro Plan'
      };

      const credits = {
        'starter': '1,000',
        'creator': '3,000',
        'pro': '6,500'
      };

      if (!confirm(`Subscribe to ${planNames[plan]}?\n\nPrice: $${price}/month\nCredits: ${credits[plan]} per month\n\nYou'll be redirected to pay with cryptocurrency.`)) {
        return;
      }

      try {
        // Uses JWT auth - userId extracted from token on server
        const response = await authFetch(`${API_BASE_URL}/api/payments/create-charge`, {
          method: 'POST',
          body: JSON.stringify({ tier: plan })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Failed to create payment');

        window.location.href = data.invoice_url;
      } catch (error) {
        console.error('Payment error:', error);
        alert('Failed to create payment. Please try again.');
      }
    }

    async function purchaseCredits(credits, price) {
      console.log(`Purchase ${credits} credits for $${price}`);

      if (!currentUser) {
        alert('Please log in first to purchase credits.');
        return;
      }

      if (!confirm(`Purchase ${credits.toLocaleString()} credits for $${price}?\n\nYou'll be redirected to pay with cryptocurrency.`)) {
        return;
      }

      try {
        // Uses JWT auth - userId extracted from token on server
        const response = await authFetch(`${API_BASE_URL}/api/payments/create-charge`, {
          method: 'POST',
          body: JSON.stringify({
            tier: `credits_${credits}`,
            credits: credits,
            price: price
          })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Failed to create payment');

        window.location.href = data.invoice_url;
      } catch (error) {
        console.error('Payment error:', error);
        alert('Failed to create payment. Please try again.');
      }
    }

    // Account page functions moved to js/account-page.js
    // Billing page functions moved to js/billing-page.js

    // Marketplace Functions
    let ownedCharacters = []; // Will be populated from API based on user ownership
    let currentCharacterModal = null;
    let allMarketplaceCharacters = []; // Will be loaded from API

    // Load marketplace characters from API (with client-side caching)
    async function loadMarketplaceCharacters(forceRefresh = false) {
      try {
        const userId = currentUser?.id;
        const isAdmin = userId && await checkIfUserIsAdmin(userId);

        // Check client cache first (unless force refresh)
        let rawCharacters = null;
        if (!forceRefresh && typeof getCachedCharactersClient === 'function') {
          rawCharacters = getCachedCharactersClient('marketplace');
        }

        // Fetch from API if no cache
        if (!rawCharacters) {
          // Marketplace always uses the public endpoint (shows only listed characters)
          // Admins can manage all characters in the Admin > Characters section
          const endpoint = `${API_BASE_URL}/api/characters`;

          const response = await authFetch(endpoint);
          if (!response.ok) throw new Error('Failed to fetch characters');

          const data = await response.json();
          rawCharacters = data.characters;

          // Update cache
          if (typeof setCachedCharactersClient === 'function') {
            setCachedCharactersClient('marketplace', rawCharacters);
          }
        }

        // Process characters for display
        allMarketplaceCharacters = rawCharacters.map(char => ({
          id: char.id,
          name: char.name,
          category: char.category,
          description: char.description || '',
          price: parseFloat(char.price) || 0,
          rating: parseFloat(char.rating) || 5.0,
          purchases: char.purchases || 0,
          tags: char.tags || [],
          image: char.image_url || generatePlaceholderImage(char.name),
          galleryImages: char.gallery_images || [],
          lora_url: char.lora_url,
          trigger_word: char.trigger_word,
          is_active: char.is_active,
          sort_order: char.sort_order,
          is_owned: char.is_owned || false
        }));

        // Update owned characters list
        ownedCharacters = allMarketplaceCharacters
          .filter(c => c.is_owned)
          .map(c => c.id);

        // Show admin button if user is admin
        const adminBtn = document.getElementById('adminCharacterBtn');
        if (adminBtn) {
          adminBtn.style.display = isAdmin ? 'flex' : 'none';
        }

        // Update global isUserAdmin before calling updateCharacterDropdowns
        isUserAdmin = isAdmin;
        window.isUserAdmin = isAdmin; // Expose for analytics tracking

        renderMarketplace();
        updateCharacterDropdowns();

        // Debug: log characters with lora_url
        const charsWithLora = allMarketplaceCharacters.filter(c => c.lora_url);
        console.log('🛍️ Marketplace loaded with', allMarketplaceCharacters.length, 'characters');
        console.log('🎭 Characters with lora_url:', charsWithLora.map(c => `${c.name}: ${c.lora_url}`));
        console.log('👤 isUserAdmin:', isUserAdmin, '| ownedCharacters:', ownedCharacters);
      } catch (error) {
        console.error('Error loading marketplace characters:', error);
        // Fallback to empty array
        allMarketplaceCharacters = [];
        renderMarketplace();
      }
    }

    // Helper function to generate placeholder image
    function generatePlaceholderImage(name) {
      const colors = ['#ff2ebb', '#00b2ff', '#ff00ff', '#00cc88', '#9966ff', '#ff6600', '#ff99cc', '#333333'];
      const color = colors[Math.abs(name.charCodeAt(0)) % colors.length];
      return `data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="280" height="280"%3E%3Crect fill="${encodeURIComponent(color)}" width="280" height="280"/%3E%3Ctext x="50%25" y="50%25" font-size="50" fill="white" text-anchor="middle" dy=".3em"%3E${encodeURIComponent(name.charAt(0))}%3C/text%3E%3C/svg%3E`;
    }

    // Helper to check admin status for marketplace
    async function checkIfUserIsAdmin(userId) {
      if (!userId) return false;
      try {
        const { data: profile } = await supabaseClient
          .from('profiles')
          .select('role')
          .eq('id', userId)
          .single();
        return profile?.role === 'admin';
      } catch (e) {
        return false;
      }
    }

    function renderMarketplace() {
      const grid = document.getElementById('marketplaceGrid');
      grid.innerHTML = '';

      const showAdminControls = document.getElementById('adminCharacterBtn')?.style.display === 'flex';

      // Add Custom Character Commission Card (first item)
      const customCard = document.createElement('div');
      customCard.className = 'character-card custom-commission-card';
      customCard.style.position = 'relative';
      customCard.onclick = () => {
        if (typeof openCustomCharacterOrderModal === 'function') {
          openCustomCharacterOrderModal();
        } else {
          alert('Custom character orders are not available at the moment.');
        }
      };
      customCard.innerHTML = `
        <div class="custom-commission-image">
          <span class="custom-commission-icon">🎨</span>
          <span class="custom-commission-label">Custom</span>
        </div>
        <div class="character-info">
          <div class="character-name">Create Your Own</div>
          <div class="character-category">Commission a custom AI character</div>
          <div class="character-footer">
            <div>
              <div class="character-price" style="color: #4ade80;">From $795</div>
              <div class="character-price-label">3-5 days delivery</div>
            </div>
            <button class="character-buy-btn" style="background: linear-gradient(135deg, #9d4edd, #ff2ebb);">
              Design Now
            </button>
          </div>
        </div>
      `;
      grid.appendChild(customCard);

      allMarketplaceCharacters.forEach(character => {
        const isOwned = ownedCharacters.includes(character.id);
        const card = document.createElement('div');
        card.className = 'character-card';
        card.style.position = 'relative';
        card.onclick = () => openCharacterModal(character);

        // Add inactive badge for admins
        const inactiveBadge = !character.is_active && showAdminControls
          ? '<div style="position: absolute; top: 8px; left: 8px; background: #ff4444; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; z-index: 5;">INACTIVE</div>'
          : '';

        // Add edit button for admins
        const editButton = showAdminControls
          ? `<button class="starthere-edit-btn" onclick="event.stopPropagation(); editCharacter('${character.id}')" style="position: absolute; top: 8px; right: 8px; z-index: 5;">✏️</button>`
          : '';

        card.innerHTML = `
          ${inactiveBadge}
          ${editButton}
          <img src="${character.image}" alt="${character.name}" class="character-image" loading="lazy">
          <div class="character-info">
            <div class="character-name">${character.name}</div>
            <div class="character-category">${character.category}</div>
            <div class="character-footer">
              <div>
                <div class="character-price">${isOwned ? 'Owned' : (character.price === 0 ? 'Free' : '$' + character.price.toFixed(2))}</div>
                ${!isOwned && character.price > 0 ? '<div class="character-price-label">one-time</div>' : ''}
              </div>
              <button class="character-buy-btn ${isOwned ? 'owned' : ''}" onclick="event.stopPropagation(); ${isOwned ? '' : 'openCharacterModal(' + JSON.stringify(character).replace(/"/g, '&quot;') + ')'}">
                ${isOwned ? '✓ Owned' : 'Buy Now'}
              </button>
            </div>
          </div>
        `;

        grid.appendChild(card);
      });

      // Show empty state if no characters
      if (allMarketplaceCharacters.length === 0) {
        grid.innerHTML = `
          <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: #666;">
            <div style="font-size: 4rem; margin-bottom: 16px;">🛍️</div>
            <div style="font-size: 1.5rem; margin-bottom: 8px;">No Characters Available</div>
            <div style="font-size: 1rem;">Characters will appear here once added to the marketplace.</div>
          </div>
        `;
      }
    }

    function renderLibrary() {
      const grid = document.getElementById('libraryGrid');
      grid.innerHTML = '';

      const owned = allMarketplaceCharacters.filter(char => ownedCharacters.includes(char.id));

      if (owned.length === 0) {
        grid.innerHTML = `
          <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: #666;">
            <div style="font-size: 4rem; margin-bottom: 16px;">📚</div>
            <div style="font-size: 1.5rem; margin-bottom: 8px;">No Characters Yet</div>
            <div style="font-size: 1rem;">Browse the marketplace to purchase your first AI character!</div>
            <button onclick="switchMarketplaceTab('browse')" style="margin-top: 24px; padding: 12px 24px; background: linear-gradient(135deg, #ff2ebb, #00b2ff); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer;">
              Browse Marketplace
            </button>
          </div>
        `;
        return;
      }

      owned.forEach(character => {
        const card = document.createElement('div');
        card.className = 'library-character-card';

        card.innerHTML = `
          <div class="library-character-badge">✓ Owned</div>
          <img src="${character.image}" alt="${character.name}" class="character-image" loading="lazy">
          <div class="character-info">
            <div class="character-name">${character.name}</div>
            <div class="character-category">${character.category}</div>
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #2a2a2a; color: #666; font-size: 0.85rem;">
              Available in Flux and Qwen models
            </div>
          </div>
        `;

        grid.appendChild(card);
      });
    }

    function switchMarketplaceTab(tab) {
      const browseTab = document.getElementById('browseTab');
      const libraryTab = document.getElementById('libraryTab');
      const browseMarketplace = document.getElementById('browseMarketplace');
      const myCharactersLibrary = document.getElementById('myCharactersLibrary');

      if (tab === 'browse') {
        browseTab.classList.add('active');
        libraryTab.classList.remove('active');
        browseMarketplace.style.display = 'block';
        myCharactersLibrary.style.display = 'none';
      } else {
        browseTab.classList.remove('active');
        libraryTab.classList.add('active');
        browseMarketplace.style.display = 'none';
        myCharactersLibrary.style.display = 'block';
        renderLibrary();
      }
    }

    function openCharacterModal(character) {
      currentCharacterModal = character;
      const modal = document.getElementById('characterModal');
      const isOwned = ownedCharacters.includes(character.id);

      document.getElementById('modalCharacterName').textContent = character.name;
      document.getElementById('modalCharacterCategory').textContent = character.category;
      document.getElementById('modalCharacterDescription').textContent = character.description;
      document.getElementById('modalCharacterImage').src = character.image;
      document.getElementById('modalCharacterPrice').textContent = isOwned ? 'Owned' : '$' + character.price.toFixed(2);

      // Render tags
      const tagsContainer = document.getElementById('modalCharacterTags');
      tagsContainer.innerHTML = character.tags.map(tag =>
        `<span class="character-tag">${tag}</span>`
      ).join('');

      // Prepare all images for lightbox (main image + gallery images)
      const galleryImages = character.galleryImages || [];
      const allImages = [character.image, ...galleryImages];

      // Make main image clickable to open lightbox
      const mainImage = document.getElementById('modalCharacterImage');
      mainImage.onclick = () => openLightbox(allImages, 0);

      // Render gallery images with lightbox functionality
      const galleryContainer = document.getElementById('modalCharacterGallery');
      if (galleryImages.length > 0) {
        galleryContainer.innerHTML = galleryImages.map((url, index) => `
          <div class="character-gallery-item" data-image-index="${index + 1}">
            <img src="${url}" alt="Example ${index + 1}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
          </div>
        `).join('');
        galleryContainer.parentElement.style.display = 'block';

        // Add click handlers to gallery items
        galleryContainer.querySelectorAll('.character-gallery-item').forEach((item, index) => {
          item.onclick = () => openLightbox(allImages, index + 1);
        });
      } else {
        galleryContainer.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No example images yet</div>';
        galleryContainer.parentElement.style.display = 'block';
      }

      // Update buy button
      const buyBtn = document.getElementById('modalBuyBtn');
      if (isOwned) {
        buyBtn.textContent = '✓ Already Owned';
        buyBtn.style.background = '#2a2a2a';
        buyBtn.style.color = '#00ff88';
        buyBtn.style.cursor = 'default';
        buyBtn.onclick = null;
      } else {
        buyBtn.textContent = `💳 Purchase for $${character.price.toFixed(2)}`;
        buyBtn.style.background = 'linear-gradient(135deg, #ff2ebb, #00b2ff)';
        buyBtn.style.color = '#fff';
        buyBtn.style.cursor = 'pointer';
        buyBtn.onclick = purchaseCharacter;
      }

      modal.classList.add('active');
    }

    function closeCharacterModal() {
      document.getElementById('characterModal').classList.remove('active');
      currentCharacterModal = null;
    }

    // Lightbox functionality
    let lightboxImages = [];
    let currentLightboxIndex = 0;

    function openLightbox(images, startIndex = 0) {
      lightboxImages = images;
      currentLightboxIndex = startIndex;
      updateLightboxImage();
      document.getElementById('imageLightbox').classList.add('active');
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }

    function closeLightbox() {
      document.getElementById('imageLightbox').classList.remove('active');
      document.body.style.overflow = ''; // Restore scrolling
      lightboxImages = [];
      currentLightboxIndex = 0;
    }

    function navigateLightbox(direction) {
      currentLightboxIndex = (currentLightboxIndex + direction + lightboxImages.length) % lightboxImages.length;
      updateLightboxImage();
    }

    function updateLightboxImage() {
      document.getElementById('lightboxImage').src = lightboxImages[currentLightboxIndex];
      document.getElementById('lightboxCounter').textContent = `${currentLightboxIndex + 1} / ${lightboxImages.length}`;
    }

    // Keyboard navigation for lightbox
    document.addEventListener('keydown', (e) => {
      const lightbox = document.getElementById('imageLightbox');
      if (lightbox.classList.contains('active')) {
        if (e.key === 'Escape') {
          closeLightbox();
        } else if (e.key === 'ArrowLeft') {
          navigateLightbox(-1);
        } else if (e.key === 'ArrowRight') {
          navigateLightbox(1);
        }
      }
    });

    // Close lightbox when clicking on background
    document.addEventListener('click', (e) => {
      const lightbox = document.getElementById('imageLightbox');
      if (e.target === lightbox) {
        closeLightbox();
      }
    });

    async function purchaseCharacter() {
      if (!currentCharacterModal) return;

      const character = currentCharacterModal;

      // Check if user is logged in
      if (!isUserLoggedIn || !currentUser) {
        alert('Please log in to purchase characters!');
        closeCharacterModal();
        openLoginModal();
        return;
      }

      // Calculate cost
      const cost = Math.round(character.price * 100); // Convert price to credits (e.g., $14.99 = 1499 credits)

      if (userCredits < cost) {
        const proceed = confirm(`Insufficient credits!\n\nThis character costs ${cost} credits, but you only have ${userCredits} credits.\n\nWould you like to view subscription plans?`);
        if (proceed) {
          closeCharacterModal();
          openSubscriptionPage();
        }
        return;
      }

      // Confirm purchase
      const confirmed = confirm(`Purchase ${character.name} for $${character.price.toFixed(2)} (${cost} credits)?\n\nThis character will be immediately available in your Flux and Qwen character dropdowns.`);

      if (confirmed) {
        try {
          // Call Supabase function to purchase character
          const { data, error } = await supabaseClient.rpc('purchase_character', {
            p_user_id: currentUser.id,
            p_character_id: character.id,
            p_price: cost
          });

          if (error) {
            console.error('Purchase error:', error);
            alert('Purchase failed: ' + error.message);
            return;
          }

          if (data === false) {
            alert('Purchase failed. You may already own this character or have insufficient credits.');
            return;
          }

          // Update local state
          userCredits -= cost;
          if (!ownedCharacters.includes(character.id)) {
            ownedCharacters.push(character.id);
          }

          // Update UI
          updateCreditsDisplay();

          // Show success message
          alert(`🎉 Success!\n\n${character.name} has been added to your account!\n\nYou can now select ${character.name} in the Flux and Qwen character dropdowns.`);

          // Re-render marketplace and close modal
          renderMarketplace();
          updateCharacterDropdowns();
          closeCharacterModal();

          console.log(`✅ Purchased ${character.name} for ${cost} credits. Remaining: ${userCredits} credits`);

        } catch (err) {
          console.error('Purchase error:', err);
          alert('An error occurred during purchase');
        }
      }
    }

    function updateCharacterDropdowns() {
      // All LoRAs are tied to marketplace characters - admins see all, users see owned only
      // Characters must have a lora_url to appear in LoRA dropdowns

      // Update Flux dropdown
      const fluxCharacter = document.getElementById('fluxCharacter');
      if (fluxCharacter) {
        const savedFluxValue = fluxCharacter.value;
        fluxCharacter.innerHTML = '<option value="none">No Character (LoRA)</option>';
        allMarketplaceCharacters.forEach(char => {
          // Admin sees all, others see only owned - must have lora_url
          if ((isUserAdmin || ownedCharacters.includes(char.id)) && char.lora_url) {
            fluxCharacter.innerHTML += `<option value="${char.id}">✨ ${char.name}</option>`;
          }
        });
        // Restore selection if still valid
        if (savedFluxValue && fluxCharacter.querySelector(`option[value="${savedFluxValue}"]`)) {
          fluxCharacter.value = savedFluxValue;
        }
      }

      // Update Qwen dropdown - only marketplace characters with lora_url
      const qwenCharacter = document.getElementById('qwenGenCharacter');
      if (qwenCharacter) {
        const savedQwenValue = qwenCharacter.value;
        qwenCharacter.innerHTML = '<option value="none">No Character (LoRA)</option>';
        allMarketplaceCharacters.forEach(char => {
          // Admin sees all, others see only owned - must have lora_url
          if ((isUserAdmin || ownedCharacters.includes(char.id)) && char.lora_url) {
            qwenCharacter.innerHTML += `<option value="${char.id}">✨ ${char.name}</option>`;
          }
        });
        // Restore selection if still valid
        if (savedQwenValue && qwenCharacter.querySelector(`option[value="${savedQwenValue}"]`)) {
          qwenCharacter.value = savedQwenValue;
        }
      }

      // Update Inpaint dropdown - same as Qwen since both use ComfyUI
      const inpaintLoraSelect = document.getElementById('inpaintLoraSelect');
      if (inpaintLoraSelect) {
        const savedInpaintValue = inpaintLoraSelect.value;
        inpaintLoraSelect.innerHTML = '<option value="">None</option>';
        allMarketplaceCharacters.forEach(char => {
          // Admin sees all, others see only owned - must have lora_url
          if ((isUserAdmin || ownedCharacters.includes(char.id)) && char.lora_url) {
            inpaintLoraSelect.innerHTML += `<option value="${char.id}">✨ ${char.name}</option>`;
          }
        });
        // Restore selection if still valid
        if (savedInpaintValue && inpaintLoraSelect.querySelector(`option[value="${savedInpaintValue}"]`)) {
          inpaintLoraSelect.value = savedInpaintValue;
        }
      }
    }

    // ==================== CHARACTER FORM FUNCTIONS ====================
    let editingCharacterId = null;
    let characterGalleryImages = []; // Array to hold gallery image URLs

    function renderCharacterGallery() {
      const container = document.getElementById('characterGalleryContainer');
      if (!container) return;

      if (characterGalleryImages.length === 0) {
        container.innerHTML = '<div style="color: #666; font-size: 0.9rem; padding: 10px;">No gallery images yet. Add some below.</div>';
        return;
      }

      container.innerHTML = characterGalleryImages.map((url, index) => `
        <div style="position: relative; width: 80px; height: 80px; border-radius: 8px; overflow: hidden; border: 1px solid #333;">
          <img src="${url}" alt="Gallery ${index + 1}" style="width: 100%; height: 100%; object-fit: cover;" loading="lazy">
          <button type="button" onclick="removeCharacterGalleryImage(${index})" style="position: absolute; top: 2px; right: 2px; width: 20px; height: 20px; border-radius: 50%; background: #ff4444; border: none; color: white; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;">×</button>
        </div>
      `).join('');
    }

    function addCharacterGalleryImage() {
      const input = document.getElementById('characterGalleryUrlInput');
      const url = input.value.trim();
      if (url) {
        characterGalleryImages.push(url);
        input.value = '';
        renderCharacterGallery();
      }
    }

    function removeCharacterGalleryImage(index) {
      characterGalleryImages.splice(index, 1);
      renderCharacterGallery();
    }

    function handleCharacterGalleryUpload(event) {
      const files = event.target.files;
      if (!files.length) return;

      Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
          characterGalleryImages.push(e.target.result);
          renderCharacterGallery();
        };
        reader.readAsDataURL(file);
      });

      // Clear the input so the same files can be selected again
      event.target.value = '';
    }

    function openCharacterForm(characterId = null) {
      const modal = document.getElementById('characterFormModal');
      const form = document.getElementById('characterForm');
      const titleEl = document.getElementById('characterFormTitle');
      const deleteBtn = document.getElementById('characterFormDelete');

      // Reset form
      form.reset();
      document.getElementById('characterFormId').value = '';
      document.getElementById('characterThumbnailPreview').innerHTML = '<span class="resource-thumbnail-placeholder">👤 No image</span>';
      document.getElementById('characterFormIsActive').checked = true;
      editingCharacterId = null;
      characterGalleryImages = [];
      renderCharacterGallery();

      if (characterId) {
        // Edit mode
        const character = allMarketplaceCharacters.find(c => c.id === characterId);
        if (character) {
          editingCharacterId = characterId;
          titleEl.textContent = 'Edit Character';
          deleteBtn.style.display = 'inline-block';

          document.getElementById('characterFormId').value = character.id;
          document.getElementById('characterFormName').value = character.name;
          document.getElementById('characterFormCategory').value = character.category;
          document.getElementById('characterFormDescription').value = character.description || '';
          document.getElementById('characterFormPrice').value = character.price || '';
          document.getElementById('characterFormSortOrder').value = character.sort_order || '';
          document.getElementById('characterFormTags').value = (character.tags || []).join(', ');
          document.getElementById('characterFormImageUrl').value = character.image || '';
          document.getElementById('characterFormLoraUrl').value = character.lora_url || '';
          document.getElementById('characterFormTriggerWord').value = character.trigger_word || '';
          document.getElementById('characterFormIsActive').checked = character.is_active !== false;

          // Show thumbnail preview
          if (character.image && !character.image.startsWith('data:image/svg')) {
            document.getElementById('characterThumbnailPreview').innerHTML = `<img src="${character.image}" alt="Preview" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`;
          }

          // Load gallery images
          characterGalleryImages = character.galleryImages || [];
          renderCharacterGallery();
        }
      } else {
        // Add mode
        titleEl.textContent = 'Add New Character';
        deleteBtn.style.display = 'none';
      }

      modal.classList.add('active');
    }

    function editCharacter(characterId) {
      openCharacterForm(characterId);
    }

    function closeCharacterForm() {
      document.getElementById('characterFormModal').classList.remove('active');
      editingCharacterId = null;
    }

    async function saveCharacter(event) {
      event.preventDefault();

      const saveBtn = document.getElementById('characterFormSave');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      try {
        const characterId = document.getElementById('characterFormId').value;
        const isEdit = !!characterId;

        const tagsInput = document.getElementById('characterFormTags').value;
        const tags = tagsInput.split(',').map(t => t.trim()).filter(t => t);

        const characterData = {
          name: document.getElementById('characterFormName').value,
          category: document.getElementById('characterFormCategory').value,
          description: document.getElementById('characterFormDescription').value,
          price: parseFloat(document.getElementById('characterFormPrice').value) || 0,
          sort_order: parseInt(document.getElementById('characterFormSortOrder').value) || 0,
          tags: tags,
          image_url: document.getElementById('characterFormImageUrl').value || null,
          gallery_images: characterGalleryImages,
          lora_url: document.getElementById('characterFormLoraUrl').value || null,
          trigger_word: document.getElementById('characterFormTriggerWord').value || null,
          is_active: document.getElementById('characterFormIsActive').checked
        };

        const url = isEdit
          ? `${API_BASE_URL}/api/characters/${characterId}`
          : `${API_BASE_URL}/api/characters`;

        const response = await authFetch(url, {
          method: isEdit ? 'PUT' : 'POST',
          body: JSON.stringify(characterData)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to save character');
        }

        closeCharacterForm();
        await loadMarketplaceCharacters();
        console.log(`✅ Character ${isEdit ? 'updated' : 'created'} successfully`);

      } catch (error) {
        console.error('Error saving character:', error);
        alert('Error saving character: ' + error.message);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Character';
      }
    }

    async function deleteCharacter() {
      if (!editingCharacterId) return;

      const character = allMarketplaceCharacters.find(c => c.id === editingCharacterId);
      if (!confirm(`Are you sure you want to delete "${character?.name || 'this character'}"?\n\nThis action cannot be undone.`)) {
        return;
      }

      try {
        // Uses JWT auth - admin check done on server
        const response = await authFetch(`${API_BASE_URL}/api/characters/${editingCharacterId}`, {
          method: 'DELETE'
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to delete character');
        }

        closeCharacterForm();
        await loadMarketplaceCharacters();
        console.log('✅ Character deleted successfully');

      } catch (error) {
        console.error('Error deleting character:', error);
        alert('Error deleting character: ' + error.message);
      }
    }

    function handleCharacterThumbnailUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const preview = document.getElementById('characterThumbnailPreview');
        preview.innerHTML = `<img src="${e.target.result}" alt="Preview" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`;
        document.getElementById('characterFormImageUrl').value = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    // Initialize user area on load
    window.addEventListener('load', () => {
      // Start as logged out
      document.getElementById('userAvatar').classList.add('logged-out');

      // You can uncomment this to start logged in for testing
      // handleLogin();
    });

    // Initialize credit system and button costs on load
    window.addEventListener('load', () => {
      // Initialize button costs
      updateImageGenerateButtonCost();
      updateVideoGenerateButtonCost();
      updateEditButtonCost();

      // Add event listeners for real-time cost updates

      // Image generation settings - Standard (Nano Banana, Seedream)
      const aspectRatioSelect = document.getElementById('aspectRatio');
      const resolutionSelect = document.getElementById('resolution');
      const numGenerationsSelect = document.getElementById('numGenerations');

      if (aspectRatioSelect) {
        aspectRatioSelect.addEventListener('change', updateImageGenerateButtonCost);
      }
      if (resolutionSelect) {
        resolutionSelect.addEventListener('change', updateImageGenerateButtonCost);
      }
      if (numGenerationsSelect) {
        numGenerationsSelect.addEventListener('change', updateImageGenerateButtonCost);
      }

      // Flux settings
      const fluxAspectRatioSelect = document.getElementById('fluxAspectRatio');
      const fluxNumGenerationsSelect = document.getElementById('fluxNumGenerations');
      const fluxCharacterSelect = document.getElementById('fluxCharacter');

      if (fluxAspectRatioSelect) {
        fluxAspectRatioSelect.addEventListener('change', updateImageGenerateButtonCost);
      }
      if (fluxNumGenerationsSelect) {
        fluxNumGenerationsSelect.addEventListener('change', updateImageGenerateButtonCost);
      }
      if (fluxCharacterSelect) {
        fluxCharacterSelect.addEventListener('change', updateImageGenerateButtonCost);
      }

      // Seedream settings
      const seedreamAspectRatioSelect = document.getElementById('seedreamAspectRatio');
      const seedreamResolutionSelect = document.getElementById('seedreamResolution');

      if (seedreamAspectRatioSelect) {
        seedreamAspectRatioSelect.addEventListener('change', updateImageGenerateButtonCost);
      }
      if (seedreamResolutionSelect) {
        seedreamResolutionSelect.addEventListener('change', updateImageGenerateButtonCost);
      }

      // Qwen Generation settings
      const qwenGenAspectRatioSelect = document.getElementById('qwenGenAspectRatio');
      const qwenGenNumGenerationsSelect = document.getElementById('qwenGenNumGenerations');
      const qwenGenCharacterSelect = document.getElementById('qwenGenCharacter');

      if (qwenGenAspectRatioSelect) {
        qwenGenAspectRatioSelect.addEventListener('change', updateImageGenerateButtonCost);
      }
      if (qwenGenNumGenerationsSelect) {
        qwenGenNumGenerationsSelect.addEventListener('change', updateImageGenerateButtonCost);
      }
      if (qwenGenCharacterSelect) {
        qwenGenCharacterSelect.addEventListener('change', updateImageGenerateButtonCost);
      }

      // Video generation settings
      const videoDurationSelect = document.getElementById('videoDuration');
      const veoDurationSelect = document.getElementById('veoDuration');
      const wanNumFramesSelect = document.getElementById('wanNumFrames');
      const wanFpsSelect = document.getElementById('wanFps');

      if (videoDurationSelect) {
        videoDurationSelect.addEventListener('change', updateVideoGenerateButtonCost);
      }
      if (veoDurationSelect) {
        veoDurationSelect.addEventListener('change', updateVideoGenerateButtonCost);
      }
      if (wanNumFramesSelect) {
        wanNumFramesSelect.addEventListener('change', updateVideoGenerateButtonCost);
      }
      if (wanFpsSelect) {
        wanFpsSelect.addEventListener('change', updateVideoGenerateButtonCost);
      }

      console.log('💳 Credit system initialized - button costs will update in real-time');

      // Initialize marketplace - load from API
      loadMarketplaceCharacters();
    });

    // Check backend status on load
    window.addEventListener('load', async () => {
      try {
        const response = await fetch(`${API_BASE_URL}/health`);
        if (!response.ok) throw new Error('Backend not responding');
        console.log('✅ Backend is ready!');
      } catch (error) {
        console.error('⚠️ Backend not available:', error);
        showError('⚠️ Backend server is not running! Please start it with: cd backend && npm run dev');
      }
    });

    // ==================== EDUCATION/CHAT FUNCTIONS ====================
    let chatSocket = null;
    let currentChannel = null;
    let userMembership = null;
    let typingTimeout = null;
    let isUserAdmin = false;
    let allMembers = [];
    let allStartHereGuides = [];

    async function initializeEducationTab() {
      // Use the global currentUser variable set by auth state handler
      const user = currentUser;

      if (!user) {
        // Show membership cards for non-logged in users
        document.getElementById('educationNoAccess').style.display = 'flex';
        document.getElementById('educationMemberContent').style.display = 'none';
        return;
      }

      // Check user's membership and admin status
      try {
        // Check membership
        const { data: membership, error } = await supabaseClient
          .from('memberships')
          .select('tier, is_active')
          .eq('user_id', user.id)
          .single();

        if (error && error.code !== 'PGRST116') {
          console.error('Error fetching membership:', error);
        }

        // Check admin status
        const { data: profile, error: profileError } = await supabaseClient
          .from('profiles')
          .select('role')
          .eq('id', user.id)
          .single();

        isUserAdmin = profile?.role === 'admin';
        window.isUserAdmin = isUserAdmin; // Expose for analytics tracking

        if (membership && membership.is_active) {
          userMembership = membership.tier;
          showMemberContent(user);
        } else if (isUserAdmin) {
          // Admins can access without membership
          userMembership = 'admin';
          showMemberContent(user);
        } else {
          // Show membership cards
          document.getElementById('educationNoAccess').style.display = 'flex';
          document.getElementById('educationMemberContent').style.display = 'none';
        }
      } catch (err) {
        console.error('Error checking membership:', err);
        document.getElementById('educationNoAccess').style.display = 'flex';
        document.getElementById('educationMemberContent').style.display = 'none';
      }
    }

    function showMemberContent(user) {
      document.getElementById('educationNoAccess').style.display = 'none';
      document.getElementById('educationMemberContent').style.display = 'flex';

      // Update tier badge
      const tierBadge = document.getElementById('channelTierBadge');
      if (isUserAdmin) {
        tierBadge.innerHTML = '👑 Admin';
        tierBadge.style.background = 'linear-gradient(135deg, rgba(234, 179, 8, 0.2), rgba(249, 115, 22, 0.2))';
        tierBadge.style.borderColor = 'rgba(234, 179, 8, 0.5)';
        document.getElementById('privateChannelsSection').style.display = 'block';
        // Show members toggle button for admins
        document.getElementById('adminMembersToggle')?.style.setProperty('display', 'block');
        // Show channel management button for admins
        document.getElementById('adminChannelsToggle')?.style.setProperty('display', 'block');
      } else if (userMembership === 'mentorship') {
        tierBadge.innerHTML = '🚀 Mentorship';
        document.getElementById('privateChannelsSection').style.display = 'block';
      } else {
        tierBadge.innerHTML = '⭐ Supernova';
        document.getElementById('privateChannelsSection').style.display = 'none';
      }

      // Connect to Socket.io for chat
      connectToChat(user);

      // Load resources for the resource library
      loadResources();

      // Initialize the default subtab (starthere) with proper admin button visibility
      // This will load starthere guides and show the correct admin button if admin
      const activeSubtab = document.querySelector('.education-subtab.active');
      const currentSubtab = activeSubtab?.id?.replace('Subtab', '') || 'starthere';
      switchEducationSubtab(currentSubtab);

      // Show Policies tab for admins
      if (isUserAdmin) {
        const policiesTab = document.getElementById('policiesSubtab');
        if (policiesTab) {
          policiesTab.style.display = 'flex';
        }
        // Load policies for admin grid
        loadPolicies();
      }

      // Check mobile overlay after a short delay to ensure DOM is updated
      setTimeout(() => {
        console.log('📱 showMemberContent: Checking mobile overlay after content shown');
        checkMobileCommunityOverlay();
      }, 200);
    }

    function connectToChat(user) {
      if (chatSocket && chatSocket.connected) {
        return;
      }

      // Connect to the backend Socket.io server
      chatSocket = io(API_BASE_URL);

      chatSocket.on('connect', () => {
        console.log('Connected to chat server');

        // Authenticate with user info - use profile data from currentUser for display name
        chatSocket.emit('authenticate', {
          userId: user.id,
          email: user.email,
          displayName: currentUser?.display_name || currentUser?.full_name || user.email?.split('@')[0],
          avatar: currentUser?.avatar_url || user.user_metadata?.avatar_url
        });
      });

      chatSocket.on('authenticated', (data) => {
        console.log('Authenticated with tier:', data.tier, 'admin:', data.isAdmin);
        isUserAdmin = data.isAdmin;
        window.isUserAdmin = data.isAdmin; // Expose for analytics tracking
        renderChannels(data.channels);

        // If admin, request all members
        if (data.isAdmin) {
          chatSocket.emit('get_all_members');
        }
      });

      chatSocket.on('all_members', (data) => {
        console.log('Received members:', data.members?.length);
        allMembers = data.members || [];
        renderMembersPanel();
      });

      chatSocket.on('channel_joined', (data) => {
        console.log('Joined channel:', data.channelId);
        currentChannel = data.channelId;
        renderMessages(data.messages);
        renderOnlineUsers(data.onlineUsers);
      });

      chatSocket.on('new_message', (message) => {
        addMessageToChat(message);
      });

      chatSocket.on('message_deleted', (data) => {
        const messageEl = document.querySelector(`[data-message-id="${data.messageId}"]`);
        if (messageEl) {
          messageEl.style.opacity = '0';
          messageEl.style.transform = 'translateX(-20px)';
          setTimeout(() => messageEl.remove(), 200);
        }
      });

      // Reaction events
      chatSocket.on('reaction_added', (data) => {
        updateMessageReactions(data.messageId, data.emoji, data.userId, true);
      });

      chatSocket.on('reaction_removed', (data) => {
        updateMessageReactions(data.messageId, data.emoji, data.userId, false);
      });

      chatSocket.on('user_typing', (data) => {
        showTypingIndicator(data.displayName);
      });

      chatSocket.on('user_stopped_typing', () => {
        hideTypingIndicator();
      });

      chatSocket.on('user_joined', (data) => {
        console.log(data.displayName + ' joined the channel');
      });

      chatSocket.on('user_left', (data) => {
        console.log(data.displayName + ' left the channel');
      });

      // Handle real-time profile updates from other users
      chatSocket.on('user_profile_updated', (data) => {
        console.log('User profile updated:', data.displayName);
        // Update online users list if visible
        const onlineUsersList = document.getElementById('onlineUsersList');
        if (onlineUsersList) {
          const userElements = onlineUsersList.querySelectorAll(`[data-user-id="${data.userId}"]`);
          userElements.forEach(el => {
            const nameEl = el.querySelector('.online-user-name');
            if (nameEl) nameEl.textContent = data.displayName;
            const avatarEl = el.querySelector('.online-user-avatar img');
            if (avatarEl && data.avatar) avatarEl.src = data.avatar;
          });
        }
      });

      chatSocket.on('error', (data) => {
        console.error('Chat error:', data.message);
        showError(data.message);
      });

      chatSocket.on('disconnect', () => {
        console.log('Disconnected from chat server');
      });
    }

    function renderChannels(channels) {
      const channelList = document.getElementById('channelList');
      const privateChannelList = document.getElementById('privateChannelList');

      channelList.innerHTML = '';
      privateChannelList.innerHTML = '';

      channels.forEach(channel => {
        const channelItem = document.createElement('div');
        channelItem.className = 'channel-item';
        channelItem.dataset.channelId = channel.id;
        channelItem.onclick = () => joinChannel(channel);

        const icon = channel.is_private ? '🔒' : '#';
        channelItem.innerHTML = `
          <span class="channel-item-icon">${icon}</span>
          <span>${channel.name}</span>
        `;

        if (channel.is_private) {
          privateChannelList.appendChild(channelItem);
        } else {
          channelList.appendChild(channelItem);
        }
      });

      // Try to restore last visited channel, or auto-join first channel
      if (channels.length > 0) {
        const savedChannelId = localStorage.getItem('vixxxen_lastChannelId');
        const savedChannel = savedChannelId ? channels.find(c => c.id === savedChannelId) : null;
        joinChannel(savedChannel || channels[0]);
      }
    }

    function joinChannel(channel) {
      // Save selected channel to localStorage for persistence
      localStorage.setItem('vixxxen_lastChannelId', channel.id);

      // Update UI
      document.querySelectorAll('.channel-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelector(`[data-channel-id="${channel.id}"]`)?.classList.add('active');

      // Update header
      document.getElementById('chatChannelName').textContent = '# ' + channel.name;
      document.getElementById('chatChannelDesc').textContent = channel.description || '';

      // Clear messages
      const messagesContainer = document.getElementById('chatMessages');
      messagesContainer.innerHTML = '<div class="chat-loading">Loading messages...</div>';

      // Show chat on mobile (Discord-like behavior)
      openMobileChat();

      // Join via socket
      chatSocket.emit('join_channel', { channelId: channel.id });
    }

    // ========== MOBILE COMMUNITY OVERLAY FUNCTIONS ==========
    let communityOriginalParent = null;
    let isMobileCommunityOverlayOpen = false;

    // Open the mobile community overlay
    function openMobileCommunityOverlay() {
      console.log('📱 openMobileCommunityOverlay called, width:', window.innerWidth);

      if (window.innerWidth > 768) {
        console.log('📱 Skipping - not mobile (width > 768)');
        return;
      }

      const overlay = document.getElementById('mobileCommunityOverlay');
      const overlayContent = document.getElementById('mobileCommunityContent');
      const educationChat = document.getElementById('educationChat');

      console.log('📱 Elements found:', { overlay: !!overlay, overlayContent: !!overlayContent, educationChat: !!educationChat });

      if (!overlay || !overlayContent || !educationChat) {
        console.log('📱 Missing elements, aborting');
        return;
      }

      // Remember original parent
      communityOriginalParent = educationChat.parentElement;

      // Move chat into overlay
      overlayContent.appendChild(educationChat);

      // Show overlay
      overlay.classList.add('active');
      isMobileCommunityOverlayOpen = true;

      // Prevent body scroll
      document.body.style.overflow = 'hidden';

      // Hide Tidio chat widget
      document.body.classList.add('mobile-community-active');
      hideTidioWidget();
    }

    // Hide/show Tidio widget
    function hideTidioWidget() {
      // Tidio creates various elements - try to hide them all
      const tidioElements = document.querySelectorAll('#tidio-chat, #tidio-chat-iframe, [id^="tidio"], iframe[src*="tidio"]');
      tidioElements.forEach(el => {
        el.style.display = 'none';
        el.style.visibility = 'hidden';
      });
      // Also try using Tidio's API if available
      if (window.tidioChatApi) {
        window.tidioChatApi.hide();
      }
    }

    function showTidioWidget() {
      const tidioElements = document.querySelectorAll('#tidio-chat, #tidio-chat-iframe, [id^="tidio"], iframe[src*="tidio"]');
      tidioElements.forEach(el => {
        el.style.display = '';
        el.style.visibility = '';
      });
      // Also try using Tidio's API if available
      if (window.tidioChatApi) {
        window.tidioChatApi.show();
      }
    }

    // Close the mobile community overlay
    function closeMobileCommunityOverlay() {
      const overlay = document.getElementById('mobileCommunityOverlay');
      const educationChat = document.getElementById('educationChat');

      if (!overlay) return;

      // Move chat back to original location
      if (communityOriginalParent && educationChat) {
        communityOriginalParent.appendChild(educationChat);
      }

      // Hide overlay
      overlay.classList.remove('active');
      isMobileCommunityOverlayOpen = false;

      // Reset chat state
      if (educationChat) {
        educationChat.classList.remove('mobile-chat-active');
      }

      // Restore body scroll
      document.body.style.overflow = '';

      // Show Tidio chat widget again
      document.body.classList.remove('mobile-community-active');
      showTidioWidget();
    }

    // Mobile chat functions (slide between channel list and chat)
    function openMobileChat() {
      const chatContainer = document.getElementById('educationChat');
      if (chatContainer) {
        chatContainer.classList.add('mobile-chat-active');
      }
    }

    function closeMobileChat() {
      const chatContainer = document.getElementById('educationChat');
      if (chatContainer) {
        chatContainer.classList.remove('mobile-chat-active');
      }
    }

    // Check if we should open overlay when community tab is shown
    function checkMobileCommunityOverlay() {
      const communityContent = document.getElementById('communityContent');
      const educationMemberContent = document.getElementById('educationMemberContent');
      const isMobile = window.innerWidth <= 768;

      const isCommunityTabActive = communityContent && communityContent.classList.contains('active');
      const isEducationVisible = educationMemberContent && educationMemberContent.style.display !== 'none';

      console.log('🔍 checkMobileCommunityOverlay:', {
        isCommunityTabActive,
        isEducationVisible,
        isMobile,
        isMobileCommunityOverlayOpen,
        windowWidth: window.innerWidth,
        educationDisplay: educationMemberContent?.style.display
      });

      if (isCommunityTabActive && isEducationVisible && isMobile && !isMobileCommunityOverlayOpen) {
        console.log('📱 Opening mobile community overlay');
        openMobileCommunityOverlay();
      } else if ((!isCommunityTabActive || !isEducationVisible || !isMobile) && isMobileCommunityOverlayOpen) {
        console.log('📱 Closing mobile community overlay');
        closeMobileCommunityOverlay();
      }
    }

    // Handle window resize
    window.addEventListener('resize', function() {
      const isMobile = window.innerWidth <= 768;
      if (!isMobile && isMobileCommunityOverlayOpen) {
        closeMobileCommunityOverlay();
      } else if (isMobile && !isMobileCommunityOverlayOpen) {
        // Check if we should open overlay on resize to mobile
        checkMobileCommunityOverlay();
      }
    });

    // Mobile keyboard handling - adjust chat when keyboard opens/closes
    function initMobileKeyboardHandling() {
      if (!window.visualViewport) return;

      const chatInputArea = document.querySelector('.chat-input-area');
      const chatMessages = document.querySelector('.chat-messages');
      const chatContainer = document.getElementById('educationChat');

      if (!chatInputArea || !chatContainer) return;

      let initialViewportHeight = window.visualViewport.height;

      window.visualViewport.addEventListener('resize', () => {
        if (window.innerWidth > 768) return; // Only on mobile

        const currentHeight = window.visualViewport.height;
        const keyboardHeight = initialViewportHeight - currentHeight;

        if (keyboardHeight > 100) {
          // Keyboard is open
          chatContainer.style.height = `${currentHeight}px`;
          chatInputArea.style.paddingBottom = '12px';

          // Scroll messages to bottom when keyboard opens
          if (chatMessages) {
            setTimeout(() => {
              chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
          }
        } else {
          // Keyboard is closed
          chatContainer.style.height = '';
          chatInputArea.style.paddingBottom = '';
        }
      });

      // Also handle scroll when focusing on input
      const chatInput = document.getElementById('chatInput');
      if (chatInput) {
        chatInput.addEventListener('focus', () => {
          if (window.innerWidth <= 768 && chatMessages) {
            setTimeout(() => {
              chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 300);
          }
        });
      }
    }

    // Initialize keyboard handling when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initMobileKeyboardHandling);

      // Also check for mobile overlay after a delay on page load
      // This catches cases where the community tab was saved and restored
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
          console.log('📱 DOMContentLoaded: Checking mobile overlay');
          checkMobileCommunityOverlay();
        }, 500);
      });
    } else {
      initMobileKeyboardHandling();
    }

    function renderMessages(messages) {
      const messagesContainer = document.getElementById('chatMessages');
      messagesContainer.innerHTML = '';

      if (messages.length === 0) {
        messagesContainer.innerHTML = `
          <div class="chat-welcome">
            <div class="chat-welcome-icon">💬</div>
            <div class="chat-welcome-title">No messages yet</div>
            <div class="chat-welcome-text">Be the first to say something!</div>
          </div>
        `;
        return;
      }

      messages.forEach(message => {
        addMessageToChat(message, false);
      });

      // Scroll to bottom
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Check if content is an image URL
    function isImageUrl(text) {
      const imageExtensions = /\.(jpg|jpeg|png|gif|webp|bmp)(\?.*)?$/i;
      const imageHosts = /(giphy\.com|media\.giphy\.com|i\.giphy\.com|supabase\.co\/storage)/i;
      return imageExtensions.test(text) || imageHosts.test(text);
    }

    // Format message content (detect images, links, etc.)
    function formatMessageContent(content) {
      // Check if the entire content is a single image URL
      const trimmed = content.trim();
      if (isImageUrl(trimmed) && !trimmed.includes(' ')) {
        return `<img src="${escapeHtml(trimmed)}" class="chat-message-image" onclick="window.open('${escapeHtml(trimmed)}', '_blank')" alt="Shared image">`;
      }

      // Escape HTML first
      let formatted = escapeHtml(content);

      // Parse @mentions - match @username patterns
      formatted = formatted.replace(/@(\w+(?:\s+\w+)?)/g, (match, username) => {
        // Check if this is a mention of the current user
        const myDisplayName = currentUser?.display_name || currentUser?.full_name;
        const isMentionMe = myDisplayName &&
          myDisplayName.toLowerCase() === username.toLowerCase();
        return `<span class="mention${isMentionMe ? ' mention-me' : ''}">${match}</span>`;
      });

      return formatted;
    }

    // Check if message mentions the current user
    function messageContainsMention(content) {
      const myDisplayName = currentUser?.display_name || currentUser?.full_name;
      if (!myDisplayName) return false;
      const mentionPattern = new RegExp(`@${myDisplayName}\\b`, 'i');
      return mentionPattern.test(content);
    }

    function addMessageToChat(message, scroll = true) {
      const messagesContainer = document.getElementById('chatMessages');

      // Remove welcome message if present
      const welcome = messagesContainer.querySelector('.chat-welcome');
      if (welcome) welcome.remove();
      const loading = messagesContainer.querySelector('.chat-loading');
      if (loading) loading.remove();

      const messageEl = document.createElement('div');
      const isMentioned = messageContainsMention(message.content);
      messageEl.className = 'chat-message' + (isMentioned ? ' mentioned' : '');
      messageEl.setAttribute('data-message-id', message.id);

      const time = new Date(message.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const avatarContent = message.user.avatar
        ? `<img src="${message.user.avatar}" alt="${message.user.displayName}">`
        : message.user.displayName?.charAt(0).toUpperCase() || '?';

      // Admin delete button
      const deleteBtn = isUserAdmin ? `
        <button class="message-delete-btn" onclick="deleteMessage('${message.id}')" title="Delete message">
          🗑️
        </button>
      ` : '';

      // Report button (can't report own messages)
      const isOwnMessage = currentUser && message.user?.id === currentUser.id;
      const safePreview = (message.content || '').substring(0, 100).replace(/['"]/g, '');
      const reportBtn = !isOwnMessage ? `
        <button class="message-report-btn" onclick="openReportModal('chat_message', '${message.id}', '', '${safePreview}', '${message.user?.id || ''}')" title="Report message">
          🚩
        </button>
      ` : '';

      // Format content (handles images, GIFs, etc.)
      const formattedContent = formatMessageContent(message.content);

      // Build reactions HTML
      const reactionsHtml = buildReactionsHtml(message.id, message.reactions || []);

      messageEl.innerHTML = `
        <div class="chat-message-avatar">${avatarContent}</div>
        <div class="chat-message-content">
          <div class="chat-message-header">
            <span class="chat-message-name">${escapeHtml(message.user.displayName)}</span>
            <span class="chat-message-time">${time}</span>
            ${reportBtn}
            ${deleteBtn}
          </div>
          <div class="chat-message-text">${formattedContent}</div>
          <div class="message-reactions" data-message-id="${message.id}">
            ${reactionsHtml}
            <button class="add-reaction-btn" onclick="showEmojiPicker(event, '${message.id}')">😀+</button>
          </div>
        </div>
      `;

      messagesContainer.appendChild(messageEl);

      if (scroll) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
    }

    // Note: escapeHtml is in js/utils.js

    // Reaction helper functions
    const ALLOWED_EMOJIS = ['👍', '❤️', '😂', '😮', '😢', '🔥'];
    let activeEmojiPicker = null;

    function buildReactionsHtml(messageId, reactions) {
      // Group reactions by emoji and count them
      const reactionCounts = {};
      reactions.forEach(r => {
        if (!reactionCounts[r.emoji]) {
          reactionCounts[r.emoji] = { count: 0, userIds: [] };
        }
        reactionCounts[r.emoji].count++;
        reactionCounts[r.emoji].userIds.push(r.userId);
      });

      // Build HTML for each reaction type
      let html = '';
      for (const [emoji, data] of Object.entries(reactionCounts)) {
        const isActive = currentUser && data.userIds.includes(currentUser.id);
        html += `
          <button class="reaction-pill ${isActive ? 'active' : ''}"
                  data-emoji="${emoji}"
                  onclick="toggleReaction('${messageId}', '${emoji}')">
            ${emoji}<span class="reaction-count">${data.count}</span>
          </button>
        `;
      }
      return html;
    }

    function showEmojiPicker(event, messageId) {
      event.stopPropagation();

      // Close any existing picker
      if (activeEmojiPicker) {
        activeEmojiPicker.remove();
        activeEmojiPicker = null;
      }

      const btn = event.currentTarget;
      const picker = document.createElement('div');
      picker.className = 'emoji-picker-popup';

      ALLOWED_EMOJIS.forEach(emoji => {
        const emojiBtn = document.createElement('button');
        emojiBtn.textContent = emoji;
        emojiBtn.onclick = (e) => {
          e.stopPropagation();
          toggleReaction(messageId, emoji);
          picker.remove();
          activeEmojiPicker = null;
        };
        picker.appendChild(emojiBtn);
      });

      btn.parentElement.style.position = 'relative';
      btn.parentElement.appendChild(picker);
      activeEmojiPicker = picker;

      // Close picker when clicking outside
      const closeHandler = (e) => {
        if (!picker.contains(e.target) && e.target !== btn) {
          picker.remove();
          activeEmojiPicker = null;
          document.removeEventListener('click', closeHandler);
        }
      };
      setTimeout(() => document.addEventListener('click', closeHandler), 0);
    }

    function toggleReaction(messageId, emoji) {
      if (!chatSocket || !currentUser) {
        showError('You must be logged in to react');
        return;
      }

      // Check if user already has this reaction
      const reactionsContainer = document.querySelector(`.message-reactions[data-message-id="${messageId}"]`);
      const existingPill = reactionsContainer?.querySelector(`.reaction-pill[data-emoji="${emoji}"].active`);

      if (existingPill) {
        // Remove reaction
        chatSocket.emit('remove_reaction', {
          messageId: messageId,
          channelId: currentChannel,
          emoji: emoji
        });
      } else {
        // Add reaction
        chatSocket.emit('add_reaction', {
          messageId: messageId,
          channelId: currentChannel,
          emoji: emoji
        });
      }
    }

    function updateMessageReactions(messageId, emoji, userId, isAdding) {
      const reactionsContainer = document.querySelector(`.message-reactions[data-message-id="${messageId}"]`);
      if (!reactionsContainer) return;

      let pill = reactionsContainer.querySelector(`.reaction-pill[data-emoji="${emoji}"]`);

      if (isAdding) {
        if (pill) {
          // Update existing pill
          const countSpan = pill.querySelector('.reaction-count');
          const currentCount = parseInt(countSpan.textContent) || 0;
          countSpan.textContent = currentCount + 1;

          // Mark as active if it's the current user
          if (currentUser && userId === currentUser.id) {
            pill.classList.add('active');
          }
        } else {
          // Create new pill - insert before the add button
          const addBtn = reactionsContainer.querySelector('.add-reaction-btn');
          const newPill = document.createElement('button');
          newPill.className = 'reaction-pill' + (currentUser && userId === currentUser.id ? ' active' : '');
          newPill.setAttribute('data-emoji', emoji);
          newPill.setAttribute('onclick', `toggleReaction('${messageId}', '${emoji}')`);
          newPill.innerHTML = `${emoji}<span class="reaction-count">1</span>`;
          reactionsContainer.insertBefore(newPill, addBtn);
        }
      } else {
        // Removing reaction
        if (pill) {
          const countSpan = pill.querySelector('.reaction-count');
          const currentCount = parseInt(countSpan.textContent) || 0;

          if (currentCount <= 1) {
            // Remove the pill entirely
            pill.remove();
          } else {
            // Decrement count
            countSpan.textContent = currentCount - 1;

            // Remove active state if it's the current user
            if (currentUser && userId === currentUser.id) {
              pill.classList.remove('active');
            }
          }
        }
      }
    }

    // @Mention autocomplete
    let mentionSearch = '';
    let mentionStartIndex = -1;
    let selectedMentionIndex = 0;

    function handleChatInput(event) {
      const input = event.target;
      const value = input.value;
      const cursorPos = input.selectionStart;

      // Find if we're in a mention context (after @ but before space)
      let atIndex = -1;
      for (let i = cursorPos - 1; i >= 0; i--) {
        if (value[i] === ' ' || value[i] === '\n') break;
        if (value[i] === '@') {
          atIndex = i;
          break;
        }
      }

      if (atIndex >= 0) {
        mentionStartIndex = atIndex;
        mentionSearch = value.substring(atIndex + 1, cursorPos).toLowerCase();
        showMentionAutocomplete();
      } else {
        hideMentionAutocomplete();
      }
    }

    function showMentionAutocomplete() {
      const autocomplete = document.getElementById('mentionAutocomplete');
      if (!autocomplete) return;

      // Filter members by search
      const filtered = allMembers.filter(m =>
        m.displayName?.toLowerCase().includes(mentionSearch)
      ).slice(0, 8); // Limit to 8 results

      if (filtered.length === 0) {
        hideMentionAutocomplete();
        return;
      }

      selectedMentionIndex = 0;

      autocomplete.innerHTML = filtered.map((member, index) => {
        const avatarContent = member.avatar
          ? `<img src="${member.avatar}" alt="${member.displayName}">`
          : member.displayName?.charAt(0).toUpperCase() || '?';

        return `
          <div class="mention-autocomplete-item ${index === 0 ? 'selected' : ''}"
               data-index="${index}"
               data-user-id="${member.id}"
               data-display-name="${escapeHtml(member.displayName)}"
               onclick="selectMention(this)">
            <div class="mention-autocomplete-avatar">${avatarContent}</div>
            <span class="mention-autocomplete-name">${escapeHtml(member.displayName)}</span>
          </div>
        `;
      }).join('');

      autocomplete.classList.add('active');

      // Add keyboard navigation
      const input = document.getElementById('chatInput');
      input.onkeydown = handleMentionKeydown;
    }

    function hideMentionAutocomplete() {
      const autocomplete = document.getElementById('mentionAutocomplete');
      if (autocomplete) {
        autocomplete.classList.remove('active');
        autocomplete.innerHTML = '';
      }
      mentionStartIndex = -1;
      mentionSearch = '';

      // Remove keyboard handler
      const input = document.getElementById('chatInput');
      if (input) input.onkeydown = null;
    }

    function handleMentionKeydown(event) {
      const autocomplete = document.getElementById('mentionAutocomplete');
      if (!autocomplete?.classList.contains('active')) return;

      const items = autocomplete.querySelectorAll('.mention-autocomplete-item');
      if (items.length === 0) return;

      if (event.key === 'ArrowDown') {
        event.preventDefault();
        items[selectedMentionIndex].classList.remove('selected');
        selectedMentionIndex = (selectedMentionIndex + 1) % items.length;
        items[selectedMentionIndex].classList.add('selected');
      } else if (event.key === 'ArrowUp') {
        event.preventDefault();
        items[selectedMentionIndex].classList.remove('selected');
        selectedMentionIndex = (selectedMentionIndex - 1 + items.length) % items.length;
        items[selectedMentionIndex].classList.add('selected');
      } else if (event.key === 'Enter' || event.key === 'Tab') {
        event.preventDefault();
        selectMention(items[selectedMentionIndex]);
      } else if (event.key === 'Escape') {
        event.preventDefault();
        hideMentionAutocomplete();
      }
    }

    function selectMention(element) {
      const displayName = element.dataset.displayName;
      const input = document.getElementById('chatInput');
      const value = input.value;

      // Replace @search with @displayName
      const before = value.substring(0, mentionStartIndex);
      const after = value.substring(mentionStartIndex + mentionSearch.length + 1);
      input.value = before + '@' + displayName + ' ' + after;

      // Set cursor after the mention
      const newCursorPos = mentionStartIndex + displayName.length + 2;
      input.setSelectionRange(newCursorPos, newCursorPos);
      input.focus();

      hideMentionAutocomplete();
    }

    function renderOnlineUsers(users) {
      const onlineList = document.getElementById('onlineUsersList');
      onlineList.innerHTML = '';

      users.forEach(user => {
        const userEl = document.createElement('div');
        userEl.className = 'online-user';

        const avatarContent = user.avatar
          ? `<img src="${user.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`
          : user.displayName?.charAt(0).toUpperCase() || '?';

        userEl.innerHTML = `
          <div class="online-user-avatar">${avatarContent}</div>
          <span>${escapeHtml(user.displayName)}</span>
          <div class="online-user-dot"></div>
        `;

        onlineList.appendChild(userEl);
      });
    }

    // Toggle members panel (admin only)
    function toggleMembersPanel() {
      const panel = document.getElementById('membersPanel');
      if (panel.style.display === 'none' || panel.style.display === '') {
        panel.style.display = 'flex';
      } else {
        panel.style.display = 'none';
      }
    }

    // Render members panel (admin only)
    function renderMembersPanel() {
      if (!isUserAdmin || !allMembers.length) return;

      const membersList = document.getElementById('membersList');
      membersList.innerHTML = '';

      // Calculate stats
      const totalMembers = allMembers.length;
      const onlineMembers = allMembers.filter(m => m.isOnline).length;
      const mentorshipMembers = allMembers.filter(m => m.tier === 'mentorship').length;

      document.getElementById('totalMembersCount').textContent = totalMembers;
      document.getElementById('onlineMembersCount').textContent = onlineMembers;
      document.getElementById('mentorshipCount').textContent = mentorshipMembers;

      // Sort: online first, then by tier
      const sortedMembers = [...allMembers].sort((a, b) => {
        if (a.isOnline !== b.isOnline) return b.isOnline - a.isOnline;
        if (a.role === 'admin' && b.role !== 'admin') return -1;
        if (b.role === 'admin' && a.role !== 'admin') return 1;
        if (a.tier === 'mentorship' && b.tier !== 'mentorship') return -1;
        if (b.tier === 'mentorship' && a.tier !== 'mentorship') return 1;
        return 0;
      });

      sortedMembers.forEach(member => {
        const memberEl = document.createElement('div');
        memberEl.className = 'member-item';

        const avatarContent = member.avatar
          ? `<img src="${member.avatar}" alt="${member.displayName}">`
          : member.displayName?.charAt(0).toUpperCase() || '?';

        let tierDisplay = 'No membership';
        let tierClass = '';
        if (member.role === 'admin') {
          tierDisplay = '👑 Admin';
          tierClass = 'admin';
        } else if (member.tier === 'mentorship') {
          tierDisplay = '🚀 Mentorship';
          tierClass = 'mentorship';
        } else if (member.tier === 'supernova') {
          tierDisplay = '⭐ Supernova';
          tierClass = 'supernova';
        }

        memberEl.innerHTML = `
          <div class="member-avatar">
            ${avatarContent}
            ${member.isOnline ? '<div class="member-online-dot"></div>' : ''}
          </div>
          <div class="member-info">
            <div class="member-name">${escapeHtml(member.displayName)}</div>
            <div class="member-tier ${tierClass}">${tierDisplay}</div>
          </div>
        `;

        membersList.appendChild(memberEl);
      });
    }

    // ==================== CHANNEL MANAGEMENT FUNCTIONS (Admin) ====================
    let managedChannels = [];

    function openChannelManageModal() {
      if (!isUserAdmin) return;
      document.getElementById('channelManageModal').style.display = 'flex';
      loadManagedChannels();
    }

    function closeChannelManageModal() {
      document.getElementById('channelManageModal').style.display = 'none';
      document.getElementById('newChannelName').value = '';
      document.getElementById('newChannelDescription').value = '';
      document.getElementById('newChannelTier').value = '';
    }

    async function loadManagedChannels() {
      const listEl = document.getElementById('channelManageList');
      listEl.innerHTML = '<div class="channel-manage-empty">Loading channels...</div>';

      try {
        const { data: channels, error } = await supabaseClient
          .from('channels')
          .select('*')
          .order('is_private', { ascending: true })
          .order('name', { ascending: true });

        if (error) {
          console.error('Error loading channels:', error);
          listEl.innerHTML = `<div class="channel-manage-empty" style="color: #ff4444;">Error loading channels: ${error.message}</div>`;
          return;
        }

        managedChannels = channels || [];
        renderManagedChannels();
      } catch (err) {
        console.error('Error loading channels:', err);
        listEl.innerHTML = `<div class="channel-manage-empty" style="color: #ff4444;">Error: ${err.message}</div>`;
      }
    }

    function renderManagedChannels() {
      const listEl = document.getElementById('channelManageList');

      if (!managedChannels.length) {
        listEl.innerHTML = '<div class="channel-manage-empty">No channels yet. Add one above!</div>';
        return;
      }

      listEl.innerHTML = managedChannels.map(channel => {
        const icon = channel.is_private ? '🔒' : '#';
        let tierDisplay = 'All members';
        let tierClass = '';

        if (channel.tier_required === 'supernova') {
          tierDisplay = 'Supernova+';
          tierClass = 'supernova';
        } else if (channel.tier_required === 'mentorship') {
          tierDisplay = 'Mentorship only';
          tierClass = 'mentorship';
        }

        return `
          <div class="channel-manage-item" data-channel-id="${channel.id}">
            <div class="channel-manage-item-info">
              <div class="channel-manage-item-icon">${icon}</div>
              <div class="channel-manage-item-details">
                <div class="channel-manage-item-name">${escapeHtml(channel.name)}</div>
                <div class="channel-manage-item-tier ${tierClass}">${tierDisplay}</div>
              </div>
            </div>
            <button class="channel-delete-btn" onclick="deleteChannel('${channel.id}')" title="Delete channel">
              🗑️
            </button>
          </div>
        `;
      }).join('');
    }

    async function addNewChannel() {
      if (!isUserAdmin) return;

      const nameInput = document.getElementById('newChannelName');
      const descInput = document.getElementById('newChannelDescription');
      const tierSelect = document.getElementById('newChannelTier');

      const name = nameInput.value.trim().toLowerCase().replace(/\s+/g, '-');
      const description = descInput.value.trim();
      const tierRequired = tierSelect.value || null;

      if (!name) {
        alert('Please enter a channel name');
        return;
      }

      try {
        const { data: channel, error } = await supabaseClient
          .from('channels')
          .insert({
            name: name,
            description: description,
            tier_required: tierRequired,
            is_private: false
          })
          .select()
          .single();

        if (error) {
          console.error('Error creating channel:', error);
          alert('Error creating channel: ' + error.message);
          return;
        }

        // Clear form
        nameInput.value = '';
        descInput.value = '';
        tierSelect.value = '';

        // Reload channels list
        await loadManagedChannels();

        // Refresh the chat channels sidebar
        if (chatSocket && chatSocket.connected) {
          chatSocket.emit('authenticate', {
            userId: currentUser.id,
            email: currentUser.email,
            displayName: currentUser.display_name || currentUser.full_name || currentUser.email?.split('@')[0],
            avatar: currentUser.avatar_url
          });
        }

        alert('Channel created successfully!');
      } catch (err) {
        console.error('Error creating channel:', err);
        alert('Error creating channel');
      }
    }

    async function deleteChannel(channelId) {
      if (!isUserAdmin) return;

      const channel = managedChannels.find(c => c.id === channelId);
      if (!channel) return;

      if (!confirm(`Are you sure you want to delete the channel "${channel.name}"? This will also delete all messages in this channel.`)) {
        return;
      }

      try {
        // First delete all messages in this channel
        const { error: msgError } = await supabaseClient
          .from('messages')
          .delete()
          .eq('channel_id', channelId);

        if (msgError) {
          console.error('Error deleting messages:', msgError);
        }

        // Then delete the channel
        const { error } = await supabaseClient
          .from('channels')
          .delete()
          .eq('id', channelId);

        if (error) {
          console.error('Error deleting channel:', error);
          alert('Error deleting channel: ' + error.message);
          return;
        }

        // Reload channels list
        await loadManagedChannels();

        // Refresh the chat channels sidebar
        if (chatSocket && chatSocket.connected) {
          chatSocket.emit('authenticate', {
            userId: currentUser.id,
            email: currentUser.email,
            displayName: currentUser.display_name || currentUser.full_name || currentUser.email?.split('@')[0],
            avatar: currentUser.avatar_url
          });
        }

        alert('Channel deleted successfully!');
      } catch (err) {
        console.error('Error deleting channel:', err);
        alert('Error deleting channel');
      }
    }

    // Close channel modal when clicking outside
    document.addEventListener('click', function(e) {
      const modal = document.getElementById('channelManageModal');
      if (e.target === modal) {
        closeChannelManageModal();
      }
    });

    // ==================== RESOURCE LIBRARY FUNCTIONS ====================
    let allResources = [];
    let currentResourceFilters = { type: 'all', topic: 'all' };
    let previewMode = false; // Admin preview mode to test purchase UI

    async function switchEducationSubtab(tab) {
      // Check rules acknowledgment when accessing community tab (for members)
      if (tab === 'community' && currentUser && !userHasAcknowledgedRules) {
        const needsAcknowledgment = await showRulesAcknowledgmentIfNeeded();
        if (needsAcknowledgment) {
          return; // Don't switch tabs until rules are acknowledged
        }
      }

      // Save current subtab to localStorage for persistence
      localStorage.setItem('vixxxen_educationSubtab', tab);

      // Update subtab buttons
      document.querySelectorAll('.education-subtab').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tab + 'Subtab').classList.add('active');

      // Update content visibility
      document.querySelectorAll('.education-subtab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(tab + 'Content').classList.add('active');

      // Check if we need to open/close mobile community overlay
      checkMobileCommunityOverlay();

      // Hide all education admin buttons first
      const adminResourcesBtn = document.getElementById('adminResourcesBtn');
      const adminPreviewToggle = document.getElementById('adminPreviewToggle');
      const adminStarthereBtn = document.getElementById('adminStarthereBtn');
      if (adminResourcesBtn) adminResourcesBtn.classList.remove('visible');
      if (adminPreviewToggle) adminPreviewToggle.classList.remove('visible');
      if (adminStarthereBtn) adminStarthereBtn.classList.remove('visible');

      // Load content based on tab and show appropriate admin buttons
      if (tab === 'resources') {
        if (allResources.length === 0) loadResources();
        // Show resource admin buttons
        if (isUserAdmin) {
          if (adminResourcesBtn) adminResourcesBtn.classList.add('visible');
          if (adminPreviewToggle) adminPreviewToggle.classList.add('visible');
        }
      } else if (tab === 'starthere') {
        if (allStartHereGuides.length === 0) loadStartHereGuides();
        // Show starthere admin button
        if (isUserAdmin) {
          if (adminStarthereBtn) adminStarthereBtn.classList.add('visible');
        }
      } else if (tab === 'policies') {
        // Initialize admin panel with the currently selected section
        switchAdminSection(currentAdminSection);
      }
      // Note: community tab doesn't have an add button (channel management is separate)
    }

    // ==================== ADMIN PANEL NAVIGATION ====================

    let currentAdminSection = 'analytics';

    function switchAdminSection(section) {
      currentAdminSection = section;

      // Update nav items
      document.querySelectorAll('.admin-nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.section === section) {
          item.classList.add('active');
        }
      });

      // Update section visibility
      document.querySelectorAll('.admin-section').forEach(sec => {
        sec.classList.remove('active');
      });

      const sectionMap = {
        'analytics': 'adminAnalyticsSection',
        'gpu': 'adminGpuSection',
        'reports': 'adminReportsSection',
        'image-moderation': 'adminImageModerationSection',
        'policies': 'adminPoliciesSection',
        'content-filter': 'adminContentFilterSection',
        'characters': 'adminCharactersSection',
        'user-services': 'adminUserServicesSection',
        'onboarding': 'adminOnboardingSection',
        'custom-orders': 'adminCustomOrdersSection',
        'landing-page': 'adminLandingPageSection'
      };

      const targetSection = document.getElementById(sectionMap[section]);
      if (targetSection) {
        targetSection.classList.add('active');
      }

      // Load section-specific data
      if (section === 'analytics') {
        loadAnalyticsDashboard();
      } else if (section === 'gpu') {
        loadGpuConfigInline();
      } else if (section === 'reports') {
        loadAdminReports();
        updateReportsBadge();
      } else if (section === 'image-moderation') {
        loadModerationQueue();
        loadModerationStats();
      } else if (section === 'policies') {
        renderPoliciesAdminGrid();
      } else if (section === 'content-filter') {
        loadBlockedWordsAdmin();
      } else if (section === 'characters') {
        console.log('👤 Switching to characters section');
        if (typeof loadCharactersManagement === 'function') {
          loadCharactersManagement();
        } else {
          console.error('👤 loadCharactersManagement is not defined!');
        }
      } else if (section === 'user-services') {
        loadUserServicesData();
      } else if (section === 'onboarding') {
        if (typeof loadOnboardingAdmin === 'function') {
          loadOnboardingAdmin();
        }
      } else if (section === 'custom-orders') {
        if (typeof loadCustomOrdersAdmin === 'function') {
          loadCustomOrdersAdmin();
        }
      } else if (section === 'landing-page') {
        if (typeof loadAdminLandingContent === 'function') {
          loadAdminLandingContent();
        }
      }
    }

    function updateReportsBadge() {
      // Update the badge in sidebar with pending reports count
      const badge = document.getElementById('adminReportsBadge');
      const pendingCount = document.getElementById('pendingReportsCount');
      if (badge && pendingCount) {
        const count = parseInt(pendingCount.textContent) || 0;
        if (count > 0) {
          badge.textContent = count;
          badge.style.display = 'inline';
        } else {
          badge.style.display = 'none';
        }
      }
    }

    // ==================== IMAGE MODERATION QUEUE FUNCTIONS ====================

    let moderationQueueData = [];
    let moderationCurrentPage = 1;
    let moderationPageSize = 20;
    let moderationFilter = 'all';
    let selectedModerationImages = new Set();

    async function loadModerationStats() {
      try {
        const response = await authFetch(`${API_BASE_URL}/api/user-images/admin/stats`);
        if (!response.ok) throw new Error('Failed to load stats');

        const data = await response.json();
        const stats = data.stats || data;

        document.getElementById('modStatPending').textContent = stats.pending_review || 0;
        document.getElementById('modStatAppeals').textContent = stats.pending_with_appeal || 0;
        document.getElementById('modStatApproved').textContent = stats.approved || 0;
        document.getElementById('modStatRejected').textContent = stats.rejected || 0;

        // Update badge
        const badge = document.getElementById('imageModerationBadge');
        if (badge) {
          const pendingCount = stats.pending_review || 0;
          if (pendingCount > 0) {
            badge.textContent = pendingCount;
            badge.style.display = 'inline';
          } else {
            badge.style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Failed to load moderation stats:', error);
      }
    }

    async function loadModerationQueue(page = 1) {
      moderationCurrentPage = page;
      const grid = document.getElementById('moderationQueueGrid');
      const emptyState = document.getElementById('moderationEmptyState');
      const pagination = document.getElementById('moderationPagination');

      grid.innerHTML = '<div class="moderation-loading">Loading moderation queue...</div>';
      emptyState.style.display = 'none';

      try {
        let url = `${API_BASE_URL}/api/user-images/admin/queue?limit=${moderationPageSize}&offset=${(page - 1) * moderationPageSize}`;

        if (moderationFilter === 'appeals') {
          url += '&hasAppeal=true';
        } else if (moderationFilter === 'celebrity') {
          url += '&flagType=celebrity';
        } else if (moderationFilter === 'minor') {
          url += '&flagType=minor';
        }

        const response = await authFetch(url);
        if (!response.ok) throw new Error('Failed to load queue');

        const data = await response.json();
        moderationQueueData = data.images || [];

        if (moderationQueueData.length === 0) {
          grid.innerHTML = '';
          emptyState.style.display = 'block';
          pagination.style.display = 'none';
          return;
        }

        renderModerationQueue();

        // Update pagination
        const totalPages = Math.ceil((data.total || 0) / moderationPageSize);
        if (totalPages > 1) {
          pagination.style.display = 'flex';
          document.getElementById('modPageInfo').textContent = `Page ${page} of ${totalPages}`;
          document.getElementById('modPrevBtn').disabled = page <= 1;
          document.getElementById('modNextBtn').disabled = page >= totalPages;
        } else {
          pagination.style.display = 'none';
        }

      } catch (error) {
        console.error('Failed to load moderation queue:', error);
        grid.innerHTML = `<div class="moderation-loading" style="color: #ff4444;">Failed to load queue: ${error.message}</div>`;
      }
    }

    function renderModerationQueue() {
      const grid = document.getElementById('moderationQueueGrid');

      grid.innerHTML = moderationQueueData.map(image => {
        const isSelected = selectedModerationImages.has(image.id);
        const hasAppeal = image.appeal_submitted_at && image.appeal_reason;
        const celebrityConfidence = image.celebrity_confidence;
        const minorConfidence = image.minor_confidence;

        // Parse moderation flags
        let flagReasons = [];
        if (image.moderation_flags?.reasons) {
          flagReasons = image.moderation_flags.reasons;
        }

        const dateStr = new Date(image.created_at).toLocaleDateString();

        return `
          <div class="mod-queue-card ${isSelected ? 'selected' : ''}" data-id="${image.id}">
            <div class="mod-card-header">
              <input type="checkbox" class="mod-card-checkbox"
                ${isSelected ? 'checked' : ''}
                onchange="toggleModerationSelection('${image.id}', this.checked)">
              <span class="mod-card-user" title="${image.user_id}">${image.user_email || image.user_id?.substring(0, 8) + '...'}</span>
              <span class="mod-card-date">${dateStr}</span>
            </div>
            <div class="mod-card-image" onclick="viewModerationImage('${image.id}')">
              <img src="${image.url || ''}" alt="Pending image" loading="lazy">
              <div class="mod-card-flags">
                ${celebrityConfidence ? `<span class="mod-flag-badge celebrity">Celebrity ${Math.round(celebrityConfidence)}%</span>` : ''}
                ${minorConfidence ? `<span class="mod-flag-badge minor">Minor ${Math.round(minorConfidence)}%</span>` : ''}
              </div>
            </div>
            ${hasAppeal ? `
              <div class="mod-card-appeal">
                <div class="mod-card-appeal-label">📝 User Appeal:</div>
                <div class="mod-card-appeal-text">${escapeHtml(image.appeal_reason)}</div>
              </div>
            ` : ''}
            <div class="mod-card-body">
              ${flagReasons.length > 0 ? `
                <div class="mod-card-reasons">
                  <strong>Flagged for:</strong>
                  <ul>${flagReasons.map(r => `<li>${escapeHtml(r)}</li>`).join('')}</ul>
                </div>
              ` : ''}
              <div class="mod-card-actions">
                <button class="mod-action-btn approve" onclick="approveModerationImage('${image.id}')">✅ Approve</button>
                <button class="mod-action-btn reject" onclick="rejectModerationImage('${image.id}')">❌ Reject</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function filterModerationQueue(filter) {
      moderationFilter = filter;
      selectedModerationImages.clear();
      updateBulkActionButtons();

      // Update filter buttons
      document.querySelectorAll('.mod-filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === filter) {
          btn.classList.add('active');
        }
      });

      loadModerationQueue(1);
    }

    function toggleModerationSelection(imageId, selected) {
      if (selected) {
        selectedModerationImages.add(imageId);
      } else {
        selectedModerationImages.delete(imageId);
      }

      // Update card visual
      const card = document.querySelector(`.mod-queue-card[data-id="${imageId}"]`);
      if (card) {
        card.classList.toggle('selected', selected);
      }

      updateBulkActionButtons();
    }

    function updateBulkActionButtons() {
      const count = selectedModerationImages.size;
      document.getElementById('selectedCount').textContent = count;
      document.getElementById('bulkApproveBtn').disabled = count === 0;
      document.getElementById('bulkRejectBtn').disabled = count === 0;
    }

    async function approveModerationImage(imageId) {
      try {
        const response = await authFetch(`${API_BASE_URL}/api/user-images/admin/${imageId}/review`, {
          method: 'POST',
          body: JSON.stringify({ decision: 'approved' })
        });

        if (!response.ok) throw new Error('Failed to approve');

        showToast('Image approved');
        loadModerationQueue(moderationCurrentPage);
        loadModerationStats();
      } catch (error) {
        console.error('Approve failed:', error);
        alert(`Failed to approve: ${error.message}`);
      }
    }

    async function rejectModerationImage(imageId) {
      const reason = prompt('Optional: Reason for rejection');

      try {
        const response = await authFetch(`${API_BASE_URL}/api/user-images/admin/${imageId}/review`, {
          method: 'POST',
          body: JSON.stringify({ decision: 'rejected', notes: reason || '' })
        });

        if (!response.ok) throw new Error('Failed to reject');

        showToast('Image rejected');
        loadModerationQueue(moderationCurrentPage);
        loadModerationStats();
      } catch (error) {
        console.error('Reject failed:', error);
        alert(`Failed to reject: ${error.message}`);
      }
    }

    async function bulkApproveModerationImages() {
      if (selectedModerationImages.size === 0) return;

      const imageIds = Array.from(selectedModerationImages);

      try {
        const response = await authFetch(`${API_BASE_URL}/api/user-images/admin/bulk-review`, {
          method: 'POST',
          body: JSON.stringify({ imageIds, decision: 'approved' })
        });

        if (!response.ok) throw new Error('Failed to bulk approve');

        const data = await response.json();
        showToast(`Approved ${data.updatedCount} images`);

        selectedModerationImages.clear();
        updateBulkActionButtons();
        loadModerationQueue(moderationCurrentPage);
        loadModerationStats();
      } catch (error) {
        console.error('Bulk approve failed:', error);
        alert(`Failed to bulk approve: ${error.message}`);
      }
    }

    async function bulkRejectModerationImages() {
      if (selectedModerationImages.size === 0) return;

      const reason = prompt('Optional: Reason for rejection');
      const imageIds = Array.from(selectedModerationImages);

      try {
        const response = await authFetch(`${API_BASE_URL}/api/user-images/admin/bulk-review`, {
          method: 'POST',
          body: JSON.stringify({ imageIds, decision: 'rejected', notes: reason || '' })
        });

        if (!response.ok) throw new Error('Failed to bulk reject');

        const data = await response.json();
        showToast(`Rejected ${data.updatedCount} images`);

        selectedModerationImages.clear();
        updateBulkActionButtons();
        loadModerationQueue(moderationCurrentPage);
        loadModerationStats();
      } catch (error) {
        console.error('Bulk reject failed:', error);
        alert(`Failed to bulk reject: ${error.message}`);
      }
    }

    function viewModerationImage(imageId) {
      const image = moderationQueueData.find(img => img.id === imageId);
      if (image && image.url) {
        const win = window.open();
        win.document.write(`
          <html>
            <head><title>Moderation Review - ${imageId}</title></head>
            <body style="margin:0; background:#111; display:flex; justify-content:center; align-items:center; min-height:100vh;">
              <img src="${image.url}" style="max-width:95vw; max-height:95vh; object-fit:contain;">
            </body>
          </html>
        `);
      }
    }

    // ==================== START HERE FUNCTIONS ====================

    async function loadStartHereGuides() {
      const user = currentUser;
      const userId = user?.id || null;

      try {
        // Uses optional JWT auth - if logged in, will track completion status
        const response = await authFetch(`${API_BASE_URL}/api/starthere`);
        const data = await response.json();

        if (data.guides) {
          allStartHereGuides = data.guides;
          renderStartHereGuides();
        }
      } catch (error) {
        console.error('Error loading start here guides:', error);
        document.getElementById('starthereGrid').innerHTML = `
          <div class="resource-empty" style="grid-column: 1/-1;">
            <div class="resource-empty-icon">⚠️</div>
            <p>Failed to load guides. Please try again later.</p>
          </div>
        `;
      }
    }

    function renderStartHereGuides() {
      const grid = document.getElementById('starthereGrid');

      if (allStartHereGuides.length === 0) {
        grid.innerHTML = `
          <div class="resource-empty" style="grid-column: 1/-1;">
            <div class="resource-empty-icon">📭</div>
            <p>No guides available yet. Check back soon!</p>
          </div>
        `;
        return;
      }

      grid.innerHTML = allStartHereGuides.map((guide, index) => {
        const stepNumber = index + 1;
        const isCompleted = guide.is_completed;

        return `
          <div class="starthere-card ${isCompleted ? 'completed' : ''}" onclick="openStartHereGuide('${guide.id}')">
            ${isUserAdmin ? `
              <button class="starthere-card-edit" onclick="editStartHereGuide(event, '${guide.id}')" title="Edit Guide">✏️</button>
            ` : ''}
            <div class="starthere-card-number">${stepNumber}</div>
            <div class="starthere-card-thumbnail">
              ${guide.thumbnail_url
                ? `<img src="${guide.thumbnail_url}" alt="${escapeHtml(guide.title)}">`
                : guide.icon || '📋'
              }
            </div>
            <div class="starthere-card-body">
              <div class="starthere-card-title">${escapeHtml(guide.title)}</div>
              <div class="starthere-card-description">${escapeHtml(guide.description || '')}</div>
              <div class="starthere-card-status ${isCompleted ? 'completed' : ''}">
                <span class="starthere-card-status-icon">${isCompleted ? '✓' : '○'}</span>
                <span>${isCompleted ? 'Completed' : 'Not started'}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function openStartHereGuide(guideId) {
      const guide = allStartHereGuides.find(g => g.id === guideId);
      if (!guide) return;

      // Reuse the resource modal for displaying guide content
      const modal = document.getElementById('resourceModal');
      const modalType = document.getElementById('resourceModalType');
      const modalTitle = document.getElementById('resourceModalTitle');
      const modalTopic = document.getElementById('resourceModalTopic');
      const modalDuration = document.getElementById('resourceModalDuration');
      const modalBody = document.getElementById('resourceModalBody');

      modalType.className = 'resource-modal-type tutorial';
      modalType.textContent = 'Guide';

      modalTitle.textContent = guide.title;
      modalTopic.textContent = 'Getting Started';
      modalDuration.textContent = guide.duration || '';

      // Show content
      if (guide.content_body) {
        modalBody.innerHTML = `
          <div class="resource-content-body">
            ${guide.content_body}
          </div>
          <div class="starthere-complete-section">
            <button class="starthere-complete-btn ${guide.is_completed ? 'completed' : ''}"
                    onclick="markGuideComplete('${guide.id}')">
              ${guide.is_completed ? '✓ Completed' : 'Mark as Complete'}
            </button>
          </div>
        `;
      } else if (guide.content_url) {
        // Handle video content
        let embedUrl = guide.content_url;
        if (guide.content_url.includes('youtube.com/watch')) {
          const videoId = new URL(guide.content_url).searchParams.get('v');
          embedUrl = `https://www.youtube.com/embed/${videoId}`;
        } else if (guide.content_url.includes('youtu.be/')) {
          const videoId = guide.content_url.split('youtu.be/')[1].split('?')[0];
          embedUrl = `https://www.youtube.com/embed/${videoId}`;
        }

        modalBody.innerHTML = `
          <div class="resource-video-container">
            <iframe src="${embedUrl}" frameborder="0" allowfullscreen></iframe>
          </div>
          <div class="starthere-complete-section">
            <button class="starthere-complete-btn ${guide.is_completed ? 'completed' : ''}"
                    onclick="markGuideComplete('${guide.id}')">
              ${guide.is_completed ? '✓ Completed' : 'Mark as Complete'}
            </button>
          </div>
        `;
      }

      modal.classList.add('active');
    }

    async function markGuideComplete(guideId) {
      const user = currentUser;
      if (!user) return;

      try {
        const response = await authFetch(`${API_BASE_URL}/api/starthere/${guideId}/complete`, {
          method: 'POST',
          body: JSON.stringify({ user_id: user.id })
        });

        if (response.ok) {
          // Update local state
          const guide = allStartHereGuides.find(g => g.id === guideId);
          if (guide) {
            guide.is_completed = true;
          }
          renderStartHereGuides();
          closeResourceModal();
        }
      } catch (error) {
        console.error('Error marking guide complete:', error);
      }
    }

    // ==================== START HERE ADMIN FUNCTIONS ====================
    let editingGuideId = null;

    function showStartHereAdminButton() {
      if (isUserAdmin) {
        document.getElementById('adminStarthereBtn')?.classList.add('visible');
      }
    }

    function openStartHereForm(guideId = null) {
      const modal = document.getElementById('starthereFormModal');
      const title = document.getElementById('starthereFormTitle');
      const deleteBtn = document.getElementById('starthereFormDelete');
      const form = document.getElementById('starthereForm');

      // Reset form
      form.reset();
      document.getElementById('starthereFormId').value = '';
      document.getElementById('starthereThumbnailPreview').innerHTML = '<span class="resource-thumbnail-placeholder">📷 No image</span>';

      if (guideId) {
        // Edit mode - find and populate guide data
        const guide = allStartHereGuides.find(g => g.id === guideId);
        if (guide) {
          editingGuideId = guideId;
          title.textContent = 'Edit Guide';
          deleteBtn.style.display = 'block';

          document.getElementById('starthereFormId').value = guide.id;
          document.getElementById('starthereFormTitleInput').value = guide.title || '';
          document.getElementById('starthereFormDescription').value = guide.description || '';
          document.getElementById('starthereFormIcon').value = guide.icon || '';
          document.getElementById('starthereFormDuration').value = guide.duration || '';
          document.getElementById('starthereFormSortOrder').value = guide.sort_order || '';
          document.getElementById('starthereFormThumbnail').value = guide.thumbnail_url || '';
          document.getElementById('starthereFormContentUrl').value = guide.content_url || '';
          document.getElementById('starthereFormContentBody').value = guide.content_body || '';

          // Show thumbnail preview if exists
          if (guide.thumbnail_url) {
            document.getElementById('starthereThumbnailPreview').innerHTML = `<img src="${guide.thumbnail_url}" alt="Thumbnail preview">`;
          }
        }
      } else {
        // Add mode
        editingGuideId = null;
        title.textContent = 'Add New Guide';
        deleteBtn.style.display = 'none';
      }

      modal.classList.add('active');
    }

    function closeStartHereForm() {
      document.getElementById('starthereFormModal').classList.remove('active');
      editingGuideId = null;
    }

    function editStartHereGuide(event, guideId) {
      event.stopPropagation(); // Prevent opening the view modal
      openStartHereForm(guideId);
    }

    async function saveStartHereGuide(event) {
      event.preventDefault();

      const user = currentUser;
      if (!user || !isUserAdmin) {
        alert('Admin access required');
        return;
      }

      const saveBtn = document.getElementById('starthereFormSave');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      const guideData = {
        title: document.getElementById('starthereFormTitleInput').value,
        description: document.getElementById('starthereFormDescription').value,
        icon: document.getElementById('starthereFormIcon').value || '📋',
        duration: document.getElementById('starthereFormDuration').value || null,
        sort_order: parseInt(document.getElementById('starthereFormSortOrder').value) || 0,
        thumbnail_url: document.getElementById('starthereFormThumbnail').value || null,
        content_url: document.getElementById('starthereFormContentUrl').value || null,
        content_body: document.getElementById('starthereFormContentBody').value || null
      };

      try {
        const isEditing = !!editingGuideId;
        const url = isEditing
          ? `${API_BASE_URL}/api/starthere/${editingGuideId}`
          : `${API_BASE_URL}/api/starthere`;

        const response = await authFetch(url, {
          method: isEditing ? 'PUT' : 'POST',
          body: JSON.stringify(guideData)
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to save guide');
        }

        closeStartHereForm();
        allStartHereGuides = []; // Force reload
        await loadStartHereGuides();
        alert(isEditing ? 'Guide updated!' : 'Guide created!');

      } catch (error) {
        console.error('Error saving guide:', error);
        alert('Error: ' + error.message);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Guide';
      }
    }

    async function deleteStartHereGuide() {
      if (!editingGuideId) return;

      const user = currentUser;
      if (!user || !isUserAdmin) {
        alert('Admin access required');
        return;
      }

      if (!confirm('Are you sure you want to delete this guide?')) return;

      try {
        // Uses JWT auth - admin check done on server
        const response = await authFetch(`${API_BASE_URL}/api/starthere/${editingGuideId}`, {
          method: 'DELETE'
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Failed to delete guide');
        }

        closeStartHereForm();
        allStartHereGuides = []; // Force reload
        await loadStartHereGuides();
        alert('Guide deleted!');

      } catch (error) {
        console.error('Error deleting guide:', error);
        alert('Error: ' + error.message);
      }
    }

    async function handleStartHereThumbnailUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const user = currentUser;
      if (!user || !isUserAdmin) {
        alert('Admin access required');
        return;
      }

      const preview = document.getElementById('starthereThumbnailPreview');
      const urlInput = document.getElementById('starthereFormThumbnail');

      // Show loading state
      preview.innerHTML = '<span class="resource-thumbnail-loading">Uploading...</span>';

      try {
        const formData = new FormData();
        formData.append('thumbnail', file);

        // Uses JWT auth - admin check done on server
        const response = await authFetch(`${API_BASE_URL}/api/resources/upload`, {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Upload failed');
        }

        // Update preview and URL input
        preview.innerHTML = `<img src="${data.url}" alt="Thumbnail preview">`;
        urlInput.value = data.url;

      } catch (error) {
        console.error('Thumbnail upload error:', error);
        preview.innerHTML = '<span class="resource-thumbnail-placeholder">📷 Upload failed</span>';
        alert('Upload failed: ' + error.message);
      }
    }

    async function loadResources() {
      const user = currentUser;
      const userId = user?.id || null;

      try {
        // Uses optional JWT auth - if logged in, will show ownership status
        const response = await authFetch(`${API_BASE_URL}/api/resources`);
        const data = await response.json();

        if (data.resources) {
          allResources = data.resources;
          renderResources();
          // Note: Don't override userCredits here - it's already loaded from profile
        }
      } catch (error) {
        console.error('Error loading resources:', error);
        document.getElementById('resourceEmpty').innerHTML = `
          <div class="resource-empty-icon">⚠️</div>
          <p>Failed to load resources. Please try again later.</p>
        `;
      }
    }

    function filterResources(filterType, value) {
      // Update filter state
      currentResourceFilters[filterType] = value;

      // Update button active states
      document.querySelectorAll(`[data-filter="${filterType}"]`).forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.value === value) {
          btn.classList.add('active');
        }
      });

      // Re-render resources with new filters
      renderResources();
    }

    function renderResources() {
      const grid = document.getElementById('resourceGrid');
      const emptyState = document.getElementById('resourceEmpty');

      // Filter resources
      let filtered = allResources;

      if (currentResourceFilters.type !== 'all') {
        filtered = filtered.filter(r => r.type === currentResourceFilters.type);
      }
      if (currentResourceFilters.topic !== 'all') {
        filtered = filtered.filter(r => r.topic === currentResourceFilters.topic);
      }

      if (filtered.length === 0) {
        grid.innerHTML = `
          <div class="resource-empty" style="grid-column: 1/-1;">
            <div class="resource-empty-icon">📭</div>
            <p>No resources found matching your filters.</p>
          </div>
        `;
        return;
      }

      grid.innerHTML = filtered.map(resource => {
        // Apply preview mode if active - simulate non-subscriber view
        const isLocked = previewMode ? true : resource.is_locked;
        const isPurchased = previewMode ? false : resource.is_purchased;
        const isPurchasable = resource.is_purchasable && resource.price;
        const isOnSale = resource.is_on_sale;
        const typeIcons = { tutorial: '📖', guide: '📄', video: '🎬' };
        const icon = typeIcons[resource.type] || '📚';

        // Build price display
        let priceHtml = '';
        if (isPurchasable && !isPurchased && isLocked) {
          if (isOnSale) {
            priceHtml = `
              <div class="resource-price-badge sale">
                <span class="original-price">$${resource.price}</span>
                <span class="sale-price">$${resource.current_price}</span>
              </div>
            `;
          } else {
            priceHtml = `<div class="resource-price-badge">$${resource.price}</div>`;
          }
        }

        // Build overlay content
        let overlayHtml = '';
        // Determine which tiers get this for free
        const freeSupernova = resource.free_for_supernova !== undefined ? resource.free_for_supernova : (resource.access_tier !== 'mentorship');
        const freeMentorship = resource.free_for_mentorship !== undefined ? resource.free_for_mentorship : true;
        let tierName = '';
        if (freeSupernova && freeMentorship) {
          tierName = 'Supernova+';
        } else if (freeMentorship) {
          tierName = 'Mentorship';
        } else if (freeSupernova) {
          tierName = 'Supernova';
        }

        if (isPurchased) {
          overlayHtml = `
            <div class="resource-purchased-badge">
              <span>✓ Owned</span>
            </div>
          `;
        } else if (isLocked) {
          if (isPurchasable) {
            overlayHtml = `
              <div class="resource-locked-overlay purchasable">
                ${tierName ? `<div class="resource-free-with">Free with ${tierName}</div><div class="resource-or-divider">or</div>` : ''}
                <div class="resource-buy-btn">Buy for $${resource.current_price || resource.price}</div>
              </div>
            `;
          } else {
            overlayHtml = `
              <div class="resource-locked-overlay">
                <div class="resource-lock-icon">🔒</div>
                <div class="resource-lock-text">Upgrade to ${tierName || 'Supernova'}</div>
              </div>
            `;
          }
        }

        return `
          <div class="resource-card ${isLocked && !isPurchased ? 'locked' : ''} ${isPurchased ? 'purchased' : ''}" onclick="openResourceModal('${resource.id}')">
            ${isUserAdmin ? `
              <button class="resource-card-edit visible" onclick="editResource(event, '${resource.id}')" title="Edit Resource">✏️</button>
            ` : ''}
            <div class="resource-thumbnail">
              ${resource.thumbnail_url
                ? `<img src="${resource.thumbnail_url}" alt="${escapeHtml(resource.title)}">`
                : icon
              }
              <div class="resource-type-badge ${resource.type}">${resource.type}</div>
              ${freeMentorship && !freeSupernova
                ? '<div class="resource-tier-badge mentorship-only">Mentorship Only</div>'
                : (freeSupernova && !freeMentorship
                  ? '<div class="resource-tier-badge supernova-only">Supernova Only</div>'
                  : '')
              }
              ${resource.duration
                ? `<div class="resource-duration">${resource.duration}</div>`
                : ''
              }
              ${priceHtml}
            </div>
            <div class="resource-card-body">
              <div class="resource-title">${escapeHtml(resource.title)}</div>
              <div class="resource-description">${escapeHtml(resource.description || '')}</div>
              <div class="resource-topic-tag">${resource.topic}</div>
            </div>
            ${overlayHtml}
          </div>
        `;
      }).join('');
    }

    function openResourceModal(resourceId) {
      const resource = allResources.find(r => r.id === resourceId);
      if (!resource) return;

      const modal = document.getElementById('resourceModal');
      const modalType = document.getElementById('resourceModalType');
      const modalTitle = document.getElementById('resourceModalTitle');
      const modalTopic = document.getElementById('resourceModalTopic');
      const modalDuration = document.getElementById('resourceModalDuration');
      const modalBody = document.getElementById('resourceModalBody');

      // Set type badge color
      modalType.className = 'resource-modal-type ' + resource.type;
      modalType.textContent = resource.type;

      modalTitle.textContent = resource.title;
      modalTopic.textContent = resource.topic.charAt(0).toUpperCase() + resource.topic.slice(1);
      modalDuration.textContent = resource.duration || '';

      // Check if locked or purchased (apply preview mode if active)
      const isLocked = previewMode ? true : resource.is_locked;
      const isPurchased = previewMode ? false : resource.is_purchased;
      // Determine which tiers get this for free
      const freeSupernova = resource.free_for_supernova !== undefined ? resource.free_for_supernova : (resource.access_tier !== 'mentorship');
      const freeMentorship = resource.free_for_mentorship !== undefined ? resource.free_for_mentorship : true;
      let tierName = '';
      let tierPrice = '';
      let upgradeTier = 'supernova';
      if (freeSupernova && freeMentorship) {
        tierName = 'Supernova';
        tierPrice = '$49/mo';
        upgradeTier = 'supernova';
      } else if (freeMentorship) {
        tierName = 'Mentorship';
        tierPrice = '$199/mo';
        upgradeTier = 'mentorship';
      } else if (freeSupernova) {
        tierName = 'Supernova';
        tierPrice = '$49/mo';
        upgradeTier = 'supernova';
      }

      if (isLocked && !isPurchased) {
        // Check if purchasable
        if (resource.is_purchasable && resource.price) {
          const priceDisplay = resource.is_on_sale
            ? `<span class="original-price">$${resource.price}</span> <span class="sale-price">$${resource.current_price}</span>`
            : `$${resource.current_price || resource.price}`;

          const saleEndText = resource.is_on_sale && resource.sale_ends_at
            ? `<div class="sale-ends-text">Sale ends ${new Date(resource.sale_ends_at).toLocaleDateString()}</div>`
            : '';

          // Build free tier section based on which tiers have access
          let freeTierHtml = '';
          if (tierName) {
            freeTierHtml = `
              <div class="resource-modal-free-tier">
                <div class="free-tier-badge">Free with ${tierName}${freeSupernova && freeMentorship ? '+' : ''}</div>
                <p>This resource is included with ${tierName} membership${freeSupernova && freeMentorship ? ' and above' : ''}.</p>
              </div>
              <div class="resource-modal-or">OR</div>
            `;
          }

          modalBody.innerHTML = `
            <div class="resource-modal-purchase">
              <div class="resource-modal-purchase-icon">💎</div>
              <div class="resource-modal-purchase-title">Premium Content</div>

              ${freeTierHtml}

              <div class="resource-modal-purchase-price">${priceDisplay}</div>
              ${saleEndText}
              <div class="resource-modal-purchase-text">
                ${escapeHtml(resource.description || 'Get lifetime access to this resource.')}
              </div>
              <div class="resource-purchase-options">
                ${userCredits > 0 ? `
                  <div class="credit-balance-display">
                    <span>Your credits: $${userCredits.toFixed(2)}</span>
                  </div>
                ` : ''}
                <button class="resource-buy-btn primary" onclick="purchaseResource('${resource.id}', false)">
                  Buy Now - ${priceDisplay}
                </button>
                ${userCredits > 0 ? `
                  <button class="resource-buy-btn secondary" onclick="purchaseResource('${resource.id}', true)">
                    Use Credits${userCredits >= (resource.current_price || resource.price) ? ' (Free!)' : ''}
                  </button>
                ` : ''}
              </div>
              ${tierName ? `
                <div class="resource-modal-or">OR</div>
                <button class="resource-upgrade-btn secondary" onclick="closeResourceModal(); selectMembership('${upgradeTier}');">
                  Get ${tierName} - ${tierPrice}
                </button>
              ` : ''}
            </div>
          `;
        } else {
          modalBody.innerHTML = `
            <div class="resource-modal-upgrade">
              <div class="resource-modal-upgrade-icon">🔒</div>
              <div class="resource-modal-upgrade-title">${tierName || 'Supernova'} Exclusive Content</div>
              <div class="resource-modal-upgrade-text">
                This resource is exclusively available to ${tierName || 'Supernova'} members.
                Upgrade your membership to access this and all other exclusive content.
              </div>
              <button class="resource-upgrade-btn" onclick="closeResourceModal(); selectMembership('${upgradeTier}');">
                Upgrade to ${tierName || 'Supernova'} - ${tierPrice || '$49/mo'}
              </button>
            </div>
          `;
        }
      } else if (resource.type === 'video' && resource.content_url) {
        // Handle video content
        const videoUrl = resource.content_url;
        let embedUrl = videoUrl;

        // Convert YouTube URL to embed URL
        if (videoUrl.includes('youtube.com/watch')) {
          const videoId = new URL(videoUrl).searchParams.get('v');
          embedUrl = `https://www.youtube.com/embed/${videoId}`;
        } else if (videoUrl.includes('youtu.be/')) {
          const videoId = videoUrl.split('youtu.be/')[1].split('?')[0];
          embedUrl = `https://www.youtube.com/embed/${videoId}`;
        }

        modalBody.innerHTML = `
          <div class="resource-video-container">
            <iframe src="${embedUrl}" frameborder="0" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>
          </div>
          ${resource.description ? `<p style="margin-top: 20px;">${escapeHtml(resource.description)}</p>` : ''}
        `;
      } else if (resource.content_body) {
        // Handle tutorial/guide content
        modalBody.innerHTML = resource.content_body;
      } else {
        modalBody.innerHTML = `
          <p>${escapeHtml(resource.description || 'No content available.')}</p>
        `;
      }

      modal.classList.add('active');

      // Close on escape key
      document.addEventListener('keydown', handleResourceModalEscape);
    }

    function closeResourceModal() {
      document.getElementById('resourceModal').classList.remove('active');
      document.removeEventListener('keydown', handleResourceModalEscape);
    }

    function handleResourceModalEscape(e) {
      if (e.key === 'Escape') {
        closeResourceModal();
      }
    }

    // Purchase resource function
    async function purchaseResource(resourceId, useCredits = false) {
      const user = currentUser;
      if (!user) {
        alert('Please log in to purchase resources');
        return;
      }

      const resource = allResources.find(r => r.id === resourceId);
      if (!resource) return;

      try {
        // Uses JWT auth - userId extracted from token on server
        const response = await authFetch(`${API_BASE_URL}/api/resources/purchase`, {
          method: 'POST',
          body: JSON.stringify({ resource_id: resourceId, use_credits: useCredits })
        });

        const data = await response.json();

        if (data.success) {
          // Purchase completed with credits
          alert(`Successfully purchased "${resource.title}"! ${data.credits_used ? `Used $${data.credits_used} in credits.` : ''}`);
          closeResourceModal();
          loadResources(); // Reload to update purchased status
        } else if (data.requires_payment) {
          // Need to pay - redirect to Coinbase or show payment modal
          const confirmPurchase = confirm(
            `Purchase "${data.resource_title}" for $${data.amount_to_pay}?\n` +
            (data.credits_to_use > 0 ? `(Using $${data.credits_to_use} in credits, paying $${data.amount_to_pay})` : '')
          );

          if (confirmPurchase) {
            // For now, simulate payment completion
            // In production, this would integrate with Coinbase Commerce
            await completePurchase(resourceId, data.credits_to_use);
          }
        } else if (data.error) {
          alert(data.error);
        }
      } catch (error) {
        console.error('Purchase error:', error);
        alert('Failed to process purchase. Please try again.');
      }
    }

    // Complete purchase after payment
    async function completePurchase(resourceId, creditsUsed = 0) {
      const user = currentUser;
      if (!user) return;

      try {
        // Uses JWT auth - userId extracted from token on server
        const response = await authFetch(`${API_BASE_URL}/api/resources/purchase/confirm`, {
          method: 'POST',
          body: JSON.stringify({
            resource_id: resourceId,
            payment_id: 'manual_' + Date.now(), // Placeholder for actual payment ID
            credits_used: creditsUsed
          })
        });

        const data = await response.json();

        if (data.success) {
          alert('Purchase completed successfully!');
          closeResourceModal();
          loadResources(); // Reload to update purchased status
        } else {
          alert(data.error || 'Failed to complete purchase');
        }
      } catch (error) {
        console.error('Purchase confirmation error:', error);
        alert('Failed to confirm purchase. Please contact support.');
      }
    }

    // Close modal when clicking outside
    document.getElementById('resourceModal')?.addEventListener('click', function(e) {
      if (e.target === this) {
        closeResourceModal();
      }
    });

    // Close resource form modal when clicking outside
    document.getElementById('resourceFormModal')?.addEventListener('click', function(e) {
      if (e.target === this) {
        closeResourceForm();
      }
    });

    // ==================== ADMIN RESOURCE FUNCTIONS ====================
    let editingResourceId = null;

    function showAdminButton() {
      if (isUserAdmin) {
        document.getElementById('adminResourcesBtn')?.classList.add('visible');
        document.getElementById('adminPreviewToggle')?.classList.add('visible');
      }
    }

    function togglePreviewMode() {
      previewMode = !previewMode;
      const toggleBtn = document.getElementById('adminPreviewToggle');
      const indicator = document.getElementById('previewIndicator');

      if (previewMode) {
        toggleBtn?.classList.add('active');
        indicator?.classList.add('visible');
        toggleBtn.innerHTML = '<span>👁️</span> Exit Preview Mode';
      } else {
        toggleBtn?.classList.remove('active');
        indicator?.classList.remove('visible');
        toggleBtn.innerHTML = '<span>👁️</span> Preview as Non-Subscriber';
      }

      // Re-render resources with preview mode applied
      renderResources();
    }

    // ==================== GPU CONFIG FUNCTIONS ====================

    const gpuModeDescriptions = {
      'serverless': 'All jobs route to RunPod Serverless (current behavior)',
      'dedicated': 'All jobs route to dedicated GPU (fails if unavailable)',
      'hybrid': 'Try dedicated first, fall back to serverless if busy/unavailable',
      'serverless-primary': 'Try serverless first, fall back to dedicated if unavailable'
    };

    async function openGpuConfigModal() {
      const modal = document.getElementById('gpuConfigModal');
      modal.classList.add('active');

      // Reset status indicators to checking
      setStatusIndicator('serverlessStatus', 'checking', 'Checking...');
      setStatusIndicator('dedicatedStatus', 'checking', 'Checking...');

      // Load current config and status
      try {
        const [configRes, statusRes] = await Promise.all([
          authFetch(`${API_BASE_URL}/api/admin/gpu-config`),
          authFetch(`${API_BASE_URL}/api/admin/gpu-status`)
        ]);

        if (configRes.ok) {
          const data = await configRes.json();
          const config = data.config;

          document.getElementById('gpuModeSelect').value = config.mode || 'serverless';
          document.getElementById('gpuDedicatedUrl').value = config.dedicatedUrl || '';
          document.getElementById('gpuTimeout').value = config.dedicatedTimeout || 5000;
          document.getElementById('gpuModeHint').textContent = gpuModeDescriptions[config.mode] || '';
        }

        if (statusRes.ok) {
          const status = await statusRes.json();

          // Update serverless status
          if (status.serverless?.configured) {
            setStatusIndicator('serverlessStatus', 'online', `Online (${status.serverless.endpoint})`);
          } else {
            setStatusIndicator('serverlessStatus', 'offline', 'Not configured');
          }

          // Update dedicated status
          if (status.dedicated?.configured) {
            if (status.dedicated.health?.healthy) {
              const queueInfo = status.dedicated.health.queueDepth > 0
                ? ` (queue: ${status.dedicated.health.queueDepth})`
                : '';
              setStatusIndicator('dedicatedStatus', 'online', `Online${queueInfo}`);
            } else {
              setStatusIndicator('dedicatedStatus', 'offline', status.dedicated.health?.reason || 'Unhealthy');
            }
          } else {
            setStatusIndicator('dedicatedStatus', 'offline', 'Not configured');
          }
        }
      } catch (error) {
        console.error('Failed to load GPU config:', error);
        setStatusIndicator('serverlessStatus', 'offline', 'Error loading');
        setStatusIndicator('dedicatedStatus', 'offline', 'Error loading');
      }
    }

    function closeGpuConfigModal() {
      document.getElementById('gpuConfigModal').classList.remove('active');
    }

    function setStatusIndicator(elementId, status, text) {
      const indicator = document.getElementById(elementId);
      if (!indicator) return;

      const dot = indicator.querySelector('.status-dot');
      const textEl = indicator.querySelector('.status-text');

      dot.className = 'status-dot ' + status;
      textEl.textContent = text;
    }

    // Update hint when mode changes
    document.getElementById('gpuModeSelect')?.addEventListener('change', function() {
      document.getElementById('gpuModeHint').textContent = gpuModeDescriptions[this.value] || '';
    });

    async function saveGpuConfig(event) {
      event.preventDefault();

      const saveBtn = document.getElementById('gpuConfigSaveBtn');
      const originalText = saveBtn.textContent;
      saveBtn.textContent = 'Saving...';
      saveBtn.disabled = true;

      try {
        const config = {
          mode: document.getElementById('gpuModeSelect').value,
          dedicatedUrl: document.getElementById('gpuDedicatedUrl').value || null,
          dedicatedTimeout: parseInt(document.getElementById('gpuTimeout').value, 10)
        };

        const response = await authFetch(`${API_BASE_URL}/api/admin/gpu-config`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });

        if (response.ok) {
          showNotification('GPU configuration saved successfully', 'success');
          closeGpuConfigModal();
        } else {
          const error = await response.json();
          showNotification(error.error || 'Failed to save configuration', 'error');
        }
      } catch (error) {
        console.error('Failed to save GPU config:', error);
        showNotification('Failed to save configuration', 'error');
      } finally {
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
      }
    }

    async function testDedicatedGpu() {
      const url = document.getElementById('gpuDedicatedUrl').value;
      if (!url) {
        showNotification('Please enter a dedicated GPU URL first', 'warning');
        return;
      }

      setStatusIndicator('dedicatedStatus', 'checking', 'Testing...');

      try {
        const response = await authFetch(`${API_BASE_URL}/api/admin/gpu-test`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });

        const result = await response.json();

        if (result.healthy) {
          const queueInfo = result.queueDepth > 0 ? ` (queue: ${result.queueDepth})` : '';
          setStatusIndicator('dedicatedStatus', 'online', `Healthy${queueInfo}`);
          showNotification('Dedicated GPU is reachable and healthy!', 'success');
        } else {
          setStatusIndicator('dedicatedStatus', 'offline', result.reason || 'Unhealthy');
          showNotification(`Dedicated GPU test failed: ${result.reason}`, 'error');
        }
      } catch (error) {
        console.error('GPU test failed:', error);
        setStatusIndicator('dedicatedStatus', 'offline', 'Test failed');
        showNotification('Failed to test dedicated GPU', 'error');
      }
    }

    // Close GPU config modal when clicking outside
    document.getElementById('gpuConfigModal')?.addEventListener('click', function(e) {
      if (e.target === this) {
        closeGpuConfigModal();
      }
    });

    // ========================================
    // Inline GPU Config Functions (Admin Panel)
    // ========================================

    async function loadGpuConfigInline() {
      try {
        // Update status displays to loading
        const modeDisplay = document.getElementById('gpuModeDisplay');
        const serverlessDisplay = document.getElementById('serverlessStatusDisplay');
        const dedicatedDisplay = document.getElementById('dedicatedStatusDisplay');

        if (modeDisplay) modeDisplay.textContent = 'Loading...';
        if (serverlessDisplay) serverlessDisplay.textContent = 'Checking...';
        if (dedicatedDisplay) dedicatedDisplay.textContent = 'Checking...';

        const [configRes, statusRes] = await Promise.all([
          authFetch(`${API_BASE_URL}/api/admin/gpu-config`),
          authFetch(`${API_BASE_URL}/api/admin/gpu-status`)
        ]);

        if (configRes.ok) {
          const data = await configRes.json();
          const config = data.config;

          // Update form fields
          const modeSelect = document.getElementById('gpuModeSelect');
          const urlInput = document.getElementById('gpuDedicatedUrl');
          const timeoutInput = document.getElementById('gpuTimeout');

          if (modeSelect) modeSelect.value = config.mode || 'serverless';
          if (urlInput) urlInput.value = config.dedicatedUrl || '';
          if (timeoutInput) timeoutInput.value = config.dedicatedTimeout || 5000;

          // Update mode display
          if (modeDisplay) {
            const modeLabels = {
              'serverless': 'Serverless',
              'dedicated': 'Dedicated',
              'hybrid': 'Hybrid',
              'serverless-primary': 'Serverless Primary'
            };
            modeDisplay.textContent = modeLabels[config.mode] || config.mode;
          }
        }

        if (statusRes.ok) {
          const status = await statusRes.json();

          // Update serverless status display
          if (serverlessDisplay) {
            if (status.serverless?.configured) {
              serverlessDisplay.textContent = 'Configured';
              serverlessDisplay.style.color = '#4ade80';
            } else {
              serverlessDisplay.textContent = 'Not Set';
              serverlessDisplay.style.color = '#ffa500';
            }
          }

          // Update dedicated status display
          if (dedicatedDisplay) {
            if (status.dedicated?.configured) {
              if (status.dedicated.health?.healthy) {
                dedicatedDisplay.textContent = 'Online';
                dedicatedDisplay.style.color = '#4ade80';
              } else {
                dedicatedDisplay.textContent = 'Offline';
                dedicatedDisplay.style.color = '#ff4444';
              }
            } else {
              dedicatedDisplay.textContent = 'Not Set';
              dedicatedDisplay.style.color = '#888';
            }
          }
        }
      } catch (error) {
        console.error('Failed to load GPU config:', error);
      }
    }

    async function testGpuEndpoint() {
      const url = document.getElementById('gpuDedicatedUrl')?.value;
      const resultDiv = document.getElementById('gpuTestResult');

      if (!url) {
        if (resultDiv) {
          resultDiv.style.display = 'block';
          resultDiv.style.background = 'rgba(255, 165, 0, 0.1)';
          resultDiv.style.border = '1px solid rgba(255, 165, 0, 0.3)';
          resultDiv.style.color = '#ffa500';
          resultDiv.innerHTML = '⚠️ Please enter a dedicated GPU URL first';
        }
        return;
      }

      if (resultDiv) {
        resultDiv.style.display = 'block';
        resultDiv.style.background = 'rgba(0, 178, 255, 0.1)';
        resultDiv.style.border = '1px solid rgba(0, 178, 255, 0.3)';
        resultDiv.style.color = '#00b2ff';
        resultDiv.innerHTML = '🔄 Testing connection...';
      }

      try {
        const response = await authFetch(`${API_BASE_URL}/api/admin/gpu-test`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });

        const result = await response.json();

        if (resultDiv) {
          if (result.healthy) {
            resultDiv.style.background = 'rgba(74, 222, 128, 0.1)';
            resultDiv.style.border = '1px solid rgba(74, 222, 128, 0.3)';
            resultDiv.style.color = '#4ade80';
            const queueInfo = result.queueDepth > 0 ? ` | Queue: ${result.queueDepth}` : '';
            const wsInfo = result.websocket ? ' | WebSocket: ✓' : '';
            resultDiv.innerHTML = `✅ Connection successful!${wsInfo}${queueInfo}`;

            // Update status display
            const dedicatedDisplay = document.getElementById('dedicatedStatusDisplay');
            if (dedicatedDisplay) {
              dedicatedDisplay.textContent = 'Online';
              dedicatedDisplay.style.color = '#4ade80';
            }
          } else {
            resultDiv.style.background = 'rgba(255, 68, 68, 0.1)';
            resultDiv.style.border = '1px solid rgba(255, 68, 68, 0.3)';
            resultDiv.style.color = '#ff4444';
            resultDiv.innerHTML = `❌ Connection failed: ${result.reason || 'Unknown error'}`;
          }
        }
      } catch (error) {
        console.error('GPU test failed:', error);
        if (resultDiv) {
          resultDiv.style.background = 'rgba(255, 68, 68, 0.1)';
          resultDiv.style.border = '1px solid rgba(255, 68, 68, 0.3)';
          resultDiv.style.color = '#ff4444';
          resultDiv.innerHTML = '❌ Test failed: Network error';
        }
      }
    }

    // Warmup status tracking
    let warmupState = { status: 'unknown', lastCheck: null };

    async function checkWarmupStatus() {
      const statusDot = document.getElementById('warmupStatusDot');
      const statusText = document.getElementById('warmupStatusText');
      const statusSubtext = document.getElementById('warmupStatusSubtext');
      const resultDiv = document.getElementById('warmupResult');

      if (statusText) statusText.textContent = 'Checking...';
      if (statusSubtext) statusSubtext.textContent = '';

      try {
        const response = await authFetch(`${API_BASE_URL}/api/admin/warmup-status`);
        const result = await response.json();

        warmupState = { ...result, lastCheck: new Date() };
        updateWarmupUI(result);

        if (resultDiv && result.message) {
          resultDiv.style.display = 'block';
          resultDiv.style.background = 'rgba(0, 178, 255, 0.1)';
          resultDiv.style.border = '1px solid rgba(0, 178, 255, 0.3)';
          resultDiv.style.color = '#00b2ff';
          resultDiv.innerHTML = result.message;
        }
      } catch (error) {
        console.error('Warmup status check failed:', error);
        if (statusDot) statusDot.style.background = '#ef4444';
        if (statusText) statusText.textContent = 'Error';
        if (statusSubtext) statusSubtext.textContent = 'Failed to check status';
      }
    }

    function updateWarmupUI(result) {
      const statusDot = document.getElementById('warmupStatusDot');
      const statusText = document.getElementById('warmupStatusText');
      const statusSubtext = document.getElementById('warmupStatusSubtext');
      const triggerBtn = document.getElementById('warmupTriggerBtn');

      if (!result.gpuOnline) {
        if (statusDot) statusDot.style.background = '#666';
        if (statusText) statusText.textContent = 'GPU Offline';
        if (statusSubtext) statusSubtext.textContent = 'Dedicated GPU is not connected';
        if (triggerBtn) triggerBtn.disabled = true;
        return;
      }

      if (triggerBtn) triggerBtn.disabled = false;

      if (result.status === 'ready') {
        if (statusDot) statusDot.style.background = '#22c55e';
        if (statusText) statusText.textContent = 'Models Loaded';
        if (statusSubtext) statusSubtext.textContent = 'Ready for fast generation';
      } else if (result.status === 'warming') {
        if (statusDot) {
          statusDot.style.background = '#fbbf24';
          statusDot.style.animation = 'pulse-yellow 1s infinite';
        }
        if (statusText) statusText.textContent = 'Warming Up...';
        if (statusSubtext) statusSubtext.textContent = 'Loading models into VRAM';
      } else {
        if (statusDot) statusDot.style.background = '#666';
        if (statusText) statusText.textContent = 'Cold';
        if (statusSubtext) statusSubtext.textContent = 'Models not loaded - first request will be slow';
      }
    }

    async function triggerWarmup() {
      const resultDiv = document.getElementById('warmupResult');
      const triggerBtn = document.getElementById('warmupTriggerBtn');

      if (triggerBtn) {
        triggerBtn.disabled = true;
        triggerBtn.innerHTML = '🔄 Warming up...';
      }

      if (resultDiv) {
        resultDiv.style.display = 'block';
        resultDiv.style.background = 'rgba(255, 165, 0, 0.1)';
        resultDiv.style.border = '1px solid rgba(255, 165, 0, 0.3)';
        resultDiv.style.color = '#ffa500';
        resultDiv.innerHTML = '🔥 Triggering warmup... This may take 1-2 minutes.';
      }

      try {
        const response = await authFetch(`${API_BASE_URL}/api/admin/warmup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ model: 'qwen' })
        });

        const result = await response.json();

        if (result.success) {
          if (resultDiv) {
            resultDiv.style.background = 'rgba(74, 222, 128, 0.1)';
            resultDiv.style.border = '1px solid rgba(74, 222, 128, 0.3)';
            resultDiv.style.color = '#4ade80';
            resultDiv.innerHTML = `✅ ${result.message || 'Warmup complete!'} (${result.loadTimeSeconds || 0}s)`;
          }
          updateWarmupUI({ gpuOnline: true, status: 'ready' });
        } else {
          if (resultDiv) {
            resultDiv.style.background = 'rgba(255, 68, 68, 0.1)';
            resultDiv.style.border = '1px solid rgba(255, 68, 68, 0.3)';
            resultDiv.style.color = '#ff4444';
            resultDiv.innerHTML = `❌ Warmup failed: ${result.error || 'Unknown error'}`;
          }
        }
      } catch (error) {
        console.error('Warmup trigger failed:', error);
        if (resultDiv) {
          resultDiv.style.background = 'rgba(255, 68, 68, 0.1)';
          resultDiv.style.border = '1px solid rgba(255, 68, 68, 0.3)';
          resultDiv.style.color = '#ff4444';
          resultDiv.innerHTML = '❌ Warmup failed: Network error';
        }
      } finally {
        if (triggerBtn) {
          triggerBtn.disabled = false;
          triggerBtn.innerHTML = '🔥 Trigger Warmup';
        }
      }
    }

    // Override saveGpuConfig to work without modal
    async function saveGpuConfig(event) {
      if (event) event.preventDefault();

      const resultDiv = document.getElementById('gpuTestResult');

      try {
        const config = {
          mode: document.getElementById('gpuModeSelect')?.value || 'serverless',
          dedicatedUrl: document.getElementById('gpuDedicatedUrl')?.value || null,
          dedicatedTimeout: parseInt(document.getElementById('gpuTimeout')?.value, 10) || 5000
        };

        if (resultDiv) {
          resultDiv.style.display = 'block';
          resultDiv.style.background = 'rgba(0, 178, 255, 0.1)';
          resultDiv.style.border = '1px solid rgba(0, 178, 255, 0.3)';
          resultDiv.style.color = '#00b2ff';
          resultDiv.innerHTML = '💾 Saving configuration...';
        }

        const response = await authFetch(`${API_BASE_URL}/api/admin/gpu-config`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });

        if (response.ok) {
          if (resultDiv) {
            resultDiv.style.background = 'rgba(74, 222, 128, 0.1)';
            resultDiv.style.border = '1px solid rgba(74, 222, 128, 0.3)';
            resultDiv.style.color = '#4ade80';
            resultDiv.innerHTML = '✅ Configuration saved successfully!';
          }

          // Refresh the display
          loadGpuConfigInline();
        } else {
          const error = await response.json();
          if (resultDiv) {
            resultDiv.style.background = 'rgba(255, 68, 68, 0.1)';
            resultDiv.style.border = '1px solid rgba(255, 68, 68, 0.3)';
            resultDiv.style.color = '#ff4444';
            resultDiv.innerHTML = `❌ Failed: ${error.error || 'Unknown error'}`;
          }
        }
      } catch (error) {
        console.error('Failed to save GPU config:', error);
        if (resultDiv) {
          resultDiv.style.background = 'rgba(255, 68, 68, 0.1)';
          resultDiv.style.border = '1px solid rgba(255, 68, 68, 0.3)';
          resultDiv.style.color = '#ff4444';
          resultDiv.innerHTML = '❌ Failed to save configuration';
        }
      }
    }

    // Load GPU config when admin panel is shown
    function onAdminPanelShown() {
      loadGpuConfigInline();
    }

    function openResourceForm(resourceId = null) {
      const modal = document.getElementById('resourceFormModal');
      const title = document.getElementById('resourceFormTitle');
      const deleteBtn = document.getElementById('resourceFormDelete');
      const form = document.getElementById('resourceForm');

      // Reset form
      form.reset();
      document.getElementById('resourceFormId').value = '';
      document.getElementById('resourceThumbnailPreview').innerHTML = '<span class="resource-thumbnail-placeholder">📷 No image</span>';
      editingResourceId = null;

      if (resourceId) {
        // Edit mode - find and populate resource data
        const resource = allResources.find(r => r.id === resourceId);
        if (resource) {
          editingResourceId = resourceId;
          title.textContent = 'Edit Resource';
          deleteBtn.style.display = 'block';

          document.getElementById('resourceFormId').value = resource.id;
          document.getElementById('resourceFormTitleInput').value = resource.title || '';
          document.getElementById('resourceFormDescription').value = resource.description || '';
          document.getElementById('resourceFormType').value = resource.type || 'tutorial';
          document.getElementById('resourceFormTopic').value = resource.topic || 'prompts';
          // Set tier checkboxes based on resource data
          document.getElementById('resourceFormFreeSupernova').checked =
            resource.free_for_supernova !== undefined ? resource.free_for_supernova : (resource.access_tier !== 'mentorship');
          document.getElementById('resourceFormFreeMentorship').checked =
            resource.free_for_mentorship !== undefined ? resource.free_for_mentorship : true;
          document.getElementById('resourceFormDuration').value = resource.duration || '';
          document.getElementById('resourceFormThumbnail').value = resource.thumbnail_url || '';
          document.getElementById('resourceFormContentUrl').value = resource.content_url || '';

          // Show thumbnail preview if exists
          if (resource.thumbnail_url) {
            document.getElementById('resourceThumbnailPreview').innerHTML = `<img src="${resource.thumbnail_url}" alt="Thumbnail preview">`;
          }
          document.getElementById('resourceFormContentBody').value = resource.content_body || '';

          // Populate pricing fields
          const isPurchasable = resource.is_purchasable || false;
          document.getElementById('resourceFormPurchasable').checked = isPurchasable;
          togglePricingFields();

          if (isPurchasable) {
            document.getElementById('resourceFormPrice').value = resource.price || '';
            document.getElementById('resourceFormSalePrice').value = resource.sale_price || '';
            if (resource.sale_ends_at) {
              // Convert to local datetime format for input
              const saleEnds = new Date(resource.sale_ends_at);
              const localDateTime = saleEnds.toISOString().slice(0, 16);
              document.getElementById('resourceFormSaleEnds').value = localDateTime;
            }
            document.getElementById('resourceFormRevenueShare').value = resource.revenue_share_percent || 70;
          }
        }
      } else {
        // Add mode
        title.textContent = 'Add New Resource';
        deleteBtn.style.display = 'none';
        // Reset pricing fields
        document.getElementById('resourceFormPurchasable').checked = false;
        togglePricingFields();
      }

      modal.classList.add('active');
    }

    function togglePricingFields() {
      const checkbox = document.getElementById('resourceFormPurchasable');
      const fields = document.getElementById('pricingFields');
      fields.style.display = checkbox.checked ? 'block' : 'none';
    }

    function closeResourceForm() {
      document.getElementById('resourceFormModal').classList.remove('active');
      editingResourceId = null;
    }

    async function saveResource(event) {
      event.preventDefault();

      const user = currentUser;
      if (!user || !isUserAdmin) {
        alert('Admin access required');
        return;
      }

      const saveBtn = document.getElementById('resourceFormSave');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      const isPurchasable = document.getElementById('resourceFormPurchasable').checked;

      const freeSupernova = document.getElementById('resourceFormFreeSupernova').checked;
      const freeMentorship = document.getElementById('resourceFormFreeMentorship').checked;

      const resourceData = {
        title: document.getElementById('resourceFormTitleInput').value,
        description: document.getElementById('resourceFormDescription').value,
        type: document.getElementById('resourceFormType').value,
        topic: document.getElementById('resourceFormTopic').value,
        free_for_supernova: freeSupernova,
        free_for_mentorship: freeMentorship,
        // For backwards compatibility, set access_tier based on checkboxes
        access_tier: freeMentorship && !freeSupernova ? 'mentorship' : 'supernova',
        duration: document.getElementById('resourceFormDuration').value || null,
        thumbnail_url: document.getElementById('resourceFormThumbnail').value || null,
        content_url: document.getElementById('resourceFormContentUrl').value || null,
        content_body: document.getElementById('resourceFormContentBody').value || null,
        // Pricing fields
        is_purchasable: isPurchasable,
        price: isPurchasable ? parseFloat(document.getElementById('resourceFormPrice').value) || null : null,
        sale_price: isPurchasable ? parseFloat(document.getElementById('resourceFormSalePrice').value) || null : null,
        sale_ends_at: isPurchasable && document.getElementById('resourceFormSaleEnds').value
          ? new Date(document.getElementById('resourceFormSaleEnds').value).toISOString() : null,
        revenue_share_percent: isPurchasable
          ? parseInt(document.getElementById('resourceFormRevenueShare').value) || 70 : 70
      };

      try {
        const isEditing = !!editingResourceId;
        const url = isEditing
          ? `${API_BASE_URL}/api/resources/${editingResourceId}`
          : `${API_BASE_URL}/api/resources`;

        const response = await authFetch(url, {
          method: isEditing ? 'PUT' : 'POST',
          body: JSON.stringify(resourceData)
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to save resource');
        }

        closeResourceForm();
        await loadResources(); // Reload the resources grid
        alert(isEditing ? 'Resource updated!' : 'Resource created!');

      } catch (error) {
        console.error('Error saving resource:', error);
        alert('Error: ' + error.message);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Resource';
      }
    }

    async function deleteResource() {
      if (!editingResourceId) return;

      const user = currentUser;
      if (!user || !isUserAdmin) {
        alert('Admin access required');
        return;
      }

      if (!confirm('Are you sure you want to delete this resource? This cannot be undone.')) {
        return;
      }

      const deleteBtn = document.getElementById('resourceFormDelete');
      deleteBtn.disabled = true;
      deleteBtn.textContent = 'Deleting...';

      try {
        const response = await authFetch(
          `${API_BASE_URL}/api/resources/${editingResourceId}`,
          { method: 'DELETE' }
        );

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to delete resource');
        }

        closeResourceForm();
        await loadResources();
        alert('Resource deleted!');

      } catch (error) {
        console.error('Error deleting resource:', error);
        alert('Error: ' + error.message);
      } finally {
        deleteBtn.disabled = false;
        deleteBtn.textContent = 'Delete';
      }
    }

    // Edit button for admin on resource cards
    function editResource(event, resourceId) {
      event.stopPropagation(); // Prevent opening the view modal
      openResourceForm(resourceId);
    }

    // Handle thumbnail image upload
    async function handleThumbnailUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const user = currentUser;
      if (!user || !isUserAdmin) {
        alert('Admin access required');
        return;
      }

      const preview = document.getElementById('resourceThumbnailPreview');
      const urlInput = document.getElementById('resourceFormThumbnail');

      // Show loading state
      preview.innerHTML = '<span class="resource-thumbnail-loading">Uploading...</span>';

      try {
        const formData = new FormData();
        formData.append('thumbnail', file);

        // Uses JWT auth - admin check done on server
        const response = await authFetch(`${API_BASE_URL}/api/resources/upload`, {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Upload failed');
        }

        // Update preview and URL input
        preview.innerHTML = `<img src="${data.url}" alt="Thumbnail preview">`;
        urlInput.value = data.url;

      } catch (error) {
        console.error('Upload error:', error);
        alert('Upload failed: ' + error.message);
        preview.innerHTML = '<span class="resource-thumbnail-placeholder">📷 No image</span>';
      }

      // Reset file input
      event.target.value = '';
    }

    // Update thumbnail preview when URL changes
    document.getElementById('resourceFormThumbnail')?.addEventListener('input', function(e) {
      const url = e.target.value;
      const preview = document.getElementById('resourceThumbnailPreview');

      if (url) {
        preview.innerHTML = `<img src="${url}" alt="Thumbnail preview" onerror="this.parentElement.innerHTML='<span class=\\'resource-thumbnail-placeholder\\'>❌ Invalid URL</span>'">`;
      } else {
        preview.innerHTML = '<span class="resource-thumbnail-placeholder">📷 No image</span>';
      }
    });

    function handleChatKeypress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendChatMessage();
      } else {
        // Send typing indicator
        if (chatSocket && currentChannel) {
          chatSocket.emit('typing_start', { channelId: currentChannel });

          // Clear existing timeout
          if (typingTimeout) clearTimeout(typingTimeout);

          // Stop typing after 2 seconds of no input
          typingTimeout = setTimeout(() => {
            chatSocket.emit('typing_stop', { channelId: currentChannel });
          }, 2000);
        }
      }
    }

    function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const content = input.value.trim();

      if (!content || !chatSocket || !currentChannel) return;

      chatSocket.emit('send_message', {
        channelId: currentChannel,
        content: content
      });

      input.value = '';

      // Stop typing indicator
      if (typingTimeout) clearTimeout(typingTimeout);
      chatSocket.emit('typing_stop', { channelId: currentChannel });
    }

    function showTypingIndicator(displayName) {
      const typingEl = document.getElementById('chatTyping');
      document.getElementById('typingUser').textContent = displayName;
      typingEl.style.display = 'block';
    }

    function hideTypingIndicator() {
      document.getElementById('chatTyping').style.display = 'none';
    }

    async function selectMembership(tier) {
      if (!currentUser) {
        alert('Please log in to purchase a membership');
        return;
      }

      const tierName = tier.charAt(0).toUpperCase() + tier.slice(1);
      const price = tier === 'supernova' ? '$49' : '$199';

      // Confirm purchase
      if (!confirm(`Subscribe to ${tierName} for ${price}/month?\n\nYou'll be redirected to pay with cryptocurrency.`)) {
        return;
      }

      try {
        // Show loading state
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'Creating payment...';
        btn.disabled = true;

        // Create payment charge (uses JWT auth)
        const response = await authFetch(`${API_BASE_URL}/api/payments/create-charge`, {
          method: 'POST',
          body: JSON.stringify({ tier: tier })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to create payment');
        }

        // Redirect to NOWPayments payment page
        window.location.href = data.invoice_url;

      } catch (error) {
        console.error('Payment error:', error);
        alert('Failed to create payment. Please try again.');

        // Reset button
        const btn = event.target;
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    // Check for payment success/cancel in URL
    function checkPaymentStatus() {
      const urlParams = new URLSearchParams(window.location.search);
      const paymentStatus = urlParams.get('payment');
      const tier = urlParams.get('tier');

      if (paymentStatus === 'success') {
        alert(`Payment received! Your ${tier || 'membership'} is being activated. This may take a few minutes for the blockchain to confirm.`);
        // Clean up URL
        window.history.replaceState({}, document.title, window.location.pathname);
      } else if (paymentStatus === 'cancelled') {
        alert('Payment was cancelled.');
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }

    // Call on page load
    checkPaymentStatus();

    // Rules Modal Functions
    let communityRulesContent = null;
    let userHasAcknowledgedRules = false;

    async function loadCommunityRules() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/policies/community_rules`);
        if (response.ok) {
          const data = await response.json();
          communityRulesContent = data.policy?.content || getDefaultRulesContent();
        } else {
          communityRulesContent = getDefaultRulesContent();
        }
        // Update both modals with the content
        const rulesListContent = document.getElementById('rulesListContent');
        const rulesAcknowledgeContent = document.getElementById('rulesAcknowledgeContent');
        if (rulesListContent) rulesListContent.innerHTML = communityRulesContent;
        if (rulesAcknowledgeContent) rulesAcknowledgeContent.innerHTML = communityRulesContent;
      } catch (error) {
        console.error('Error loading community rules:', error);
        communityRulesContent = getDefaultRulesContent();
      }
    }

    function getDefaultRulesContent() {
      return `
        <div class="rule-item rule-highlight">
          <span class="rule-number">#1</span>
          <span class="rule-text"><strong>The #1 rule:</strong> Do as Aika says, not as she does.</span>
        </div>
        <div class="rule-item">
          <span class="rule-number">📵</span>
          <span class="rule-text"><strong>Anti-deep-fake stance:</strong> Celebrity deep-fakes or content theft are frowned upon. Lawful uses are fine—keep them clearly lawful.</span>
        </div>
        <div class="rule-item rule-critical">
          <span class="rule-number">🚫</span>
          <span class="rule-text"><strong>No depictions of under-age characters:</strong> Any sexual, suggestive, or otherwise exploitative portrayal of minors is strictly forbidden.</span>
        </div>
        <div class="rule-item">
          <span class="rule-number">💜</span>
          <span class="rule-text"><strong>Be kind & respect everyone's business:</strong> Personal attacks, harassment, hate speech, or discrimination are not tolerated.</span>
        </div>
        <div class="rule-item">
          <span class="rule-number">👮</span>
          <span class="rule-text"><strong>Follow staff instructions:</strong> Mods and admins are here to keep things safe—heed their guidance.</span>
        </div>
        <div class="rule-item">
          <span class="rule-number">🚨</span>
          <span class="rule-text"><strong>Report violations:</strong> If you see a rules breach, notify an organizer or admin right away.</span>
        </div>
      `;
    }

    function openRulesModal() {
      if (!communityRulesContent) loadCommunityRules();
      document.getElementById('rulesModal').classList.add('active');
    }

    function closeRulesModal() {
      document.getElementById('rulesModal').classList.remove('active');
    }

    // Rules acknowledgment checkbox handler
    document.addEventListener('change', (e) => {
      if (e.target.id === 'rulesAcknowledgeCheckbox') {
        const btn = document.getElementById('rulesAcknowledgeBtn');
        if (btn) {
          btn.disabled = !e.target.checked;
          btn.style.opacity = e.target.checked ? '1' : '0.5';
        }
      }
    });

    async function checkRulesAcknowledgment() {
      if (!currentUser) return true; // Not logged in, skip check

      try {
        const response = await authFetch(`${API_BASE_URL}/api/payments/membership/rules-status`);
        if (response.ok) {
          const data = await response.json();
          userHasAcknowledgedRules = data.acknowledged;
          return data.acknowledged;
        }
      } catch (error) {
        console.error('Error checking rules acknowledgment:', error);
      }
      return true; // Default to true on error to not block access
    }

    async function showRulesAcknowledgmentIfNeeded() {
      if (!currentUser) return false;

      const hasAcknowledged = await checkRulesAcknowledgment();
      if (!hasAcknowledged) {
        // Load rules content if not already loaded
        if (!communityRulesContent) await loadCommunityRules();

        // Reset checkbox
        const checkbox = document.getElementById('rulesAcknowledgeCheckbox');
        if (checkbox) checkbox.checked = false;
        const btn = document.getElementById('rulesAcknowledgeBtn');
        if (btn) {
          btn.disabled = true;
          btn.style.opacity = '0.5';
        }

        document.getElementById('rulesAcknowledgeModal').classList.add('active');
        return true; // Modal was shown
      }
      return false; // No modal needed
    }

    async function acknowledgeRules() {
      const btn = document.getElementById('rulesAcknowledgeBtn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        const response = await fetch(`${API_BASE_URL}/api/payments/membership/acknowledge-rules`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${(await supabase.auth.getSession()).data.session?.access_token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          userHasAcknowledgedRules = true;
          document.getElementById('rulesAcknowledgeModal').classList.remove('active');
          btn.textContent = 'Accept & Continue';
          btn.disabled = false;
        } else {
          const error = await response.json();
          alert('Failed to save acknowledgment: ' + (error.message || 'Please try again'));
          btn.textContent = 'Accept & Continue';
          btn.disabled = false;
        }
      } catch (error) {
        console.error('Error acknowledging rules:', error);
        alert('Failed to save acknowledgment. Please try again.');
        btn.textContent = 'Accept & Continue';
        btn.disabled = false;
      }
    }

    // Close rules modal when clicking outside
    document.addEventListener('click', (e) => {
      const rulesModal = document.getElementById('rulesModal');
      if (e.target === rulesModal) {
        closeRulesModal();
      }
      // Note: Don't allow closing acknowledge modal by clicking outside
    });

    // ==================== POLICY MODAL FUNCTIONS ====================
    let currentPolicyType = null;
    let allPolicies = {};

    async function loadPolicies() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/policies`);
        if (!response.ok) throw new Error('Failed to fetch policies');
        const data = await response.json();

        // Store policies by type for quick access
        allPolicies = {};
        data.policies.forEach(p => {
          allPolicies[p.type] = p;
        });

        console.log('📜 Policies loaded:', Object.keys(allPolicies).length);
      } catch (error) {
        console.error('Error loading policies:', error);
      }
    }

    // Note: Analytics dashboard functions are in js/analytics.js

    function renderPoliciesAdminGrid() {
      const grid = document.getElementById('policiesAdminGrid');
      if (!grid) return;

      const policyTypes = [
        { type: 'community_rules', icon: '📋', title: 'Community Rules', desc: 'Rules that members must acknowledge before accessing the community' },
        { type: 'terms', icon: '📜', title: 'Terms of Service', desc: 'Define the rules and guidelines for using your platform' },
        { type: 'privacy', icon: '🔒', title: 'Privacy Policy', desc: 'Explain how you collect, use, and protect user data' },
        { type: 'refund', icon: '💰', title: 'Refund Policy', desc: 'Outline your refund and cancellation policies' },
        { type: '2257', icon: '⚖️', title: '2257 Compliance', desc: '18 U.S.C. 2257 Record-Keeping Requirements Statement' },
        { type: 'prohibited', icon: '🚫', title: 'Prohibited Content', desc: 'Define content that is strictly forbidden on the platform' },
        { type: 'faq', icon: '❓', title: 'FAQ', desc: 'Frequently asked questions and answers for users' },
        { type: 'contact', icon: '📧', title: 'Contact', desc: 'Contact information and support details' }
      ];

      grid.innerHTML = policyTypes.map(p => {
        const policy = allPolicies[p.type];
        const lastUpdated = policy?.updated_at ? new Date(policy.updated_at).toLocaleDateString() : 'Not set';

        return `
          <div class="policy-admin-card" onclick="editPolicyFromAdmin('${p.type}')">
            <div class="policy-admin-card-icon">${p.icon}</div>
            <div class="policy-admin-card-title">${p.title}</div>
            <div class="policy-admin-card-desc">${p.desc}</div>
            <div class="policy-admin-card-meta">Last updated: ${lastUpdated}</div>
            <button class="policy-admin-card-btn">Edit Policy</button>
          </div>
        `;
      }).join('');
    }

    function editPolicyFromAdmin(type) {
      currentPolicyType = type;
      const policy = allPolicies[type] || { title: type.charAt(0).toUpperCase() + type.slice(1) + ' Policy', content: '' };

      const editorModal = document.getElementById('policyEditorModal');
      document.getElementById('policyEditorType').value = type;
      document.getElementById('policyEditorTitle').textContent = `Edit ${policy.title}`;
      document.getElementById('policyEditorTitleInput').value = policy.title;
      document.getElementById('policyEditorContent').value = policy.content;
      editorModal.classList.add('active');
    }

    async function openPolicyModal(type) {
      currentPolicyType = type;
      const modal = document.getElementById('policyModal');
      const body = document.getElementById('policyModalBody');

      // Show loading state
      body.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Loading...</div>';
      modal.classList.add('active');

      try {
        // Check if we have the policy cached
        let policy = allPolicies[type];

        if (!policy) {
          // Fetch from API
          const response = await fetch(`${API_BASE_URL}/api/policies/${type}`);
          if (!response.ok) throw new Error('Policy not found');
          const data = await response.json();
          policy = data.policy;
          allPolicies[type] = policy;
        }

        body.innerHTML = policy.content;

      } catch (error) {
        console.error('Error loading policy:', error);

        // Handle policies with default content
        const defaultContentFunctions = {
          'prohibited': { fn: getProhibitedDefaultContent, title: 'Prohibited Content Policy' },
          'terms': { fn: getTermsDefaultContent, title: 'Terms of Service' },
          'privacy': { fn: getPrivacyDefaultContent, title: 'Privacy Policy' },
          'faq': { fn: getFaqDefaultContent, title: 'Frequently Asked Questions' },
          'contact': { fn: getContactDefaultContent, title: 'Contact Us' }
        };

        if (defaultContentFunctions[type]) {
          const defaultConfig = defaultContentFunctions[type];
          body.innerHTML = defaultConfig.fn();
          if (isUserAdmin) {
            editBtn.style.display = 'inline-block';
            allPolicies[type] = {
              type: type,
              title: defaultConfig.title,
              content: defaultConfig.fn()
            };
          } else {
            editBtn.style.display = 'none';
          }
        } else {
          body.innerHTML = `
            <div style="text-align: center; padding: 40px;">
              <div style="font-size: 3rem; margin-bottom: 16px;">📄</div>
              <div style="color: #888;">Policy not available. Please try again later.</div>
            </div>
          `;
          editBtn.style.display = 'none';
        }
      }
    }

    function closePolicyModal() {
      document.getElementById('policyModal').classList.remove('active');
      currentPolicyType = null;
    }

    // 2257 Compliance Statement - Uses database policy if available, otherwise default
    function open2257Modal() {
      currentPolicyType = '2257';
      const modal = document.getElementById('policyModal');
      const body = document.getElementById('policyModalBody');

      // Check if we have a custom 2257 policy in the database
      const policy = allPolicies['2257'];

      if (policy && policy.content) {
        // Use the custom content from database
        body.innerHTML = policy.content;
      } else {
        // Use default hardcoded content
        body.innerHTML = get2257DefaultContent();
        // Pre-populate allPolicies with default
        allPolicies['2257'] = {
          type: '2257',
          title: '2257 Compliance Statement',
          content: get2257DefaultContent()
        };
      }

      modal.classList.add('active');
    }

    function get2257DefaultContent() {
      return `
        <div style="max-width: 700px; margin: 0 auto;">
          <h1 style="color: #fff; font-size: 1.8rem; margin-bottom: 24px; text-align: center;">
            18 U.S.C. 2257 Record-Keeping Requirements Compliance Statement
          </h1>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
            <h2 style="color: #00b2ff; font-size: 1.2rem; margin-bottom: 16px;">AI-Generated Content Disclosure</h2>
            <p style="color: #ccc; line-height: 1.8; margin-bottom: 16px;">
              All visual content available on this platform is <strong>entirely AI-generated</strong>.
              No actual human beings, whether adults or minors, are depicted in any imagery or video
              content produced by or available through this service.
            </p>
            <p style="color: #ccc; line-height: 1.8;">
              All AI-generated characters are fictional creations and are depicted as adults
              (18 years of age or older). Any resemblance to real persons, living or dead,
              is purely coincidental.
            </p>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
            <h2 style="color: #00b2ff; font-size: 1.2rem; margin-bottom: 16px;">Age Verification</h2>
            <p style="color: #ccc; line-height: 1.8;">
              All users must verify they are at least 18 years of age before accessing
              adult content features on this platform. We implement geographic-based
              restrictions and age verification in compliance with applicable state and
              federal laws.
            </p>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
            <h2 style="color: #00b2ff; font-size: 1.2rem; margin-bottom: 16px;">Record Keeping</h2>
            <p style="color: #ccc; line-height: 1.8; margin-bottom: 16px;">
              Although 18 U.S.C. 2257 was enacted to address content depicting actual individuals,
              we voluntarily maintain comprehensive records of all AI-generated content as a
              demonstration of our commitment to safety and compliance.
            </p>
            <p style="color: #ccc; line-height: 1.8;">
              Records maintained include: unique content identifiers, timestamps of creation,
              user account information, AI model used, and generation parameters. These records
              are retained in accordance with industry best practices.
            </p>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
            <h2 style="color: #00b2ff; font-size: 1.2rem; margin-bottom: 16px;">Custodian of Records</h2>
            <p style="color: #ccc; line-height: 1.8; margin-bottom: 16px;">
              Records required pursuant to 18 U.S.C. 2257 and associated regulations are kept by:
            </p>
            <div style="background: #1a1a1a; border-radius: 6px; padding: 16px; color: #aaa; font-family: monospace;">
              Vixxxen AI<br>
              Custodian of Records<br>
              [Address on file]<br>
              <br>
              Contact: admin@vixxxen.ai
            </div>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px;">
            <h2 style="color: #00b2ff; font-size: 1.2rem; margin-bottom: 16px;">Prohibited Content</h2>
            <p style="color: #ccc; line-height: 1.8; margin-bottom: 16px;">
              The following content is strictly prohibited and will result in immediate account termination:
            </p>
            <ul style="color: #ccc; line-height: 2; padding-left: 24px;">
              <li>Any depiction of minors or child-like characters</li>
              <li>Non-consensual scenarios</li>
              <li>Content depicting real persons without consent</li>
              <li>Bestiality or zoophilic content</li>
              <li>Content promoting violence or illegal activities</li>
            </ul>
          </div>

          <p style="color: #666; font-size: 0.85rem; text-align: center; margin-top: 24px;">
            Last updated: ${new Date().toLocaleDateString()}
          </p>
        </div>
      `;
    }

    function getProhibitedDefaultContent() {
      return `
        <div style="max-width: 700px; margin: 0 auto;">
          <h1 style="color: #fff; font-size: 1.8rem; margin-bottom: 24px; text-align: center;">
            🚫 Prohibited Content Policy
          </h1>

          <div style="background: #3a1a1a; border: 1px solid #5a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
            <h2 style="color: #ff6b6b; font-size: 1.2rem; margin-bottom: 16px;">Zero Tolerance Policy</h2>
            <p style="color: #ccc; line-height: 1.8;">
              Vixxxen maintains a <strong>zero tolerance policy</strong> for illegal content and content that violates our community standards.
              Violations will result in immediate account termination and may be reported to appropriate authorities.
            </p>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
            <h2 style="color: #ff6b6b; font-size: 1.2rem; margin-bottom: 16px;">Absolutely Prohibited Content</h2>
            <p style="color: #ccc; line-height: 1.8; margin-bottom: 16px;">
              The following content is <strong>strictly prohibited</strong> and will not be tolerated under any circumstances:
            </p>
            <ul style="color: #ccc; line-height: 2.2; padding-left: 24px;">
              <li><strong>Child Sexual Abuse Material (CSAM)</strong> - Any content depicting, suggesting, or referencing minors in sexual situations</li>
              <li><strong>Minor-appearing characters</strong> - Any AI-generated characters that appear to be under 18 years of age</li>
              <li><strong>Non-consensual content</strong> - Rape, sexual assault, or any non-consensual scenarios</li>
              <li><strong>Real persons without consent</strong> - Deepfakes or content depicting real individuals without their explicit consent</li>
              <li><strong>Bestiality/Zoophilia</strong> - Any sexual content involving animals</li>
              <li><strong>Extreme violence</strong> - Gore, torture, mutilation, or snuff content</li>
              <li><strong>Incest content</strong> - Sexual content depicting family relationships</li>
            </ul>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
            <h2 style="color: #ffa500; font-size: 1.2rem; margin-bottom: 16px;">Additional Prohibited Content</h2>
            <ul style="color: #ccc; line-height: 2.2; padding-left: 24px;">
              <li>Content promoting terrorism or extremist ideologies</li>
              <li>Content promoting self-harm or suicide</li>
              <li>Content promoting illegal drug manufacturing or trafficking</li>
              <li>Content that infringes on copyrights or trademarks</li>
              <li>Harassment, doxxing, or targeting of real individuals</li>
              <li>Spam, scams, or fraudulent content</li>
              <li>Content that violates any applicable laws</li>
            </ul>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
            <h2 style="color: #00b2ff; font-size: 1.2rem; margin-bottom: 16px;">Reporting Violations</h2>
            <p style="color: #ccc; line-height: 1.8; margin-bottom: 16px;">
              If you encounter content that violates this policy, please report it immediately using the
              report button (🚩) on any content, or contact us directly at:
            </p>
            <div style="background: #1a1a1a; border-radius: 6px; padding: 16px; color: #aaa; font-family: monospace;">
              Email: admin@vixxxen.ai<br>
              Subject: Content Policy Violation Report
            </div>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px;">
            <h2 style="color: #00b2ff; font-size: 1.2rem; margin-bottom: 16px;">Enforcement</h2>
            <p style="color: #ccc; line-height: 1.8;">
              Violations of this policy may result in:
            </p>
            <ul style="color: #ccc; line-height: 2; padding-left: 24px; margin-top: 12px;">
              <li>Immediate content removal</li>
              <li>Account suspension or permanent termination</li>
              <li>Forfeiture of any credits or subscription fees</li>
              <li>Reporting to law enforcement agencies where required by law</li>
              <li>Civil or criminal liability</li>
            </ul>
          </div>

          <p style="color: #666; font-size: 0.85rem; text-align: center; margin-top: 24px;">
            Last updated: ${new Date().toLocaleDateString()}
          </p>
        </div>
      `;
    }

    function getTermsDefaultContent() {
      return `
        <div style="max-width: 700px; margin: 0 auto;">
          <h1 style="color: #fff; font-size: 1.8rem; margin-bottom: 24px; text-align: center;">
            📋 Terms of Service
          </h1>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
            <h2 style="color: #00b2ff; font-size: 1.2rem; margin-bottom: 16px;">1. Acceptance of Terms</h2>
            <p style="color: #ccc; line-height: 1.8;">
              By accessing and using Vixxxen ("the Service"), you agree to be bound by these Terms of Service.
              If you do not agree to these terms, please do not use the Service. You must be at least 18 years
              of age to use this Service.
            </p>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
            <h2 style="color: #00b2ff; font-size: 1.2rem; margin-bottom: 16px;">2. AI-Generated Content</h2>
            <p style="color: #ccc; line-height: 1.8;">
              All characters and content generated on this platform are created using artificial intelligence.
              <strong>No real persons are depicted.</strong> All AI-generated characters are fictional and are
              depicted as adults (18 years of age or older). Any resemblance to real persons is purely coincidental.
            </p>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
            <h2 style="color: #00b2ff; font-size: 1.2rem; margin-bottom: 16px;">3. User Responsibilities</h2>
            <p style="color: #ccc; line-height: 1.8; margin-bottom: 12px;">You agree to:</p>
            <ul style="color: #ccc; line-height: 2; padding-left: 24px;">
              <li>Provide accurate age verification information</li>
              <li>Not use the Service to create prohibited content (see Prohibited Content Policy)</li>
              <li>Not share your account credentials with others</li>
              <li>Not attempt to circumvent any security features</li>
              <li>Comply with all applicable laws and regulations</li>
            </ul>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
            <h2 style="color: #00b2ff; font-size: 1.2rem; margin-bottom: 16px;">4. Intellectual Property</h2>
            <p style="color: #ccc; line-height: 1.8;">
              Content you generate using the Service is subject to our license terms. You may use generated
              content for personal, non-commercial purposes. The underlying AI models, characters, and platform
              remain the property of Vixxxen. You may not claim copyright ownership over AI-generated outputs.
            </p>
          </div>

          <div style="background: #1a2a3a; border: 1px solid #2a4a6a; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
            <h2 style="color: #00b2ff; font-size: 1.2rem; margin-bottom: 16px;">5. DMCA / Copyright Policy</h2>
            <p style="color: #ccc; line-height: 1.8; margin-bottom: 16px;">
              We respect intellectual property rights and expect our users to do the same. If you believe
              content on our platform infringes your copyright, please submit a DMCA takedown notice.
            </p>
            <h3 style="color: #88c0d0; font-size: 1rem; margin-bottom: 12px;">To File a DMCA Notice:</h3>
            <p style="color: #ccc; line-height: 1.8; margin-bottom: 12px;">Send a written notice to our designated agent containing:</p>
            <ul style="color: #ccc; line-height: 2; padding-left: 24px; margin-bottom: 16px;">
              <li>Your physical or electronic signature</li>
              <li>Identification of the copyrighted work claimed to be infringed</li>
              <li>Identification of the infringing material and its location on our Service</li>
              <li>Your contact information (address, phone number, email)</li>
              <li>A statement that you have a good faith belief the use is not authorized</li>
              <li>A statement, under penalty of perjury, that the information is accurate and you are authorized to act on behalf of the copyright owner</li>
            </ul>
            <div style="background: #1a1a1a; border-radius: 6px; padding: 16px; color: #aaa; font-family: monospace;">
              DMCA Agent: Vixxxen AI<br>
              Email: dmca@vixxxen.ai<br>
              Address: [On file with U.S. Copyright Office]
            </div>
            <p style="color: #888; font-size: 0.85rem; margin-top: 12px;">
              Note: Misrepresentations in a DMCA notice may result in liability for damages.
            </p>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
            <h2 style="color: #00b2ff; font-size: 1.2rem; margin-bottom: 16px;">6. Subscription & Billing</h2>
            <p style="color: #ccc; line-height: 1.8;">
              Paid subscriptions are billed on a recurring basis until cancelled. You may cancel at any time
              through your account settings. Refunds are handled according to our Refund Policy. Credits
              purchased are non-refundable except as required by law.
            </p>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
            <h2 style="color: #00b2ff; font-size: 1.2rem; margin-bottom: 16px;">7. Termination</h2>
            <p style="color: #ccc; line-height: 1.8;">
              We reserve the right to suspend or terminate accounts that violate these Terms or our
              Prohibited Content Policy. Upon termination, your right to use the Service ceases immediately.
              Any credits or subscription fees are forfeited upon termination for policy violations.
            </p>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
            <h2 style="color: #00b2ff; font-size: 1.2rem; margin-bottom: 16px;">8. Disclaimer of Warranties</h2>
            <p style="color: #ccc; line-height: 1.8;">
              THE SERVICE IS PROVIDED "AS IS" WITHOUT WARRANTIES OF ANY KIND. WE DO NOT GUARANTEE
              UNINTERRUPTED ACCESS OR ERROR-FREE OPERATION. AI-GENERATED CONTENT MAY CONTAIN ERRORS
              OR UNEXPECTED OUTPUTS.
            </p>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
            <h2 style="color: #00b2ff; font-size: 1.2rem; margin-bottom: 16px;">9. Limitation of Liability</h2>
            <p style="color: #ccc; line-height: 1.8;">
              TO THE MAXIMUM EXTENT PERMITTED BY LAW, VIXXXEN SHALL NOT BE LIABLE FOR ANY INDIRECT,
              INCIDENTAL, SPECIAL, OR CONSEQUENTIAL DAMAGES ARISING FROM YOUR USE OF THE SERVICE.
            </p>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px;">
            <h2 style="color: #00b2ff; font-size: 1.2rem; margin-bottom: 16px;">10. Contact</h2>
            <p style="color: #ccc; line-height: 1.8;">
              For questions about these Terms, please contact us at:
            </p>
            <div style="background: #1a1a1a; border-radius: 6px; padding: 16px; color: #aaa; font-family: monospace; margin-top: 12px;">
              Email: admin@vixxxen.ai
            </div>
          </div>

          <p style="color: #666; font-size: 0.85rem; text-align: center; margin-top: 24px;">
            Last updated: ${new Date().toLocaleDateString()}
          </p>
        </div>
      `;
    }

    function getPrivacyDefaultContent() {
      return `
        <div style="max-width: 700px; margin: 0 auto;">
          <h1 style="color: #fff; font-size: 1.8rem; margin-bottom: 24px; text-align: center;">
            🔒 Privacy Policy
          </h1>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
            <h2 style="color: #00b2ff; font-size: 1.2rem; margin-bottom: 16px;">1. Information We Collect</h2>
            <p style="color: #ccc; line-height: 1.8; margin-bottom: 12px;">We collect information you provide directly:</p>
            <ul style="color: #ccc; line-height: 2; padding-left: 24px;">
              <li><strong>Account Information:</strong> Email address, display name, password</li>
              <li><strong>Payment Information:</strong> Processed securely by our payment providers (we do not store full card details)</li>
              <li><strong>Usage Data:</strong> Content you generate, preferences, settings</li>
              <li><strong>Communications:</strong> Support requests, feedback you send us</li>
            </ul>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
            <h2 style="color: #00b2ff; font-size: 1.2rem; margin-bottom: 16px;">2. How We Use Your Information</h2>
            <ul style="color: #ccc; line-height: 2; padding-left: 24px;">
              <li>Provide and maintain the Service</li>
              <li>Process transactions and send related information</li>
              <li>Send technical notices and support messages</li>
              <li>Respond to your comments and questions</li>
              <li>Detect, prevent, and address fraud and abuse</li>
              <li>Comply with legal obligations (including 2257 record-keeping)</li>
            </ul>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
            <h2 style="color: #00b2ff; font-size: 1.2rem; margin-bottom: 16px;">3. Information Sharing</h2>
            <p style="color: #ccc; line-height: 1.8; margin-bottom: 12px;">We do not sell your personal information. We may share information with:</p>
            <ul style="color: #ccc; line-height: 2; padding-left: 24px;">
              <li><strong>Service Providers:</strong> Payment processors, hosting providers, analytics services</li>
              <li><strong>Legal Requirements:</strong> When required by law or to protect our rights</li>
              <li><strong>Business Transfers:</strong> In connection with a merger, acquisition, or sale of assets</li>
            </ul>
          </div>

          <div style="background: #1a2a3a; border: 1px solid #2a4a6a; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
            <h2 style="color: #00b2ff; font-size: 1.2rem; margin-bottom: 16px;">4. Cookies & Tracking Technologies</h2>
            <p style="color: #ccc; line-height: 1.8; margin-bottom: 16px;">
              We use cookies and similar technologies to operate and improve our Service.
            </p>
            <h3 style="color: #88c0d0; font-size: 1rem; margin-bottom: 12px;">Types of Cookies We Use:</h3>
            <ul style="color: #ccc; line-height: 2; padding-left: 24px; margin-bottom: 16px;">
              <li><strong>Essential Cookies:</strong> Required for the Service to function (authentication, security)</li>
              <li><strong>Preference Cookies:</strong> Remember your settings and preferences</li>
              <li><strong>Analytics Cookies:</strong> Help us understand how visitors use our Service</li>
            </ul>
            <h3 style="color: #88c0d0; font-size: 1rem; margin-bottom: 12px;">Managing Cookies:</h3>
            <p style="color: #ccc; line-height: 1.8;">
              Most browsers allow you to control cookies through settings. However, disabling certain cookies
              may affect Service functionality. By using our Service, you consent to our use of cookies as
              described in this policy.
            </p>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
            <h2 style="color: #00b2ff; font-size: 1.2rem; margin-bottom: 16px;">5. Data Security</h2>
            <p style="color: #ccc; line-height: 1.8;">
              We implement appropriate technical and organizational measures to protect your personal information.
              However, no method of transmission over the Internet is 100% secure. We cannot guarantee absolute
              security but strive to use commercially acceptable means to protect your data.
            </p>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
            <h2 style="color: #00b2ff; font-size: 1.2rem; margin-bottom: 16px;">6. Data Retention</h2>
            <p style="color: #ccc; line-height: 1.8;">
              We retain your information for as long as your account is active or as needed to provide services.
              We may retain certain information as required by law (e.g., 2257 compliance records) or for
              legitimate business purposes. You may request deletion of your account and associated data.
            </p>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
            <h2 style="color: #00b2ff; font-size: 1.2rem; margin-bottom: 16px;">7. Your Rights</h2>
            <p style="color: #ccc; line-height: 1.8; margin-bottom: 12px;">Depending on your location, you may have the right to:</p>
            <ul style="color: #ccc; line-height: 2; padding-left: 24px;">
              <li>Access the personal information we hold about you</li>
              <li>Correct inaccurate information</li>
              <li>Request deletion of your data</li>
              <li>Object to or restrict certain processing</li>
              <li>Data portability</li>
            </ul>
            <p style="color: #ccc; line-height: 1.8; margin-top: 12px;">
              To exercise these rights, contact us at admin@vixxxen.ai
            </p>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px;">
            <h2 style="color: #00b2ff; font-size: 1.2rem; margin-bottom: 16px;">8. Contact Us</h2>
            <p style="color: #ccc; line-height: 1.8;">
              For questions about this Privacy Policy, please contact:
            </p>
            <div style="background: #1a1a1a; border-radius: 6px; padding: 16px; color: #aaa; font-family: monospace; margin-top: 12px;">
              Email: admin@vixxxen.ai
            </div>
          </div>

          <p style="color: #666; font-size: 0.85rem; text-align: center; margin-top: 24px;">
            Last updated: ${new Date().toLocaleDateString()}
          </p>
        </div>
      `;
    }

    function getFaqDefaultContent() {
      return `
        <div style="max-width: 700px; margin: 0 auto;">
          <h1 style="color: #fff; font-size: 1.8rem; margin-bottom: 24px; text-align: center;">
            ❓ Frequently Asked Questions
          </h1>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 16px;">
            <h3 style="color: #00b2ff; font-size: 1.1rem; margin-bottom: 12px;">What is Vixxxen?</h3>
            <p style="color: #ccc; line-height: 1.8;">
              Vixxxen is an AI-powered content creation platform that allows you to generate images, videos,
              and audio featuring AI-generated characters. All content is entirely AI-generated - no real
              persons are depicted.
            </p>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 16px;">
            <h3 style="color: #00b2ff; font-size: 1.1rem; margin-bottom: 12px;">How do credits work?</h3>
            <p style="color: #ccc; line-height: 1.8;">
              Credits are used to generate content. Different operations cost different amounts of credits.
              You can earn credits through your subscription or purchase additional credits. Your credit
              balance is displayed in the sidebar.
            </p>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 16px;">
            <h3 style="color: #00b2ff; font-size: 1.1rem; margin-bottom: 12px;">What subscription plans are available?</h3>
            <p style="color: #ccc; line-height: 1.8;">
              We offer several subscription tiers: Rising Star, Supernova, and Mentorship. Each tier provides
              different amounts of monthly credits and access to exclusive features. Visit the subscription
              page for current pricing and benefits.
            </p>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 16px;">
            <h3 style="color: #00b2ff; font-size: 1.1rem; margin-bottom: 12px;">How do I cancel my subscription?</h3>
            <p style="color: #ccc; line-height: 1.8;">
              You can cancel your subscription at any time from your Account settings. Go to Manage Account,
              then Billing to access cancellation options. Your access will continue until the end of your
              current billing period.
            </p>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 16px;">
            <h3 style="color: #00b2ff; font-size: 1.1rem; margin-bottom: 12px;">Is the content really AI-generated?</h3>
            <p style="color: #ccc; line-height: 1.8;">
              Yes, 100%. All characters, images, videos, and audio on Vixxxen are created using artificial
              intelligence. No real human beings are depicted in any content. All AI characters are fictional
              and depicted as adults (18+).
            </p>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 16px;">
            <h3 style="color: #00b2ff; font-size: 1.1rem; margin-bottom: 12px;">What content is prohibited?</h3>
            <p style="color: #ccc; line-height: 1.8;">
              We have a strict Prohibited Content Policy. Content depicting minors, non-consensual scenarios,
              real persons without consent, bestiality, extreme violence, and other illegal content is
              strictly forbidden. Violations result in immediate account termination. See our full
              Prohibited Content Policy for details.
            </p>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 16px;">
            <h3 style="color: #00b2ff; font-size: 1.1rem; margin-bottom: 12px;">How do I report inappropriate content?</h3>
            <p style="color: #ccc; line-height: 1.8;">
              Click the 🚩 flag icon on any content (images, videos, or chat messages) to report it.
              You can also email us directly at admin@vixxxen.ai. All reports are reviewed by our
              moderation team.
            </p>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 16px;">
            <h3 style="color: #00b2ff; font-size: 1.1rem; margin-bottom: 12px;">Can I get a refund?</h3>
            <p style="color: #ccc; line-height: 1.8;">
              Please see our Refund Policy for details. Generally, subscription fees may be refunded within
              a limited window if you haven't used significant credits. Credits purchased separately are
              non-refundable except as required by law.
            </p>
          </div>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 8px; padding: 24px; margin-bottom: 16px;">
            <h3 style="color: #00b2ff; font-size: 1.1rem; margin-bottom: 12px;">How do I contact support?</h3>
            <p style="color: #ccc; line-height: 1.8;">
              You can reach our support team at:
            </p>
            <div style="background: #1a1a1a; border-radius: 6px; padding: 12px; color: #aaa; font-family: monospace; margin-top: 12px;">
              Email: admin@vixxxen.ai
            </div>
            <p style="color: #888; font-size: 0.9rem; margin-top: 12px;">
              We aim to respond to all inquiries within 24-48 hours.
            </p>
          </div>

          <div style="background: #1a2a3a; border: 1px solid #2a4a6a; border-radius: 8px; padding: 24px;">
            <h3 style="color: #00b2ff; font-size: 1.1rem; margin-bottom: 12px;">Still have questions?</h3>
            <p style="color: #ccc; line-height: 1.8;">
              If you couldn't find the answer you're looking for, please don't hesitate to contact us.
              We're here to help!
            </p>
          </div>

          <p style="color: #666; font-size: 0.85rem; text-align: center; margin-top: 24px;">
            Last updated: ${new Date().toLocaleDateString()}
          </p>
        </div>
      `;
    }

    function getContactDefaultContent() {
      return `
        <div style="max-width: 600px; margin: 0 auto;">
          <h1 style="color: #fff; font-size: 1.8rem; margin-bottom: 24px; text-align: center;">
            📞 Contact Us
          </h1>

          <p style="color: #ccc; line-height: 1.8; text-align: center; margin-bottom: 32px;">
            Have questions, feedback, or need support? We're here to help!
          </p>

          <div style="background: #252525; border: 1px solid #2a2a2a; border-radius: 12px; padding: 32px; margin-bottom: 24px;">
            <div style="display: flex; align-items: flex-start; margin-bottom: 24px;">
              <span style="font-size: 1.5rem; margin-right: 16px;">📧</span>
              <div>
                <h3 style="color: #00b2ff; font-size: 1rem; margin-bottom: 8px;">Email</h3>
                <a href="mailto:admin@vixxxen.ai" style="color: #ccc; text-decoration: none; font-size: 1.1rem;">
                  admin@vixxxen.ai
                </a>
                <p style="color: #888; font-size: 0.85rem; margin-top: 4px;">
                  We typically respond within 24-48 hours
                </p>
              </div>
            </div>

            <div style="display: flex; align-items: flex-start; margin-bottom: 24px;">
              <span style="font-size: 1.5rem; margin-right: 16px;">📱</span>
              <div>
                <h3 style="color: #00b2ff; font-size: 1rem; margin-bottom: 8px;">Phone</h3>
                <a href="tel:+19706800366" style="color: #ccc; text-decoration: none; font-size: 1.1rem;">
                  (970) 680-0366
                </a>
                <p style="color: #888; font-size: 0.85rem; margin-top: 4px;">
                  Monday - Friday, 9am - 5pm MT
                </p>
              </div>
            </div>

            <div style="display: flex; align-items: flex-start;">
              <span style="font-size: 1.5rem; margin-right: 16px;">🏢</span>
              <div>
                <h3 style="color: #00b2ff; font-size: 1rem; margin-bottom: 8px;">Business Address</h3>
                <p style="color: #ccc; line-height: 1.6;">
                  Vixxxen LLC<br>
                  1209 Mountain Road PL NE STE R<br>
                  Albuquerque, NM 87110
                </p>
              </div>
            </div>
          </div>

          <div style="background: #1a2a3a; border: 1px solid #2a4a6a; border-radius: 12px; padding: 24px; text-align: center;">
            <h3 style="color: #00b2ff; font-size: 1rem; margin-bottom: 12px;">Report Content Issues</h3>
            <p style="color: #ccc; line-height: 1.8;">
              To report inappropriate content, use the 🚩 flag button on any content,
              or email us at <a href="mailto:admin@vixxxen.ai" style="color: #00b2ff;">admin@vixxxen.ai</a>
            </p>
          </div>

          <div style="background: #2a1a1a; border: 1px solid #4a2a2a; border-radius: 12px; padding: 24px; text-align: center; margin-top: 24px;">
            <h3 style="color: #ff6b6b; font-size: 1rem; margin-bottom: 12px;">DMCA Notices</h3>
            <p style="color: #ccc; line-height: 1.8;">
              For copyright/DMCA takedown requests, please email:<br>
              <a href="mailto:dmca@vixxxen.ai" style="color: #ff6b6b;">dmca@vixxxen.ai</a>
            </p>
          </div>
        </div>
      `;
    }

    function openPolicyEditor() {
      if (!currentPolicyType || !isUserAdmin) return;

      const policy = allPolicies[currentPolicyType];
      if (!policy) return;

      closePolicyModal();

      const editorModal = document.getElementById('policyEditorModal');
      document.getElementById('policyEditorType').value = currentPolicyType;
      document.getElementById('policyEditorTitle').textContent = `Edit ${policy.title}`;
      document.getElementById('policyEditorTitleInput').value = policy.title;
      document.getElementById('policyEditorContent').value = policy.content;

      editorModal.classList.add('active');
    }

    function closePolicyEditor() {
      document.getElementById('policyEditorModal').classList.remove('active');
    }

    async function savePolicy(event) {
      event.preventDefault();

      const saveBtn = document.getElementById('policyEditorSave');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      try {
        // Get type from hidden input, fallback to currentPolicyType
        let type = document.getElementById('policyEditorType').value;
        if (!type && currentPolicyType) {
          type = currentPolicyType;
        }

        if (!type) {
          throw new Error('Policy type is not set. Please close and reopen the editor.');
        }

        const policyData = {
          title: document.getElementById('policyEditorTitleInput').value,
          content: document.getElementById('policyEditorContent').value
        };

        console.log('📝 Saving policy:', type, policyData.title);

        // Uses JWT auth - admin check done on server
        const response = await authFetch(`${API_BASE_URL}/api/policies/${type}`, {
          method: 'PUT',
          body: JSON.stringify(policyData)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to save policy');
        }

        const data = await response.json();
        allPolicies[type] = data.policy;

        closePolicyEditor();
        renderPoliciesAdminGrid(); // Refresh the admin grid
        console.log('✅ Policy saved successfully');
        alert('Policy saved successfully!');

      } catch (error) {
        console.error('Error saving policy:', error);
        alert('Error saving policy: ' + error.message);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Policy';
      }
    }

    // Close policy modal when clicking outside
    document.addEventListener('click', (e) => {
      const policyModal = document.getElementById('policyModal');
      if (e.target === policyModal) {
        closePolicyModal();
      }
    });

    // Load policies on page load
    window.addEventListener('load', loadPolicies);

    // Video Call Function (Jitsi Meet)
    function startVideoCall() {
      if (!currentChannel) {
        alert('Please join a channel first before starting a call.');
        return;
      }

      // Generate a unique room name based on channel ID
      const roomName = `vixxxen-${currentChannel.replace(/-/g, '').substring(0, 20)}`;
      const jitsiUrl = `https://meet.jit.si/${roomName}`;

      // Open Jitsi in a new tab
      window.open(jitsiUrl, '_blank', 'noopener,noreferrer');

      // Optionally notify the channel that a call started
      if (chatSocket) {
        chatSocket.emit('send_message', {
          channelId: currentChannel,
          content: `📹 Started a video call! Join here: ${jitsiUrl}`
        });
      }
    }

    // Delete message function (admin only)
    function deleteMessage(messageId) {
      if (!isUserAdmin) {
        alert('Admin access required');
        return;
      }

      if (!confirm('Delete this message?')) {
        return;
      }

      if (chatSocket && currentChannel) {
        chatSocket.emit('delete_message', {
          messageId: messageId,
          channelId: currentChannel
        });
      }
    }

    // Image upload handling
    async function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Validate file type
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        return;
      }

      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('Image must be less than 5MB');
        return;
      }

      if (!chatSocket || !currentChannel) {
        alert('Please join a channel first');
        return;
      }

      try {
        // Show uploading state
        const input = document.getElementById('chatInput');
        const originalPlaceholder = input.placeholder;
        input.placeholder = 'Uploading image...';
        input.disabled = true;

        // Generate unique filename
        const fileExt = file.name.split('.').pop();
        const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;
        const filePath = `${currentUser.id}/${fileName}`;

        // Upload to Supabase Storage
        const { data, error } = await supabaseClient.storage
          .from('chat-images')
          .upload(filePath, file);

        if (error) {
          console.error('Upload error:', error);
          alert('Failed to upload image');
          return;
        }

        // Get public URL
        const { data: urlData } = supabaseClient.storage
          .from('chat-images')
          .getPublicUrl(filePath);

        // Send message with image URL
        chatSocket.emit('send_message', {
          channelId: currentChannel,
          content: urlData.publicUrl
        });

        // Reset input
        input.placeholder = originalPlaceholder;
        input.disabled = false;
        event.target.value = '';

      } catch (err) {
        console.error('Image upload error:', err);
        alert('Failed to upload image');
        document.getElementById('chatInput').disabled = false;
      }
    }

    // Giphy API key
    const GIPHY_API_KEY = 'xcEYnwFUkoj0sd0WOLP5ugcVQoLVAPAQ';
    let giphySearchTimeout = null;

    function openGiphyModal() {
      if (!chatSocket || !currentChannel) {
        alert('Please join a channel first');
        return;
      }

      document.getElementById('giphyModal').style.display = 'flex';
      document.getElementById('giphySearchInput').value = '';
      document.getElementById('giphySearchInput').focus();

      // Load trending GIFs
      loadTrendingGifs();
    }

    function closeGiphyModal() {
      document.getElementById('giphyModal').style.display = 'none';
    }

    async function loadTrendingGifs() {
      const resultsContainer = document.getElementById('giphyResults');
      resultsContainer.innerHTML = '<div class="giphy-loading">Loading trending GIFs...</div>';

      try {
        const response = await fetch(
          `https://api.giphy.com/v1/gifs/trending?api_key=${GIPHY_API_KEY}&limit=18&rating=pg-13`
        );
        const data = await response.json();

        if (data.data && data.data.length > 0) {
          renderGiphyResults(data.data, 'Trending');
        } else {
          resultsContainer.innerHTML = '<div class="giphy-loading">No GIFs found</div>';
        }
      } catch (err) {
        console.error('Giphy error:', err);
        resultsContainer.innerHTML = '<div class="giphy-loading">Failed to load GIFs. Check your API key.</div>';
      }
    }

    function handleGiphySearch(event) {
      const query = event.target.value.trim();

      // Debounce search
      clearTimeout(giphySearchTimeout);

      if (!query) {
        loadTrendingGifs();
        return;
      }

      giphySearchTimeout = setTimeout(() => {
        searchGiphy(query);
      }, 300);
    }

    async function searchGiphy(query) {
      const resultsContainer = document.getElementById('giphyResults');
      resultsContainer.innerHTML = '<div class="giphy-loading">Searching...</div>';

      try {
        const response = await fetch(
          `https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_API_KEY}&q=${encodeURIComponent(query)}&limit=18&rating=pg-13`
        );
        const data = await response.json();

        if (data.data && data.data.length > 0) {
          renderGiphyResults(data.data, `Results for "${query}"`);
        } else {
          resultsContainer.innerHTML = '<div class="giphy-loading">No GIFs found</div>';
        }
      } catch (err) {
        console.error('Giphy search error:', err);
        resultsContainer.innerHTML = '<div class="giphy-loading">Search failed</div>';
      }
    }

    function renderGiphyResults(gifs, label) {
      const resultsContainer = document.getElementById('giphyResults');
      resultsContainer.innerHTML = `<div class="giphy-trending-label">${label}</div>`;

      gifs.forEach(gif => {
        const item = document.createElement('div');
        item.className = 'giphy-item';
        item.onclick = () => selectGif(gif);

        // Use fixed_height_small for preview
        const previewUrl = gif.images.fixed_height_small?.url || gif.images.fixed_height?.url;

        item.innerHTML = `<img src="${previewUrl}" alt="${gif.title}" loading="lazy">`;
        resultsContainer.appendChild(item);
      });
    }

    function selectGif(gif) {
      // Use the original or downsized version for the message
      const gifUrl = gif.images.downsized?.url || gif.images.original?.url;

      // Send as message
      chatSocket.emit('send_message', {
        channelId: currentChannel,
        content: gifUrl
      });

      closeGiphyModal();
    }

    // Close giphy modal when clicking outside
    document.addEventListener('click', (e) => {
      const giphyModal = document.getElementById('giphyModal');
      if (e.target === giphyModal) {
        closeGiphyModal();
      }
    });

    // Cleanup chat connection on logout
    const originalHandleLogout = handleLogout;
    handleLogout = async function() {
      if (chatSocket) {
        chatSocket.disconnect();
        chatSocket = null;
      }
      currentChannel = null;
      userMembership = null;
      await originalHandleLogout();
    };

  </script>

  <!-- Mobile Community Overlay (for mobile full-screen chat) -->
  <div id="mobileCommunityOverlay" class="mobile-community-overlay">
    <div class="mobile-community-header">
      <button class="mobile-community-close" onclick="closeMobileCommunityOverlay()">← Back</button>
      <span class="mobile-community-title">Community</span>
    </div>
    <div class="mobile-community-content" id="mobileCommunityContent">
      <!-- Community chat will be moved here on mobile -->
    </div>
  </div>

  <!-- Tidio Chat Widget -->
  <script src="//code.tidio.co/fnunrrlpajmwhyf4q88ygib7zm84nlih.js" async></script>
</body>
</html>
